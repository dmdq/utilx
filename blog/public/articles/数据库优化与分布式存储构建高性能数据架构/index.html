<!doctype html><html lang=zh-cn dir=auto data-theme=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>数据库优化与分布式存储：构建高性能数据架构 | 技术博客 - 有条工具</title><meta name=keywords content="数据库性能优化,SQL查询优化,索引设计,分布式数据库,分库分表,缓存策略,数据一致性"><meta name=description content="深入探讨数据库优化技巧和分布式存储架构，涵盖索引优化、查询优化、分库分表、分布式数据库、缓存策略等核心主题。"><meta name=author content="有条工具团队"><link rel=canonical href=/blog/articles/%E6%95%B0%E6%8D%AE%E5%BA%93%E4%BC%98%E5%8C%96%E4%B8%8E%E5%88%86%E5%B8%83%E5%BC%8F%E5%AD%98%E5%82%A8%E6%9E%84%E5%BB%BA%E9%AB%98%E6%80%A7%E8%83%BD%E6%95%B0%E6%8D%AE%E6%9E%B6%E6%9E%84/><link crossorigin=anonymous href=/blog/assets/css/stylesheet.7e8505b7cdf8bb22ab2305e53c2700bb06c7e64faeb72cd3468823a9a3bd3d6e.css integrity="sha256-foUFt834uyKrIwXlPCcAuwbH5k+utyzTRogjqaO9PW4=" rel="preload stylesheet" as=style><link rel=icon href=/favicon.ico><link rel=icon type=image/png sizes=16x16 href=/blog/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=/blog/favicon-32x32.png><link rel=apple-touch-icon href=/blog/apple-touch-icon.png><link rel=mask-icon href=/blog/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate type=application/rss+xml href=/blog/articles/%E6%95%B0%E6%8D%AE%E5%BA%93%E4%BC%98%E5%8C%96%E4%B8%8E%E5%88%86%E5%B8%83%E5%BC%8F%E5%AD%98%E5%82%A8%E6%9E%84%E5%BB%BA%E9%AB%98%E6%80%A7%E8%83%BD%E6%95%B0%E6%8D%AE%E6%9E%B6%E6%9E%84/feed.xml title=rss><link rel=alternate hreflang=zh-cn href=/blog/articles/%E6%95%B0%E6%8D%AE%E5%BA%93%E4%BC%98%E5%8C%96%E4%B8%8E%E5%88%86%E5%B8%83%E5%BC%8F%E5%AD%98%E5%82%A8%E6%9E%84%E5%BB%BA%E9%AB%98%E6%80%A7%E8%83%BD%E6%95%B0%E6%8D%AE%E6%9E%B6%E6%9E%84/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51);color-scheme:dark}.list{background:var(--theme)}.toc{background:var(--entry)}}@media(prefers-color-scheme:light){.list::-webkit-scrollbar-thumb{border-color:var(--code-bg)}}</style></noscript><script>localStorage.getItem("pref-theme")==="dark"?document.querySelector("html").dataset.theme="dark":localStorage.getItem("pref-theme")==="light"?document.querySelector("html").dataset.theme="light":window.matchMedia("(prefers-color-scheme: dark)").matches?document.querySelector("html").dataset.theme="dark":document.querySelector("html").dataset.theme="light"</script><script src=/js/external-link-config.js></script><script src=/js/external-link-interceptor.js></script><link rel=stylesheet href=/blog/css/custom.css media=screen><script type=application/ld+json>{"@context":"https://schema.org","@type":"WebSite","name":"技术博客 - 有条工具 | 开发者工具使用教程 & 编程技巧分享","url":"https://www.util.cn/blog/","description":"有条工具技术博客 - 分享开发者工具使用教程、编程技巧和实战开发经验。提供JSON格式化、SQL优化、Markdown编辑器等在线工具的详细使用指南，帮助开发者提升工作效率。","publisher":{"@type":"Organization","name":"有条工具","url":"https://www.util.cn","logo":{"@type":"ImageObject","url":"https://www.util.cn/blog/logo/logo-256.png","width":256,"height":256}},"potentialAction":[{"@type":"SearchAction","target":"https://www.util.cn/blog/search?q={search_term_string}","query-input":"required name=search_term_string"}]}</script><meta property="og:type" content="website"><meta property="og:title" content="技术博客 - 有条工具 | 开发者工具使用教程 & 编程技巧分享"><meta property="og:description" content="有条工具技术博客 - 分享开发者工具使用教程、编程技巧和实战开发经验。提供JSON格式化、SQL优化、Markdown编辑器等在线工具的详细使用指南，帮助开发者提升工作效率。"><meta property="og:url" content="https://www.util.cn/blog/"><meta property="og:site_name" content="有条工具技术博客"><meta property="og:image" content="https://www.util.cn/blog/logo/logo-256.png"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="630"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="技术博客 - 有条工具 | 开发者工具使用教程 & 编程技巧分享"><meta name=twitter:description content="有条工具技术博客 - 分享开发者工具使用教程、编程技巧和实战开发经验。"><meta name=twitter:image content="https://www.util.cn/blog/logo/logo-256.png"><meta name=baidu-site-verification content><meta name=category content="技术博客,开发者工具,编程教程"><meta name=coverage content="Worldwide"><meta name=distribution content="Global"><meta name=rating content="General"><script id=51la_code async crossorigin=anonymous src="https://sdk.51.la/js-sdk-pro.min.js?id=3OM52V0xJAPv6ozF&hash=pro"></script><script>window.addEventListener("load",function(){setTimeout(function(){typeof la!="undefined"?console.log("51la统计已加载"):(console.warn("51la统计加载失败，使用备用方案"),function(){var e=document.createElement("script");e.src="https://sdk.51.la/js-sdk-pro.min.js?id=3OM52V0xJAPv6ozF&hash=backup",e.async=!0,document.head.appendChild(e)}())},3e3)})</script><meta property="og:url" content="/blog/articles/%E6%95%B0%E6%8D%AE%E5%BA%93%E4%BC%98%E5%8C%96%E4%B8%8E%E5%88%86%E5%B8%83%E5%BC%8F%E5%AD%98%E5%82%A8%E6%9E%84%E5%BB%BA%E9%AB%98%E6%80%A7%E8%83%BD%E6%95%B0%E6%8D%AE%E6%9E%B6%E6%9E%84/"><meta property="og:site_name" content="技术博客 - 有条工具"><meta property="og:title" content="数据库优化与分布式存储：构建高性能数据架构"><meta property="og:description" content="深入探讨数据库优化技巧和分布式存储架构，涵盖索引优化、查询优化、分库分表、分布式数据库、缓存策略等核心主题。"><meta property="og:locale" content="zh-cn"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-12-30T15:00:00+08:00"><meta property="article:modified_time" content="2025-12-30T15:00:00+08:00"><meta property="article:tag" content="数据库优化"><meta property="article:tag" content="分布式存储"><meta property="article:tag" content="索引优化"><meta property="article:tag" content="查询优化"><meta property="article:tag" content="分库分表"><meta name=twitter:card content="summary"><meta name=twitter:title content="数据库优化与分布式存储：构建高性能数据架构"><meta name=twitter:description content="深入探讨数据库优化技巧和分布式存储架构，涵盖索引优化、查询优化、分库分表、分布式数据库、缓存策略等核心主题。"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"所有文章","item":"/blog/posts/"},{"@type":"ListItem","position":2,"name":"数据库优化与分布式存储：构建高性能数据架构","item":"/blog/articles/%E6%95%B0%E6%8D%AE%E5%BA%93%E4%BC%98%E5%8C%96%E4%B8%8E%E5%88%86%E5%B8%83%E5%BC%8F%E5%AD%98%E5%82%A8%E6%9E%84%E5%BB%BA%E9%AB%98%E6%80%A7%E8%83%BD%E6%95%B0%E6%8D%AE%E6%9E%B6%E6%9E%84/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"数据库优化与分布式存储：构建高性能数据架构","name":"数据库优化与分布式存储：构建高性能数据架构","description":"深入探讨数据库优化技巧和分布式存储架构，涵盖索引优化、查询优化、分库分表、分布式数据库、缓存策略等核心主题。","keywords":["数据库性能优化","SQL查询优化","索引设计","分布式数据库","分库分表","缓存策略","数据一致性"],"articleBody":"引言 数据是现代应用的核心资产。随着数据量的爆炸式增长，数据库性能和可扩展性成为系统设计的关键挑战。本文将深入探讨数据库优化技巧和分布式存储架构，帮助读者构建高性能的数据架构。\n一、数据库性能优化 1.1 索引优化策略 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 -- ========== 索引基础 ========== -- 1. B-Tree索引（最常用） -- 适合：等值查询、范围查询、排序 CREATE INDEX idx_user_email ON users(email); CREATE INDEX idx_order_created ON orders(created_at); -- 2. 复合索引 -- 注意：最左前缀原则 CREATE INDEX idx_user_status_created ON users(status, created_at); -- 有效的查询（能使用索引） SELECT * FROM users WHERE status = 1 AND created_at \u003e '2024-01-01'; SELECT * FROM users WHERE status = 1; -- 无效的查询（不能使用索引） SELECT * FROM users WHERE created_at \u003e '2024-01-01'; -- 3. 覆盖索引 -- 包含查询所需的所有字段，避免回表 CREATE INDEX idx_user_cover ON users(status, created_at, id, name); -- 4. 唯一索引 CREATE UNIQUE INDEX idx_user_username ON users(username); -- ========== 索引设计原则 ========== /* 1. 选择性高的字段适合建索引 - 高选择性：唯一值多（如用户ID、邮箱） - 低选择性：重复值多（如性别、状态） 2. WHERE、JOIN、ORDER BY子句的字段 3. 小字段优先 - 整数 \u003e 日期 \u003e 短字符串 \u003e 长字符串 4. 联合索引的顺序 - 最常查询的字段放前面 - 范围查询字段放后面 5. 避免过多索引 - 降低写入性能 - 占用存储空间 */ -- ========== 索引优化案例 ========== -- 问题：查询慢 -- 耗时：2.5秒 SELECT * FROM orders o LEFT JOIN users u ON o.user_id = u.id WHERE o.status = 'pending' AND o.created_at \u003e '2024-01-01' ORDER BY o.created_at DESC LIMIT 20; -- 优化1：添加合适索引 CREATE INDEX idx_orders_status_created ON orders(status, created_at DESC); CREATE INDEX idx_orders_user_id ON orders(user_id); -- 耗时：0.3秒 -- 优化2：只查询需要的字段 SELECT o.id, o.order_no, o.total_amount, u.username FROM orders o LEFT JOIN users u ON o.user_id = u.id WHERE o.status = 'pending' AND o.created_at \u003e '2024-01-01' ORDER BY o.created_at DESC LIMIT 20; -- 耗时：0.1秒 -- 优化3：使用覆盖索引 CREATE INDEX idx_orders_cover ON orders( status, created_at DESC, id, order_no, total_amount, user_id ); -- 耗时：0.05秒 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 # ========== 索引分析与维护 ========== import pymysql from typing import List, Dict, Tuple class IndexAnalyzer: \"\"\"索引分析器\"\"\" def __init__(self, connection_config: dict): self.conn = pymysql.connect(**connection_config) def analyze_table_indexes(self, table_name: str) -\u003e List[Dict]: \"\"\"分析表的索引使用情况\"\"\" with self.conn.cursor() as cursor: # 查询索引信息 sql = \"\"\" SHOW INDEX FROM %s \"\"\" % table_name cursor.execute(sql) indexes = cursor.fetchall() # 查询索引使用统计 sql = \"\"\" SELECT table_name, index_name, cardinality, column_name, seq_in_index FROM information_schema.statistics WHERE table_schema = DATABASE() AND table_name = %s ORDER BY index_name, seq_in_index \"\"\" cursor.execute(sql, (table_name,)) stats = cursor.fetchall() return { 'indexes': indexes, 'statistics': stats } def find_unused_indexes(self) -\u003e List[Dict]: \"\"\"查找未使用的索引\"\"\" with self.conn.cursor() as cursor: # MySQL 5.7+ 使用performance_schema sql = \"\"\" SELECT object_schema AS table_schema, object_name AS table_name, index_name FROM performance_schema.table_io_waits_summary_by_index_usage WHERE index_name IS NOT NULL AND count_star = 0 AND index_name != 'PRIMARY' ORDER BY object_schema, object_name \"\"\" cursor.execute(sql) return cursor.fetchall() def find_duplicate_indexes(self, table_name: str) -\u003e List[Tuple]: \"\"\"查找冗余索引\"\"\" with self.conn.cursor() as cursor: # 查询索引及其列 sql = \"\"\" SELECT index_name, GROUP_CONCAT(column_name ORDER BY seq_in_index) as columns FROM information_schema.statistics WHERE table_schema = DATABASE() AND table_name = %s GROUP BY index_name HAVING COUNT(*) \u003e 1 \"\"\" cursor.execute(sql, (table_name,)) indexes = cursor.fetchall() # 查找冗余索引 duplicates = [] for i, idx1 in enumerate(indexes): for idx2 in indexes[i+1:]: # 检查是否包含关系 if idx2[1].startswith(idx1[1]): duplicates.append((idx1[0], idx2[0])) return duplicates def suggest_indexes(self, table_name: str) -\u003e List[Dict]: \"\"\"推荐索引\"\"\" with self.conn.cursor() as cursor: # 分析慢查询日志 sql = \"\"\" SELECT sql_text, count(*) as frequency FROM mysql.slow_log WHERE sql_text LIKE %s GROUP BY sql_text ORDER BY frequency DESC LIMIT 10 \"\"\" cursor.execute(sql, (f'%{table_name}%',)) slow_queries = cursor.fetchall() suggestions = [] for query, freq in slow_queries: # 提取WHERE条件字段 # 这里简化处理，实际需要解析SQL # ... suggestions.append({ 'query': query, 'frequency': freq, 'suggested_index': '建议基于WHERE子句创建索引' }) return suggestions 1.2 查询优化 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 -- ========== SQL查询优化 ========== -- 1. 避免SELECT * -- 不推荐 SELECT * FROM users WHERE id = 1; -- 推荐 SELECT id, username, email FROM users WHERE id = 1; -- 2. 使用LIMIT限制结果集 SELECT * FROM orders WHERE status = 'pending' LIMIT 100; -- 3. 优化JOIN -- 小表驱动大表 SELECT * FROM small_table s JOIN large_table l ON s.id = l.small_id; -- 4. 子查询优化 -- 不推荐 SELECT * FROM users WHERE id IN (SELECT user_id FROM orders WHERE amount \u003e 1000); -- 推荐 SELECT DISTINCT u.* FROM users u INNER JOIN orders o ON u.id = o.user_id WHERE o.amount \u003e 1000; -- 5. EXISTS vs IN -- 小表用IN，大表用EXISTS -- 小表 SELECT * FROM users WHERE id IN (1, 2, 3); -- 大表 SELECT * FROM users u WHERE EXISTS ( SELECT 1 FROM orders o WHERE o.user_id = u.id AND o.status = 'pending' ); -- 6. 避免在WHERE子句中使用函数 -- 不推荐 SELECT * FROM orders WHERE DATE(created_at) = '2024-01-01'; -- 推荐 SELECT * FROM orders WHERE created_at \u003e= '2024-01-01' AND created_at \u003c '2024-01-02'; -- 7. 使用UNION ALL代替UNION -- 不推荐（去重开销大） SELECT user_id FROM orders_2024 UNION SELECT user_id FROM orders_2023; -- 推荐 SELECT user_id FROM orders_2024 UNION ALL SELECT user_id FROM orders_2023; -- 8. 批量操作 -- 不推荐（多次单条插入） INSERT INTO logs (message) VALUES ('log1'); INSERT INTO logs (message) VALUES ('log2'); INSERT INTO logs (message) VALUES ('log3'); -- 推荐 INSERT INTO logs (message) VALUES ('log1'), ('log2'), ('log3'); 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 # ========== 查询优化器 ========== import re from typing import List, Dict, Tuple class SQLQueryOptimizer: \"\"\"SQL查询优化器\"\"\" def __init__(self): self.rules = { 'select_star': self._check_select_star, 'missing_where': self._check_missing_where, 'function_in_where': self._check_function_in_where, 'subquery': self._check_subquery, 'nplus1': self._check_nplus1 } def optimize(self, sql: str) -\u003e Dict: \"\"\"优化SQL\"\"\" issues = [] suggestions = [] for rule_name, rule_func in self.rules.items(): result = rule_func(sql) if result: issues.append(result['issue']) suggestions.append(result['suggestion']) return { 'original_sql': sql, 'issues': issues, 'suggestions': suggestions } def _check_select_star(self, sql: str) -\u003e Dict: \"\"\"检查SELECT ***\"\"\" if re.search(r'SELECT\\s+\\*\\s+FROM', sql, re.IGNORECASE): return { 'issue': '使用SELECT *', 'suggestion': '只查询需要的列，减少数据传输' } return None def _check_missing_where(self, sql: str) -\u003e Dict: \"\"\"检查缺少WHERE条件\"\"\" if re.search(r'(DELETE|UPDATE)\\s+\\w+\\s+(?!WHERE)', sql, re.IGNORECASE): return { 'issue': 'DELETE/UPDATE缺少WHERE条件', 'suggestion': '添加WHERE条件，避免全表操作' } return None def _check_function_in_where(self, sql: str) -\u003e Dict: \"\"\"检查WHERE子句中使用函数\"\"\" if re.search( r'WHERE\\s+.*(?:DATE|YEAR|MONTH|DAY)\\(', sql, re.IGNORECASE ): return { 'issue': 'WHERE子句中使用函数', 'suggestion': '将函数作用到比较值上，而非字段' } return None def _check_subquery(self, sql: str) -\u003e Dict: \"\"\"检查子查询\"\"\" if 'IN (SELECT' in sql.upper(): return { 'issue': '使用IN子查询', 'suggestion': '考虑改用JOIN或EXISTS' } return None def _check_nplus1(self, sql: str) -\u003e Dict: \"\"\"检查N+1查询\"\"\" # 这里简化处理，实际需要分析执行模式 return None class QueryExecutionAnalyzer: \"\"\"查询执行分析器\"\"\" def __init__(self, connection): self.conn = connection def explain_query(self, sql: str) -\u003e Dict: \"\"\"分析查询执行计划\"\"\" with self.conn.cursor() as cursor: # 执行EXPLAIN explain_sql = f\"EXPLAIN {sql}\" cursor.execute(explain_sql) result = cursor.fetchall() analysis = { 'type': [], 'table': [], 'possible_keys': [], 'key': [], 'rows': [], 'filtered': [], 'extra': [] } for row in result: analysis['type'].append(row['type']) analysis['table'].append(row['table']) analysis['possible_keys'].append(row['possible_keys']) analysis['key'].append(row['key']) analysis['rows'].append(row['rows']) analysis['filtered'].append(row['filtered']) analysis['extra'].append(row['Extra']) # 分析结果 suggestions = [] # 检查是否全表扫描 if 'ALL' in analysis['type']: suggestions.append( '警告：存在全表扫描，考虑添加索引' ) # 检查是否使用了索引 if None in analysis['key']: suggestions.append( '部分查询没有使用索引，检查索引设计' ) # 检查扫描行数 if analysis['rows'] and sum(analysis['rows']) \u003e 10000: suggestions.append( '扫描行数较多，考虑优化查询或索引' ) return { 'explain_plan': result, 'suggestions': suggestions } def profile_query(self, sql: str) -\u003e Dict: \"\"\"分析查询性能\"\"\" with self.conn.cursor() as cursor: # 开启profiling cursor.execute(\"SET profiling = 1\") # 执行查询 cursor.execute(sql) # 获取profiling结果 cursor.execute(\"SHOW PROFILE\") profile = cursor.fetchall() # 获取查询统计 cursor.execute(\"SHOW PROFILE FOR QUERY 1\") stats = cursor.fetchall() return { 'profile': profile, 'statistics': stats } 二、分库分表策略 2.1 水平分表 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 213 214 215 216 217 218 219 220 221 222 223 224 225 226 227 228 229 230 231 232 233 # ========== 分表策略 ========== class ShardingStrategy: \"\"\"分片策略\"\"\" def __init__(self, shard_count: int): self.shard_count = shard_count def hash_sharding(self, key: str) -\u003e int: \"\"\"哈希分片\"\"\" hash_value = hash(key) return hash_value % self.shard_count def range_sharding(self, key: int) -\u003e int: \"\"\"范围分片\"\"\" # 假设key是自增ID shard_size = 1000000 # 每个分片100万条 return key // shard_size def modulo_sharding(self, key: int) -\u003e int: \"\"\"取模分片\"\"\" return key % self.shard_count def consistent_hash_sharding(self, key: str) -\u003e int: \"\"\"一致性哈希分片\"\"\" import hashlib hash_value = int(hashlib.md5(key.encode()).hexdigest(), 16) return hash_value % self.shard_count class ShardingManager: \"\"\"分片管理器\"\"\" def __init__(self, shard_configs: List[dict]): self.shards = {} for config in shard_configs: shard_id = config['id'] self.shards[shard_id] = { 'connection': self._create_connection(config), 'config': config } self.strategy = ShardingStrategy(len(shard_configs)) def _create_connection(self, config: dict): \"\"\"创建数据库连接\"\"\" import pymysql return pymysql.connect( host=config['host'], port=config['port'], user=config['user'], password=config['password'], database=config['database'] ) def get_shard(self, shard_key: str, sharding_type: str = 'hash'): \"\"\"获取分片连接\"\"\" if sharding_type == 'hash': shard_id = self.strategy.hash_sharding(shard_key) elif sharding_type == 'consistent': shard_id = self.strategy.consistent_hash_sharding(shard_key) elif sharding_type == 'modulo': shard_id = self.strategy.modulo_sharding(int(shard_key)) else: raise ValueError(f\"Unknown sharding type: {sharding_type}\") return self.shards[shard_id]['connection'] def execute_on_shard(self, shard_key: str, sql: str, params=None): \"\"\"在指定分片执行SQL\"\"\" conn = self.get_shard(shard_key) with conn.cursor() as cursor: cursor.execute(sql, params or ()) return cursor.fetchall() def query_all_shards(self, sql: str, params=None): \"\"\"查询所有分片\"\"\" results = [] for shard_id, shard in self.shards.items(): conn = shard['connection'] with conn.cursor() as cursor: cursor.execute(sql, params or ()) shard_results = cursor.fetchall() # 添加分片标识 for row in shard_results: if isinstance(row, dict): row['_shard_id'] = shard_id results.extend(shard_results) return results def broadcast_write(self, sql: str, params=None): \"\"\"广播写入所有分片\"\"\" results = [] for shard_id, shard in self.shards.items(): conn = shard['connection'] with conn.cursor() as cursor: cursor.execute(sql, params or ()) conn.commit() results.append({ 'shard_id': shard_id, 'affected_rows': cursor.rowcount }) return results # ========== 分表路由 ========== class TableRouter: \"\"\"表路由\"\"\" def __init__(self, sharding_manager: ShardingManager): self.manager = sharding_manager self.table_rules = {} def add_rule(self, table_name: str, sharding_key: str, sharding_type: str): \"\"\"添加分表规则\"\"\" self.table_rules[table_name] = { 'sharding_key': sharding_key, 'sharding_type': sharding_type } def get_table_name(self, original_table: str, shard_key: str) -\u003e str: \"\"\"获取实际表名\"\"\" rule = self.table_rules.get(original_table) if not rule: return original_table # 计算分片ID if rule['sharding_type'] == 'hash': shard_id = hash(shard_key) % self.manager.strategy.shard_count elif rule['sharding_type'] == 'modulo': shard_id = int(shard_key) % self.manager.strategy.shard_count else: shard_id = 0 return f\"{original_table}_{shard_id:04d}\" def execute_query(self, table_name: str, query_template: str, **kwargs): \"\"\"执行分表查询\"\"\" # 获取分片键值 rule = self.table_rules.get(table_name) if not rule: # 不分表，直接执行 return self.manager.execute_on_shard('0', query_template, kwargs) shard_key_value = kwargs.get(rule['sharding_key']) if not shard_key_value: raise ValueError(f\"Missing sharding key: {rule['sharding_key']}\") # 获取实际表名 actual_table = self.get_table_name(table_name, str(shard_key_value)) # 替换表名 actual_query = query_template.replace(f'FROM {table_name}', f'FROM {actual_table}') return self.manager.execute_on_shard(str(shard_key_value), actual_query, kwargs) # 使用示例 shard_configs = [ { 'id': 0, 'host': 'db0.example.com', 'port': 3306, 'user': 'root', 'password': 'password', 'database': 'app_db_0' }, { 'id': 1, 'host': 'db1.example.com', 'port': 3306, 'user': 'root', 'password': 'password', 'database': 'app_db_1' }, { 'id': 2, 'host': 'db2.example.com', 'port': 3306, 'user': 'root', 'password': 'password', 'database': 'app_db_2' }, { 'id': 3, 'host': 'db3.example.com', 'port': 3306, 'user': 'root', 'password': 'password', 'database': 'app_db_3' } ] sharding_manager = ShardingManager(shard_configs) table_router = TableRouter(sharding_manager) # 配置orders表按user_id分表 table_router.add_rule('orders', 'user_id', 'modulo') # 插入订单（自动路由到正确的分片） table_router.execute_query( 'orders', \"INSERT INTO orders (user_id, order_no, total_amount) VALUES (:user_id, :order_no, :total_amount)\", user_id=12345, order_no='ORD2024010112345', total_amount=9999.99 ) # 查询订单（自动路由到正确的分片） results = table_router.execute_query( 'orders', \"SELECT * FROM orders WHERE user_id = :user_id\", user_id=12345 ) 2.2 垂直分库 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 # ========== 垂直分库策略 ========== class VerticalSharding: \"\"\"垂直分库\"\"\" def __init__(self): self.databases = { 'user_db': None, # 用户相关表 'order_db': None, # 订单相关表 'product_db': None, # 商品相关表 'log_db': None # 日志相关表 } def route_by_module(self, table_name: str): \"\"\"按模块路由\"\"\" module_mapping = { # 用户模块 'users': 'user_db', 'user_profiles': 'user_db', 'user_addresses': 'user_db', 'user_preferences': 'user_db', # 订单模块 'orders': 'order_db', 'order_items': 'order_db', 'order_payments': 'order_db', 'order_shippings': 'order_db', # 商品模块 'products': 'product_db', 'categories': 'product_db', 'product_skus': 'product_db', 'inventory': 'product_db', # 日志模块 'operation_logs': 'log_db', 'access_logs': 'log_db', 'error_logs': 'log_db' } return self.databases.get(module_mapping.get(table_name)) def cross_database_query(self, queries: List[dict]): \"\"\"跨库查询\"\"\" results = {} for query_info in queries: db_name = query_info['database'] sql = query_info['sql'] params = query_info.get('params', {}) conn = self.databases[db_name] with conn.cursor() as cursor: cursor.execute(sql, params) results[db_name] = cursor.fetchall() # 在应用层合并结果 return self._merge_results(results) def _merge_results(self, results: dict) -\u003e List[dict]: \"\"\"合并跨库查询结果\"\"\" # 根据业务逻辑合并结果 # 这里是简化示例 merged = [] # 从user_db获取用户信息 users = results.get('user_db', []) # 从order_db获取订单信息 orders = results.get('order_db', []) # 合并数据 user_dict = {user['id']: user for user in users} for order in orders: user_id = order['user_id'] if user_id in user_dict: merged.append({ **user_dict[user_id], 'order': order }) return merged # ========== 分布式事务（Saga模式） ========== class DistributedTransaction: \"\"\"分布式事务管理器\"\"\" def __init__(self): self.participants = [] self.compensations = [] def add_participant(self, database: str, operation: str, compensation: str): \"\"\"添加事务参与者\"\"\" self.participants.append({ 'database': database, 'operation': operation }) self.compensations.append({ 'database': database, 'operation': compensation }) async def execute(self) -\u003e bool: \"\"\"执行分布式事务\"\"\" executed = [] try: # 顺序执行各分库操作 for participant in self.participants: conn = self.databases[participant['database']] with conn.cursor() as cursor: cursor.execute(participant['operation']) conn.commit() executed.append(participant) return True except Exception as e: # 执行补偿操作 for i in range(len(executed) - 1, -1, -1): compensation = self.compensations[i] try: conn = self.databases[compensation['database']] with conn.cursor() as cursor: cursor.execute(compensation['operation']) conn.commit() except Exception as ce: # 补偿失败，记录日志 print(f\"Compensation failed: {ce}\") return False 三、分布式数据库 3.1 NewSQL数据库 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 # ========== TiDB集成示例 ========== import MySQLdb class TiDBClient: \"\"\"TiDB客户端\"\"\" def __init__(self, host: str, port: int, user: str, password: str, database: str): self.conn = MySQLdb.connect( host=host, port=port, user=user, password=password, database=database, charset='utf8mb4' ) def insert_batch(self, table: str, records: List[dict]) -\u003e int: \"\"\"批量插入\"\"\" if not records: return 0 # 构建批量插入SQL columns = list(records[0].keys()) placeholders = ', '.join(['%s'] * len(columns)) sql = f\"\"\" INSERT INTO {table} ({', '.join(columns)}) VALUES ({placeholders}) \"\"\" values = [ tuple(record[col] for col in columns) for record in records ] with self.conn.cursor() as cursor: cursor.executemany(sql, values) self.conn.commit() return cursor.rowcount def select_with_pagination( self, table: str, where: str = None, order_by: str = None, limit: int = 100, offset: int = 0 ) -\u003e List[dict]: \"\"\"分页查询\"\"\" sql = f\"SELECT * FROM {table}\" if where: sql += f\" WHERE {where}\" if order_by: sql += f\" ORDER BY {order_by}\" sql += f\" LIMIT {limit} OFFSET {offset}\" with self.conn.cursor(MySQLdb.cursors.DictCursor) as cursor: cursor.execute(sql) return cursor.fetchall() def get_transaction_info(self) -\u003e dict: \"\"\"获取事务信息\"\"\" with self.conn.cursor() as cursor: # 查询当前事务信息 cursor.execute(\"SELECT @@txn_version as version\") version = cursor.fetchone() cursor.execute(\"SELECT @@autocommit as autocommit\") autocommit = cursor.fetchone() return { 'version': version[0] if version else None, 'autocommit': autocommit[0] if autocommit else None } # ========== 分布式事务使用 ========== class DistributedOrderService: \"\"\"分布式订单服务\"\"\" def __init__(self, tidb_client: TiDBClient): self.tidb = tidb_client async def create_order(self, order_data: dict, items: List[dict]) -\u003e str: \"\"\"创建订单（分布式事务）\"\"\" try: # 开启事务 with self.tidb.conn as cursor: # 1. 创建订单 order_sql = \"\"\" INSERT INTO orders (user_id, order_no, total_amount, status) VALUES (%s, %s, %s, %s) \"\"\" cursor.execute(order_sql, ( order_data['user_id'], order_data['order_no'], order_data['total_amount'], 'pending' )) order_id = cursor.lastrowid # 2. 创建订单明细 for item in items: item_sql = \"\"\" INSERT INTO order_items ( order_id, product_id, quantity, price ) VALUES (%s, %s, %s, %s) \"\"\" cursor.execute(item_sql, ( order_id, item['product_id'], item['quantity'], item['price'] )) # 3. 扣减库存 for item in items: inventory_sql = \"\"\" UPDATE inventory SET stock = stock - %s WHERE product_id = %s AND stock \u003e= %s \"\"\" affected = cursor.execute(inventory_sql, ( item['quantity'], item['product_id'], item['quantity'] )) if affected == 0: # 库存不足，回滚事务 raise Exception(f\"Insufficient stock for product {item['product_id']}\") # 4. 创建支付记录 payment_sql = \"\"\" INSERT INTO payments ( order_id, amount, status, payment_method ) VALUES (%s, %s, %s, %s) \"\"\" cursor.execute(payment_sql, ( order_id, order_data['total_amount'], 'pending', order_data['payment_method'] )) # 提交事务 self.tidb.conn.commit() return order_id except Exception as e: # 回滚事务 self.tidb.conn.rollback() raise e 3.2 分布式缓存 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 213 214 215 # ========== Redis集群 ========== import redis from rediscluster import RedisCluster class RedisClusterClient: \"\"\"Redis集群客户端\"\"\" def __init__(self, startup_nodes: List[dict]): \"\"\" startup_nodes: [ {'host': 'redis1.example.com', 'port': 7000}, {'host': 'redis2.example.com', 'port': 7001}, {'host': 'redis3.example.com', 'port': 7002} ] \"\"\" self.client = RedisCluster( startup_nodes=startup_nodes, decode_responses=True, skip_full_coverage_check=True, max_connections=32 ) def set(self, key: str, value: str, expire: int = None): \"\"\"设置键值\"\"\" return self.client.set(key, value, ex=expire) def get(self, key: str) -\u003e str: \"\"\"获取值\"\"\" return self.client.get(key) def mget(self, keys: List[str]) -\u003e List[str]: \"\"\"批量获取\"\"\" return self.client.mget(keys) def delete(self, *keys: str): \"\"\"删除键\"\"\" return self.client.delete(*keys) def exists(self, *keys: str) -\u003e int: \"\"\"检查键是否存在\"\"\" return self.client.exists(*keys) def expire(self, key: str, seconds: int): \"\"\"设置过期时间\"\"\" return self.client.expire(key, seconds) def incr(self, key: str, amount: int = 1) -\u003e int: \"\"\"递增\"\"\" return self.client.incrby(key, amount) def decr(self, key: str, amount: int = 1) -\u003e int: \"\"\"递减\"\"\" return self.client.decrby(key, amount) def hset(self, name: str, key: str, value: str): \"\"\"哈希表设置\"\"\" return self.client.hset(name, key, value) def hget(self, name: str, key: str) -\u003e str: \"\"\"哈希表获取\"\"\" return self.client.hget(name, key) def hgetall(self, name: str) -\u003e dict: \"\"\"获取整个哈希表\"\"\" return self.client.hgetall(name) # ========== 缓存策略 ========== class CacheStrategy: \"\"\"缓存策略\"\"\" def __init__(self, redis_client: RedisClusterClient): self.redis = redis_client def cache_aside(self, key: str, load_func, expire: int = 3600): \"\"\"Cache-Aside模式\"\"\" # 先查缓存 value = self.redis.get(key) if value is not None: return value # 缓存未命中，加载数据 value = load_func() # 写入缓存 self.redis.set(key, value, expire) return value def invalidate(self, *keys: str): \"\"\"使缓存失效\"\"\" self.redis.delete(*keys) def warm_up(self, data: dict, expire: int = 3600): \"\"\"缓存预热\"\"\" pipe = self.redis.client.pipeline() for key, value in data.items(): pipe.set(key, value, expire) pipe.execute() def update(self, key: str, value: str, expire: int = 3600): \"\"\"更新缓存\"\"\" self.redis.set(key, value, expire) # ========== 分布式锁 ========== class DistributedLock: \"\"\"分布式锁\"\"\" def __init__(self, redis_client: RedisClusterClient): self.redis = redis_client def acquire( self, lock_name: str, acquire_timeout: int = 10, lock_timeout: int = 30 ) -\u003e bool: \"\"\"获取锁\"\"\" import time lock_key = f\"lock:{lock_name}\" lock_value = f\"{time.time()}\" end_time = time.time() + acquire_timeout while time.time() \u003c end_time: # 尝试获取锁 if self.redis.client.set( lock_key, lock_value, nx=True, ex=lock_timeout ): return True time.sleep(0.001) return False def release(self, lock_name: str): \"\"\"释放锁\"\"\" lock_key = f\"lock:{lock_name}\" # 使用Lua脚本确保只释放自己的锁 lua_script = \"\"\" if redis.call(\"get\", KEYS[1]) == ARGV[1] then return redis.call(\"del\", KEYS[1]) else return 0 end \"\"\" self.redis.client.eval( lua_script, 1, lock_key, self.redis.get(lock_key) ) # ========== 限流器 ========== class RateLimiter: \"\"\"分布式限流器\"\"\" def __init__(self, redis_client: RedisClusterClient): self.redis = redis_client def is_allowed( self, key: str, limit: int, window: int ) -\u003e bool: \"\"\" 滑动窗口限流 key: 限流键（如用户ID、IP等） limit: 时间窗口内最大请求数 window: 时间窗口（秒） \"\"\" import time now = time.time() window_start = now - window pipe = self.redis.client.pipeline() # 移除时间窗口外的记录 pipe.zremrangebyscore(key, 0, window_start) # 获取当前计数 pipe.zcard(key) # 添加当前请求 pipe.zadd(key, {str(now): now}) # 设置过期时间 pipe.expire(key, window + 1) results = pipe.execute() current_count = results[1] return current_count \u003c limit 四、数据库监控与运维 4.1 性能监控 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 # ========== 数据库监控 ========== class DatabaseMonitor: \"\"\"数据库监控\"\"\" def __init__(self, connection): self.conn = connection def get_connection_stats(self) -\u003e dict: \"\"\"获取连接统计\"\"\" with self.conn.cursor() as cursor: cursor.execute(\"\"\" SHOW STATUS LIKE 'Threads%' \"\"\") stats = cursor.fetchall() return { 'threads_connected': next( (s[1] for s in stats if s[0] == 'Threads_connected'), 0 ), 'threads_running': next( (s[1] for s in stats if s[0] == 'Threads_running'), 0 ) } def get_query_stats(self) -\u003e dict: \"\"\"获取查询统计\"\"\" with self.conn.cursor() as cursor: # 慢查询统计 cursor.execute(\"\"\" SELECT COUNT(*) as slow_query_count, AVG(query_time) as avg_query_time, MAX(query_time) as max_query_time FROM mysql.slow_log WHERE start_time \u003e DATE_SUB(NOW(), INTERVAL 1 HOUR) \"\"\") slow_stats = cursor.fetchone() # QPS/TPS统计 cursor.execute(\"\"\" SHOW STATUS LIKE 'Questions' \"\"\") questions = cursor.fetchone() cursor.execute(\"\"\" SHOW STATUS LIKE 'Uptime' \"\"\") uptime = cursor.fetchone() qps = questions[1] / uptime[1] if uptime[1] \u003e 0 else 0 return { 'slow_query_count': slow_stats[0], 'avg_query_time': float(slow_stats[1]) if slow_stats[1] else 0, 'max_query_time': float(slow_stats[2]) if slow_stats[2] else 0, 'qps': round(qps, 2) } def get_replication_lag(self) -\u003e int: \"\"\"获取主从延迟\"\"\" with self.conn.cursor() as cursor: cursor.execute(\"SHOW SLAVE STATUS\") status = cursor.fetchone() if status: return status['Seconds_Behind_Master'] return 0 def get_innodb_stats(self) -\u003e dict: \"\"\"获取InnoDB统计\"\"\" with self.conn.cursor() as cursor: cursor.execute(\"\"\" SHOW STATUS LIKE 'Innodb_%' \"\"\") stats = cursor.fetchall() return { 'row_lock_waits': next( (s[1] for s in stats if s[0] == 'Innodb_row_lock_current_waits'), 0 ), 'deadlocks': next( (s[1] for s in stats if s[0] == 'Innodb_deadlocks'), 0 ), 'buffer_pool_hit_rate': self._calculate_hit_rate(stats) } def _calculate_hit_rate(self, stats: list) -\u003e float: \"\"\"计算缓冲池命中率\"\"\" reads = next( (s[1] for s in stats if s[0] == 'Innodb_buffer_pool_reads'), 0 ) read_requests = next( (s[1] for s in stats if s[0] == 'Innodb_buffer_pool_read_requests'), 1 ) if read_requests == 0: return 100.0 hit_rate = (1 - reads / read_requests) * 100 return round(hit_rate, 2) # ========== 慢查询分析 ========== class SlowQueryAnalyzer: \"\"\"慢查询分析器\"\"\" def __init__(self, connection): self.conn = connection def get_slow_queries(self, limit: int = 100) -\u003e List[dict]: \"\"\"获取慢查询\"\"\" with self.conn.cursor() as cursor: sql = \"\"\" SELECT query_time, lock_time, rows_sent, rows_examined, sql_text FROM mysql.slow_log ORDER BY query_time DESC LIMIT %s \"\"\" cursor.execute(sql, (limit,)) return cursor.fetchall() def analyze_slow_query(self, query: str) -\u003e dict: \"\"\"分析慢查询\"\"\" analyzer = SQLQueryOptimizer() return analyzer.optimize(query) def suggest_indexes(self, query: str) -\u003e List[str]: \"\"\"推荐索引\"\"\" # 提取WHERE、JOIN、ORDER BY子句中的字段 # 这里简化处理 import re # 提取表名 tables = re.findall(r'FROM\\s+(\\w+)', query, re.IGNORECASE) tables += re.findall(r'JOIN\\s+(\\w+)', query, re.IGNORECASE) # 提取WHERE条件字段 where_fields = re.findall( r'WHERE\\s+(\\w+)\\.\\w+\\s*=', query, re.IGNORECASE ) suggestions = [] for table in set(tables): for field in set(where_fields): suggestions.append( f\"CREATE INDEX idx_{table}_{field} ON {table}({field})\" ) return suggestions 4.2 备份与恢复 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 # ========== 数据库备份 ========== import subprocess import os from datetime import datetime from typing import List class DatabaseBackup: \"\"\"数据库备份\"\"\" def __init__( self, host: str, user: str, password: str, backup_dir: str = '/backup' ): self.host = host self.user = user self.password = password self.backup_dir = backup_dir os.makedirs(backup_dir, exist_ok=True) def backup_database( self, database: str, backup_type: str = 'full' ) -\u003e str: \"\"\"备份数据库\"\"\" timestamp = datetime.now().strftime('%Y%m%d_%H%M%S') backup_file = os.path.join( self.backup_dir, f\"{database}_{backup_type}_{timestamp}.sql\" ) # 使用mysqldump备份 command = [ 'mysqldump', f'--host={self.host}', f'--user={self.user}', f'--password={self.password}', '--single-transaction', '--routines', '--triggers', '--events', '--quick', database ] with open(backup_file, 'w') as f: subprocess.run( command, stdout=f, stderr=subprocess.PIPE, check=True ) # 压缩备份文件 self._compress_file(backup_file) return f\"{backup_file}.gz\" def backup_all_databases(self) -\u003e str: \"\"\"备份所有数据库\"\"\" timestamp = datetime.now().strftime('%Y%m%d_%H%M%S') backup_file = os.path.join( self.backup_dir, f\"all_databases_{timestamp}.sql\" ) command = [ 'mysqldump', f'--host={self.host}', f'--user={self.user}', f'--password={self.password}', '--all-databases', '--single-transaction', '--routines', '--triggers', '--events' ] with open(backup_file, 'w') as f: subprocess.run( command, stdout=f, stderr=subprocess.PIPE, check=True ) self._compress_file(backup_file) return f\"{backup_file}.gz\" def _compress_file(self, filepath: str): \"\"\"压缩文件\"\"\" import gzip with open(filepath, 'rb') as f_in: with gzip.open(f\"{filepath}.gz\", 'wb') as f_out: f_out.writelines(f_in) os.remove(filepath) def restore_database(self, backup_file: str, database: str = None): \"\"\"恢复数据库\"\"\" # 解压备份文件 if backup_file.endswith('.gz'): import gzip temp_file = backup_file[:-3] with gzip.open(backup_file, 'rb') as f_in: with open(temp_file, 'wb') as f_out: f_out.writelines(f_in) backup_file = temp_file # 恢复数据库 command = [ 'mysql', f'--host={self.host}', f'--user={self.user}', f'--password={self.password}' ] if database: command.append(database) with open(backup_file, 'r') as f: subprocess.run( command, stdin=f, stderr=subprocess.PIPE, check=True ) # 清理临时文件 if backup_file.endswith('.sql'): os.remove(backup_file) def list_backups(self) -\u003e List[dict]: \"\"\"列出备份文件\"\"\" backups = [] for filename in os.listdir(self.backup_dir): if filename.endswith('.sql.gz'): filepath = os.path.join(self.backup_dir, filename) stat = os.stat(filepath) backups.append({ 'filename': filename, 'size': stat.st_size, 'created_at': datetime.fromtimestamp(stat.st_ctime) }) return sorted(backups, key=lambda x: x['created_at'], reverse=True) def cleanup_old_backups(self, keep_days: int = 7): \"\"\"清理旧备份\"\"\" from datetime import timedelta cutoff_time = datetime.now() - timedelta(days=keep_days) for filename in os.listdir(self.backup_dir): filepath = os.path.join(self.backup_dir, filename) stat = os.stat(filepath) if datetime.fromtimestamp(stat.st_ctime) \u003c cutoff_time: os.remove(filepath) print(f\"Removed old backup: {filename}\") 总结 构建高性能的数据架构需要：\n索引优化：合理设计索引，提升查询性能 查询优化：优化SQL语句，避免全表扫描 分库分表：按业务特点选择合适的分片策略 分布式存储：使用分布式数据库和缓存 监控运维：建立完善的监控和备份机制 相关工具推荐\nSQL格式化工具 - SQL美化 JSON格式化工具 - JSON数据处理 Base64编码工具 - 编码转换 ","wordCount":"4859","inLanguage":"zh-cn","datePublished":"2025-12-30T15:00:00+08:00","dateModified":"2025-12-30T15:00:00+08:00","author":{"@type":"Person","name":"有条工具团队"},"mainEntityOfPage":{"@type":"WebPage","@id":"/blog/articles/%E6%95%B0%E6%8D%AE%E5%BA%93%E4%BC%98%E5%8C%96%E4%B8%8E%E5%88%86%E5%B8%83%E5%BC%8F%E5%AD%98%E5%82%A8%E6%9E%84%E5%BB%BA%E9%AB%98%E6%80%A7%E8%83%BD%E6%95%B0%E6%8D%AE%E6%9E%B6%E6%9E%84/"},"publisher":{"@type":"Organization","name":"技术博客 - 有条工具","logo":{"@type":"ImageObject","url":"/favicon.ico"}}}</script></head><body id=top><header class=header><nav class=nav><div class=logo><a href=/blog/ accesskey=h title="技术博客 - 有条工具 (Alt + H)">技术博客 - 有条工具</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=/blog/posts/ title="所有文章列表 - 有条工具技术博客：查看所有技术文章和教程内容"><span>文章</span></a></li><li><a href=https://www.util.cn title="有条工具 - 开发者的常用工具集合：无广告 · 本地计算 · 即开即用的在线工具平台，提供JSON格式化、SQL格式化、Markdown编辑器等实用工具"><span>有条工具</span>&nbsp;
<svg fill="none" shape-rendering="geometricPrecision" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li><li><a href=/blog/categories/ title="文章分类 - 有条工具技术博客：按技术领域分类的优质文章，包括前端开发、工具使用、编程技巧等"><span>分类</span></a></li><li><a href=/blog/tags/ title="标签云 - 有条工具技术博客：通过标签快速找到感兴趣的技术文章和教程内容"><span>标签</span></a></li><li><a href=/blog/archives/ title="文章归档 - 有条工具技术博客：按时间查看历史文章"><span>归档</span></a></li><li><a href=/blog/search/ title="搜索文章 - 有条工具技术博客：通过关键词搜索找到感兴趣的技术文章和教程内容，支持标题、内容、分类和标签搜索"><span>搜索</span></a></li></ul></nav></header><main class=main><article class=post-single><div class=post-content-wrapper><main class=post-content-main><header class=post-header-main><h1 class="post-title entry-hint-parent">数据库优化与分布式存储：构建高性能数据架构</h1><div class=post-description>深入探讨数据库优化技巧和分布式存储架构，涵盖索引优化、查询优化、分库分表、分布式数据库、缓存策略等核心主题。</div><div class=post-meta><div class=post-meta-content><div class=post-categories-inline><a href=/blog/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/ class=category-link>数据库</a><a href=/blog/categories/%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F/ class=category-link>分布式系统</a></div><span class=post-date>2025-12-30</span><span class=post-author>有条工具团队</span></div><style>.post-meta-content{display:flex;align-items:center;flex-wrap:wrap;gap:.75rem;font-family:sf mono,monaco,courier new,monospace;font-size:.875rem;color:#9ca3af !important}.post-categories-inline{display:inline-flex;align-items:center;gap:.5rem}.category-link{display:inline-flex;align-items:center;gap:.25rem;padding:.25rem .75rem;background:rgba(255,255,255,.1);color:#e5e7eb !important;text-decoration:none;font-size:.75rem;font-weight:600;text-transform:uppercase;letter-spacing:.05em;border:1px solid rgba(255,255,255,.2);border-radius:0;transition:all .3s ease;white-space:nowrap}.category-link:hover{background:rgba(255,255,255,.2);color:#fff !important;border-color:rgba(255,255,255,.3);transform:translateY(-1px)}.category-link::before{content:'📁';font-size:.7rem;opacity:.8}.post-date,.post-reading-time,.post-word-count,.post-author{color:#9ca3af !important}[data-theme=dark] .post-meta-content{color:#9ca3af !important}[data-theme=dark] .category-link{background:rgba(255,255,255,.1);color:#e5e7eb !important;border-color:rgba(255,255,255,.2)}[data-theme=dark] .category-link:hover{background:rgba(255,255,255,.2);color:#fff !important;border-color:rgba(255,255,255,.3)}[data-theme=dark] .post-date,[data-theme=dark] .post-reading-time,[data-theme=dark] .post-word-count,[data-theme=dark] .post-author{color:#9ca3af !important}[data-theme=light] .post-meta-content{color:#6c757d !important}[data-theme=light] .category-link{background:rgba(0,0,0,5%);color:#495057 !important;border-color:rgba(0,0,0,.15)}[data-theme=light] .category-link:hover{background:rgba(0,102,204,.1);color:#212529 !important;border-color:rgba(0,102,204,.3)}[data-theme=light] .post-date,[data-theme=light] .post-reading-time,[data-theme=light] .post-word-count,[data-theme=light] .post-author{color:#6c757d !important}@media(max-width:768px){.post-meta-content{gap:.5rem;font-size:.8rem}.category-link{padding:.2rem .6rem;font-size:.7rem}}</style></div></header><div class=post-content><h2 id=引言>引言<a hidden class=anchor aria-hidden=true href=#引言>#</a></h2><p>数据是现代应用的核心资产。随着数据量的爆炸式增长，数据库性能和可扩展性成为系统设计的关键挑战。本文将深入探讨数据库优化技巧和分布式存储架构，帮助读者构建高性能的数据架构。</p><h2 id=一数据库性能优化>一、数据库性能优化<a hidden class=anchor aria-hidden=true href=#一数据库性能优化>#</a></h2><h3 id=11-索引优化策略>1.1 索引优化策略<a hidden class=anchor aria-hidden=true href=#11-索引优化策略>#</a></h3><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">78
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">79
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">80
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">81
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">82
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">83
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">84
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">85
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">86
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#8b949e;font-style:italic>-- ========== 索引基础 ==========
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#8b949e;font-style:italic>-- 1. B-Tree索引（最常用）
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>-- 适合：等值查询、范围查询、排序
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>CREATE</span><span style=color:#6e7681> </span><span style=color:#ff7b72>INDEX</span><span style=color:#6e7681> </span>idx_user_email<span style=color:#6e7681> </span><span style=color:#ff7b72>ON</span><span style=color:#6e7681> </span>users(email);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>CREATE</span><span style=color:#6e7681> </span><span style=color:#ff7b72>INDEX</span><span style=color:#6e7681> </span>idx_order_created<span style=color:#6e7681> </span><span style=color:#ff7b72>ON</span><span style=color:#6e7681> </span>orders(created_at);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#8b949e;font-style:italic>-- 2. 复合索引
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>-- 注意：最左前缀原则
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>CREATE</span><span style=color:#6e7681> </span><span style=color:#ff7b72>INDEX</span><span style=color:#6e7681> </span>idx_user_status_created<span style=color:#6e7681> </span><span style=color:#ff7b72>ON</span><span style=color:#6e7681> </span>users(status,<span style=color:#6e7681> </span>created_at);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#8b949e;font-style:italic>-- 有效的查询（能使用索引）
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>SELECT</span><span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>*</span><span style=color:#6e7681> </span><span style=color:#ff7b72>FROM</span><span style=color:#6e7681> </span>users<span style=color:#6e7681> </span><span style=color:#ff7b72>WHERE</span><span style=color:#6e7681> </span>status<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span><span style=color:#a5d6ff>1</span><span style=color:#6e7681> </span><span style=color:#ff7b72>AND</span><span style=color:#6e7681> </span>created_at<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>&gt;</span><span style=color:#6e7681> </span><span style=color:#a5d6ff>&#39;2024-01-01&#39;</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>SELECT</span><span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>*</span><span style=color:#6e7681> </span><span style=color:#ff7b72>FROM</span><span style=color:#6e7681> </span>users<span style=color:#6e7681> </span><span style=color:#ff7b72>WHERE</span><span style=color:#6e7681> </span>status<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span><span style=color:#a5d6ff>1</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#8b949e;font-style:italic>-- 无效的查询（不能使用索引）
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>SELECT</span><span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>*</span><span style=color:#6e7681> </span><span style=color:#ff7b72>FROM</span><span style=color:#6e7681> </span>users<span style=color:#6e7681> </span><span style=color:#ff7b72>WHERE</span><span style=color:#6e7681> </span>created_at<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>&gt;</span><span style=color:#6e7681> </span><span style=color:#a5d6ff>&#39;2024-01-01&#39;</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#8b949e;font-style:italic>-- 3. 覆盖索引
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>-- 包含查询所需的所有字段，避免回表
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>CREATE</span><span style=color:#6e7681> </span><span style=color:#ff7b72>INDEX</span><span style=color:#6e7681> </span>idx_user_cover<span style=color:#6e7681> </span><span style=color:#ff7b72>ON</span><span style=color:#6e7681> </span>users(status,<span style=color:#6e7681> </span>created_at,<span style=color:#6e7681> </span>id,<span style=color:#6e7681> </span>name);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#8b949e;font-style:italic>-- 4. 唯一索引
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>CREATE</span><span style=color:#6e7681> </span><span style=color:#ff7b72>UNIQUE</span><span style=color:#6e7681> </span><span style=color:#ff7b72>INDEX</span><span style=color:#6e7681> </span>idx_user_username<span style=color:#6e7681> </span><span style=color:#ff7b72>ON</span><span style=color:#6e7681> </span>users(username);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#8b949e;font-style:italic>-- ========== 索引设计原则 ==========
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#8b949e;font-style:italic>/*
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>1. 选择性高的字段适合建索引
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>   - 高选择性：唯一值多（如用户ID、邮箱）
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>   - 低选择性：重复值多（如性别、状态）
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>2. WHERE、JOIN、ORDER BY子句的字段
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>3. 小字段优先
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>   - 整数 &gt; 日期 &gt; 短字符串 &gt; 长字符串
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>4. 联合索引的顺序
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>   - 最常查询的字段放前面
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>   - 范围查询字段放后面
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>5. 避免过多索引
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>   - 降低写入性能
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>   - 占用存储空间
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>*/</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#8b949e;font-style:italic>-- ========== 索引优化案例 ==========
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#8b949e;font-style:italic>-- 问题：查询慢
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>-- 耗时：2.5秒
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>SELECT</span><span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>*</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>FROM</span><span style=color:#6e7681> </span>orders<span style=color:#6e7681> </span>o<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>LEFT</span><span style=color:#6e7681> </span><span style=color:#ff7b72>JOIN</span><span style=color:#6e7681> </span>users<span style=color:#6e7681> </span>u<span style=color:#6e7681> </span><span style=color:#ff7b72>ON</span><span style=color:#6e7681> </span>o.user_id<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span>u.id<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>WHERE</span><span style=color:#6e7681> </span>o.status<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span><span style=color:#a5d6ff>&#39;pending&#39;</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#ff7b72>AND</span><span style=color:#6e7681> </span>o.created_at<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>&gt;</span><span style=color:#6e7681> </span><span style=color:#a5d6ff>&#39;2024-01-01&#39;</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>ORDER</span><span style=color:#6e7681> </span><span style=color:#ff7b72>BY</span><span style=color:#6e7681> </span>o.created_at<span style=color:#6e7681> </span><span style=color:#ff7b72>DESC</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>LIMIT</span><span style=color:#6e7681> </span><span style=color:#a5d6ff>20</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#8b949e;font-style:italic>-- 优化1：添加合适索引
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>CREATE</span><span style=color:#6e7681> </span><span style=color:#ff7b72>INDEX</span><span style=color:#6e7681> </span>idx_orders_status_created<span style=color:#6e7681> </span><span style=color:#ff7b72>ON</span><span style=color:#6e7681> </span>orders(status,<span style=color:#6e7681> </span>created_at<span style=color:#6e7681> </span><span style=color:#ff7b72>DESC</span>);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>CREATE</span><span style=color:#6e7681> </span><span style=color:#ff7b72>INDEX</span><span style=color:#6e7681> </span>idx_orders_user_id<span style=color:#6e7681> </span><span style=color:#ff7b72>ON</span><span style=color:#6e7681> </span>orders(user_id);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#8b949e;font-style:italic>-- 耗时：0.3秒
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#8b949e;font-style:italic>-- 优化2：只查询需要的字段
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>SELECT</span><span style=color:#6e7681> </span>o.id,<span style=color:#6e7681> </span>o.order_no,<span style=color:#6e7681> </span>o.total_amount,<span style=color:#6e7681> </span>u.username<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>FROM</span><span style=color:#6e7681> </span>orders<span style=color:#6e7681> </span>o<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>LEFT</span><span style=color:#6e7681> </span><span style=color:#ff7b72>JOIN</span><span style=color:#6e7681> </span>users<span style=color:#6e7681> </span>u<span style=color:#6e7681> </span><span style=color:#ff7b72>ON</span><span style=color:#6e7681> </span>o.user_id<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span>u.id<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>WHERE</span><span style=color:#6e7681> </span>o.status<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span><span style=color:#a5d6ff>&#39;pending&#39;</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#ff7b72>AND</span><span style=color:#6e7681> </span>o.created_at<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>&gt;</span><span style=color:#6e7681> </span><span style=color:#a5d6ff>&#39;2024-01-01&#39;</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>ORDER</span><span style=color:#6e7681> </span><span style=color:#ff7b72>BY</span><span style=color:#6e7681> </span>o.created_at<span style=color:#6e7681> </span><span style=color:#ff7b72>DESC</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>LIMIT</span><span style=color:#6e7681> </span><span style=color:#a5d6ff>20</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#8b949e;font-style:italic>-- 耗时：0.1秒
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#8b949e;font-style:italic>-- 优化3：使用覆盖索引
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>CREATE</span><span style=color:#6e7681> </span><span style=color:#ff7b72>INDEX</span><span style=color:#6e7681> </span>idx_orders_cover<span style=color:#6e7681> </span><span style=color:#ff7b72>ON</span><span style=color:#6e7681> </span>orders(<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>status,<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>created_at<span style=color:#6e7681> </span><span style=color:#ff7b72>DESC</span>,<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>id,<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>order_no,<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>total_amount,<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>user_id<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span>);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#8b949e;font-style:italic>-- 耗时：0.05秒
</span></span></span></code></pre></td></tr></table></div></div><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 78
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 79
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 80
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 81
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 82
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 83
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 84
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 85
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 86
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 87
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 88
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 89
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 90
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 91
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 92
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 93
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 94
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 95
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 96
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 97
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 98
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 99
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">100
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">101
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">102
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">103
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">104
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">105
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">106
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">107
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">108
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">109
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">110
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">111
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">112
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">113
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">114
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">115
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">116
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">117
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">118
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">119
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">120
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">121
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">122
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">123
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">124
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">125
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">126
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">127
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">128
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#8b949e;font-style:italic># ========== 索引分析与维护 ==========</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>import</span> <span style=color:#ff7b72>pymysql</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>from</span> <span style=color:#ff7b72>typing</span> <span style=color:#ff7b72>import</span> List, Dict, Tuple
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>class</span> <span style=color:#f0883e;font-weight:700>IndexAnalyzer</span>:
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#34;&#34;&#34;索引分析器&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>__init__</span>(self, connection_config: dict):
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>conn <span style=color:#ff7b72;font-weight:700>=</span> pymysql<span style=color:#ff7b72;font-weight:700>.</span>connect(<span style=color:#ff7b72;font-weight:700>**</span>connection_config)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>analyze_table_indexes</span>(self, table_name: str) <span style=color:#ff7b72;font-weight:700>-&gt;</span> List[Dict]:
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;分析表的索引使用情况&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>with</span> self<span style=color:#ff7b72;font-weight:700>.</span>conn<span style=color:#ff7b72;font-weight:700>.</span>cursor() <span style=color:#ff7b72>as</span> cursor:
</span></span><span style=display:flex><span>            <span style=color:#8b949e;font-style:italic># 查询索引信息</span>
</span></span><span style=display:flex><span>            sql <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                SHOW INDEX FROM </span><span style=color:#a5d6ff>%s</span><span style=color:#a5d6ff>
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>            &#34;&#34;&#34;</span> <span style=color:#ff7b72;font-weight:700>%</span> table_name
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            cursor<span style=color:#ff7b72;font-weight:700>.</span>execute(sql)
</span></span><span style=display:flex><span>            indexes <span style=color:#ff7b72;font-weight:700>=</span> cursor<span style=color:#ff7b72;font-weight:700>.</span>fetchall()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#8b949e;font-style:italic># 查询索引使用统计</span>
</span></span><span style=display:flex><span>            sql <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                SELECT
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                    table_name,
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                    index_name,
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                    cardinality,
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                    column_name,
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                    seq_in_index
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                FROM information_schema.statistics
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                WHERE table_schema = DATABASE()
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                  AND table_name = </span><span style=color:#a5d6ff>%s</span><span style=color:#a5d6ff>
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                ORDER BY index_name, seq_in_index
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>            &#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            cursor<span style=color:#ff7b72;font-weight:700>.</span>execute(sql, (table_name,))
</span></span><span style=display:flex><span>            stats <span style=color:#ff7b72;font-weight:700>=</span> cursor<span style=color:#ff7b72;font-weight:700>.</span>fetchall()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>return</span> {
</span></span><span style=display:flex><span>                <span style=color:#a5d6ff>&#39;indexes&#39;</span>: indexes,
</span></span><span style=display:flex><span>                <span style=color:#a5d6ff>&#39;statistics&#39;</span>: stats
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>find_unused_indexes</span>(self) <span style=color:#ff7b72;font-weight:700>-&gt;</span> List[Dict]:
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;查找未使用的索引&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>with</span> self<span style=color:#ff7b72;font-weight:700>.</span>conn<span style=color:#ff7b72;font-weight:700>.</span>cursor() <span style=color:#ff7b72>as</span> cursor:
</span></span><span style=display:flex><span>            <span style=color:#8b949e;font-style:italic># MySQL 5.7+ 使用performance_schema</span>
</span></span><span style=display:flex><span>            sql <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                SELECT
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                    object_schema AS table_schema,
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                    object_name AS table_name,
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                    index_name
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                FROM performance_schema.table_io_waits_summary_by_index_usage
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                WHERE index_name IS NOT NULL
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                  AND count_star = 0
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                  AND index_name != &#39;PRIMARY&#39;
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                ORDER BY object_schema, object_name
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>            &#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            cursor<span style=color:#ff7b72;font-weight:700>.</span>execute(sql)
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>return</span> cursor<span style=color:#ff7b72;font-weight:700>.</span>fetchall()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>find_duplicate_indexes</span>(self, table_name: str) <span style=color:#ff7b72;font-weight:700>-&gt;</span> List[Tuple]:
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;查找冗余索引&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>with</span> self<span style=color:#ff7b72;font-weight:700>.</span>conn<span style=color:#ff7b72;font-weight:700>.</span>cursor() <span style=color:#ff7b72>as</span> cursor:
</span></span><span style=display:flex><span>            <span style=color:#8b949e;font-style:italic># 查询索引及其列</span>
</span></span><span style=display:flex><span>            sql <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                SELECT
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                    index_name,
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                    GROUP_CONCAT(column_name ORDER BY seq_in_index) as columns
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                FROM information_schema.statistics
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                WHERE table_schema = DATABASE()
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                  AND table_name = </span><span style=color:#a5d6ff>%s</span><span style=color:#a5d6ff>
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                GROUP BY index_name
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                HAVING COUNT(*) &gt; 1
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>            &#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            cursor<span style=color:#ff7b72;font-weight:700>.</span>execute(sql, (table_name,))
</span></span><span style=display:flex><span>            indexes <span style=color:#ff7b72;font-weight:700>=</span> cursor<span style=color:#ff7b72;font-weight:700>.</span>fetchall()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#8b949e;font-style:italic># 查找冗余索引</span>
</span></span><span style=display:flex><span>            duplicates <span style=color:#ff7b72;font-weight:700>=</span> []
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>for</span> i, idx1 <span style=color:#ff7b72;font-weight:700>in</span> enumerate(indexes):
</span></span><span style=display:flex><span>                <span style=color:#ff7b72>for</span> idx2 <span style=color:#ff7b72;font-weight:700>in</span> indexes[i<span style=color:#ff7b72;font-weight:700>+</span><span style=color:#a5d6ff>1</span>:]:
</span></span><span style=display:flex><span>                    <span style=color:#8b949e;font-style:italic># 检查是否包含关系</span>
</span></span><span style=display:flex><span>                    <span style=color:#ff7b72>if</span> idx2[<span style=color:#a5d6ff>1</span>]<span style=color:#ff7b72;font-weight:700>.</span>startswith(idx1[<span style=color:#a5d6ff>1</span>]):
</span></span><span style=display:flex><span>                        duplicates<span style=color:#ff7b72;font-weight:700>.</span>append((idx1[<span style=color:#a5d6ff>0</span>], idx2[<span style=color:#a5d6ff>0</span>]))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>return</span> duplicates
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>suggest_indexes</span>(self, table_name: str) <span style=color:#ff7b72;font-weight:700>-&gt;</span> List[Dict]:
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;推荐索引&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>with</span> self<span style=color:#ff7b72;font-weight:700>.</span>conn<span style=color:#ff7b72;font-weight:700>.</span>cursor() <span style=color:#ff7b72>as</span> cursor:
</span></span><span style=display:flex><span>            <span style=color:#8b949e;font-style:italic># 分析慢查询日志</span>
</span></span><span style=display:flex><span>            sql <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                SELECT
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                    sql_text,
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                    count(*) as frequency
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                FROM mysql.slow_log
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                WHERE sql_text LIKE </span><span style=color:#a5d6ff>%s</span><span style=color:#a5d6ff>
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                GROUP BY sql_text
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                ORDER BY frequency DESC
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                LIMIT 10
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>            &#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            cursor<span style=color:#ff7b72;font-weight:700>.</span>execute(sql, (<span style=color:#79c0ff>f</span><span style=color:#a5d6ff>&#39;%</span><span style=color:#a5d6ff>{</span>table_name<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>%&#39;</span>,))
</span></span><span style=display:flex><span>            slow_queries <span style=color:#ff7b72;font-weight:700>=</span> cursor<span style=color:#ff7b72;font-weight:700>.</span>fetchall()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            suggestions <span style=color:#ff7b72;font-weight:700>=</span> []
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>for</span> query, freq <span style=color:#ff7b72;font-weight:700>in</span> slow_queries:
</span></span><span style=display:flex><span>                <span style=color:#8b949e;font-style:italic># 提取WHERE条件字段</span>
</span></span><span style=display:flex><span>                <span style=color:#8b949e;font-style:italic># 这里简化处理，实际需要解析SQL</span>
</span></span><span style=display:flex><span>                <span style=color:#8b949e;font-style:italic># ...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                suggestions<span style=color:#ff7b72;font-weight:700>.</span>append({
</span></span><span style=display:flex><span>                    <span style=color:#a5d6ff>&#39;query&#39;</span>: query,
</span></span><span style=display:flex><span>                    <span style=color:#a5d6ff>&#39;frequency&#39;</span>: freq,
</span></span><span style=display:flex><span>                    <span style=color:#a5d6ff>&#39;suggested_index&#39;</span>: <span style=color:#a5d6ff>&#39;建议基于WHERE子句创建索引&#39;</span>
</span></span><span style=display:flex><span>                })
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>return</span> suggestions
</span></span></code></pre></td></tr></table></div></div><h3 id=12-查询优化>1.2 查询优化<a hidden class=anchor aria-hidden=true href=#12-查询优化>#</a></h3><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">71
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#8b949e;font-style:italic>-- ========== SQL查询优化 ==========
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#8b949e;font-style:italic>-- 1. 避免SELECT *
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>-- 不推荐
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>SELECT</span><span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>*</span><span style=color:#6e7681> </span><span style=color:#ff7b72>FROM</span><span style=color:#6e7681> </span>users<span style=color:#6e7681> </span><span style=color:#ff7b72>WHERE</span><span style=color:#6e7681> </span>id<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span><span style=color:#a5d6ff>1</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#8b949e;font-style:italic>-- 推荐
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>SELECT</span><span style=color:#6e7681> </span>id,<span style=color:#6e7681> </span>username,<span style=color:#6e7681> </span>email<span style=color:#6e7681> </span><span style=color:#ff7b72>FROM</span><span style=color:#6e7681> </span>users<span style=color:#6e7681> </span><span style=color:#ff7b72>WHERE</span><span style=color:#6e7681> </span>id<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span><span style=color:#a5d6ff>1</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#8b949e;font-style:italic>-- 2. 使用LIMIT限制结果集
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>SELECT</span><span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>*</span><span style=color:#6e7681> </span><span style=color:#ff7b72>FROM</span><span style=color:#6e7681> </span>orders<span style=color:#6e7681> </span><span style=color:#ff7b72>WHERE</span><span style=color:#6e7681> </span>status<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span><span style=color:#a5d6ff>&#39;pending&#39;</span><span style=color:#6e7681> </span><span style=color:#ff7b72>LIMIT</span><span style=color:#6e7681> </span><span style=color:#a5d6ff>100</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#8b949e;font-style:italic>-- 3. 优化JOIN
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>-- 小表驱动大表
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>SELECT</span><span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>*</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>FROM</span><span style=color:#6e7681> </span>small_table<span style=color:#6e7681> </span>s<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>JOIN</span><span style=color:#6e7681> </span>large_table<span style=color:#6e7681> </span>l<span style=color:#6e7681> </span><span style=color:#ff7b72>ON</span><span style=color:#6e7681> </span>s.id<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span>l.small_id;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#8b949e;font-style:italic>-- 4. 子查询优化
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>-- 不推荐
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>SELECT</span><span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>*</span><span style=color:#6e7681> </span><span style=color:#ff7b72>FROM</span><span style=color:#6e7681> </span>users<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>WHERE</span><span style=color:#6e7681> </span>id<span style=color:#6e7681> </span><span style=color:#ff7b72>IN</span><span style=color:#6e7681> </span>(<span style=color:#ff7b72>SELECT</span><span style=color:#6e7681> </span>user_id<span style=color:#6e7681> </span><span style=color:#ff7b72>FROM</span><span style=color:#6e7681> </span>orders<span style=color:#6e7681> </span><span style=color:#ff7b72>WHERE</span><span style=color:#6e7681> </span>amount<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>&gt;</span><span style=color:#6e7681> </span><span style=color:#a5d6ff>1000</span>);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#8b949e;font-style:italic>-- 推荐
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>SELECT</span><span style=color:#6e7681> </span><span style=color:#ff7b72>DISTINCT</span><span style=color:#6e7681> </span>u.<span style=color:#ff7b72;font-weight:700>*</span><span style=color:#6e7681> </span><span style=color:#ff7b72>FROM</span><span style=color:#6e7681> </span>users<span style=color:#6e7681> </span>u<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>INNER</span><span style=color:#6e7681> </span><span style=color:#ff7b72>JOIN</span><span style=color:#6e7681> </span>orders<span style=color:#6e7681> </span>o<span style=color:#6e7681> </span><span style=color:#ff7b72>ON</span><span style=color:#6e7681> </span>u.id<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span>o.user_id<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>WHERE</span><span style=color:#6e7681> </span>o.amount<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>&gt;</span><span style=color:#6e7681> </span><span style=color:#a5d6ff>1000</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#8b949e;font-style:italic>-- 5. EXISTS vs IN
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>-- 小表用IN，大表用EXISTS
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>-- 小表
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>SELECT</span><span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>*</span><span style=color:#6e7681> </span><span style=color:#ff7b72>FROM</span><span style=color:#6e7681> </span>users<span style=color:#6e7681> </span><span style=color:#ff7b72>WHERE</span><span style=color:#6e7681> </span>id<span style=color:#6e7681> </span><span style=color:#ff7b72>IN</span><span style=color:#6e7681> </span>(<span style=color:#a5d6ff>1</span>,<span style=color:#6e7681> </span><span style=color:#a5d6ff>2</span>,<span style=color:#6e7681> </span><span style=color:#a5d6ff>3</span>);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#8b949e;font-style:italic>-- 大表
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>SELECT</span><span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>*</span><span style=color:#6e7681> </span><span style=color:#ff7b72>FROM</span><span style=color:#6e7681> </span>users<span style=color:#6e7681> </span>u<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>WHERE</span><span style=color:#6e7681> </span><span style=color:#ff7b72>EXISTS</span><span style=color:#6e7681> </span>(<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#ff7b72>SELECT</span><span style=color:#6e7681> </span><span style=color:#a5d6ff>1</span><span style=color:#6e7681> </span><span style=color:#ff7b72>FROM</span><span style=color:#6e7681> </span>orders<span style=color:#6e7681> </span>o<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#ff7b72>WHERE</span><span style=color:#6e7681> </span>o.user_id<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span>u.id<span style=color:#6e7681> </span><span style=color:#ff7b72>AND</span><span style=color:#6e7681> </span>o.status<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span><span style=color:#a5d6ff>&#39;pending&#39;</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span>);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#8b949e;font-style:italic>-- 6. 避免在WHERE子句中使用函数
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>-- 不推荐
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>SELECT</span><span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>*</span><span style=color:#6e7681> </span><span style=color:#ff7b72>FROM</span><span style=color:#6e7681> </span>orders<span style=color:#6e7681> </span><span style=color:#ff7b72>WHERE</span><span style=color:#6e7681> </span>DATE(created_at)<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span><span style=color:#a5d6ff>&#39;2024-01-01&#39;</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#8b949e;font-style:italic>-- 推荐
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>SELECT</span><span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>*</span><span style=color:#6e7681> </span><span style=color:#ff7b72>FROM</span><span style=color:#6e7681> </span>orders<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>WHERE</span><span style=color:#6e7681> </span>created_at<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>&gt;=</span><span style=color:#6e7681> </span><span style=color:#a5d6ff>&#39;2024-01-01&#39;</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#ff7b72>AND</span><span style=color:#6e7681> </span>created_at<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>&lt;</span><span style=color:#6e7681> </span><span style=color:#a5d6ff>&#39;2024-01-02&#39;</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#8b949e;font-style:italic>-- 7. 使用UNION ALL代替UNION
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>-- 不推荐（去重开销大）
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>SELECT</span><span style=color:#6e7681> </span>user_id<span style=color:#6e7681> </span><span style=color:#ff7b72>FROM</span><span style=color:#6e7681> </span>orders_2024<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>UNION</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>SELECT</span><span style=color:#6e7681> </span>user_id<span style=color:#6e7681> </span><span style=color:#ff7b72>FROM</span><span style=color:#6e7681> </span>orders_2023;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#8b949e;font-style:italic>-- 推荐
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>SELECT</span><span style=color:#6e7681> </span>user_id<span style=color:#6e7681> </span><span style=color:#ff7b72>FROM</span><span style=color:#6e7681> </span>orders_2024<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>UNION</span><span style=color:#6e7681> </span><span style=color:#ff7b72>ALL</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>SELECT</span><span style=color:#6e7681> </span>user_id<span style=color:#6e7681> </span><span style=color:#ff7b72>FROM</span><span style=color:#6e7681> </span>orders_2023;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#8b949e;font-style:italic>-- 8. 批量操作
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>-- 不推荐（多次单条插入）
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>INSERT</span><span style=color:#6e7681> </span><span style=color:#ff7b72>INTO</span><span style=color:#6e7681> </span>logs<span style=color:#6e7681> </span>(message)<span style=color:#6e7681> </span><span style=color:#ff7b72>VALUES</span><span style=color:#6e7681> </span>(<span style=color:#a5d6ff>&#39;log1&#39;</span>);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>INSERT</span><span style=color:#6e7681> </span><span style=color:#ff7b72>INTO</span><span style=color:#6e7681> </span>logs<span style=color:#6e7681> </span>(message)<span style=color:#6e7681> </span><span style=color:#ff7b72>VALUES</span><span style=color:#6e7681> </span>(<span style=color:#a5d6ff>&#39;log2&#39;</span>);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>INSERT</span><span style=color:#6e7681> </span><span style=color:#ff7b72>INTO</span><span style=color:#6e7681> </span>logs<span style=color:#6e7681> </span>(message)<span style=color:#6e7681> </span><span style=color:#ff7b72>VALUES</span><span style=color:#6e7681> </span>(<span style=color:#a5d6ff>&#39;log3&#39;</span>);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#8b949e;font-style:italic>-- 推荐
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>INSERT</span><span style=color:#6e7681> </span><span style=color:#ff7b72>INTO</span><span style=color:#6e7681> </span>logs<span style=color:#6e7681> </span>(message)<span style=color:#6e7681> </span><span style=color:#ff7b72>VALUES</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>(<span style=color:#a5d6ff>&#39;log1&#39;</span>),<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>(<span style=color:#a5d6ff>&#39;log2&#39;</span>),<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>(<span style=color:#a5d6ff>&#39;log3&#39;</span>);<span style=color:#6e7681>
</span></span></span></code></pre></td></tr></table></div></div><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 78
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 79
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 80
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 81
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 82
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 83
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 84
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 85
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 86
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 87
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 88
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 89
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 90
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 91
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 92
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 93
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 94
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 95
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 96
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 97
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 98
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 99
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">100
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">101
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">102
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">103
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">104
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">105
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">106
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">107
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">108
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">109
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">110
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">111
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">112
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">113
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">114
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">115
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">116
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">117
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">118
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">119
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">120
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">121
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">122
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">123
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">124
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">125
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">126
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">127
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">128
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">129
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">130
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">131
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">132
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">133
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">134
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">135
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">136
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">137
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">138
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">139
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">140
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">141
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">142
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">143
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">144
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">145
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">146
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">147
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">148
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">149
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">150
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">151
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">152
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">153
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">154
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">155
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">156
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">157
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">158
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">159
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">160
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">161
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">162
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#8b949e;font-style:italic># ========== 查询优化器 ==========</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>import</span> <span style=color:#ff7b72>re</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>from</span> <span style=color:#ff7b72>typing</span> <span style=color:#ff7b72>import</span> List, Dict, Tuple
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>class</span> <span style=color:#f0883e;font-weight:700>SQLQueryOptimizer</span>:
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#34;&#34;&#34;SQL查询优化器&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>__init__</span>(self):
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>rules <span style=color:#ff7b72;font-weight:700>=</span> {
</span></span><span style=display:flex><span>            <span style=color:#a5d6ff>&#39;select_star&#39;</span>: self<span style=color:#ff7b72;font-weight:700>.</span>_check_select_star,
</span></span><span style=display:flex><span>            <span style=color:#a5d6ff>&#39;missing_where&#39;</span>: self<span style=color:#ff7b72;font-weight:700>.</span>_check_missing_where,
</span></span><span style=display:flex><span>            <span style=color:#a5d6ff>&#39;function_in_where&#39;</span>: self<span style=color:#ff7b72;font-weight:700>.</span>_check_function_in_where,
</span></span><span style=display:flex><span>            <span style=color:#a5d6ff>&#39;subquery&#39;</span>: self<span style=color:#ff7b72;font-weight:700>.</span>_check_subquery,
</span></span><span style=display:flex><span>            <span style=color:#a5d6ff>&#39;nplus1&#39;</span>: self<span style=color:#ff7b72;font-weight:700>.</span>_check_nplus1
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>optimize</span>(self, sql: str) <span style=color:#ff7b72;font-weight:700>-&gt;</span> Dict:
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;优化SQL&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        issues <span style=color:#ff7b72;font-weight:700>=</span> []
</span></span><span style=display:flex><span>        suggestions <span style=color:#ff7b72;font-weight:700>=</span> []
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>for</span> rule_name, rule_func <span style=color:#ff7b72;font-weight:700>in</span> self<span style=color:#ff7b72;font-weight:700>.</span>rules<span style=color:#ff7b72;font-weight:700>.</span>items():
</span></span><span style=display:flex><span>            result <span style=color:#ff7b72;font-weight:700>=</span> rule_func(sql)
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>if</span> result:
</span></span><span style=display:flex><span>                issues<span style=color:#ff7b72;font-weight:700>.</span>append(result[<span style=color:#a5d6ff>&#39;issue&#39;</span>])
</span></span><span style=display:flex><span>                suggestions<span style=color:#ff7b72;font-weight:700>.</span>append(result[<span style=color:#a5d6ff>&#39;suggestion&#39;</span>])
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> {
</span></span><span style=display:flex><span>            <span style=color:#a5d6ff>&#39;original_sql&#39;</span>: sql,
</span></span><span style=display:flex><span>            <span style=color:#a5d6ff>&#39;issues&#39;</span>: issues,
</span></span><span style=display:flex><span>            <span style=color:#a5d6ff>&#39;suggestions&#39;</span>: suggestions
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>_check_select_star</span>(self, sql: str) <span style=color:#ff7b72;font-weight:700>-&gt;</span> Dict:
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;检查SELECT ***&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>if</span> re<span style=color:#ff7b72;font-weight:700>.</span>search(<span style=color:#79c0ff>r</span><span style=color:#a5d6ff>&#39;SELECT\s+\*\s+FROM&#39;</span>, sql, re<span style=color:#ff7b72;font-weight:700>.</span>IGNORECASE):
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>return</span> {
</span></span><span style=display:flex><span>                <span style=color:#a5d6ff>&#39;issue&#39;</span>: <span style=color:#a5d6ff>&#39;使用SELECT *&#39;</span>,
</span></span><span style=display:flex><span>                <span style=color:#a5d6ff>&#39;suggestion&#39;</span>: <span style=color:#a5d6ff>&#39;只查询需要的列，减少数据传输&#39;</span>
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> <span style=color:#79c0ff>None</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>_check_missing_where</span>(self, sql: str) <span style=color:#ff7b72;font-weight:700>-&gt;</span> Dict:
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;检查缺少WHERE条件&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>if</span> re<span style=color:#ff7b72;font-weight:700>.</span>search(<span style=color:#79c0ff>r</span><span style=color:#a5d6ff>&#39;(DELETE|UPDATE)\s+\w+\s+(?!WHERE)&#39;</span>, sql, re<span style=color:#ff7b72;font-weight:700>.</span>IGNORECASE):
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>return</span> {
</span></span><span style=display:flex><span>                <span style=color:#a5d6ff>&#39;issue&#39;</span>: <span style=color:#a5d6ff>&#39;DELETE/UPDATE缺少WHERE条件&#39;</span>,
</span></span><span style=display:flex><span>                <span style=color:#a5d6ff>&#39;suggestion&#39;</span>: <span style=color:#a5d6ff>&#39;添加WHERE条件，避免全表操作&#39;</span>
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> <span style=color:#79c0ff>None</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>_check_function_in_where</span>(self, sql: str) <span style=color:#ff7b72;font-weight:700>-&gt;</span> Dict:
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;检查WHERE子句中使用函数&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>if</span> re<span style=color:#ff7b72;font-weight:700>.</span>search(
</span></span><span style=display:flex><span>            <span style=color:#79c0ff>r</span><span style=color:#a5d6ff>&#39;WHERE\s+.*(?:DATE|YEAR|MONTH|DAY)\(&#39;</span>,
</span></span><span style=display:flex><span>            sql,
</span></span><span style=display:flex><span>            re<span style=color:#ff7b72;font-weight:700>.</span>IGNORECASE
</span></span><span style=display:flex><span>        ):
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>return</span> {
</span></span><span style=display:flex><span>                <span style=color:#a5d6ff>&#39;issue&#39;</span>: <span style=color:#a5d6ff>&#39;WHERE子句中使用函数&#39;</span>,
</span></span><span style=display:flex><span>                <span style=color:#a5d6ff>&#39;suggestion&#39;</span>: <span style=color:#a5d6ff>&#39;将函数作用到比较值上，而非字段&#39;</span>
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> <span style=color:#79c0ff>None</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>_check_subquery</span>(self, sql: str) <span style=color:#ff7b72;font-weight:700>-&gt;</span> Dict:
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;检查子查询&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>if</span> <span style=color:#a5d6ff>&#39;IN (SELECT&#39;</span> <span style=color:#ff7b72;font-weight:700>in</span> sql<span style=color:#ff7b72;font-weight:700>.</span>upper():
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>return</span> {
</span></span><span style=display:flex><span>                <span style=color:#a5d6ff>&#39;issue&#39;</span>: <span style=color:#a5d6ff>&#39;使用IN子查询&#39;</span>,
</span></span><span style=display:flex><span>                <span style=color:#a5d6ff>&#39;suggestion&#39;</span>: <span style=color:#a5d6ff>&#39;考虑改用JOIN或EXISTS&#39;</span>
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> <span style=color:#79c0ff>None</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>_check_nplus1</span>(self, sql: str) <span style=color:#ff7b72;font-weight:700>-&gt;</span> Dict:
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;检查N+1查询&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic># 这里简化处理，实际需要分析执行模式</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> <span style=color:#79c0ff>None</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>class</span> <span style=color:#f0883e;font-weight:700>QueryExecutionAnalyzer</span>:
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#34;&#34;&#34;查询执行分析器&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>__init__</span>(self, connection):
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>conn <span style=color:#ff7b72;font-weight:700>=</span> connection
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>explain_query</span>(self, sql: str) <span style=color:#ff7b72;font-weight:700>-&gt;</span> Dict:
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;分析查询执行计划&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>with</span> self<span style=color:#ff7b72;font-weight:700>.</span>conn<span style=color:#ff7b72;font-weight:700>.</span>cursor() <span style=color:#ff7b72>as</span> cursor:
</span></span><span style=display:flex><span>            <span style=color:#8b949e;font-style:italic># 执行EXPLAIN</span>
</span></span><span style=display:flex><span>            explain_sql <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#79c0ff>f</span><span style=color:#a5d6ff>&#34;EXPLAIN </span><span style=color:#a5d6ff>{</span>sql<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>&#34;</span>
</span></span><span style=display:flex><span>            cursor<span style=color:#ff7b72;font-weight:700>.</span>execute(explain_sql)
</span></span><span style=display:flex><span>            result <span style=color:#ff7b72;font-weight:700>=</span> cursor<span style=color:#ff7b72;font-weight:700>.</span>fetchall()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            analysis <span style=color:#ff7b72;font-weight:700>=</span> {
</span></span><span style=display:flex><span>                <span style=color:#a5d6ff>&#39;type&#39;</span>: [],
</span></span><span style=display:flex><span>                <span style=color:#a5d6ff>&#39;table&#39;</span>: [],
</span></span><span style=display:flex><span>                <span style=color:#a5d6ff>&#39;possible_keys&#39;</span>: [],
</span></span><span style=display:flex><span>                <span style=color:#a5d6ff>&#39;key&#39;</span>: [],
</span></span><span style=display:flex><span>                <span style=color:#a5d6ff>&#39;rows&#39;</span>: [],
</span></span><span style=display:flex><span>                <span style=color:#a5d6ff>&#39;filtered&#39;</span>: [],
</span></span><span style=display:flex><span>                <span style=color:#a5d6ff>&#39;extra&#39;</span>: []
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>for</span> row <span style=color:#ff7b72;font-weight:700>in</span> result:
</span></span><span style=display:flex><span>                analysis[<span style=color:#a5d6ff>&#39;type&#39;</span>]<span style=color:#ff7b72;font-weight:700>.</span>append(row[<span style=color:#a5d6ff>&#39;type&#39;</span>])
</span></span><span style=display:flex><span>                analysis[<span style=color:#a5d6ff>&#39;table&#39;</span>]<span style=color:#ff7b72;font-weight:700>.</span>append(row[<span style=color:#a5d6ff>&#39;table&#39;</span>])
</span></span><span style=display:flex><span>                analysis[<span style=color:#a5d6ff>&#39;possible_keys&#39;</span>]<span style=color:#ff7b72;font-weight:700>.</span>append(row[<span style=color:#a5d6ff>&#39;possible_keys&#39;</span>])
</span></span><span style=display:flex><span>                analysis[<span style=color:#a5d6ff>&#39;key&#39;</span>]<span style=color:#ff7b72;font-weight:700>.</span>append(row[<span style=color:#a5d6ff>&#39;key&#39;</span>])
</span></span><span style=display:flex><span>                analysis[<span style=color:#a5d6ff>&#39;rows&#39;</span>]<span style=color:#ff7b72;font-weight:700>.</span>append(row[<span style=color:#a5d6ff>&#39;rows&#39;</span>])
</span></span><span style=display:flex><span>                analysis[<span style=color:#a5d6ff>&#39;filtered&#39;</span>]<span style=color:#ff7b72;font-weight:700>.</span>append(row[<span style=color:#a5d6ff>&#39;filtered&#39;</span>])
</span></span><span style=display:flex><span>                analysis[<span style=color:#a5d6ff>&#39;extra&#39;</span>]<span style=color:#ff7b72;font-weight:700>.</span>append(row[<span style=color:#a5d6ff>&#39;Extra&#39;</span>])
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#8b949e;font-style:italic># 分析结果</span>
</span></span><span style=display:flex><span>            suggestions <span style=color:#ff7b72;font-weight:700>=</span> []
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#8b949e;font-style:italic># 检查是否全表扫描</span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>if</span> <span style=color:#a5d6ff>&#39;ALL&#39;</span> <span style=color:#ff7b72;font-weight:700>in</span> analysis[<span style=color:#a5d6ff>&#39;type&#39;</span>]:
</span></span><span style=display:flex><span>                suggestions<span style=color:#ff7b72;font-weight:700>.</span>append(
</span></span><span style=display:flex><span>                    <span style=color:#a5d6ff>&#39;警告：存在全表扫描，考虑添加索引&#39;</span>
</span></span><span style=display:flex><span>                )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#8b949e;font-style:italic># 检查是否使用了索引</span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>if</span> <span style=color:#79c0ff>None</span> <span style=color:#ff7b72;font-weight:700>in</span> analysis[<span style=color:#a5d6ff>&#39;key&#39;</span>]:
</span></span><span style=display:flex><span>                suggestions<span style=color:#ff7b72;font-weight:700>.</span>append(
</span></span><span style=display:flex><span>                    <span style=color:#a5d6ff>&#39;部分查询没有使用索引，检查索引设计&#39;</span>
</span></span><span style=display:flex><span>                )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#8b949e;font-style:italic># 检查扫描行数</span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>if</span> analysis[<span style=color:#a5d6ff>&#39;rows&#39;</span>] <span style=color:#ff7b72;font-weight:700>and</span> sum(analysis[<span style=color:#a5d6ff>&#39;rows&#39;</span>]) <span style=color:#ff7b72;font-weight:700>&gt;</span> <span style=color:#a5d6ff>10000</span>:
</span></span><span style=display:flex><span>                suggestions<span style=color:#ff7b72;font-weight:700>.</span>append(
</span></span><span style=display:flex><span>                    <span style=color:#a5d6ff>&#39;扫描行数较多，考虑优化查询或索引&#39;</span>
</span></span><span style=display:flex><span>                )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>return</span> {
</span></span><span style=display:flex><span>                <span style=color:#a5d6ff>&#39;explain_plan&#39;</span>: result,
</span></span><span style=display:flex><span>                <span style=color:#a5d6ff>&#39;suggestions&#39;</span>: suggestions
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>profile_query</span>(self, sql: str) <span style=color:#ff7b72;font-weight:700>-&gt;</span> Dict:
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;分析查询性能&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>with</span> self<span style=color:#ff7b72;font-weight:700>.</span>conn<span style=color:#ff7b72;font-weight:700>.</span>cursor() <span style=color:#ff7b72>as</span> cursor:
</span></span><span style=display:flex><span>            <span style=color:#8b949e;font-style:italic># 开启profiling</span>
</span></span><span style=display:flex><span>            cursor<span style=color:#ff7b72;font-weight:700>.</span>execute(<span style=color:#a5d6ff>&#34;SET profiling = 1&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#8b949e;font-style:italic># 执行查询</span>
</span></span><span style=display:flex><span>            cursor<span style=color:#ff7b72;font-weight:700>.</span>execute(sql)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#8b949e;font-style:italic># 获取profiling结果</span>
</span></span><span style=display:flex><span>            cursor<span style=color:#ff7b72;font-weight:700>.</span>execute(<span style=color:#a5d6ff>&#34;SHOW PROFILE&#34;</span>)
</span></span><span style=display:flex><span>            profile <span style=color:#ff7b72;font-weight:700>=</span> cursor<span style=color:#ff7b72;font-weight:700>.</span>fetchall()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#8b949e;font-style:italic># 获取查询统计</span>
</span></span><span style=display:flex><span>            cursor<span style=color:#ff7b72;font-weight:700>.</span>execute(<span style=color:#a5d6ff>&#34;SHOW PROFILE FOR QUERY 1&#34;</span>)
</span></span><span style=display:flex><span>            stats <span style=color:#ff7b72;font-weight:700>=</span> cursor<span style=color:#ff7b72;font-weight:700>.</span>fetchall()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>return</span> {
</span></span><span style=display:flex><span>                <span style=color:#a5d6ff>&#39;profile&#39;</span>: profile,
</span></span><span style=display:flex><span>                <span style=color:#a5d6ff>&#39;statistics&#39;</span>: stats
</span></span><span style=display:flex><span>            }
</span></span></code></pre></td></tr></table></div></div><h2 id=二分库分表策略>二、分库分表策略<a hidden class=anchor aria-hidden=true href=#二分库分表策略>#</a></h2><h3 id=21-水平分表>2.1 水平分表<a hidden class=anchor aria-hidden=true href=#21-水平分表>#</a></h3><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 78
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 79
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 80
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 81
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 82
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 83
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 84
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 85
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 86
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 87
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 88
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 89
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 90
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 91
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 92
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 93
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 94
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 95
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 96
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 97
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 98
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 99
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">100
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">101
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">102
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">103
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">104
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">105
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">106
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">107
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">108
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">109
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">110
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">111
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">112
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">113
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">114
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">115
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">116
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">117
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">118
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">119
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">120
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">121
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">122
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">123
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">124
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">125
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">126
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">127
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">128
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">129
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">130
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">131
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">132
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">133
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">134
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">135
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">136
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">137
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">138
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">139
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">140
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">141
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">142
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">143
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">144
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">145
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">146
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">147
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">148
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">149
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">150
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">151
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">152
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">153
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">154
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">155
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">156
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">157
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">158
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">159
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">160
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">161
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">162
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">163
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">164
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">165
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">166
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">167
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">168
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">169
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">170
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">171
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">172
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">173
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">174
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">175
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">176
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">177
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">178
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">179
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">180
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">181
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">182
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">183
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">184
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">185
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">186
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">187
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">188
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">189
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">190
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">191
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">192
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">193
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">194
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">195
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">196
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">197
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">198
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">199
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">200
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">201
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">202
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">203
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">204
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">205
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">206
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">207
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">208
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">209
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">210
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">211
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">212
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">213
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">214
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">215
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">216
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">217
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">218
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">219
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">220
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">221
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">222
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">223
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">224
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">225
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">226
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">227
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">228
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">229
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">230
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">231
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">232
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">233
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#8b949e;font-style:italic># ========== 分表策略 ==========</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>class</span> <span style=color:#f0883e;font-weight:700>ShardingStrategy</span>:
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#34;&#34;&#34;分片策略&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>__init__</span>(self, shard_count: int):
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>shard_count <span style=color:#ff7b72;font-weight:700>=</span> shard_count
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>hash_sharding</span>(self, key: str) <span style=color:#ff7b72;font-weight:700>-&gt;</span> int:
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;哈希分片&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        hash_value <span style=color:#ff7b72;font-weight:700>=</span> hash(key)
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> hash_value <span style=color:#ff7b72;font-weight:700>%</span> self<span style=color:#ff7b72;font-weight:700>.</span>shard_count
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>range_sharding</span>(self, key: int) <span style=color:#ff7b72;font-weight:700>-&gt;</span> int:
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;范围分片&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic># 假设key是自增ID</span>
</span></span><span style=display:flex><span>        shard_size <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>1000000</span>  <span style=color:#8b949e;font-style:italic># 每个分片100万条</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> key <span style=color:#ff7b72;font-weight:700>//</span> shard_size
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>modulo_sharding</span>(self, key: int) <span style=color:#ff7b72;font-weight:700>-&gt;</span> int:
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;取模分片&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> key <span style=color:#ff7b72;font-weight:700>%</span> self<span style=color:#ff7b72;font-weight:700>.</span>shard_count
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>consistent_hash_sharding</span>(self, key: str) <span style=color:#ff7b72;font-weight:700>-&gt;</span> int:
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;一致性哈希分片&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>import</span> <span style=color:#ff7b72>hashlib</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        hash_value <span style=color:#ff7b72;font-weight:700>=</span> int(hashlib<span style=color:#ff7b72;font-weight:700>.</span>md5(key<span style=color:#ff7b72;font-weight:700>.</span>encode())<span style=color:#ff7b72;font-weight:700>.</span>hexdigest(), <span style=color:#a5d6ff>16</span>)
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> hash_value <span style=color:#ff7b72;font-weight:700>%</span> self<span style=color:#ff7b72;font-weight:700>.</span>shard_count
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>class</span> <span style=color:#f0883e;font-weight:700>ShardingManager</span>:
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#34;&#34;&#34;分片管理器&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>__init__</span>(self, shard_configs: List[dict]):
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>shards <span style=color:#ff7b72;font-weight:700>=</span> {}
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>for</span> config <span style=color:#ff7b72;font-weight:700>in</span> shard_configs:
</span></span><span style=display:flex><span>            shard_id <span style=color:#ff7b72;font-weight:700>=</span> config[<span style=color:#a5d6ff>&#39;id&#39;</span>]
</span></span><span style=display:flex><span>            self<span style=color:#ff7b72;font-weight:700>.</span>shards[shard_id] <span style=color:#ff7b72;font-weight:700>=</span> {
</span></span><span style=display:flex><span>                <span style=color:#a5d6ff>&#39;connection&#39;</span>: self<span style=color:#ff7b72;font-weight:700>.</span>_create_connection(config),
</span></span><span style=display:flex><span>                <span style=color:#a5d6ff>&#39;config&#39;</span>: config
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>strategy <span style=color:#ff7b72;font-weight:700>=</span> ShardingStrategy(len(shard_configs))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>_create_connection</span>(self, config: dict):
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;创建数据库连接&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>import</span> <span style=color:#ff7b72>pymysql</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> pymysql<span style=color:#ff7b72;font-weight:700>.</span>connect(
</span></span><span style=display:flex><span>            host<span style=color:#ff7b72;font-weight:700>=</span>config[<span style=color:#a5d6ff>&#39;host&#39;</span>],
</span></span><span style=display:flex><span>            port<span style=color:#ff7b72;font-weight:700>=</span>config[<span style=color:#a5d6ff>&#39;port&#39;</span>],
</span></span><span style=display:flex><span>            user<span style=color:#ff7b72;font-weight:700>=</span>config[<span style=color:#a5d6ff>&#39;user&#39;</span>],
</span></span><span style=display:flex><span>            password<span style=color:#ff7b72;font-weight:700>=</span>config[<span style=color:#a5d6ff>&#39;password&#39;</span>],
</span></span><span style=display:flex><span>            database<span style=color:#ff7b72;font-weight:700>=</span>config[<span style=color:#a5d6ff>&#39;database&#39;</span>]
</span></span><span style=display:flex><span>        )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>get_shard</span>(self, shard_key: str, sharding_type: str <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>&#39;hash&#39;</span>):
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;获取分片连接&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>if</span> sharding_type <span style=color:#ff7b72;font-weight:700>==</span> <span style=color:#a5d6ff>&#39;hash&#39;</span>:
</span></span><span style=display:flex><span>            shard_id <span style=color:#ff7b72;font-weight:700>=</span> self<span style=color:#ff7b72;font-weight:700>.</span>strategy<span style=color:#ff7b72;font-weight:700>.</span>hash_sharding(shard_key)
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>elif</span> sharding_type <span style=color:#ff7b72;font-weight:700>==</span> <span style=color:#a5d6ff>&#39;consistent&#39;</span>:
</span></span><span style=display:flex><span>            shard_id <span style=color:#ff7b72;font-weight:700>=</span> self<span style=color:#ff7b72;font-weight:700>.</span>strategy<span style=color:#ff7b72;font-weight:700>.</span>consistent_hash_sharding(shard_key)
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>elif</span> sharding_type <span style=color:#ff7b72;font-weight:700>==</span> <span style=color:#a5d6ff>&#39;modulo&#39;</span>:
</span></span><span style=display:flex><span>            shard_id <span style=color:#ff7b72;font-weight:700>=</span> self<span style=color:#ff7b72;font-weight:700>.</span>strategy<span style=color:#ff7b72;font-weight:700>.</span>modulo_sharding(int(shard_key))
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>else</span>:
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>raise</span> <span style=color:#f0883e;font-weight:700>ValueError</span>(<span style=color:#79c0ff>f</span><span style=color:#a5d6ff>&#34;Unknown sharding type: </span><span style=color:#a5d6ff>{</span>sharding_type<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> self<span style=color:#ff7b72;font-weight:700>.</span>shards[shard_id][<span style=color:#a5d6ff>&#39;connection&#39;</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>execute_on_shard</span>(self, shard_key: str, sql: str, params<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#79c0ff>None</span>):
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;在指定分片执行SQL&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        conn <span style=color:#ff7b72;font-weight:700>=</span> self<span style=color:#ff7b72;font-weight:700>.</span>get_shard(shard_key)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>with</span> conn<span style=color:#ff7b72;font-weight:700>.</span>cursor() <span style=color:#ff7b72>as</span> cursor:
</span></span><span style=display:flex><span>            cursor<span style=color:#ff7b72;font-weight:700>.</span>execute(sql, params <span style=color:#ff7b72;font-weight:700>or</span> ())
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>return</span> cursor<span style=color:#ff7b72;font-weight:700>.</span>fetchall()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>query_all_shards</span>(self, sql: str, params<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#79c0ff>None</span>):
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;查询所有分片&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        results <span style=color:#ff7b72;font-weight:700>=</span> []
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>for</span> shard_id, shard <span style=color:#ff7b72;font-weight:700>in</span> self<span style=color:#ff7b72;font-weight:700>.</span>shards<span style=color:#ff7b72;font-weight:700>.</span>items():
</span></span><span style=display:flex><span>            conn <span style=color:#ff7b72;font-weight:700>=</span> shard[<span style=color:#a5d6ff>&#39;connection&#39;</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>with</span> conn<span style=color:#ff7b72;font-weight:700>.</span>cursor() <span style=color:#ff7b72>as</span> cursor:
</span></span><span style=display:flex><span>                cursor<span style=color:#ff7b72;font-weight:700>.</span>execute(sql, params <span style=color:#ff7b72;font-weight:700>or</span> ())
</span></span><span style=display:flex><span>                shard_results <span style=color:#ff7b72;font-weight:700>=</span> cursor<span style=color:#ff7b72;font-weight:700>.</span>fetchall()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#8b949e;font-style:italic># 添加分片标识</span>
</span></span><span style=display:flex><span>                <span style=color:#ff7b72>for</span> row <span style=color:#ff7b72;font-weight:700>in</span> shard_results:
</span></span><span style=display:flex><span>                    <span style=color:#ff7b72>if</span> isinstance(row, dict):
</span></span><span style=display:flex><span>                        row[<span style=color:#a5d6ff>&#39;_shard_id&#39;</span>] <span style=color:#ff7b72;font-weight:700>=</span> shard_id
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                results<span style=color:#ff7b72;font-weight:700>.</span>extend(shard_results)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> results
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>broadcast_write</span>(self, sql: str, params<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#79c0ff>None</span>):
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;广播写入所有分片&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        results <span style=color:#ff7b72;font-weight:700>=</span> []
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>for</span> shard_id, shard <span style=color:#ff7b72;font-weight:700>in</span> self<span style=color:#ff7b72;font-weight:700>.</span>shards<span style=color:#ff7b72;font-weight:700>.</span>items():
</span></span><span style=display:flex><span>            conn <span style=color:#ff7b72;font-weight:700>=</span> shard[<span style=color:#a5d6ff>&#39;connection&#39;</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>with</span> conn<span style=color:#ff7b72;font-weight:700>.</span>cursor() <span style=color:#ff7b72>as</span> cursor:
</span></span><span style=display:flex><span>                cursor<span style=color:#ff7b72;font-weight:700>.</span>execute(sql, params <span style=color:#ff7b72;font-weight:700>or</span> ())
</span></span><span style=display:flex><span>                conn<span style=color:#ff7b72;font-weight:700>.</span>commit()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                results<span style=color:#ff7b72;font-weight:700>.</span>append({
</span></span><span style=display:flex><span>                    <span style=color:#a5d6ff>&#39;shard_id&#39;</span>: shard_id,
</span></span><span style=display:flex><span>                    <span style=color:#a5d6ff>&#39;affected_rows&#39;</span>: cursor<span style=color:#ff7b72;font-weight:700>.</span>rowcount
</span></span><span style=display:flex><span>                })
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> results
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># ========== 分表路由 ==========</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>class</span> <span style=color:#f0883e;font-weight:700>TableRouter</span>:
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#34;&#34;&#34;表路由&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>__init__</span>(self, sharding_manager: ShardingManager):
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>manager <span style=color:#ff7b72;font-weight:700>=</span> sharding_manager
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>table_rules <span style=color:#ff7b72;font-weight:700>=</span> {}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>add_rule</span>(self, table_name: str, sharding_key: str, sharding_type: str):
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;添加分表规则&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>table_rules[table_name] <span style=color:#ff7b72;font-weight:700>=</span> {
</span></span><span style=display:flex><span>            <span style=color:#a5d6ff>&#39;sharding_key&#39;</span>: sharding_key,
</span></span><span style=display:flex><span>            <span style=color:#a5d6ff>&#39;sharding_type&#39;</span>: sharding_type
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>get_table_name</span>(self, original_table: str, shard_key: str) <span style=color:#ff7b72;font-weight:700>-&gt;</span> str:
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;获取实际表名&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        rule <span style=color:#ff7b72;font-weight:700>=</span> self<span style=color:#ff7b72;font-weight:700>.</span>table_rules<span style=color:#ff7b72;font-weight:700>.</span>get(original_table)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>if</span> <span style=color:#ff7b72;font-weight:700>not</span> rule:
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>return</span> original_table
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic># 计算分片ID</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>if</span> rule[<span style=color:#a5d6ff>&#39;sharding_type&#39;</span>] <span style=color:#ff7b72;font-weight:700>==</span> <span style=color:#a5d6ff>&#39;hash&#39;</span>:
</span></span><span style=display:flex><span>            shard_id <span style=color:#ff7b72;font-weight:700>=</span> hash(shard_key) <span style=color:#ff7b72;font-weight:700>%</span> self<span style=color:#ff7b72;font-weight:700>.</span>manager<span style=color:#ff7b72;font-weight:700>.</span>strategy<span style=color:#ff7b72;font-weight:700>.</span>shard_count
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>elif</span> rule[<span style=color:#a5d6ff>&#39;sharding_type&#39;</span>] <span style=color:#ff7b72;font-weight:700>==</span> <span style=color:#a5d6ff>&#39;modulo&#39;</span>:
</span></span><span style=display:flex><span>            shard_id <span style=color:#ff7b72;font-weight:700>=</span> int(shard_key) <span style=color:#ff7b72;font-weight:700>%</span> self<span style=color:#ff7b72;font-weight:700>.</span>manager<span style=color:#ff7b72;font-weight:700>.</span>strategy<span style=color:#ff7b72;font-weight:700>.</span>shard_count
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>else</span>:
</span></span><span style=display:flex><span>            shard_id <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> <span style=color:#79c0ff>f</span><span style=color:#a5d6ff>&#34;</span><span style=color:#a5d6ff>{</span>original_table<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>_</span><span style=color:#a5d6ff>{</span>shard_id<span style=color:#a5d6ff>:</span><span style=color:#a5d6ff>04d</span><span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>execute_query</span>(self, table_name: str, query_template: str, <span style=color:#ff7b72;font-weight:700>**</span>kwargs):
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;执行分表查询&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic># 获取分片键值</span>
</span></span><span style=display:flex><span>        rule <span style=color:#ff7b72;font-weight:700>=</span> self<span style=color:#ff7b72;font-weight:700>.</span>table_rules<span style=color:#ff7b72;font-weight:700>.</span>get(table_name)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>if</span> <span style=color:#ff7b72;font-weight:700>not</span> rule:
</span></span><span style=display:flex><span>            <span style=color:#8b949e;font-style:italic># 不分表，直接执行</span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>return</span> self<span style=color:#ff7b72;font-weight:700>.</span>manager<span style=color:#ff7b72;font-weight:700>.</span>execute_on_shard(<span style=color:#a5d6ff>&#39;0&#39;</span>, query_template, kwargs)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        shard_key_value <span style=color:#ff7b72;font-weight:700>=</span> kwargs<span style=color:#ff7b72;font-weight:700>.</span>get(rule[<span style=color:#a5d6ff>&#39;sharding_key&#39;</span>])
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>if</span> <span style=color:#ff7b72;font-weight:700>not</span> shard_key_value:
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>raise</span> <span style=color:#f0883e;font-weight:700>ValueError</span>(<span style=color:#79c0ff>f</span><span style=color:#a5d6ff>&#34;Missing sharding key: </span><span style=color:#a5d6ff>{</span>rule[<span style=color:#a5d6ff>&#39;sharding_key&#39;</span>]<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic># 获取实际表名</span>
</span></span><span style=display:flex><span>        actual_table <span style=color:#ff7b72;font-weight:700>=</span> self<span style=color:#ff7b72;font-weight:700>.</span>get_table_name(table_name, str(shard_key_value))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic># 替换表名</span>
</span></span><span style=display:flex><span>        actual_query <span style=color:#ff7b72;font-weight:700>=</span> query_template<span style=color:#ff7b72;font-weight:700>.</span>replace(<span style=color:#79c0ff>f</span><span style=color:#a5d6ff>&#39;FROM </span><span style=color:#a5d6ff>{</span>table_name<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>&#39;</span>, <span style=color:#79c0ff>f</span><span style=color:#a5d6ff>&#39;FROM </span><span style=color:#a5d6ff>{</span>actual_table<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> self<span style=color:#ff7b72;font-weight:700>.</span>manager<span style=color:#ff7b72;font-weight:700>.</span>execute_on_shard(str(shard_key_value), actual_query, kwargs)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># 使用示例</span>
</span></span><span style=display:flex><span>shard_configs <span style=color:#ff7b72;font-weight:700>=</span> [
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#39;id&#39;</span>: <span style=color:#a5d6ff>0</span>,
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#39;host&#39;</span>: <span style=color:#a5d6ff>&#39;db0.example.com&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#39;port&#39;</span>: <span style=color:#a5d6ff>3306</span>,
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#39;user&#39;</span>: <span style=color:#a5d6ff>&#39;root&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#39;password&#39;</span>: <span style=color:#a5d6ff>&#39;password&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#39;database&#39;</span>: <span style=color:#a5d6ff>&#39;app_db_0&#39;</span>
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#39;id&#39;</span>: <span style=color:#a5d6ff>1</span>,
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#39;host&#39;</span>: <span style=color:#a5d6ff>&#39;db1.example.com&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#39;port&#39;</span>: <span style=color:#a5d6ff>3306</span>,
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#39;user&#39;</span>: <span style=color:#a5d6ff>&#39;root&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#39;password&#39;</span>: <span style=color:#a5d6ff>&#39;password&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#39;database&#39;</span>: <span style=color:#a5d6ff>&#39;app_db_1&#39;</span>
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#39;id&#39;</span>: <span style=color:#a5d6ff>2</span>,
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#39;host&#39;</span>: <span style=color:#a5d6ff>&#39;db2.example.com&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#39;port&#39;</span>: <span style=color:#a5d6ff>3306</span>,
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#39;user&#39;</span>: <span style=color:#a5d6ff>&#39;root&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#39;password&#39;</span>: <span style=color:#a5d6ff>&#39;password&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#39;database&#39;</span>: <span style=color:#a5d6ff>&#39;app_db_2&#39;</span>
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#39;id&#39;</span>: <span style=color:#a5d6ff>3</span>,
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#39;host&#39;</span>: <span style=color:#a5d6ff>&#39;db3.example.com&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#39;port&#39;</span>: <span style=color:#a5d6ff>3306</span>,
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#39;user&#39;</span>: <span style=color:#a5d6ff>&#39;root&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#39;password&#39;</span>: <span style=color:#a5d6ff>&#39;password&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#39;database&#39;</span>: <span style=color:#a5d6ff>&#39;app_db_3&#39;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sharding_manager <span style=color:#ff7b72;font-weight:700>=</span> ShardingManager(shard_configs)
</span></span><span style=display:flex><span>table_router <span style=color:#ff7b72;font-weight:700>=</span> TableRouter(sharding_manager)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># 配置orders表按user_id分表</span>
</span></span><span style=display:flex><span>table_router<span style=color:#ff7b72;font-weight:700>.</span>add_rule(<span style=color:#a5d6ff>&#39;orders&#39;</span>, <span style=color:#a5d6ff>&#39;user_id&#39;</span>, <span style=color:#a5d6ff>&#39;modulo&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># 插入订单（自动路由到正确的分片）</span>
</span></span><span style=display:flex><span>table_router<span style=color:#ff7b72;font-weight:700>.</span>execute_query(
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#39;orders&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#34;INSERT INTO orders (user_id, order_no, total_amount) VALUES (:user_id, :order_no, :total_amount)&#34;</span>,
</span></span><span style=display:flex><span>    user_id<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>12345</span>,
</span></span><span style=display:flex><span>    order_no<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>&#39;ORD2024010112345&#39;</span>,
</span></span><span style=display:flex><span>    total_amount<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>9999.99</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># 查询订单（自动路由到正确的分片）</span>
</span></span><span style=display:flex><span>results <span style=color:#ff7b72;font-weight:700>=</span> table_router<span style=color:#ff7b72;font-weight:700>.</span>execute_query(
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#39;orders&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#34;SELECT * FROM orders WHERE user_id = :user_id&#34;</span>,
</span></span><span style=display:flex><span>    user_id<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>12345</span>
</span></span><span style=display:flex><span>)
</span></span></code></pre></td></tr></table></div></div><h3 id=22-垂直分库>2.2 垂直分库<a hidden class=anchor aria-hidden=true href=#22-垂直分库>#</a></h3><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 78
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 79
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 80
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 81
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 82
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 83
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 84
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 85
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 86
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 87
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 88
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 89
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 90
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 91
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 92
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 93
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 94
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 95
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 96
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 97
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 98
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 99
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">100
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">101
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">102
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">103
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">104
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">105
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">106
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">107
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">108
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">109
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">110
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">111
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">112
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">113
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">114
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">115
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">116
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">117
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">118
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">119
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">120
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">121
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">122
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">123
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">124
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">125
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">126
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">127
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">128
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">129
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">130
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">131
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">132
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">133
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">134
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">135
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">136
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">137
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">138
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">139
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">140
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">141
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">142
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">143
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">144
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">145
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#8b949e;font-style:italic># ========== 垂直分库策略 ==========</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>class</span> <span style=color:#f0883e;font-weight:700>VerticalSharding</span>:
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#34;&#34;&#34;垂直分库&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>__init__</span>(self):
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>databases <span style=color:#ff7b72;font-weight:700>=</span> {
</span></span><span style=display:flex><span>            <span style=color:#a5d6ff>&#39;user_db&#39;</span>: <span style=color:#79c0ff>None</span>,      <span style=color:#8b949e;font-style:italic># 用户相关表</span>
</span></span><span style=display:flex><span>            <span style=color:#a5d6ff>&#39;order_db&#39;</span>: <span style=color:#79c0ff>None</span>,     <span style=color:#8b949e;font-style:italic># 订单相关表</span>
</span></span><span style=display:flex><span>            <span style=color:#a5d6ff>&#39;product_db&#39;</span>: <span style=color:#79c0ff>None</span>,   <span style=color:#8b949e;font-style:italic># 商品相关表</span>
</span></span><span style=display:flex><span>            <span style=color:#a5d6ff>&#39;log_db&#39;</span>: <span style=color:#79c0ff>None</span>        <span style=color:#8b949e;font-style:italic># 日志相关表</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>route_by_module</span>(self, table_name: str):
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;按模块路由&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        module_mapping <span style=color:#ff7b72;font-weight:700>=</span> {
</span></span><span style=display:flex><span>            <span style=color:#8b949e;font-style:italic># 用户模块</span>
</span></span><span style=display:flex><span>            <span style=color:#a5d6ff>&#39;users&#39;</span>: <span style=color:#a5d6ff>&#39;user_db&#39;</span>,
</span></span><span style=display:flex><span>            <span style=color:#a5d6ff>&#39;user_profiles&#39;</span>: <span style=color:#a5d6ff>&#39;user_db&#39;</span>,
</span></span><span style=display:flex><span>            <span style=color:#a5d6ff>&#39;user_addresses&#39;</span>: <span style=color:#a5d6ff>&#39;user_db&#39;</span>,
</span></span><span style=display:flex><span>            <span style=color:#a5d6ff>&#39;user_preferences&#39;</span>: <span style=color:#a5d6ff>&#39;user_db&#39;</span>,
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#8b949e;font-style:italic># 订单模块</span>
</span></span><span style=display:flex><span>            <span style=color:#a5d6ff>&#39;orders&#39;</span>: <span style=color:#a5d6ff>&#39;order_db&#39;</span>,
</span></span><span style=display:flex><span>            <span style=color:#a5d6ff>&#39;order_items&#39;</span>: <span style=color:#a5d6ff>&#39;order_db&#39;</span>,
</span></span><span style=display:flex><span>            <span style=color:#a5d6ff>&#39;order_payments&#39;</span>: <span style=color:#a5d6ff>&#39;order_db&#39;</span>,
</span></span><span style=display:flex><span>            <span style=color:#a5d6ff>&#39;order_shippings&#39;</span>: <span style=color:#a5d6ff>&#39;order_db&#39;</span>,
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#8b949e;font-style:italic># 商品模块</span>
</span></span><span style=display:flex><span>            <span style=color:#a5d6ff>&#39;products&#39;</span>: <span style=color:#a5d6ff>&#39;product_db&#39;</span>,
</span></span><span style=display:flex><span>            <span style=color:#a5d6ff>&#39;categories&#39;</span>: <span style=color:#a5d6ff>&#39;product_db&#39;</span>,
</span></span><span style=display:flex><span>            <span style=color:#a5d6ff>&#39;product_skus&#39;</span>: <span style=color:#a5d6ff>&#39;product_db&#39;</span>,
</span></span><span style=display:flex><span>            <span style=color:#a5d6ff>&#39;inventory&#39;</span>: <span style=color:#a5d6ff>&#39;product_db&#39;</span>,
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#8b949e;font-style:italic># 日志模块</span>
</span></span><span style=display:flex><span>            <span style=color:#a5d6ff>&#39;operation_logs&#39;</span>: <span style=color:#a5d6ff>&#39;log_db&#39;</span>,
</span></span><span style=display:flex><span>            <span style=color:#a5d6ff>&#39;access_logs&#39;</span>: <span style=color:#a5d6ff>&#39;log_db&#39;</span>,
</span></span><span style=display:flex><span>            <span style=color:#a5d6ff>&#39;error_logs&#39;</span>: <span style=color:#a5d6ff>&#39;log_db&#39;</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> self<span style=color:#ff7b72;font-weight:700>.</span>databases<span style=color:#ff7b72;font-weight:700>.</span>get(module_mapping<span style=color:#ff7b72;font-weight:700>.</span>get(table_name))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>cross_database_query</span>(self, queries: List[dict]):
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;跨库查询&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        results <span style=color:#ff7b72;font-weight:700>=</span> {}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>for</span> query_info <span style=color:#ff7b72;font-weight:700>in</span> queries:
</span></span><span style=display:flex><span>            db_name <span style=color:#ff7b72;font-weight:700>=</span> query_info[<span style=color:#a5d6ff>&#39;database&#39;</span>]
</span></span><span style=display:flex><span>            sql <span style=color:#ff7b72;font-weight:700>=</span> query_info[<span style=color:#a5d6ff>&#39;sql&#39;</span>]
</span></span><span style=display:flex><span>            params <span style=color:#ff7b72;font-weight:700>=</span> query_info<span style=color:#ff7b72;font-weight:700>.</span>get(<span style=color:#a5d6ff>&#39;params&#39;</span>, {})
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            conn <span style=color:#ff7b72;font-weight:700>=</span> self<span style=color:#ff7b72;font-weight:700>.</span>databases[db_name]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>with</span> conn<span style=color:#ff7b72;font-weight:700>.</span>cursor() <span style=color:#ff7b72>as</span> cursor:
</span></span><span style=display:flex><span>                cursor<span style=color:#ff7b72;font-weight:700>.</span>execute(sql, params)
</span></span><span style=display:flex><span>                results[db_name] <span style=color:#ff7b72;font-weight:700>=</span> cursor<span style=color:#ff7b72;font-weight:700>.</span>fetchall()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic># 在应用层合并结果</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> self<span style=color:#ff7b72;font-weight:700>.</span>_merge_results(results)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>_merge_results</span>(self, results: dict) <span style=color:#ff7b72;font-weight:700>-&gt;</span> List[dict]:
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;合并跨库查询结果&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic># 根据业务逻辑合并结果</span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic># 这里是简化示例</span>
</span></span><span style=display:flex><span>        merged <span style=color:#ff7b72;font-weight:700>=</span> []
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic># 从user_db获取用户信息</span>
</span></span><span style=display:flex><span>        users <span style=color:#ff7b72;font-weight:700>=</span> results<span style=color:#ff7b72;font-weight:700>.</span>get(<span style=color:#a5d6ff>&#39;user_db&#39;</span>, [])
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic># 从order_db获取订单信息</span>
</span></span><span style=display:flex><span>        orders <span style=color:#ff7b72;font-weight:700>=</span> results<span style=color:#ff7b72;font-weight:700>.</span>get(<span style=color:#a5d6ff>&#39;order_db&#39;</span>, [])
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic># 合并数据</span>
</span></span><span style=display:flex><span>        user_dict <span style=color:#ff7b72;font-weight:700>=</span> {user[<span style=color:#a5d6ff>&#39;id&#39;</span>]: user <span style=color:#ff7b72>for</span> user <span style=color:#ff7b72;font-weight:700>in</span> users}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>for</span> order <span style=color:#ff7b72;font-weight:700>in</span> orders:
</span></span><span style=display:flex><span>            user_id <span style=color:#ff7b72;font-weight:700>=</span> order[<span style=color:#a5d6ff>&#39;user_id&#39;</span>]
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>if</span> user_id <span style=color:#ff7b72;font-weight:700>in</span> user_dict:
</span></span><span style=display:flex><span>                merged<span style=color:#ff7b72;font-weight:700>.</span>append({
</span></span><span style=display:flex><span>                    <span style=color:#ff7b72;font-weight:700>**</span>user_dict[user_id],
</span></span><span style=display:flex><span>                    <span style=color:#a5d6ff>&#39;order&#39;</span>: order
</span></span><span style=display:flex><span>                })
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> merged
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># ========== 分布式事务（Saga模式） ==========</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>class</span> <span style=color:#f0883e;font-weight:700>DistributedTransaction</span>:
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#34;&#34;&#34;分布式事务管理器&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>__init__</span>(self):
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>participants <span style=color:#ff7b72;font-weight:700>=</span> []
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>compensations <span style=color:#ff7b72;font-weight:700>=</span> []
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>add_participant</span>(self, database: str, operation: str, compensation: str):
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;添加事务参与者&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>participants<span style=color:#ff7b72;font-weight:700>.</span>append({
</span></span><span style=display:flex><span>            <span style=color:#a5d6ff>&#39;database&#39;</span>: database,
</span></span><span style=display:flex><span>            <span style=color:#a5d6ff>&#39;operation&#39;</span>: operation
</span></span><span style=display:flex><span>        })
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>compensations<span style=color:#ff7b72;font-weight:700>.</span>append({
</span></span><span style=display:flex><span>            <span style=color:#a5d6ff>&#39;database&#39;</span>: database,
</span></span><span style=display:flex><span>            <span style=color:#a5d6ff>&#39;operation&#39;</span>: compensation
</span></span><span style=display:flex><span>        })
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>async</span> <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>execute</span>(self) <span style=color:#ff7b72;font-weight:700>-&gt;</span> bool:
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;执行分布式事务&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        executed <span style=color:#ff7b72;font-weight:700>=</span> []
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>try</span>:
</span></span><span style=display:flex><span>            <span style=color:#8b949e;font-style:italic># 顺序执行各分库操作</span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>for</span> participant <span style=color:#ff7b72;font-weight:700>in</span> self<span style=color:#ff7b72;font-weight:700>.</span>participants:
</span></span><span style=display:flex><span>                conn <span style=color:#ff7b72;font-weight:700>=</span> self<span style=color:#ff7b72;font-weight:700>.</span>databases[participant[<span style=color:#a5d6ff>&#39;database&#39;</span>]]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#ff7b72>with</span> conn<span style=color:#ff7b72;font-weight:700>.</span>cursor() <span style=color:#ff7b72>as</span> cursor:
</span></span><span style=display:flex><span>                    cursor<span style=color:#ff7b72;font-weight:700>.</span>execute(participant[<span style=color:#a5d6ff>&#39;operation&#39;</span>])
</span></span><span style=display:flex><span>                    conn<span style=color:#ff7b72;font-weight:700>.</span>commit()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                    executed<span style=color:#ff7b72;font-weight:700>.</span>append(participant)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>return</span> <span style=color:#79c0ff>True</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>except</span> <span style=color:#f0883e;font-weight:700>Exception</span> <span style=color:#ff7b72>as</span> e:
</span></span><span style=display:flex><span>            <span style=color:#8b949e;font-style:italic># 执行补偿操作</span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>for</span> i <span style=color:#ff7b72;font-weight:700>in</span> range(len(executed) <span style=color:#ff7b72;font-weight:700>-</span> <span style=color:#a5d6ff>1</span>, <span style=color:#ff7b72;font-weight:700>-</span><span style=color:#a5d6ff>1</span>, <span style=color:#ff7b72;font-weight:700>-</span><span style=color:#a5d6ff>1</span>):
</span></span><span style=display:flex><span>                compensation <span style=color:#ff7b72;font-weight:700>=</span> self<span style=color:#ff7b72;font-weight:700>.</span>compensations[i]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#ff7b72>try</span>:
</span></span><span style=display:flex><span>                    conn <span style=color:#ff7b72;font-weight:700>=</span> self<span style=color:#ff7b72;font-weight:700>.</span>databases[compensation[<span style=color:#a5d6ff>&#39;database&#39;</span>]]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                    <span style=color:#ff7b72>with</span> conn<span style=color:#ff7b72;font-weight:700>.</span>cursor() <span style=color:#ff7b72>as</span> cursor:
</span></span><span style=display:flex><span>                        cursor<span style=color:#ff7b72;font-weight:700>.</span>execute(compensation[<span style=color:#a5d6ff>&#39;operation&#39;</span>])
</span></span><span style=display:flex><span>                        conn<span style=color:#ff7b72;font-weight:700>.</span>commit()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#ff7b72>except</span> <span style=color:#f0883e;font-weight:700>Exception</span> <span style=color:#ff7b72>as</span> ce:
</span></span><span style=display:flex><span>                    <span style=color:#8b949e;font-style:italic># 补偿失败，记录日志</span>
</span></span><span style=display:flex><span>                    print(<span style=color:#79c0ff>f</span><span style=color:#a5d6ff>&#34;Compensation failed: </span><span style=color:#a5d6ff>{</span>ce<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>return</span> <span style=color:#79c0ff>False</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=三分布式数据库>三、分布式数据库<a hidden class=anchor aria-hidden=true href=#三分布式数据库>#</a></h2><h3 id=31-newsql数据库>3.1 NewSQL数据库<a hidden class=anchor aria-hidden=true href=#31-newsql数据库>#</a></h3><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 78
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 79
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 80
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 81
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 82
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 83
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 84
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 85
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 86
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 87
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 88
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 89
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 90
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 91
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 92
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 93
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 94
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 95
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 96
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 97
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 98
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 99
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">100
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">101
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">102
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">103
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">104
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">105
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">106
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">107
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">108
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">109
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">110
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">111
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">112
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">113
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">114
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">115
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">116
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">117
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">118
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">119
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">120
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">121
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">122
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">123
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">124
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">125
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">126
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">127
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">128
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">129
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">130
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">131
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">132
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">133
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">134
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">135
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">136
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">137
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">138
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">139
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">140
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">141
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">142
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">143
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">144
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">145
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">146
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">147
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">148
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">149
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">150
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">151
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">152
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">153
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">154
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">155
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">156
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">157
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">158
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">159
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">160
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">161
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">162
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">163
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">164
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#8b949e;font-style:italic># ========== TiDB集成示例 ==========</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>import</span> <span style=color:#ff7b72>MySQLdb</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>class</span> <span style=color:#f0883e;font-weight:700>TiDBClient</span>:
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#34;&#34;&#34;TiDB客户端&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>__init__</span>(self, host: str, port: int, user: str, password: str, database: str):
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>conn <span style=color:#ff7b72;font-weight:700>=</span> MySQLdb<span style=color:#ff7b72;font-weight:700>.</span>connect(
</span></span><span style=display:flex><span>            host<span style=color:#ff7b72;font-weight:700>=</span>host,
</span></span><span style=display:flex><span>            port<span style=color:#ff7b72;font-weight:700>=</span>port,
</span></span><span style=display:flex><span>            user<span style=color:#ff7b72;font-weight:700>=</span>user,
</span></span><span style=display:flex><span>            password<span style=color:#ff7b72;font-weight:700>=</span>password,
</span></span><span style=display:flex><span>            database<span style=color:#ff7b72;font-weight:700>=</span>database,
</span></span><span style=display:flex><span>            charset<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>&#39;utf8mb4&#39;</span>
</span></span><span style=display:flex><span>        )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>insert_batch</span>(self, table: str, records: List[dict]) <span style=color:#ff7b72;font-weight:700>-&gt;</span> int:
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;批量插入&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>if</span> <span style=color:#ff7b72;font-weight:700>not</span> records:
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>return</span> <span style=color:#a5d6ff>0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic># 构建批量插入SQL</span>
</span></span><span style=display:flex><span>        columns <span style=color:#ff7b72;font-weight:700>=</span> list(records[<span style=color:#a5d6ff>0</span>]<span style=color:#ff7b72;font-weight:700>.</span>keys())
</span></span><span style=display:flex><span>        placeholders <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>&#39;, &#39;</span><span style=color:#ff7b72;font-weight:700>.</span>join([<span style=color:#a5d6ff>&#39;</span><span style=color:#a5d6ff>%s</span><span style=color:#a5d6ff>&#39;</span>] <span style=color:#ff7b72;font-weight:700>*</span> len(columns))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        sql <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#79c0ff>f</span><span style=color:#a5d6ff>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>            INSERT INTO </span><span style=color:#a5d6ff>{</span>table<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff> (</span><span style=color:#a5d6ff>{</span><span style=color:#a5d6ff>&#39;, &#39;</span><span style=color:#ff7b72;font-weight:700>.</span>join(columns)<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>)
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>            VALUES (</span><span style=color:#a5d6ff>{</span>placeholders<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>)
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>        &#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        values <span style=color:#ff7b72;font-weight:700>=</span> [
</span></span><span style=display:flex><span>            tuple(record[col] <span style=color:#ff7b72>for</span> col <span style=color:#ff7b72;font-weight:700>in</span> columns)
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>for</span> record <span style=color:#ff7b72;font-weight:700>in</span> records
</span></span><span style=display:flex><span>        ]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>with</span> self<span style=color:#ff7b72;font-weight:700>.</span>conn<span style=color:#ff7b72;font-weight:700>.</span>cursor() <span style=color:#ff7b72>as</span> cursor:
</span></span><span style=display:flex><span>            cursor<span style=color:#ff7b72;font-weight:700>.</span>executemany(sql, values)
</span></span><span style=display:flex><span>            self<span style=color:#ff7b72;font-weight:700>.</span>conn<span style=color:#ff7b72;font-weight:700>.</span>commit()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>return</span> cursor<span style=color:#ff7b72;font-weight:700>.</span>rowcount
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>select_with_pagination</span>(
</span></span><span style=display:flex><span>        self,
</span></span><span style=display:flex><span>        table: str,
</span></span><span style=display:flex><span>        where: str <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#79c0ff>None</span>,
</span></span><span style=display:flex><span>        order_by: str <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#79c0ff>None</span>,
</span></span><span style=display:flex><span>        limit: int <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>100</span>,
</span></span><span style=display:flex><span>        offset: int <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>0</span>
</span></span><span style=display:flex><span>    ) <span style=color:#ff7b72;font-weight:700>-&gt;</span> List[dict]:
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;分页查询&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        sql <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#79c0ff>f</span><span style=color:#a5d6ff>&#34;SELECT * FROM </span><span style=color:#a5d6ff>{</span>table<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>if</span> where:
</span></span><span style=display:flex><span>            sql <span style=color:#ff7b72;font-weight:700>+=</span> <span style=color:#79c0ff>f</span><span style=color:#a5d6ff>&#34; WHERE </span><span style=color:#a5d6ff>{</span>where<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>if</span> order_by:
</span></span><span style=display:flex><span>            sql <span style=color:#ff7b72;font-weight:700>+=</span> <span style=color:#79c0ff>f</span><span style=color:#a5d6ff>&#34; ORDER BY </span><span style=color:#a5d6ff>{</span>order_by<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        sql <span style=color:#ff7b72;font-weight:700>+=</span> <span style=color:#79c0ff>f</span><span style=color:#a5d6ff>&#34; LIMIT </span><span style=color:#a5d6ff>{</span>limit<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff> OFFSET </span><span style=color:#a5d6ff>{</span>offset<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>with</span> self<span style=color:#ff7b72;font-weight:700>.</span>conn<span style=color:#ff7b72;font-weight:700>.</span>cursor(MySQLdb<span style=color:#ff7b72;font-weight:700>.</span>cursors<span style=color:#ff7b72;font-weight:700>.</span>DictCursor) <span style=color:#ff7b72>as</span> cursor:
</span></span><span style=display:flex><span>            cursor<span style=color:#ff7b72;font-weight:700>.</span>execute(sql)
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>return</span> cursor<span style=color:#ff7b72;font-weight:700>.</span>fetchall()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>get_transaction_info</span>(self) <span style=color:#ff7b72;font-weight:700>-&gt;</span> dict:
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;获取事务信息&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>with</span> self<span style=color:#ff7b72;font-weight:700>.</span>conn<span style=color:#ff7b72;font-weight:700>.</span>cursor() <span style=color:#ff7b72>as</span> cursor:
</span></span><span style=display:flex><span>            <span style=color:#8b949e;font-style:italic># 查询当前事务信息</span>
</span></span><span style=display:flex><span>            cursor<span style=color:#ff7b72;font-weight:700>.</span>execute(<span style=color:#a5d6ff>&#34;SELECT @@txn_version as version&#34;</span>)
</span></span><span style=display:flex><span>            version <span style=color:#ff7b72;font-weight:700>=</span> cursor<span style=color:#ff7b72;font-weight:700>.</span>fetchone()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            cursor<span style=color:#ff7b72;font-weight:700>.</span>execute(<span style=color:#a5d6ff>&#34;SELECT @@autocommit as autocommit&#34;</span>)
</span></span><span style=display:flex><span>            autocommit <span style=color:#ff7b72;font-weight:700>=</span> cursor<span style=color:#ff7b72;font-weight:700>.</span>fetchone()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>return</span> {
</span></span><span style=display:flex><span>                <span style=color:#a5d6ff>&#39;version&#39;</span>: version[<span style=color:#a5d6ff>0</span>] <span style=color:#ff7b72>if</span> version <span style=color:#ff7b72>else</span> <span style=color:#79c0ff>None</span>,
</span></span><span style=display:flex><span>                <span style=color:#a5d6ff>&#39;autocommit&#39;</span>: autocommit[<span style=color:#a5d6ff>0</span>] <span style=color:#ff7b72>if</span> autocommit <span style=color:#ff7b72>else</span> <span style=color:#79c0ff>None</span>
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># ========== 分布式事务使用 ==========</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>class</span> <span style=color:#f0883e;font-weight:700>DistributedOrderService</span>:
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#34;&#34;&#34;分布式订单服务&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>__init__</span>(self, tidb_client: TiDBClient):
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>tidb <span style=color:#ff7b72;font-weight:700>=</span> tidb_client
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>async</span> <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>create_order</span>(self, order_data: dict, items: List[dict]) <span style=color:#ff7b72;font-weight:700>-&gt;</span> str:
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;创建订单（分布式事务）&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>try</span>:
</span></span><span style=display:flex><span>            <span style=color:#8b949e;font-style:italic># 开启事务</span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>with</span> self<span style=color:#ff7b72;font-weight:700>.</span>tidb<span style=color:#ff7b72;font-weight:700>.</span>conn <span style=color:#ff7b72>as</span> cursor:
</span></span><span style=display:flex><span>                <span style=color:#8b949e;font-style:italic># 1. 创建订单</span>
</span></span><span style=display:flex><span>                order_sql <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                    INSERT INTO orders (user_id, order_no, total_amount, status)
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                    VALUES (</span><span style=color:#a5d6ff>%s</span><span style=color:#a5d6ff>, </span><span style=color:#a5d6ff>%s</span><span style=color:#a5d6ff>, </span><span style=color:#a5d6ff>%s</span><span style=color:#a5d6ff>, </span><span style=color:#a5d6ff>%s</span><span style=color:#a5d6ff>)
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                &#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>                cursor<span style=color:#ff7b72;font-weight:700>.</span>execute(order_sql, (
</span></span><span style=display:flex><span>                    order_data[<span style=color:#a5d6ff>&#39;user_id&#39;</span>],
</span></span><span style=display:flex><span>                    order_data[<span style=color:#a5d6ff>&#39;order_no&#39;</span>],
</span></span><span style=display:flex><span>                    order_data[<span style=color:#a5d6ff>&#39;total_amount&#39;</span>],
</span></span><span style=display:flex><span>                    <span style=color:#a5d6ff>&#39;pending&#39;</span>
</span></span><span style=display:flex><span>                ))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                order_id <span style=color:#ff7b72;font-weight:700>=</span> cursor<span style=color:#ff7b72;font-weight:700>.</span>lastrowid
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#8b949e;font-style:italic># 2. 创建订单明细</span>
</span></span><span style=display:flex><span>                <span style=color:#ff7b72>for</span> item <span style=color:#ff7b72;font-weight:700>in</span> items:
</span></span><span style=display:flex><span>                    item_sql <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                        INSERT INTO order_items (
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                            order_id, product_id, quantity, price
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                        ) VALUES (</span><span style=color:#a5d6ff>%s</span><span style=color:#a5d6ff>, </span><span style=color:#a5d6ff>%s</span><span style=color:#a5d6ff>, </span><span style=color:#a5d6ff>%s</span><span style=color:#a5d6ff>, </span><span style=color:#a5d6ff>%s</span><span style=color:#a5d6ff>)
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                    &#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>                    cursor<span style=color:#ff7b72;font-weight:700>.</span>execute(item_sql, (
</span></span><span style=display:flex><span>                        order_id,
</span></span><span style=display:flex><span>                        item[<span style=color:#a5d6ff>&#39;product_id&#39;</span>],
</span></span><span style=display:flex><span>                        item[<span style=color:#a5d6ff>&#39;quantity&#39;</span>],
</span></span><span style=display:flex><span>                        item[<span style=color:#a5d6ff>&#39;price&#39;</span>]
</span></span><span style=display:flex><span>                    ))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#8b949e;font-style:italic># 3. 扣减库存</span>
</span></span><span style=display:flex><span>                <span style=color:#ff7b72>for</span> item <span style=color:#ff7b72;font-weight:700>in</span> items:
</span></span><span style=display:flex><span>                    inventory_sql <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                        UPDATE inventory
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                        SET stock = stock - </span><span style=color:#a5d6ff>%s</span><span style=color:#a5d6ff>
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                        WHERE product_id = </span><span style=color:#a5d6ff>%s</span><span style=color:#a5d6ff> AND stock &gt;= </span><span style=color:#a5d6ff>%s</span><span style=color:#a5d6ff>
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                    &#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>                    affected <span style=color:#ff7b72;font-weight:700>=</span> cursor<span style=color:#ff7b72;font-weight:700>.</span>execute(inventory_sql, (
</span></span><span style=display:flex><span>                        item[<span style=color:#a5d6ff>&#39;quantity&#39;</span>],
</span></span><span style=display:flex><span>                        item[<span style=color:#a5d6ff>&#39;product_id&#39;</span>],
</span></span><span style=display:flex><span>                        item[<span style=color:#a5d6ff>&#39;quantity&#39;</span>]
</span></span><span style=display:flex><span>                    ))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                    <span style=color:#ff7b72>if</span> affected <span style=color:#ff7b72;font-weight:700>==</span> <span style=color:#a5d6ff>0</span>:
</span></span><span style=display:flex><span>                        <span style=color:#8b949e;font-style:italic># 库存不足，回滚事务</span>
</span></span><span style=display:flex><span>                        <span style=color:#ff7b72>raise</span> <span style=color:#f0883e;font-weight:700>Exception</span>(<span style=color:#79c0ff>f</span><span style=color:#a5d6ff>&#34;Insufficient stock for product </span><span style=color:#a5d6ff>{</span>item[<span style=color:#a5d6ff>&#39;product_id&#39;</span>]<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#8b949e;font-style:italic># 4. 创建支付记录</span>
</span></span><span style=display:flex><span>                payment_sql <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                    INSERT INTO payments (
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                        order_id, amount, status, payment_method
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                    ) VALUES (</span><span style=color:#a5d6ff>%s</span><span style=color:#a5d6ff>, </span><span style=color:#a5d6ff>%s</span><span style=color:#a5d6ff>, </span><span style=color:#a5d6ff>%s</span><span style=color:#a5d6ff>, </span><span style=color:#a5d6ff>%s</span><span style=color:#a5d6ff>)
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                &#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>                cursor<span style=color:#ff7b72;font-weight:700>.</span>execute(payment_sql, (
</span></span><span style=display:flex><span>                    order_id,
</span></span><span style=display:flex><span>                    order_data[<span style=color:#a5d6ff>&#39;total_amount&#39;</span>],
</span></span><span style=display:flex><span>                    <span style=color:#a5d6ff>&#39;pending&#39;</span>,
</span></span><span style=display:flex><span>                    order_data[<span style=color:#a5d6ff>&#39;payment_method&#39;</span>]
</span></span><span style=display:flex><span>                ))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#8b949e;font-style:italic># 提交事务</span>
</span></span><span style=display:flex><span>                self<span style=color:#ff7b72;font-weight:700>.</span>tidb<span style=color:#ff7b72;font-weight:700>.</span>conn<span style=color:#ff7b72;font-weight:700>.</span>commit()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#ff7b72>return</span> order_id
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>except</span> <span style=color:#f0883e;font-weight:700>Exception</span> <span style=color:#ff7b72>as</span> e:
</span></span><span style=display:flex><span>            <span style=color:#8b949e;font-style:italic># 回滚事务</span>
</span></span><span style=display:flex><span>            self<span style=color:#ff7b72;font-weight:700>.</span>tidb<span style=color:#ff7b72;font-weight:700>.</span>conn<span style=color:#ff7b72;font-weight:700>.</span>rollback()
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>raise</span> e
</span></span></code></pre></td></tr></table></div></div><h3 id=32-分布式缓存>3.2 分布式缓存<a hidden class=anchor aria-hidden=true href=#32-分布式缓存>#</a></h3><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 78
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 79
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 80
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 81
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 82
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 83
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 84
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 85
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 86
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 87
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 88
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 89
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 90
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 91
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 92
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 93
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 94
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 95
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 96
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 97
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 98
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 99
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">100
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">101
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">102
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">103
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">104
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">105
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">106
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">107
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">108
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">109
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">110
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">111
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">112
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">113
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">114
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">115
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">116
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">117
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">118
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">119
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">120
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">121
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">122
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">123
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">124
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">125
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">126
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">127
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">128
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">129
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">130
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">131
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">132
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">133
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">134
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">135
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">136
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">137
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">138
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">139
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">140
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">141
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">142
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">143
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">144
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">145
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">146
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">147
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">148
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">149
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">150
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">151
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">152
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">153
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">154
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">155
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">156
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">157
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">158
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">159
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">160
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">161
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">162
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">163
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">164
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">165
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">166
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">167
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">168
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">169
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">170
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">171
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">172
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">173
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">174
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">175
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">176
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">177
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">178
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">179
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">180
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">181
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">182
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">183
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">184
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">185
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">186
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">187
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">188
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">189
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">190
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">191
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">192
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">193
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">194
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">195
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">196
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">197
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">198
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">199
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">200
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">201
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">202
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">203
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">204
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">205
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">206
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">207
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">208
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">209
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">210
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">211
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">212
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">213
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">214
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">215
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#8b949e;font-style:italic># ========== Redis集群 ==========</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>import</span> <span style=color:#ff7b72>redis</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>from</span> <span style=color:#ff7b72>rediscluster</span> <span style=color:#ff7b72>import</span> RedisCluster
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>class</span> <span style=color:#f0883e;font-weight:700>RedisClusterClient</span>:
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#34;&#34;&#34;Redis集群客户端&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>__init__</span>(self, startup_nodes: List[dict]):
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>        startup_nodes: [
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>            {&#39;host&#39;: &#39;redis1.example.com&#39;, &#39;port&#39;: 7000},
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>            {&#39;host&#39;: &#39;redis2.example.com&#39;, &#39;port&#39;: 7001},
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>            {&#39;host&#39;: &#39;redis3.example.com&#39;, &#39;port&#39;: 7002}
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>        ]
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>        &#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>client <span style=color:#ff7b72;font-weight:700>=</span> RedisCluster(
</span></span><span style=display:flex><span>            startup_nodes<span style=color:#ff7b72;font-weight:700>=</span>startup_nodes,
</span></span><span style=display:flex><span>            decode_responses<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#79c0ff>True</span>,
</span></span><span style=display:flex><span>            skip_full_coverage_check<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#79c0ff>True</span>,
</span></span><span style=display:flex><span>            max_connections<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>32</span>
</span></span><span style=display:flex><span>        )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>set</span>(self, key: str, value: str, expire: int <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#79c0ff>None</span>):
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;设置键值&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> self<span style=color:#ff7b72;font-weight:700>.</span>client<span style=color:#ff7b72;font-weight:700>.</span>set(key, value, ex<span style=color:#ff7b72;font-weight:700>=</span>expire)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>get</span>(self, key: str) <span style=color:#ff7b72;font-weight:700>-&gt;</span> str:
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;获取值&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> self<span style=color:#ff7b72;font-weight:700>.</span>client<span style=color:#ff7b72;font-weight:700>.</span>get(key)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>mget</span>(self, keys: List[str]) <span style=color:#ff7b72;font-weight:700>-&gt;</span> List[str]:
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;批量获取&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> self<span style=color:#ff7b72;font-weight:700>.</span>client<span style=color:#ff7b72;font-weight:700>.</span>mget(keys)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>delete</span>(self, <span style=color:#ff7b72;font-weight:700>*</span>keys: str):
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;删除键&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> self<span style=color:#ff7b72;font-weight:700>.</span>client<span style=color:#ff7b72;font-weight:700>.</span>delete(<span style=color:#ff7b72;font-weight:700>*</span>keys)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>exists</span>(self, <span style=color:#ff7b72;font-weight:700>*</span>keys: str) <span style=color:#ff7b72;font-weight:700>-&gt;</span> int:
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;检查键是否存在&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> self<span style=color:#ff7b72;font-weight:700>.</span>client<span style=color:#ff7b72;font-weight:700>.</span>exists(<span style=color:#ff7b72;font-weight:700>*</span>keys)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>expire</span>(self, key: str, seconds: int):
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;设置过期时间&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> self<span style=color:#ff7b72;font-weight:700>.</span>client<span style=color:#ff7b72;font-weight:700>.</span>expire(key, seconds)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>incr</span>(self, key: str, amount: int <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>1</span>) <span style=color:#ff7b72;font-weight:700>-&gt;</span> int:
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;递增&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> self<span style=color:#ff7b72;font-weight:700>.</span>client<span style=color:#ff7b72;font-weight:700>.</span>incrby(key, amount)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>decr</span>(self, key: str, amount: int <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>1</span>) <span style=color:#ff7b72;font-weight:700>-&gt;</span> int:
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;递减&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> self<span style=color:#ff7b72;font-weight:700>.</span>client<span style=color:#ff7b72;font-weight:700>.</span>decrby(key, amount)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>hset</span>(self, name: str, key: str, value: str):
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;哈希表设置&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> self<span style=color:#ff7b72;font-weight:700>.</span>client<span style=color:#ff7b72;font-weight:700>.</span>hset(name, key, value)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>hget</span>(self, name: str, key: str) <span style=color:#ff7b72;font-weight:700>-&gt;</span> str:
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;哈希表获取&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> self<span style=color:#ff7b72;font-weight:700>.</span>client<span style=color:#ff7b72;font-weight:700>.</span>hget(name, key)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>hgetall</span>(self, name: str) <span style=color:#ff7b72;font-weight:700>-&gt;</span> dict:
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;获取整个哈希表&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> self<span style=color:#ff7b72;font-weight:700>.</span>client<span style=color:#ff7b72;font-weight:700>.</span>hgetall(name)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># ========== 缓存策略 ==========</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>class</span> <span style=color:#f0883e;font-weight:700>CacheStrategy</span>:
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#34;&#34;&#34;缓存策略&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>__init__</span>(self, redis_client: RedisClusterClient):
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>redis <span style=color:#ff7b72;font-weight:700>=</span> redis_client
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>cache_aside</span>(self, key: str, load_func, expire: int <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>3600</span>):
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;Cache-Aside模式&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic># 先查缓存</span>
</span></span><span style=display:flex><span>        value <span style=color:#ff7b72;font-weight:700>=</span> self<span style=color:#ff7b72;font-weight:700>.</span>redis<span style=color:#ff7b72;font-weight:700>.</span>get(key)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>if</span> value <span style=color:#ff7b72;font-weight:700>is</span> <span style=color:#ff7b72;font-weight:700>not</span> <span style=color:#79c0ff>None</span>:
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>return</span> value
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic># 缓存未命中，加载数据</span>
</span></span><span style=display:flex><span>        value <span style=color:#ff7b72;font-weight:700>=</span> load_func()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic># 写入缓存</span>
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>redis<span style=color:#ff7b72;font-weight:700>.</span>set(key, value, expire)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> value
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>invalidate</span>(self, <span style=color:#ff7b72;font-weight:700>*</span>keys: str):
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;使缓存失效&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>redis<span style=color:#ff7b72;font-weight:700>.</span>delete(<span style=color:#ff7b72;font-weight:700>*</span>keys)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>warm_up</span>(self, data: dict, expire: int <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>3600</span>):
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;缓存预热&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        pipe <span style=color:#ff7b72;font-weight:700>=</span> self<span style=color:#ff7b72;font-weight:700>.</span>redis<span style=color:#ff7b72;font-weight:700>.</span>client<span style=color:#ff7b72;font-weight:700>.</span>pipeline()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>for</span> key, value <span style=color:#ff7b72;font-weight:700>in</span> data<span style=color:#ff7b72;font-weight:700>.</span>items():
</span></span><span style=display:flex><span>            pipe<span style=color:#ff7b72;font-weight:700>.</span>set(key, value, expire)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        pipe<span style=color:#ff7b72;font-weight:700>.</span>execute()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>update</span>(self, key: str, value: str, expire: int <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>3600</span>):
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;更新缓存&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>redis<span style=color:#ff7b72;font-weight:700>.</span>set(key, value, expire)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># ========== 分布式锁 ==========</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>class</span> <span style=color:#f0883e;font-weight:700>DistributedLock</span>:
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#34;&#34;&#34;分布式锁&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>__init__</span>(self, redis_client: RedisClusterClient):
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>redis <span style=color:#ff7b72;font-weight:700>=</span> redis_client
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>acquire</span>(
</span></span><span style=display:flex><span>        self,
</span></span><span style=display:flex><span>        lock_name: str,
</span></span><span style=display:flex><span>        acquire_timeout: int <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>10</span>,
</span></span><span style=display:flex><span>        lock_timeout: int <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>30</span>
</span></span><span style=display:flex><span>    ) <span style=color:#ff7b72;font-weight:700>-&gt;</span> bool:
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;获取锁&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>import</span> <span style=color:#ff7b72>time</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        lock_key <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#79c0ff>f</span><span style=color:#a5d6ff>&#34;lock:</span><span style=color:#a5d6ff>{</span>lock_name<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>&#34;</span>
</span></span><span style=display:flex><span>        lock_value <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#79c0ff>f</span><span style=color:#a5d6ff>&#34;</span><span style=color:#a5d6ff>{</span>time<span style=color:#ff7b72;font-weight:700>.</span>time()<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        end_time <span style=color:#ff7b72;font-weight:700>=</span> time<span style=color:#ff7b72;font-weight:700>.</span>time() <span style=color:#ff7b72;font-weight:700>+</span> acquire_timeout
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>while</span> time<span style=color:#ff7b72;font-weight:700>.</span>time() <span style=color:#ff7b72;font-weight:700>&lt;</span> end_time:
</span></span><span style=display:flex><span>            <span style=color:#8b949e;font-style:italic># 尝试获取锁</span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>if</span> self<span style=color:#ff7b72;font-weight:700>.</span>redis<span style=color:#ff7b72;font-weight:700>.</span>client<span style=color:#ff7b72;font-weight:700>.</span>set(
</span></span><span style=display:flex><span>                lock_key,
</span></span><span style=display:flex><span>                lock_value,
</span></span><span style=display:flex><span>                nx<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#79c0ff>True</span>,
</span></span><span style=display:flex><span>                ex<span style=color:#ff7b72;font-weight:700>=</span>lock_timeout
</span></span><span style=display:flex><span>            ):
</span></span><span style=display:flex><span>                <span style=color:#ff7b72>return</span> <span style=color:#79c0ff>True</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            time<span style=color:#ff7b72;font-weight:700>.</span>sleep(<span style=color:#a5d6ff>0.001</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> <span style=color:#79c0ff>False</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>release</span>(self, lock_name: str):
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;释放锁&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        lock_key <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#79c0ff>f</span><span style=color:#a5d6ff>&#34;lock:</span><span style=color:#a5d6ff>{</span>lock_name<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic># 使用Lua脚本确保只释放自己的锁</span>
</span></span><span style=display:flex><span>        lua_script <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>            if redis.call(&#34;get&#34;, KEYS[1]) == ARGV[1] then
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                return redis.call(&#34;del&#34;, KEYS[1])
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>            else
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                return 0
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>            end
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>        &#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>redis<span style=color:#ff7b72;font-weight:700>.</span>client<span style=color:#ff7b72;font-weight:700>.</span>eval(
</span></span><span style=display:flex><span>            lua_script,
</span></span><span style=display:flex><span>            <span style=color:#a5d6ff>1</span>,
</span></span><span style=display:flex><span>            lock_key,
</span></span><span style=display:flex><span>            self<span style=color:#ff7b72;font-weight:700>.</span>redis<span style=color:#ff7b72;font-weight:700>.</span>get(lock_key)
</span></span><span style=display:flex><span>        )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># ========== 限流器 ==========</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>class</span> <span style=color:#f0883e;font-weight:700>RateLimiter</span>:
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#34;&#34;&#34;分布式限流器&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>__init__</span>(self, redis_client: RedisClusterClient):
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>redis <span style=color:#ff7b72;font-weight:700>=</span> redis_client
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>is_allowed</span>(
</span></span><span style=display:flex><span>        self,
</span></span><span style=display:flex><span>        key: str,
</span></span><span style=display:flex><span>        limit: int,
</span></span><span style=display:flex><span>        window: int
</span></span><span style=display:flex><span>    ) <span style=color:#ff7b72;font-weight:700>-&gt;</span> bool:
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>        滑动窗口限流
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>        key: 限流键（如用户ID、IP等）
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>        limit: 时间窗口内最大请求数
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>        window: 时间窗口（秒）
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>        &#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>import</span> <span style=color:#ff7b72>time</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        now <span style=color:#ff7b72;font-weight:700>=</span> time<span style=color:#ff7b72;font-weight:700>.</span>time()
</span></span><span style=display:flex><span>        window_start <span style=color:#ff7b72;font-weight:700>=</span> now <span style=color:#ff7b72;font-weight:700>-</span> window
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        pipe <span style=color:#ff7b72;font-weight:700>=</span> self<span style=color:#ff7b72;font-weight:700>.</span>redis<span style=color:#ff7b72;font-weight:700>.</span>client<span style=color:#ff7b72;font-weight:700>.</span>pipeline()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic># 移除时间窗口外的记录</span>
</span></span><span style=display:flex><span>        pipe<span style=color:#ff7b72;font-weight:700>.</span>zremrangebyscore(key, <span style=color:#a5d6ff>0</span>, window_start)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic># 获取当前计数</span>
</span></span><span style=display:flex><span>        pipe<span style=color:#ff7b72;font-weight:700>.</span>zcard(key)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic># 添加当前请求</span>
</span></span><span style=display:flex><span>        pipe<span style=color:#ff7b72;font-weight:700>.</span>zadd(key, {str(now): now})
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic># 设置过期时间</span>
</span></span><span style=display:flex><span>        pipe<span style=color:#ff7b72;font-weight:700>.</span>expire(key, window <span style=color:#ff7b72;font-weight:700>+</span> <span style=color:#a5d6ff>1</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        results <span style=color:#ff7b72;font-weight:700>=</span> pipe<span style=color:#ff7b72;font-weight:700>.</span>execute()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        current_count <span style=color:#ff7b72;font-weight:700>=</span> results[<span style=color:#a5d6ff>1</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> current_count <span style=color:#ff7b72;font-weight:700>&lt;</span> limit
</span></span></code></pre></td></tr></table></div></div><h2 id=四数据库监控与运维>四、数据库监控与运维<a hidden class=anchor aria-hidden=true href=#四数据库监控与运维>#</a></h2><h3 id=41-性能监控>4.1 性能监控<a hidden class=anchor aria-hidden=true href=#41-性能监控>#</a></h3><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 78
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 79
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 80
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 81
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 82
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 83
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 84
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 85
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 86
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 87
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 88
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 89
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 90
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 91
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 92
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 93
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 94
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 95
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 96
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 97
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 98
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 99
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">100
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">101
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">102
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">103
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">104
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">105
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">106
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">107
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">108
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">109
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">110
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">111
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">112
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">113
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">114
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">115
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">116
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">117
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">118
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">119
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">120
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">121
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">122
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">123
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">124
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">125
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">126
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">127
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">128
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">129
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">130
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">131
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">132
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">133
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">134
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">135
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">136
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">137
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">138
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">139
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">140
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">141
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">142
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">143
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">144
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">145
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">146
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">147
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">148
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">149
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">150
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">151
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">152
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">153
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">154
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">155
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">156
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">157
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">158
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">159
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">160
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">161
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">162
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">163
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">164
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">165
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">166
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">167
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">168
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">169
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">170
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">171
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">172
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">173
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">174
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">175
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">176
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">177
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">178
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#8b949e;font-style:italic># ========== 数据库监控 ==========</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>class</span> <span style=color:#f0883e;font-weight:700>DatabaseMonitor</span>:
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#34;&#34;&#34;数据库监控&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>__init__</span>(self, connection):
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>conn <span style=color:#ff7b72;font-weight:700>=</span> connection
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>get_connection_stats</span>(self) <span style=color:#ff7b72;font-weight:700>-&gt;</span> dict:
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;获取连接统计&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>with</span> self<span style=color:#ff7b72;font-weight:700>.</span>conn<span style=color:#ff7b72;font-weight:700>.</span>cursor() <span style=color:#ff7b72>as</span> cursor:
</span></span><span style=display:flex><span>            cursor<span style=color:#ff7b72;font-weight:700>.</span>execute(<span style=color:#a5d6ff>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                SHOW STATUS LIKE &#39;Threads%&#39;
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>            &#34;&#34;&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            stats <span style=color:#ff7b72;font-weight:700>=</span> cursor<span style=color:#ff7b72;font-weight:700>.</span>fetchall()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>return</span> {
</span></span><span style=display:flex><span>                <span style=color:#a5d6ff>&#39;threads_connected&#39;</span>: next(
</span></span><span style=display:flex><span>                    (s[<span style=color:#a5d6ff>1</span>] <span style=color:#ff7b72>for</span> s <span style=color:#ff7b72;font-weight:700>in</span> stats <span style=color:#ff7b72>if</span> s[<span style=color:#a5d6ff>0</span>] <span style=color:#ff7b72;font-weight:700>==</span> <span style=color:#a5d6ff>&#39;Threads_connected&#39;</span>),
</span></span><span style=display:flex><span>                    <span style=color:#a5d6ff>0</span>
</span></span><span style=display:flex><span>                ),
</span></span><span style=display:flex><span>                <span style=color:#a5d6ff>&#39;threads_running&#39;</span>: next(
</span></span><span style=display:flex><span>                    (s[<span style=color:#a5d6ff>1</span>] <span style=color:#ff7b72>for</span> s <span style=color:#ff7b72;font-weight:700>in</span> stats <span style=color:#ff7b72>if</span> s[<span style=color:#a5d6ff>0</span>] <span style=color:#ff7b72;font-weight:700>==</span> <span style=color:#a5d6ff>&#39;Threads_running&#39;</span>),
</span></span><span style=display:flex><span>                    <span style=color:#a5d6ff>0</span>
</span></span><span style=display:flex><span>                )
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>get_query_stats</span>(self) <span style=color:#ff7b72;font-weight:700>-&gt;</span> dict:
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;获取查询统计&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>with</span> self<span style=color:#ff7b72;font-weight:700>.</span>conn<span style=color:#ff7b72;font-weight:700>.</span>cursor() <span style=color:#ff7b72>as</span> cursor:
</span></span><span style=display:flex><span>            <span style=color:#8b949e;font-style:italic># 慢查询统计</span>
</span></span><span style=display:flex><span>            cursor<span style=color:#ff7b72;font-weight:700>.</span>execute(<span style=color:#a5d6ff>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                SELECT
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                    COUNT(*) as slow_query_count,
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                    AVG(query_time) as avg_query_time,
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                    MAX(query_time) as max_query_time
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                FROM mysql.slow_log
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                WHERE start_time &gt; DATE_SUB(NOW(), INTERVAL 1 HOUR)
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>            &#34;&#34;&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            slow_stats <span style=color:#ff7b72;font-weight:700>=</span> cursor<span style=color:#ff7b72;font-weight:700>.</span>fetchone()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#8b949e;font-style:italic># QPS/TPS统计</span>
</span></span><span style=display:flex><span>            cursor<span style=color:#ff7b72;font-weight:700>.</span>execute(<span style=color:#a5d6ff>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                SHOW STATUS LIKE &#39;Questions&#39;
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>            &#34;&#34;&#34;</span>)
</span></span><span style=display:flex><span>            questions <span style=color:#ff7b72;font-weight:700>=</span> cursor<span style=color:#ff7b72;font-weight:700>.</span>fetchone()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            cursor<span style=color:#ff7b72;font-weight:700>.</span>execute(<span style=color:#a5d6ff>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                SHOW STATUS LIKE &#39;Uptime&#39;
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>            &#34;&#34;&#34;</span>)
</span></span><span style=display:flex><span>            uptime <span style=color:#ff7b72;font-weight:700>=</span> cursor<span style=color:#ff7b72;font-weight:700>.</span>fetchone()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            qps <span style=color:#ff7b72;font-weight:700>=</span> questions[<span style=color:#a5d6ff>1</span>] <span style=color:#ff7b72;font-weight:700>/</span> uptime[<span style=color:#a5d6ff>1</span>] <span style=color:#ff7b72>if</span> uptime[<span style=color:#a5d6ff>1</span>] <span style=color:#ff7b72;font-weight:700>&gt;</span> <span style=color:#a5d6ff>0</span> <span style=color:#ff7b72>else</span> <span style=color:#a5d6ff>0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>return</span> {
</span></span><span style=display:flex><span>                <span style=color:#a5d6ff>&#39;slow_query_count&#39;</span>: slow_stats[<span style=color:#a5d6ff>0</span>],
</span></span><span style=display:flex><span>                <span style=color:#a5d6ff>&#39;avg_query_time&#39;</span>: float(slow_stats[<span style=color:#a5d6ff>1</span>]) <span style=color:#ff7b72>if</span> slow_stats[<span style=color:#a5d6ff>1</span>] <span style=color:#ff7b72>else</span> <span style=color:#a5d6ff>0</span>,
</span></span><span style=display:flex><span>                <span style=color:#a5d6ff>&#39;max_query_time&#39;</span>: float(slow_stats[<span style=color:#a5d6ff>2</span>]) <span style=color:#ff7b72>if</span> slow_stats[<span style=color:#a5d6ff>2</span>] <span style=color:#ff7b72>else</span> <span style=color:#a5d6ff>0</span>,
</span></span><span style=display:flex><span>                <span style=color:#a5d6ff>&#39;qps&#39;</span>: round(qps, <span style=color:#a5d6ff>2</span>)
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>get_replication_lag</span>(self) <span style=color:#ff7b72;font-weight:700>-&gt;</span> int:
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;获取主从延迟&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>with</span> self<span style=color:#ff7b72;font-weight:700>.</span>conn<span style=color:#ff7b72;font-weight:700>.</span>cursor() <span style=color:#ff7b72>as</span> cursor:
</span></span><span style=display:flex><span>            cursor<span style=color:#ff7b72;font-weight:700>.</span>execute(<span style=color:#a5d6ff>&#34;SHOW SLAVE STATUS&#34;</span>)
</span></span><span style=display:flex><span>            status <span style=color:#ff7b72;font-weight:700>=</span> cursor<span style=color:#ff7b72;font-weight:700>.</span>fetchone()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>if</span> status:
</span></span><span style=display:flex><span>                <span style=color:#ff7b72>return</span> status[<span style=color:#a5d6ff>&#39;Seconds_Behind_Master&#39;</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>return</span> <span style=color:#a5d6ff>0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>get_innodb_stats</span>(self) <span style=color:#ff7b72;font-weight:700>-&gt;</span> dict:
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;获取InnoDB统计&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>with</span> self<span style=color:#ff7b72;font-weight:700>.</span>conn<span style=color:#ff7b72;font-weight:700>.</span>cursor() <span style=color:#ff7b72>as</span> cursor:
</span></span><span style=display:flex><span>            cursor<span style=color:#ff7b72;font-weight:700>.</span>execute(<span style=color:#a5d6ff>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                SHOW STATUS LIKE &#39;Innodb_%&#39;
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>            &#34;&#34;&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            stats <span style=color:#ff7b72;font-weight:700>=</span> cursor<span style=color:#ff7b72;font-weight:700>.</span>fetchall()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>return</span> {
</span></span><span style=display:flex><span>                <span style=color:#a5d6ff>&#39;row_lock_waits&#39;</span>: next(
</span></span><span style=display:flex><span>                    (s[<span style=color:#a5d6ff>1</span>] <span style=color:#ff7b72>for</span> s <span style=color:#ff7b72;font-weight:700>in</span> stats <span style=color:#ff7b72>if</span> s[<span style=color:#a5d6ff>0</span>] <span style=color:#ff7b72;font-weight:700>==</span> <span style=color:#a5d6ff>&#39;Innodb_row_lock_current_waits&#39;</span>),
</span></span><span style=display:flex><span>                    <span style=color:#a5d6ff>0</span>
</span></span><span style=display:flex><span>                ),
</span></span><span style=display:flex><span>                <span style=color:#a5d6ff>&#39;deadlocks&#39;</span>: next(
</span></span><span style=display:flex><span>                    (s[<span style=color:#a5d6ff>1</span>] <span style=color:#ff7b72>for</span> s <span style=color:#ff7b72;font-weight:700>in</span> stats <span style=color:#ff7b72>if</span> s[<span style=color:#a5d6ff>0</span>] <span style=color:#ff7b72;font-weight:700>==</span> <span style=color:#a5d6ff>&#39;Innodb_deadlocks&#39;</span>),
</span></span><span style=display:flex><span>                    <span style=color:#a5d6ff>0</span>
</span></span><span style=display:flex><span>                ),
</span></span><span style=display:flex><span>                <span style=color:#a5d6ff>&#39;buffer_pool_hit_rate&#39;</span>: self<span style=color:#ff7b72;font-weight:700>.</span>_calculate_hit_rate(stats)
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>_calculate_hit_rate</span>(self, stats: list) <span style=color:#ff7b72;font-weight:700>-&gt;</span> float:
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;计算缓冲池命中率&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        reads <span style=color:#ff7b72;font-weight:700>=</span> next(
</span></span><span style=display:flex><span>            (s[<span style=color:#a5d6ff>1</span>] <span style=color:#ff7b72>for</span> s <span style=color:#ff7b72;font-weight:700>in</span> stats <span style=color:#ff7b72>if</span> s[<span style=color:#a5d6ff>0</span>] <span style=color:#ff7b72;font-weight:700>==</span> <span style=color:#a5d6ff>&#39;Innodb_buffer_pool_reads&#39;</span>),
</span></span><span style=display:flex><span>            <span style=color:#a5d6ff>0</span>
</span></span><span style=display:flex><span>        )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        read_requests <span style=color:#ff7b72;font-weight:700>=</span> next(
</span></span><span style=display:flex><span>            (s[<span style=color:#a5d6ff>1</span>] <span style=color:#ff7b72>for</span> s <span style=color:#ff7b72;font-weight:700>in</span> stats <span style=color:#ff7b72>if</span> s[<span style=color:#a5d6ff>0</span>] <span style=color:#ff7b72;font-weight:700>==</span> <span style=color:#a5d6ff>&#39;Innodb_buffer_pool_read_requests&#39;</span>),
</span></span><span style=display:flex><span>            <span style=color:#a5d6ff>1</span>
</span></span><span style=display:flex><span>        )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>if</span> read_requests <span style=color:#ff7b72;font-weight:700>==</span> <span style=color:#a5d6ff>0</span>:
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>return</span> <span style=color:#a5d6ff>100.0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        hit_rate <span style=color:#ff7b72;font-weight:700>=</span> (<span style=color:#a5d6ff>1</span> <span style=color:#ff7b72;font-weight:700>-</span> reads <span style=color:#ff7b72;font-weight:700>/</span> read_requests) <span style=color:#ff7b72;font-weight:700>*</span> <span style=color:#a5d6ff>100</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> round(hit_rate, <span style=color:#a5d6ff>2</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># ========== 慢查询分析 ==========</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>class</span> <span style=color:#f0883e;font-weight:700>SlowQueryAnalyzer</span>:
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#34;&#34;&#34;慢查询分析器&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>__init__</span>(self, connection):
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>conn <span style=color:#ff7b72;font-weight:700>=</span> connection
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>get_slow_queries</span>(self, limit: int <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>100</span>) <span style=color:#ff7b72;font-weight:700>-&gt;</span> List[dict]:
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;获取慢查询&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>with</span> self<span style=color:#ff7b72;font-weight:700>.</span>conn<span style=color:#ff7b72;font-weight:700>.</span>cursor() <span style=color:#ff7b72>as</span> cursor:
</span></span><span style=display:flex><span>            sql <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                SELECT
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                    query_time,
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                    lock_time,
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                    rows_sent,
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                    rows_examined,
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                    sql_text
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                FROM mysql.slow_log
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                ORDER BY query_time DESC
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                LIMIT </span><span style=color:#a5d6ff>%s</span><span style=color:#a5d6ff>
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>            &#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            cursor<span style=color:#ff7b72;font-weight:700>.</span>execute(sql, (limit,))
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>return</span> cursor<span style=color:#ff7b72;font-weight:700>.</span>fetchall()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>analyze_slow_query</span>(self, query: str) <span style=color:#ff7b72;font-weight:700>-&gt;</span> dict:
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;分析慢查询&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        analyzer <span style=color:#ff7b72;font-weight:700>=</span> SQLQueryOptimizer()
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> analyzer<span style=color:#ff7b72;font-weight:700>.</span>optimize(query)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>suggest_indexes</span>(self, query: str) <span style=color:#ff7b72;font-weight:700>-&gt;</span> List[str]:
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;推荐索引&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic># 提取WHERE、JOIN、ORDER BY子句中的字段</span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic># 这里简化处理</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>import</span> <span style=color:#ff7b72>re</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic># 提取表名</span>
</span></span><span style=display:flex><span>        tables <span style=color:#ff7b72;font-weight:700>=</span> re<span style=color:#ff7b72;font-weight:700>.</span>findall(<span style=color:#79c0ff>r</span><span style=color:#a5d6ff>&#39;FROM\s+(\w+)&#39;</span>, query, re<span style=color:#ff7b72;font-weight:700>.</span>IGNORECASE)
</span></span><span style=display:flex><span>        tables <span style=color:#ff7b72;font-weight:700>+=</span> re<span style=color:#ff7b72;font-weight:700>.</span>findall(<span style=color:#79c0ff>r</span><span style=color:#a5d6ff>&#39;JOIN\s+(\w+)&#39;</span>, query, re<span style=color:#ff7b72;font-weight:700>.</span>IGNORECASE)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic># 提取WHERE条件字段</span>
</span></span><span style=display:flex><span>        where_fields <span style=color:#ff7b72;font-weight:700>=</span> re<span style=color:#ff7b72;font-weight:700>.</span>findall(
</span></span><span style=display:flex><span>            <span style=color:#79c0ff>r</span><span style=color:#a5d6ff>&#39;WHERE\s+(\w+)\.\w+\s*=&#39;</span>,
</span></span><span style=display:flex><span>            query,
</span></span><span style=display:flex><span>            re<span style=color:#ff7b72;font-weight:700>.</span>IGNORECASE
</span></span><span style=display:flex><span>        )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        suggestions <span style=color:#ff7b72;font-weight:700>=</span> []
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>for</span> table <span style=color:#ff7b72;font-weight:700>in</span> set(tables):
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>for</span> field <span style=color:#ff7b72;font-weight:700>in</span> set(where_fields):
</span></span><span style=display:flex><span>                suggestions<span style=color:#ff7b72;font-weight:700>.</span>append(
</span></span><span style=display:flex><span>                    <span style=color:#79c0ff>f</span><span style=color:#a5d6ff>&#34;CREATE INDEX idx_</span><span style=color:#a5d6ff>{</span>table<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>_</span><span style=color:#a5d6ff>{</span>field<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff> ON </span><span style=color:#a5d6ff>{</span>table<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>(</span><span style=color:#a5d6ff>{</span>field<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>)&#34;</span>
</span></span><span style=display:flex><span>                )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> suggestions
</span></span></code></pre></td></tr></table></div></div><h3 id=42-备份与恢复>4.2 备份与恢复<a hidden class=anchor aria-hidden=true href=#42-备份与恢复>#</a></h3><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 78
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 79
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 80
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 81
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 82
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 83
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 84
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 85
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 86
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 87
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 88
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 89
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 90
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 91
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 92
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 93
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 94
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 95
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 96
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 97
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 98
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 99
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">100
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">101
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">102
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">103
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">104
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">105
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">106
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">107
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">108
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">109
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">110
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">111
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">112
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">113
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">114
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">115
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">116
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">117
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">118
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">119
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">120
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">121
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">122
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">123
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">124
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">125
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">126
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">127
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">128
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">129
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">130
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">131
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">132
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">133
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">134
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">135
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">136
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">137
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">138
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">139
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">140
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">141
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">142
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">143
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">144
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">145
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">146
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">147
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">148
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">149
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">150
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">151
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">152
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">153
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">154
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">155
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">156
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">157
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">158
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">159
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">160
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">161
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">162
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">163
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">164
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">165
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">166
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">167
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">168
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">169
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">170
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">171
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">172
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">173
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">174
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">175
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">176
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">177
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">178
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">179
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">180
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#8b949e;font-style:italic># ========== 数据库备份 ==========</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>import</span> <span style=color:#ff7b72>subprocess</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>import</span> <span style=color:#ff7b72>os</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>from</span> <span style=color:#ff7b72>datetime</span> <span style=color:#ff7b72>import</span> datetime
</span></span><span style=display:flex><span><span style=color:#ff7b72>from</span> <span style=color:#ff7b72>typing</span> <span style=color:#ff7b72>import</span> List
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>class</span> <span style=color:#f0883e;font-weight:700>DatabaseBackup</span>:
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#34;&#34;&#34;数据库备份&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>__init__</span>(
</span></span><span style=display:flex><span>        self,
</span></span><span style=display:flex><span>        host: str,
</span></span><span style=display:flex><span>        user: str,
</span></span><span style=display:flex><span>        password: str,
</span></span><span style=display:flex><span>        backup_dir: str <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>&#39;/backup&#39;</span>
</span></span><span style=display:flex><span>    ):
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>host <span style=color:#ff7b72;font-weight:700>=</span> host
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>user <span style=color:#ff7b72;font-weight:700>=</span> user
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>password <span style=color:#ff7b72;font-weight:700>=</span> password
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>backup_dir <span style=color:#ff7b72;font-weight:700>=</span> backup_dir
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        os<span style=color:#ff7b72;font-weight:700>.</span>makedirs(backup_dir, exist_ok<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#79c0ff>True</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>backup_database</span>(
</span></span><span style=display:flex><span>        self,
</span></span><span style=display:flex><span>        database: str,
</span></span><span style=display:flex><span>        backup_type: str <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>&#39;full&#39;</span>
</span></span><span style=display:flex><span>    ) <span style=color:#ff7b72;font-weight:700>-&gt;</span> str:
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;备份数据库&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        timestamp <span style=color:#ff7b72;font-weight:700>=</span> datetime<span style=color:#ff7b72;font-weight:700>.</span>now()<span style=color:#ff7b72;font-weight:700>.</span>strftime(<span style=color:#a5d6ff>&#39;%Y%m</span><span style=color:#a5d6ff>%d</span><span style=color:#a5d6ff>_%H%M%S&#39;</span>)
</span></span><span style=display:flex><span>        backup_file <span style=color:#ff7b72;font-weight:700>=</span> os<span style=color:#ff7b72;font-weight:700>.</span>path<span style=color:#ff7b72;font-weight:700>.</span>join(
</span></span><span style=display:flex><span>            self<span style=color:#ff7b72;font-weight:700>.</span>backup_dir,
</span></span><span style=display:flex><span>            <span style=color:#79c0ff>f</span><span style=color:#a5d6ff>&#34;</span><span style=color:#a5d6ff>{</span>database<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>_</span><span style=color:#a5d6ff>{</span>backup_type<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>_</span><span style=color:#a5d6ff>{</span>timestamp<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>.sql&#34;</span>
</span></span><span style=display:flex><span>        )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic># 使用mysqldump备份</span>
</span></span><span style=display:flex><span>        command <span style=color:#ff7b72;font-weight:700>=</span> [
</span></span><span style=display:flex><span>            <span style=color:#a5d6ff>&#39;mysqldump&#39;</span>,
</span></span><span style=display:flex><span>            <span style=color:#79c0ff>f</span><span style=color:#a5d6ff>&#39;--host=</span><span style=color:#a5d6ff>{</span>self<span style=color:#ff7b72;font-weight:700>.</span>host<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>&#39;</span>,
</span></span><span style=display:flex><span>            <span style=color:#79c0ff>f</span><span style=color:#a5d6ff>&#39;--user=</span><span style=color:#a5d6ff>{</span>self<span style=color:#ff7b72;font-weight:700>.</span>user<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>&#39;</span>,
</span></span><span style=display:flex><span>            <span style=color:#79c0ff>f</span><span style=color:#a5d6ff>&#39;--password=</span><span style=color:#a5d6ff>{</span>self<span style=color:#ff7b72;font-weight:700>.</span>password<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>&#39;</span>,
</span></span><span style=display:flex><span>            <span style=color:#a5d6ff>&#39;--single-transaction&#39;</span>,
</span></span><span style=display:flex><span>            <span style=color:#a5d6ff>&#39;--routines&#39;</span>,
</span></span><span style=display:flex><span>            <span style=color:#a5d6ff>&#39;--triggers&#39;</span>,
</span></span><span style=display:flex><span>            <span style=color:#a5d6ff>&#39;--events&#39;</span>,
</span></span><span style=display:flex><span>            <span style=color:#a5d6ff>&#39;--quick&#39;</span>,
</span></span><span style=display:flex><span>            database
</span></span><span style=display:flex><span>        ]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>with</span> open(backup_file, <span style=color:#a5d6ff>&#39;w&#39;</span>) <span style=color:#ff7b72>as</span> f:
</span></span><span style=display:flex><span>            subprocess<span style=color:#ff7b72;font-weight:700>.</span>run(
</span></span><span style=display:flex><span>                command,
</span></span><span style=display:flex><span>                stdout<span style=color:#ff7b72;font-weight:700>=</span>f,
</span></span><span style=display:flex><span>                stderr<span style=color:#ff7b72;font-weight:700>=</span>subprocess<span style=color:#ff7b72;font-weight:700>.</span>PIPE,
</span></span><span style=display:flex><span>                check<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#79c0ff>True</span>
</span></span><span style=display:flex><span>            )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic># 压缩备份文件</span>
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>_compress_file(backup_file)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> <span style=color:#79c0ff>f</span><span style=color:#a5d6ff>&#34;</span><span style=color:#a5d6ff>{</span>backup_file<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>.gz&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>backup_all_databases</span>(self) <span style=color:#ff7b72;font-weight:700>-&gt;</span> str:
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;备份所有数据库&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        timestamp <span style=color:#ff7b72;font-weight:700>=</span> datetime<span style=color:#ff7b72;font-weight:700>.</span>now()<span style=color:#ff7b72;font-weight:700>.</span>strftime(<span style=color:#a5d6ff>&#39;%Y%m</span><span style=color:#a5d6ff>%d</span><span style=color:#a5d6ff>_%H%M%S&#39;</span>)
</span></span><span style=display:flex><span>        backup_file <span style=color:#ff7b72;font-weight:700>=</span> os<span style=color:#ff7b72;font-weight:700>.</span>path<span style=color:#ff7b72;font-weight:700>.</span>join(
</span></span><span style=display:flex><span>            self<span style=color:#ff7b72;font-weight:700>.</span>backup_dir,
</span></span><span style=display:flex><span>            <span style=color:#79c0ff>f</span><span style=color:#a5d6ff>&#34;all_databases_</span><span style=color:#a5d6ff>{</span>timestamp<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>.sql&#34;</span>
</span></span><span style=display:flex><span>        )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        command <span style=color:#ff7b72;font-weight:700>=</span> [
</span></span><span style=display:flex><span>            <span style=color:#a5d6ff>&#39;mysqldump&#39;</span>,
</span></span><span style=display:flex><span>            <span style=color:#79c0ff>f</span><span style=color:#a5d6ff>&#39;--host=</span><span style=color:#a5d6ff>{</span>self<span style=color:#ff7b72;font-weight:700>.</span>host<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>&#39;</span>,
</span></span><span style=display:flex><span>            <span style=color:#79c0ff>f</span><span style=color:#a5d6ff>&#39;--user=</span><span style=color:#a5d6ff>{</span>self<span style=color:#ff7b72;font-weight:700>.</span>user<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>&#39;</span>,
</span></span><span style=display:flex><span>            <span style=color:#79c0ff>f</span><span style=color:#a5d6ff>&#39;--password=</span><span style=color:#a5d6ff>{</span>self<span style=color:#ff7b72;font-weight:700>.</span>password<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>&#39;</span>,
</span></span><span style=display:flex><span>            <span style=color:#a5d6ff>&#39;--all-databases&#39;</span>,
</span></span><span style=display:flex><span>            <span style=color:#a5d6ff>&#39;--single-transaction&#39;</span>,
</span></span><span style=display:flex><span>            <span style=color:#a5d6ff>&#39;--routines&#39;</span>,
</span></span><span style=display:flex><span>            <span style=color:#a5d6ff>&#39;--triggers&#39;</span>,
</span></span><span style=display:flex><span>            <span style=color:#a5d6ff>&#39;--events&#39;</span>
</span></span><span style=display:flex><span>        ]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>with</span> open(backup_file, <span style=color:#a5d6ff>&#39;w&#39;</span>) <span style=color:#ff7b72>as</span> f:
</span></span><span style=display:flex><span>            subprocess<span style=color:#ff7b72;font-weight:700>.</span>run(
</span></span><span style=display:flex><span>                command,
</span></span><span style=display:flex><span>                stdout<span style=color:#ff7b72;font-weight:700>=</span>f,
</span></span><span style=display:flex><span>                stderr<span style=color:#ff7b72;font-weight:700>=</span>subprocess<span style=color:#ff7b72;font-weight:700>.</span>PIPE,
</span></span><span style=display:flex><span>                check<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#79c0ff>True</span>
</span></span><span style=display:flex><span>            )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>_compress_file(backup_file)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> <span style=color:#79c0ff>f</span><span style=color:#a5d6ff>&#34;</span><span style=color:#a5d6ff>{</span>backup_file<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>.gz&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>_compress_file</span>(self, filepath: str):
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;压缩文件&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>import</span> <span style=color:#ff7b72>gzip</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>with</span> open(filepath, <span style=color:#a5d6ff>&#39;rb&#39;</span>) <span style=color:#ff7b72>as</span> f_in:
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>with</span> gzip<span style=color:#ff7b72;font-weight:700>.</span>open(<span style=color:#79c0ff>f</span><span style=color:#a5d6ff>&#34;</span><span style=color:#a5d6ff>{</span>filepath<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>.gz&#34;</span>, <span style=color:#a5d6ff>&#39;wb&#39;</span>) <span style=color:#ff7b72>as</span> f_out:
</span></span><span style=display:flex><span>                f_out<span style=color:#ff7b72;font-weight:700>.</span>writelines(f_in)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        os<span style=color:#ff7b72;font-weight:700>.</span>remove(filepath)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>restore_database</span>(self, backup_file: str, database: str <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#79c0ff>None</span>):
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;恢复数据库&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic># 解压备份文件</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>if</span> backup_file<span style=color:#ff7b72;font-weight:700>.</span>endswith(<span style=color:#a5d6ff>&#39;.gz&#39;</span>):
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>import</span> <span style=color:#ff7b72>gzip</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            temp_file <span style=color:#ff7b72;font-weight:700>=</span> backup_file[:<span style=color:#ff7b72;font-weight:700>-</span><span style=color:#a5d6ff>3</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>with</span> gzip<span style=color:#ff7b72;font-weight:700>.</span>open(backup_file, <span style=color:#a5d6ff>&#39;rb&#39;</span>) <span style=color:#ff7b72>as</span> f_in:
</span></span><span style=display:flex><span>                <span style=color:#ff7b72>with</span> open(temp_file, <span style=color:#a5d6ff>&#39;wb&#39;</span>) <span style=color:#ff7b72>as</span> f_out:
</span></span><span style=display:flex><span>                    f_out<span style=color:#ff7b72;font-weight:700>.</span>writelines(f_in)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            backup_file <span style=color:#ff7b72;font-weight:700>=</span> temp_file
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic># 恢复数据库</span>
</span></span><span style=display:flex><span>        command <span style=color:#ff7b72;font-weight:700>=</span> [
</span></span><span style=display:flex><span>            <span style=color:#a5d6ff>&#39;mysql&#39;</span>,
</span></span><span style=display:flex><span>            <span style=color:#79c0ff>f</span><span style=color:#a5d6ff>&#39;--host=</span><span style=color:#a5d6ff>{</span>self<span style=color:#ff7b72;font-weight:700>.</span>host<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>&#39;</span>,
</span></span><span style=display:flex><span>            <span style=color:#79c0ff>f</span><span style=color:#a5d6ff>&#39;--user=</span><span style=color:#a5d6ff>{</span>self<span style=color:#ff7b72;font-weight:700>.</span>user<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>&#39;</span>,
</span></span><span style=display:flex><span>            <span style=color:#79c0ff>f</span><span style=color:#a5d6ff>&#39;--password=</span><span style=color:#a5d6ff>{</span>self<span style=color:#ff7b72;font-weight:700>.</span>password<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>&#39;</span>
</span></span><span style=display:flex><span>        ]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>if</span> database:
</span></span><span style=display:flex><span>            command<span style=color:#ff7b72;font-weight:700>.</span>append(database)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>with</span> open(backup_file, <span style=color:#a5d6ff>&#39;r&#39;</span>) <span style=color:#ff7b72>as</span> f:
</span></span><span style=display:flex><span>            subprocess<span style=color:#ff7b72;font-weight:700>.</span>run(
</span></span><span style=display:flex><span>                command,
</span></span><span style=display:flex><span>                stdin<span style=color:#ff7b72;font-weight:700>=</span>f,
</span></span><span style=display:flex><span>                stderr<span style=color:#ff7b72;font-weight:700>=</span>subprocess<span style=color:#ff7b72;font-weight:700>.</span>PIPE,
</span></span><span style=display:flex><span>                check<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#79c0ff>True</span>
</span></span><span style=display:flex><span>            )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic># 清理临时文件</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>if</span> backup_file<span style=color:#ff7b72;font-weight:700>.</span>endswith(<span style=color:#a5d6ff>&#39;.sql&#39;</span>):
</span></span><span style=display:flex><span>            os<span style=color:#ff7b72;font-weight:700>.</span>remove(backup_file)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>list_backups</span>(self) <span style=color:#ff7b72;font-weight:700>-&gt;</span> List[dict]:
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;列出备份文件&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        backups <span style=color:#ff7b72;font-weight:700>=</span> []
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>for</span> filename <span style=color:#ff7b72;font-weight:700>in</span> os<span style=color:#ff7b72;font-weight:700>.</span>listdir(self<span style=color:#ff7b72;font-weight:700>.</span>backup_dir):
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>if</span> filename<span style=color:#ff7b72;font-weight:700>.</span>endswith(<span style=color:#a5d6ff>&#39;.sql.gz&#39;</span>):
</span></span><span style=display:flex><span>                filepath <span style=color:#ff7b72;font-weight:700>=</span> os<span style=color:#ff7b72;font-weight:700>.</span>path<span style=color:#ff7b72;font-weight:700>.</span>join(self<span style=color:#ff7b72;font-weight:700>.</span>backup_dir, filename)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                stat <span style=color:#ff7b72;font-weight:700>=</span> os<span style=color:#ff7b72;font-weight:700>.</span>stat(filepath)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                backups<span style=color:#ff7b72;font-weight:700>.</span>append({
</span></span><span style=display:flex><span>                    <span style=color:#a5d6ff>&#39;filename&#39;</span>: filename,
</span></span><span style=display:flex><span>                    <span style=color:#a5d6ff>&#39;size&#39;</span>: stat<span style=color:#ff7b72;font-weight:700>.</span>st_size,
</span></span><span style=display:flex><span>                    <span style=color:#a5d6ff>&#39;created_at&#39;</span>: datetime<span style=color:#ff7b72;font-weight:700>.</span>fromtimestamp(stat<span style=color:#ff7b72;font-weight:700>.</span>st_ctime)
</span></span><span style=display:flex><span>                })
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> sorted(backups, key<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#ff7b72>lambda</span> x: x[<span style=color:#a5d6ff>&#39;created_at&#39;</span>], reverse<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#79c0ff>True</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>cleanup_old_backups</span>(self, keep_days: int <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>7</span>):
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;清理旧备份&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>from</span> <span style=color:#ff7b72>datetime</span> <span style=color:#ff7b72>import</span> timedelta
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        cutoff_time <span style=color:#ff7b72;font-weight:700>=</span> datetime<span style=color:#ff7b72;font-weight:700>.</span>now() <span style=color:#ff7b72;font-weight:700>-</span> timedelta(days<span style=color:#ff7b72;font-weight:700>=</span>keep_days)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>for</span> filename <span style=color:#ff7b72;font-weight:700>in</span> os<span style=color:#ff7b72;font-weight:700>.</span>listdir(self<span style=color:#ff7b72;font-weight:700>.</span>backup_dir):
</span></span><span style=display:flex><span>            filepath <span style=color:#ff7b72;font-weight:700>=</span> os<span style=color:#ff7b72;font-weight:700>.</span>path<span style=color:#ff7b72;font-weight:700>.</span>join(self<span style=color:#ff7b72;font-weight:700>.</span>backup_dir, filename)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            stat <span style=color:#ff7b72;font-weight:700>=</span> os<span style=color:#ff7b72;font-weight:700>.</span>stat(filepath)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>if</span> datetime<span style=color:#ff7b72;font-weight:700>.</span>fromtimestamp(stat<span style=color:#ff7b72;font-weight:700>.</span>st_ctime) <span style=color:#ff7b72;font-weight:700>&lt;</span> cutoff_time:
</span></span><span style=display:flex><span>                os<span style=color:#ff7b72;font-weight:700>.</span>remove(filepath)
</span></span><span style=display:flex><span>                print(<span style=color:#79c0ff>f</span><span style=color:#a5d6ff>&#34;Removed old backup: </span><span style=color:#a5d6ff>{</span>filename<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>&#34;</span>)
</span></span></code></pre></td></tr></table></div></div><h2 id=总结>总结<a hidden class=anchor aria-hidden=true href=#总结>#</a></h2><p>构建高性能的数据架构需要：</p><ol><li><strong>索引优化</strong>：合理设计索引，提升查询性能</li><li><strong>查询优化</strong>：优化SQL语句，避免全表扫描</li><li><strong>分库分表</strong>：按业务特点选择合适的分片策略</li><li><strong>分布式存储</strong>：使用分布式数据库和缓存</li><li><strong>监控运维</strong>：建立完善的监控和备份机制</li></ol><blockquote><p><strong>相关工具推荐</strong></p><ul><li><a href=https://www.util.cn/tools/sql-formatter/>SQL格式化工具</a> - SQL美化</li><li><a href=https://www.util.cn/tools/json-formatter/>JSON格式化工具</a> - JSON数据处理</li><li><a href=https://www.util.cn/tools/base64-encode/>Base64编码工具</a> - 编码转换</li></ul></blockquote></div><footer class=post-footer-modern><div class=post-tags-modern><span class=tags-label>🏷️ 标签</span><div class=tags-list><a href=/blog/tags/%E6%95%B0%E6%8D%AE%E5%BA%93%E4%BC%98%E5%8C%96/ class=tag-pill>数据库优化
</a><a href=/blog/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E5%AD%98%E5%82%A8/ class=tag-pill>分布式存储
</a><a href=/blog/tags/%E7%B4%A2%E5%BC%95%E4%BC%98%E5%8C%96/ class=tag-pill>索引优化
</a><a href=/blog/tags/%E6%9F%A5%E8%AF%A2%E4%BC%98%E5%8C%96/ class=tag-pill>查询优化
</a><a href=/blog/tags/%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8/ class=tag-pill>分库分表</a></div></div><style>.post-footer-modern{margin-top:3rem;padding-top:2rem;border-top:1px solid var(--border,#333333)}.post-tags-modern{display:flex;align-items:center;gap:1rem;margin-bottom:2rem;flex-wrap:wrap}.tags-label{font-size:.875rem;font-weight:600;color:var(--secondary,#999999) !important;white-space:nowrap}.tags-list{display:flex;flex-wrap:wrap;gap:.5rem;flex:1}.tag-pill{display:inline-block;padding:.25rem .75rem;background:rgba(255,255,255,5%);border:1px solid var(--border,#333333);border-radius:0;color:var(--secondary,#cccccc) !important;text-decoration:none;font-size:.8rem;font-weight:500;transition:all .2s ease}.tag-pill:hover{background:var(--primary,#ffffff);color:var(--background,#000000) !important;border-color:var(--primary,#ffffff);transform:translateY(-1px)}.post-nav-modern{margin-top:2rem}.nav-grid{display:grid;grid-template-columns:1fr 1fr;gap:1rem}.nav-card{display:flex;align-items:center;gap:1rem;padding:1.25rem;background:rgba(255,255,255,2%);border:1px solid var(--border,#333333);border-radius:12px;text-decoration:none;transition:all .2s ease;min-height:80px}.nav-card:hover{background:rgba(255,255,255,5%);border-color:var(--primary,#ffffff);transform:translateY(-2px)}.nav-card.nav-prev{justify-content:flex-start}.nav-card.nav-next{justify-content:flex-end;text-align:right}.nav-card.nav-next .nav-content{text-align:right}.nav-empty{display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,1%);border:1px dashed var(--border,#333333);color:var(--secondary,#666666)}.nav-arrow{font-size:1.5rem;color:var(--primary,#ffffff);font-weight:300}.nav-content{flex:1}.nav-title{font-size:.95rem;font-weight:600;color:var(--primary,#ffffff) !important;line-height:1.4;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}[data-theme=light] .post-footer-modern{border-color:var(--border-light,#dee2e6)}[data-theme=light] .tags-label{color:var(--secondary-light,#6c757d) !important}[data-theme=light] .tag-pill{background:rgba(0,0,0,5%);border-color:var(--border-light,#dee2e6);color:var(--secondary-light,#495057) !important}[data-theme=light] .tag-pill:hover{background:var(--primary-light,#0066cc);color:var(--background-light,#ffffff) !important;border-color:var(--primary-light,#0066cc)}[data-theme=light] .nav-card{background:rgba(0,0,0,2%);border-color:var(--border-light,#dee2e6)}[data-theme=light] .nav-card:hover{background:rgba(0,102,204,5%);border-color:var(--primary-light,#0066cc)}[data-theme=light] .nav-empty{background:rgba(0,0,0,1%);border-color:var(--border-light,#dee2e6);color:var(--secondary-light,#6c757d)}[data-theme=light] .nav-arrow{color:var(--primary-light,#0066cc)}[data-theme=light] .nav-title{color:var(--primary-light,#212529) !important}@media(max-width:768px){.nav-grid{grid-template-columns:1fr;gap:.75rem}.nav-card{padding:1rem;min-height:70px}.nav-card.nav-next{text-align:left}.nav-card.nav-next .nav-content{text-align:left}.nav-title{font-size:.875rem}.post-tags-modern{flex-direction:column;gap:.75rem}}@media(max-width:480px){.nav-arrow{font-size:1.25rem}.nav-card{padding:.875rem}.nav-title{font-size:.8rem;-webkit-line-clamp:1}}</style><nav class=post-nav-modern><div class=nav-grid><a href=/blog/articles/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E4%B8%8E%E6%BC%8F%E6%B4%9E%E6%B7%B1%E5%BA%A6%E5%88%86%E6%9E%90%E4%BB%8E%E6%94%BB%E5%87%BB%E5%88%B0%E9%98%B2%E5%BE%A1%E7%9A%84%E5%AE%8C%E6%95%B4%E6%8C%87%E5%8D%97/ class="nav-card nav-prev"><div class=nav-arrow>←</div><div class=nav-content><div class=nav-title>网络安全与漏洞深度分析：从攻击到防御的完整指南</div></div></a><a href=/blog/articles/%E8%B7%A8%E5%B9%B3%E5%8F%B0%E7%A7%BB%E5%8A%A8%E5%BC%80%E5%8F%91%E5%AE%8C%E5%85%A8%E6%8C%87%E5%8D%97react-native%E4%B8%8Eflutter%E6%B7%B1%E5%BA%A6%E5%AE%9E%E8%B7%B5/ class="nav-card nav-next"><div class=nav-content><div class=nav-title>跨平台移动开发完全指南：React Native与Flutter深度实践</div></div><div class=nav-arrow>→</div></a></div></nav></footer></main><aside class=post-sidebar><div class=sidebar-toc id=sidebar-toc><div class=toc-header><div class=toc-title>目录</div><button class=toc-toggle id=toc-toggle aria-label="Toggle TOC">
<svg class="toc-toggle-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6 6 18M6 6l12 12"/></svg></button></div><div class=toc-content id=toc-content><ul class=toc-list><li class="toc-item toc-h2"><a href=#h2-0 class=toc-item-link><span class=toc-item-text>引言</span></a></li><li class="toc-item toc-h2"><a href=#h2-1 class=toc-item-link><span class=toc-item-text>一、数据库性能优化</span></a></li><li class="toc-item toc-h2"><a href=#h2-2 class=toc-item-link><span class=toc-item-text>二、分库分表策略</span></a></li><li class="toc-item toc-h2"><a href=#h2-3 class=toc-item-link><span class=toc-item-text>三、分布式数据库</span></a></li><li class="toc-item toc-h2"><a href=#h2-4 class=toc-item-link><span class=toc-item-text>四、数据库监控与运维</span></a></li><li class="toc-item toc-h2"><a href=#h2-5 class=toc-item-link><span class=toc-item-text>总结</span></a></li></ul></div></div><script>document.addEventListener("DOMContentLoaded",function(){const e=document.getElementById("sidebar-toc"),t=document.getElementById("toc-toggle"),o=document.getElementById("toc-content"),i=t?.querySelector(".toc-toggle-icon");if(!e)return;let n=!1;t&&t.addEventListener("click",function(){n=!n,n?(o.style.display="none",e.style.width="auto",i.innerHTML='<path d="M9 18l6-6-6-6"/>'):(o.style.display="block",e.style.width="200px",i.innerHTML='<path d="M18 6L6 18M6 6l12 12"/>')});const s=document.querySelector(".post-content");if(s){const e=s.querySelectorAll("h1");e.forEach((e,t)=>{e.id=`h1-${t}`});const t=s.querySelectorAll("h2");t.forEach((e,t)=>{e.id=`h2-${t}`})}const a=document.querySelectorAll(".toc-item-link");a.forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();const n=this.getAttribute("href").substring(1),t=document.getElementById(n);if(t){const e=document.querySelector(".post-header-main")?.offsetHeight||0,n=t.offsetTop-e-20;window.scrollTo({top:n,behavior:"smooth"})}})})})</script><style>.sidebar-toc{position:sticky;top:2rem;width:200px;background:#fff;border:1px solid #e5e7eb;border-radius:4px;overflow:hidden;box-shadow:0 1px 3px rgba(0,0,0,.1);z-index:100}.sidebar-toc.hidden{display:none}.toc-header{padding:12px 16px;border-bottom:1px solid #e5e7eb;background:#fafbfc;display:flex;align-items:center;justify-content:space-between}.toc-title{margin:0;font-size:13px;font-weight:500;color:#374151 !important;font-family:-apple-system,BlinkMacSystemFont,segoe ui,Roboto,sans-serif;text-transform:uppercase;letter-spacing:1px}.toc-toggle{background:0 0;border:none;cursor:pointer;padding:4px;border-radius:4px;display:flex;align-items:center;justify-content:center;transition:all .2s ease;color:#6b7280}.toc-toggle:hover{background:#e5e7eb;color:#374151}.toc-toggle-icon{transition:transform .2s ease}.toc-content{padding:12px 0}.toc-list{list-style:none;margin:0;padding:0}.toc-item{margin-bottom:4px;display:block !important;visibility:visible !important}.toc-h1,.toc-h2{display:block !important}.toc-h2{margin-left:0}.toc-item-link{display:flex;align-items:center;gap:8px;padding:8px 12px;color:#374151 !important;text-decoration:none;font-size:13px;line-height:1.4;border-radius:3px;transition:all .2s ease;font-weight:400}.toc-item-link:hover{background:#f8fafc;color:#1f2937 !important}.toc-item-link.active{background:#e0f2fe;color:#01579b !important;font-weight:500}.toc-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}.dot-red{background:#ef4444}.dot-blue{background:#2196f3}.toc-item-text{color:#1f2937 !important;font-weight:400;flex:1;display:inline !important;visibility:visible !important;opacity:1 !important;font-size:13px !important;line-height:1.4 !important}.toc-item-link .toc-item-text{color:#1f2937 !important;display:inline !important;visibility:visible !important;opacity:1 !important}.toc-item.active .dot-red{background:#d32f2f}.toc-item.active .dot-blue{background:#1976d2}[data-theme=dark] .sidebar-toc{background:#1f2937;border-color:#374151;box-shadow:0 1px 3px rgba(0,0,0,.3)}[data-theme=dark] .toc-header{background:#111827;border-color:#374151}[data-theme=dark] .toc-title{color:#f3f4f6 !important}[data-theme=dark] .toc-toggle{color:#9ca3af}[data-theme=dark] .toc-toggle:hover{background:#374151;color:#f3f4f6}[data-theme=dark] .toc-item-link{color:#e5e7eb !important}[data-theme=dark] .toc-item-link:hover{background:#374151;color:#f9fafb !important}[data-theme=dark] .toc-item-link.active{background:#0d47a1;color:#fff !important}[data-theme=dark] .toc-item-text{color:#f9fafb !important;display:inline !important;visibility:visible !important;opacity:1 !important}[data-theme=dark] .toc-item-link .toc-item-text{color:#f9fafb !important;display:inline !important;visibility:visible !important;opacity:1 !important}@media(max-width:1024px){.sidebar-toc{display:none}.post-content-wrapper{grid-template-columns:1fr !important;padding:0 1rem !important}}</style><style>.post-content-wrapper{display:grid;grid-template-columns:1fr 200px;gap:2rem;padding:0 2rem;max-width:100%}.post-content-main{min-width:0}.post-sidebar{position:sticky;top:2rem;height:fit-content;min-width:0}.post-header-main{margin-bottom:2rem;padding-bottom:1rem;border-bottom:1px solid var(--border,#333333)}.post-header-main .post-title{color:var(--primary,#ffffff) !important;font-size:2.5rem;font-weight:700;line-height:1.2;margin-bottom:1rem}.post-header-main .post-description{color:var(--secondary,#cccccc) !important;font-size:1.1rem;line-height:1.6;margin-bottom:1rem}.post-header-main .post-meta{margin-bottom:0}@media(max-width:1024px){.post-content-wrapper{grid-template-columns:1fr !important;gap:1rem;padding:0 1rem !important}.post-sidebar{display:none}}@media(max-width:768px){.post-header-main .post-title{font-size:2rem}.post-header-main .post-description{font-size:1rem}}</style></aside></div></article></main><footer class=footer><span>© 2024-2025 有条工具技术博客</span> ·</footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");if(menu){const e=localStorage.getItem("menu-scroll-position");e&&(menu.scrollLeft=parseInt(e,10)),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}}document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{const e=document.querySelector("html");e.dataset.theme==="dark"?(e.dataset.theme="light",localStorage.setItem("pref-theme","light")):(e.dataset.theme="dark",localStorage.setItem("pref-theme","dark"))})</script></body></html>