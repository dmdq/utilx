<!doctype html><html lang=zh-cn dir=auto data-theme=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>后端系统架构设计：从单体到微服务的演进之路 | 技术博客 - 有条工具</title><meta name=keywords content="后端架构设计,微服务架构,分布式系统设计,服务治理,容错设计,系统可扩展性,高并发架构"><meta name=description content="深入探讨后端系统架构设计，涵盖单体架构、微服务架构、分布式系统、服务治理、容错设计等核心主题，帮助工程师构建高可用、可扩展的后端系统。"><meta name=author content="有条工具团队"><link rel=canonical href=/blog/articles/%E5%90%8E%E7%AB%AF%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1%E4%BB%8E%E5%8D%95%E4%BD%93%E5%88%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%E7%9A%84%E6%BC%94%E8%BF%9B%E4%B9%8B%E8%B7%AF/><link crossorigin=anonymous href=/blog/assets/css/stylesheet.7e8505b7cdf8bb22ab2305e53c2700bb06c7e64faeb72cd3468823a9a3bd3d6e.css integrity="sha256-foUFt834uyKrIwXlPCcAuwbH5k+utyzTRogjqaO9PW4=" rel="preload stylesheet" as=style><link rel=icon href=/favicon.ico><link rel=icon type=image/png sizes=16x16 href=/blog/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=/blog/favicon-32x32.png><link rel=apple-touch-icon href=/blog/apple-touch-icon.png><link rel=mask-icon href=/blog/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate type=application/rss+xml href=/blog/articles/%E5%90%8E%E7%AB%AF%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1%E4%BB%8E%E5%8D%95%E4%BD%93%E5%88%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%E7%9A%84%E6%BC%94%E8%BF%9B%E4%B9%8B%E8%B7%AF/feed.xml title=rss><link rel=alternate hreflang=zh-cn href=/blog/articles/%E5%90%8E%E7%AB%AF%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1%E4%BB%8E%E5%8D%95%E4%BD%93%E5%88%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%E7%9A%84%E6%BC%94%E8%BF%9B%E4%B9%8B%E8%B7%AF/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51);color-scheme:dark}.list{background:var(--theme)}.toc{background:var(--entry)}}@media(prefers-color-scheme:light){.list::-webkit-scrollbar-thumb{border-color:var(--code-bg)}}</style></noscript><script>localStorage.getItem("pref-theme")==="dark"?document.querySelector("html").dataset.theme="dark":localStorage.getItem("pref-theme")==="light"?document.querySelector("html").dataset.theme="light":window.matchMedia("(prefers-color-scheme: dark)").matches?document.querySelector("html").dataset.theme="dark":document.querySelector("html").dataset.theme="light"</script><script src=/js/external-link-config.js></script><script src=/js/external-link-interceptor.js></script><link rel=stylesheet href=/blog/css/custom.css media=screen><script type=application/ld+json>{"@context":"https://schema.org","@type":"WebSite","name":"技术博客 - 有条工具 | 开发者工具使用教程 & 编程技巧分享","url":"https://www.util.cn/blog/","description":"有条工具技术博客 - 分享开发者工具使用教程、编程技巧和实战开发经验。提供JSON格式化、SQL优化、Markdown编辑器等在线工具的详细使用指南，帮助开发者提升工作效率。","publisher":{"@type":"Organization","name":"有条工具","url":"https://www.util.cn","logo":{"@type":"ImageObject","url":"https://www.util.cn/blog/logo/logo-256.png","width":256,"height":256}},"potentialAction":[{"@type":"SearchAction","target":"https://www.util.cn/blog/search?q={search_term_string}","query-input":"required name=search_term_string"}]}</script><meta property="og:type" content="website"><meta property="og:title" content="技术博客 - 有条工具 | 开发者工具使用教程 & 编程技巧分享"><meta property="og:description" content="有条工具技术博客 - 分享开发者工具使用教程、编程技巧和实战开发经验。提供JSON格式化、SQL优化、Markdown编辑器等在线工具的详细使用指南，帮助开发者提升工作效率。"><meta property="og:url" content="https://www.util.cn/blog/"><meta property="og:site_name" content="有条工具技术博客"><meta property="og:image" content="https://www.util.cn/blog/logo/logo-256.png"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="630"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="技术博客 - 有条工具 | 开发者工具使用教程 & 编程技巧分享"><meta name=twitter:description content="有条工具技术博客 - 分享开发者工具使用教程、编程技巧和实战开发经验。"><meta name=twitter:image content="https://www.util.cn/blog/logo/logo-256.png"><meta name=baidu-site-verification content><meta name=category content="技术博客,开发者工具,编程教程"><meta name=coverage content="Worldwide"><meta name=distribution content="Global"><meta name=rating content="General"><script id=51la_code async crossorigin=anonymous src="https://sdk.51.la/js-sdk-pro.min.js?id=3OM52V0xJAPv6ozF&hash=pro"></script><script>window.addEventListener("load",function(){setTimeout(function(){typeof la!="undefined"?console.log("51la统计已加载"):(console.warn("51la统计加载失败，使用备用方案"),function(){var e=document.createElement("script");e.src="https://sdk.51.la/js-sdk-pro.min.js?id=3OM52V0xJAPv6ozF&hash=backup",e.async=!0,document.head.appendChild(e)}())},3e3)})</script><meta property="og:url" content="/blog/articles/%E5%90%8E%E7%AB%AF%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1%E4%BB%8E%E5%8D%95%E4%BD%93%E5%88%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%E7%9A%84%E6%BC%94%E8%BF%9B%E4%B9%8B%E8%B7%AF/"><meta property="og:site_name" content="技术博客 - 有条工具"><meta property="og:title" content="后端系统架构设计：从单体到微服务的演进之路"><meta property="og:description" content="深入探讨后端系统架构设计，涵盖单体架构、微服务架构、分布式系统、服务治理、容错设计等核心主题，帮助工程师构建高可用、可扩展的后端系统。"><meta property="og:locale" content="zh-cn"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-12-30T11:00:00+08:00"><meta property="article:modified_time" content="2025-12-30T11:00:00+08:00"><meta property="article:tag" content="微服务"><meta property="article:tag" content="分布式系统"><meta property="article:tag" content="系统设计"><meta property="article:tag" content="服务治理"><meta property="article:tag" content="高可用"><meta name=twitter:card content="summary"><meta name=twitter:title content="后端系统架构设计：从单体到微服务的演进之路"><meta name=twitter:description content="深入探讨后端系统架构设计，涵盖单体架构、微服务架构、分布式系统、服务治理、容错设计等核心主题，帮助工程师构建高可用、可扩展的后端系统。"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"所有文章","item":"/blog/posts/"},{"@type":"ListItem","position":2,"name":"后端系统架构设计：从单体到微服务的演进之路","item":"/blog/articles/%E5%90%8E%E7%AB%AF%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1%E4%BB%8E%E5%8D%95%E4%BD%93%E5%88%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%E7%9A%84%E6%BC%94%E8%BF%9B%E4%B9%8B%E8%B7%AF/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"后端系统架构设计：从单体到微服务的演进之路","name":"后端系统架构设计：从单体到微服务的演进之路","description":"深入探讨后端系统架构设计，涵盖单体架构、微服务架构、分布式系统、服务治理、容错设计等核心主题，帮助工程师构建高可用、可扩展的后端系统。","keywords":["后端架构设计","微服务架构","分布式系统设计","服务治理","容错设计","系统可扩展性","高并发架构"],"articleBody":"引言 随着业务规模的不断扩大，后端系统架构需要不断演进以应对日益增长的挑战。从单体应用到微服务架构，从单机部署到分布式集群，每一次架构演进都是为了解决特定的痛点。本文将深入探讨后端系统架构设计的核心原则、模式与实践。\n一、架构演进历程 1.1 架构演进路径 单体应用 → 分层架构 → SOA → 微服务 → Serverless 演进阶段对比\n架构类型 特点 优势 挑战 适用场景 单体应用 单一代码库、单一部署 开发简单、部署容易 扩展性差、技术栈固定 小型项目、初创期 分层架构 MVC/MVP分层 职责清晰、易于维护 层间耦合强 中小型项目 SOA 服务化、ESB总线 服务复用、松耦合 ESB单点、复杂度高 企业级应用 微服务 独立服务、自治部署 独立扩展、技术自由 运维复杂、分布式事务 大型复杂系统 Serverless 函数级、按需付费 极致弹性、成本优化 厂商锁定、冷启动 事件驱动、波峰明显 1.2 单体架构的局限性 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 # 单体应用的典型问题 # 问题1: 代码耦合严重 # 一个请求的处理流程涉及多个模块 class OrderService: def create_order(self, user_id, items): # 直接依赖多个模块 user = UserService().get_user(user_id) inventory = InventoryService().check_stock(items) payment = PaymentService().process_payment(items) shipping = ShippingService().calculate_shipping(user.address) notification = NotificationService().send_confirmation(user.email) # 如果任何一个模块出错，整个订单创建失败 return Order(user=user, items=items, payment=payment) # 问题2: 难以独立扩展 # 当订单服务压力大时，必须整体扩展 # 无法针对特定瓶颈服务单独扩容 # 问题3: 技术栈锁定 # 整个应用必须使用相同的语言和框架 # 无法为新服务选择更适合的技术 # 问题4: 部署风险高 # 任何小的修改都需要重新部署整个应用 # 一处bug可能影响整个系统 二、微服务架构设计 2.1 核心设计原则 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 # ========== 服务拆分原则 ========== # 1. 单一职责原则 # 每个服务专注于一个业务领域 class UserService: \"\"\"用户服务 - 只负责用户相关的业务\"\"\" def create_user(self, data): pass def get_user(self, user_id): pass def update_user(self, user_id, data): pass class OrderService: \"\"\"订单服务 - 只负责订单相关的业务\"\"\" def create_order(self, data): pass def get_order(self, order_id): pass def cancel_order(self, order_id): pass # 2. 限界上下文原则 # 按照业务领域边界拆分服务 # DDD (Domain-Driven Design) 战术模式 # 3. 数据独立性原则 # 每个服务拥有独立的数据库 class UserDatabase: \"\"\"用户服务的数据库\"\"\" def __init__(self): self.db = PostgreSQL('users_db') class OrderDatabase: \"\"\"订单服务的数据库\"\"\" def __init__(self): self.db = MongoDB('orders_db') # 4. API网关原则 # 统一入口，路由转发 class APIGateway: \"\"\"API网关 - 服务统一入口\"\"\" def __init__(self): self.routes = { '/api/users/*': UserService(), '/api/orders/*': OrderService(), '/api/products/*': ProductService(), '/api/payments/*': PaymentService() } def route(self, request): # 路由匹配 for pattern, service in self.routes.items(): if request.path.match(pattern): return service.handle(request) # 聚合多个服务的响应 if request.path == '/api/dashboard': return self.aggregate_dashboard(request) def aggregate_dashboard(self, request): \"\"\"聚合多个服务的数据\"\"\" user_data = self.call_service('/api/users/me', request) order_data = self.call_service('/api/orders/recent', request) notification_data = self.call_service('/api/notifications', request) return { 'user': user_data, 'orders': order_data, 'notifications': notification_data } 2.2 服务通信模式 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 # ========== 同步通信: REST/gRPC ========== import requests from typing import Protocol # REST API调用 class OrderClient: \"\"\"订单服务客户端\"\"\" BASE_URL = \"http://order-service:8080\" def create_order(self, order_data: dict) -\u003e dict: response = requests.post( f\"{self.BASE_URL}/api/orders\", json=order_data, timeout=5 # 超时控制 ) response.raise_for_status() return response.json() def get_order(self, order_id: str) -\u003e dict: response = requests.get( f\"{self.BASE_URL}/api/orders/{order_id}\", timeout=3 ) response.raise_for_status() return response.json() # gRPC调用 (性能更高) import grpc from generated import order_pb2, order_pb2_grpc class OrderGRPCClient: \"\"\"订单服务gRPC客户端\"\"\" def __init__(self): self.channel = grpc.insecure_channel('order-service:9090') self.stub = order_pb2_grpc.OrderServiceStub(self.channel) def create_order(self, order_data: dict) -\u003e order_pb2.OrderResponse: request = order_pb2.CreateOrderRequest( user_id=order_data['user_id'], items=[ order_pb2.OrderItem( product_id=item['product_id'], quantity=item['quantity'] ) for item in order_data['items'] ] ) return self.stub.CreateOrder(request, timeout=5) # ========== 异步通信: 消息队列 ========== import asyncio from aio_pika import connect, Message class EventBus: \"\"\"事件总线 - 异步消息传递\"\"\" def __init__(self, amqp_url: str): self.connection = None self.channel = None self.amqp_url = amqp_url async def connect(self): \"\"\"建立连接\"\"\" self.connection = await connect(self.amqp_url) self.channel = await self.connection.channel() # 声明交换机 await self.channel.declare_exchange( 'domain-events', 'topic', durable=True ) async def publish(self, event_type: str, event_data: dict): \"\"\"发布事件\"\"\" exchange = await self.get_exchange() message = Message( json.dumps(event_data).encode(), content_type='application/json', delivery_mode=2 # 持久化 ) await exchange.publish( message, routing_key=event_type ) async def subscribe(self, event_pattern: str, handler): \"\"\"订阅事件\"\"\" exchange = await self.get_exchange() # 声明队列 queue = await self.channel.declare_queue( f'{event_pattern}-queue', durable=True ) # 绑定交换机 await queue.bind(exchange, routing_key=event_pattern) async with queue.iterator() as queue_iter: async for message in queue_iter: try: event_data = json.loads(message.body.decode()) await handler(event_data) await message.ack() except Exception as e: await message.nack() # 事件驱动架构示例 class OrderCreatedEvent: \"\"\"订单创建事件\"\"\" def __init__(self, order_id, user_id, items): self.event_type = 'order.created' self.data = { 'order_id': order_id, 'user_id': user_id, 'items': items, 'timestamp': datetime.now().isoformat() } # 订单服务发布事件 async def create_order_with_event(order_data): # 创建订单 order = await order_repository.create(order_data) # 发布事件 event_bus = EventBus() await event_bus.publish( 'order.created', OrderCreatedEvent( order.id, order.user_id, order.items ).data ) return order # 库存服务监听事件 async def handle_order_created(event_data): \"\"\"处理订单创建事件 - 扣减库存\"\"\" order_id = event_data['order_id'] items = event_data['items'] for item in items: await inventory_service.deduct_stock( item['product_id'], item['quantity'] ) await event_bus.publish( 'inventory.deducted', {'order_id': order_id, 'status': 'completed'} ) # 通知服务监听事件 async def handle_inventory_deducted(event_data): \"\"\"处理库存扣减完成事件 - 发送通知\"\"\" order_id = event_data['order_id'] order = await order_repository.get(order_id) await notification_service.send_order_confirmation( order.user_email, order_id ) 2.3 服务发现与注册 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 # ========== 服务注册中心 ========== import asyncio from typing import Dict, List, Optional from datetime import datetime, timedelta class ServiceInstance: \"\"\"服务实例\"\"\" def __init__(self, service_id: str, address: str, port: int): self.service_id = service_id self.address = address self.port = port self.last_heartbeat = datetime.now() @property def url(self) -\u003e str: return f\"http://{self.address}:{self.port}\" def is_alive(self, timeout: int = 10) -\u003e bool: \"\"\"检查实例是否存活\"\"\" return (datetime.now() - self.last_heartbeat).seconds \u003c timeout class ServiceRegistry: \"\"\"服务注册中心\"\"\" def __init__(self): self.services: Dict[str, List[ServiceInstance]] = {} def register(self, service_name: str, instance: ServiceInstance): \"\"\"注册服务实例\"\"\" if service_name not in self.services: self.services[service_name] = [] # 检查是否已存在 existing = next( (i for i in self.services[service_name] if i.service_id == instance.service_id), None ) if existing: # 更新心跳时间 existing.last_heartbeat = datetime.now() else: # 新注册 self.services[service_name].append(instance) print(f\"Registered: {service_name} - {instance.url}\") def deregister(self, service_name: str, service_id: str): \"\"\"注销服务实例\"\"\" if service_name in self.services: self.services[service_name] = [ i for i in self.services[service_name] if i.service_id != service_id ] def discover(self, service_name: str) -\u003e Optional[ServiceInstance]: \"\"\"服务发现 - 负载均衡\"\"\" if service_name not in self.services: return None # 过滤掉失效的实例 alive_instances = [ i for i in self.services[service_name] if i.is_alive() ] if not alive_instances: return None # 轮询负载均衡 return alive_instances[hash(service_name) % len(alive_instances)] # 或者使用随机选择 # return random.choice(alive_instances) def heartbeat(self, service_name: str, service_id: str): \"\"\"接收心跳\"\"\" if service_name in self.services: for instance in self.services[service_name]: if instance.service_id == service_id: instance.last_heartbeat = datetime.now() # ========== 服务客户端 ========== class ServiceClient: \"\"\"服务客户端 - 带服务发现\"\"\" def __init__(self, registry: ServiceRegistry): self.registry = registry self.cache = {} # 缓存服务地址 async def call(self, service_name: str, endpoint: str, **kwargs): \"\"\"调用服务\"\"\" # 从缓存或注册中心获取服务地址 instance = self.cache.get(service_name) if not instance or not instance.is_alive(): instance = self.registry.discover(service_name) if not instance: raise ServiceUnavailableException(f\"Service {service_name} not found\") self.cache[service_name] = instance # 构建请求URL url = f\"{instance.url}{endpoint}\" try: response = requests.post(url, json=kwargs, timeout=5) response.raise_for_status() return response.json() except requests.RequestException as e: # 调用失败，清除缓存 self.cache.pop(service_name, None) raise e # ========== 使用示例 ========== # 服务启动时注册 registry = ServiceRegistry() async def start_service(): service_instance = ServiceInstance( service_id=f\"order-service-{os.getenv('INSTANCE_ID')}\", address=os.getenv('SERVICE_ADDRESS'), port=int(os.getenv('SERVICE_PORT')) ) registry.register('order-service', service_instance) # 定期发送心跳 while True: await asyncio.sleep(5) registry.heartbeat('order-service', service_instance.service_id) 2.4 分布式配置管理 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 # ========== 配置中心 ========== import asyncio import json from typing import Any, Callable from watchfiles import awatch class ConfigCenter: \"\"\"分布式配置中心\"\"\" def __init__(self, config_dir: str = './config'): self.config_dir = config_dir self.configs = {} self.watchers = {} # config_key -\u003e [callbacks] def load_config(self, service_name: str) -\u003e dict: \"\"\"加载服务配置\"\"\" config_file = f\"{self.config_dir}/{service_name}.json\" try: with open(config_file) as f: config = json.load(f) self.configs[service_name] = config return config except FileNotFoundError: return {} def get_config(self, service_name: str, key: str = None) -\u003e Any: \"\"\"获取配置\"\"\" config = self.configs.get(service_name, {}) if key: return config.get(key) return config def watch_config(self, service_name: str, callback: Callable): \"\"\"监听配置变化\"\"\" if service_name not in self.watchers: self.watchers[service_name] = [] self.watchers[service_name].append(callback) async def watch_changes(self): \"\"\"监听配置文件变化\"\"\" async for changes in awatch(self.config_dir): for change_type, config_path in changes: service_name = config_path.stem if change_type == Change.modified: # 重新加载配置 old_config = self.configs.get(service_name, {}) new_config = self.load_config(service_name) # 触发回调 if service_name in self.watchers: for callback in self.watchers[service_name]: await callback(old_config, new_config) # ========== 使用示例 ========== config_center = ConfigCenter() # 加载配置 app_config = config_center.load_config('order-service') # 监听配置变化 async def on_config_changed(old_config, new_config): \"\"\"配置变化处理\"\"\" if old_config.get('log_level') != new_config.get('log_level'): # 重新配置日志级别 logging.getLogger().setLevel(new_config['log_level']) if old_config.get('database') != new_config.get('database'): # 重新建立数据库连接 await reconnect_database(new_config['database']) config_center.watch_config('order-service', on_config_changed) 三、数据一致性设计 3.1 分布式事务 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 # ========== 两阶段提交 (2PC) ========== class TwoPhaseCommit: \"\"\"两阶段提交协调者\"\"\" def __init__(self): self.participants = [] def register_participant(self, participant): \"\"\"注册参与者\"\"\" self.participants.append(participant) async def execute(self, transaction_data): \"\"\"执行分布式事务\"\"\" transaction_id = generate_transaction_id() # 阶段1: 准备阶段 prepared = [] for participant in self.participants: try: result = await participant.prepare(transaction_id, transaction_data) if result == 'PREPARED': prepared.append(participant) else: # 任何参与者拒绝，回滚所有 await self._rollback_all(transaction_id, prepared) return False except Exception as e: await self._rollback_all(transaction_id, prepared) raise e # 阶段2: 提交阶段 committed = [] for participant in prepared: try: await participant.commit(transaction_id) committed.append(participant) except Exception as e: # 提交失败，需要人工介入 await self._rollback_all(transaction_id, committed) raise Exception(f\"Commit failed: {e}\") return True async def _rollback_all(self, transaction_id, participants): \"\"\"回滚所有参与者\"\"\" for participant in participants: try: await participant.rollback(transaction_id) except Exception as e: logging.error(f\"Rollback failed: {e}\") # ========== Saga模式 ========== # 长事务的替代方案 class SagaOrchestrator: \"\"\"Saga编排器\"\"\" def __init__(self): self.steps = [] self.compensations = [] def add_step(self, action, compensation): \"\"\"添加步骤\"\"\" self.steps.append(action) self.compensations.append(compensation) async def execute(self, initial_data): \"\"\"执行Saga\"\"\" context = initial_data executed_steps = [] # 执行每个步骤 for i, step in enumerate(self.steps): try: context = await step(context) executed_steps.append(i) except Exception as e: # 失败，执行补偿 await self._compensate(executed_steps, context) raise e return context async def _compensate(self, executed_steps, context): \"\"\"执行补偿事务\"\"\" # 逆序执行补偿 for i in reversed(executed_steps): try: await self.compensations[i](context) except Exception as e: logging.error(f\"Compensation failed: {e}\") # 订单Saga示例 class OrderSaga: \"\"\"订单处理Saga\"\"\" def __init__(self): self.saga = SagaOrchestrator() self._setup_steps() def _setup_steps(self): \"\"\"设置Saga步骤\"\"\" # 步骤1: 创建订单 async def create_order(context): order = await order_repository.create(context['order_data']) context['order'] = order return context async def cancel_order(context): await order_repository.update_status( context['order'].id, 'CANCELLED' ) # 步骤2: 扣减库存 async def deduct_inventory(context): for item in context['order'].items: await inventory_service.deduct_stock( item.product_id, item.quantity ) return context async def restore_inventory(context): for item in context['order'].items: await inventory_service.restore_stock( item.product_id, item.quantity ) # 步骤3: 处理支付 async def process_payment(context): payment = await payment_service.charge( context['order'].user_id, context['order'].total_amount ) context['payment'] = payment return context async def refund_payment(context): await payment_service.refund( context['payment'].transaction_id ) # 步骤4: 发送通知 async def send_notification(context): await notification_service.send( context['order'].user_email, 'Order Created', f'Your order {context[\"order\"].id} has been created' ) return context async def cancel_notification(context): # 通知可能不需要补偿 pass # 添加步骤和补偿 self.saga.add_step(create_order, cancel_order) self.saga.add_step(deduct_inventory, restore_inventory) self.saga.add_step(process_payment, refund_payment) self.saga.add_step(send_notification, cancel_notification) async def execute(self, order_data): \"\"\"执行订单Saga\"\"\" return await self.saga.execute({'order_data': order_data}) 3.2 最终一致性 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 # ========== 事件溯源 ========== # 通过事件流重建状态 class EventStore: \"\"\"事件存储\"\"\" def __init__(self): self.events = [] async def append_event(self, aggregate_id: str, event: dict): \"\"\"追加事件\"\"\" event['aggregate_id'] = aggregate_id event['timestamp'] = datetime.now().isoformat() event['version'] = len(self.events) + 1 self.events.append(event) async def get_events(self, aggregate_id: str) -\u003e List[dict]: \"\"\"获取聚合的所有事件\"\"\" return [ e for e in self.events if e['aggregate_id'] == aggregate_id ] class OrderAggregate: \"\"\"订单聚合 - 通过事件重建状态\"\"\" def __init__(self, event_store: EventStore): self.event_store = event_store self.state = None async def rebuild(self, order_id: str): \"\"\"从事件流重建状态\"\"\" events = await self.event_store.get_events(order_id) state = None for event in events: state = self._apply_event(state, event) self.state = state return state def _apply_event(self, state, event): \"\"\"应用事件到状态\"\"\" event_type = event['type'] if event_type == 'OrderCreated': return { 'id': event['order_id'], 'user_id': event['user_id'], 'items': event['items'], 'status': 'CREATED' } elif event_type == 'PaymentCompleted': state['status'] = 'PAID' state['payment_id'] = event['payment_id'] return state elif event_type == 'OrderShipped': state['status'] = 'SHIPPED' state['shipping_id'] = event['shipping_id'] return state elif event_type == 'OrderCancelled': state['status'] = 'CANCELLED' return state return state async def create_order(self, user_id, items): \"\"\"创建订单\"\"\" event = { 'type': 'OrderCreated', 'order_id': generate_id(), 'user_id': user_id, 'items': items } await self.event_store.append_event(event['order_id'], event) return await self.rebuild(event['order_id']) # ========== CQRS ========== # 命令查询职责分离 class CommandBus: \"\"\"命令总线\"\"\" def __init__(self): self.handlers = {} def register(self, command_type: str, handler): \"\"\"注册命令处理器\"\"\" self.handlers[command_type] = handler async def execute(self, command: dict): \"\"\"执行命令\"\"\" command_type = command['type'] if command_type not in self.handlers: raise ValueError(f\"Unknown command: {command_type}\") return await self.handlers[command_type](command) class QueryBus: \"\"\"查询总线\"\"\" def __init__(self): self.handlers = {} def register(self, query_type: str, handler): \"\"\"注册查询处理器\"\"\" self.handlers[query_type] = handler async def execute(self, query: dict): \"\"\"执行查询\"\"\" query_type = query['type'] if query_type not in self.handlers: raise ValueError(f\"Unknown query: {query_type}\") return await self.handlers[query_type](query) # CQRS示例 class OrderService: \"\"\"订单服务 - CQRS\"\"\" def __init__(self): self.command_bus = CommandBus() self.query_bus = QueryBus() self.event_store = EventStore() self.read_db = {} # 读模型 self._register_handlers() def _register_handlers(self): \"\"\"注册处理器\"\"\" # 命令处理器 self.command_bus.register('CreateOrder', self._handle_create_order) self.command_bus.register('CancelOrder', self._handle_cancel_order) # 查询处理器 self.query_bus.register('GetOrder', self._handle_get_order) self.query_bus.register('ListOrders', self._handle_list_orders) async def _handle_create_order(self, command): \"\"\"处理创建订单命令\"\"\" event = { 'type': 'OrderCreated', 'order_id': command['order_id'], 'user_id': command['user_id'], 'items': command['items'] } await self.event_store.append_event(command['order_id'], event) # 更新读模型 self._update_read_model(event) return event['order_id'] async def _handle_cancel_order(self, command): \"\"\"处理取消订单命令\"\"\" event = { 'type': 'OrderCancelled', 'order_id': command['order_id'] } await self.event_store.append_event(command['order_id'], event) # 更新读模型 self._update_read_model(event) async def _handle_get_order(self, query): \"\"\"处理获取订单查询\"\"\" return self.read_db.get(query['order_id']) async def _handle_list_orders(self, query): \"\"\"处理订单列表查询\"\"\" user_id = query.get('user_id') orders = [ order for order in self.read_db.values() if not user_id or order['user_id'] == user_id ] return orders def _update_read_model(self, event): \"\"\"更新读模型\"\"\" order_id = event['order_id'] if event['type'] == 'OrderCreated': self.read_db[order_id] = { 'id': order_id, 'user_id': event['user_id'], 'items': event['items'], 'status': 'CREATED' } elif event['type'] == 'OrderCancelled': if order_id in self.read_db: self.read_db[order_id]['status'] = 'CANCELLED' 四、容错与高可用设计 4.1 熔断器模式 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 import asyncio from enum import Enum from datetime import datetime, timedelta class CircuitState(Enum): CLOSED = 'CLOSED' # 正常状态 OPEN = 'OPEN' # 熔断状态 HALF_OPEN = 'HALF_OPEN' # 半开状态 class CircuitBreaker: \"\"\"熔断器\"\"\" def __init__( self, failure_threshold: int = 5, timeout: int = 60, half_open_attempts: int = 3 ): self.failure_threshold = failure_threshold self.timeout = timeout self.half_open_attempts = half_open_attempts self.state = CircuitState.CLOSED self.failure_count = 0 self.success_count = 0 self.last_failure_time = None async def call(self, func, *args, **kwargs): \"\"\"通过熔断器调用函数\"\"\" if self.state == CircuitState.OPEN: # 熔断状态，检查是否可以进入半开 if self._should_attempt_reset(): self.state = CircuitState.HALF_OPEN self.success_count = 0 else: raise CircuitBreakerOpenException( f\"Circuit breaker is OPEN. Try again later.\" ) try: result = await func(*args, **kwargs) # 成功，重置计数 self._on_success() return result except Exception as e: # 失败，增加计数 self._on_failure() raise e def _should_attempt_reset(self) -\u003e bool: \"\"\"检查是否应该尝试重置\"\"\" if self.last_failure_time is None: return False elapsed = (datetime.now() - self.last_failure_time).seconds return elapsed \u003e= self.timeout def _on_success(self): \"\"\"处理成功\"\"\" if self.state == CircuitState.HALF_OPEN: self.success_count += 1 # 半开状态下连续成功，恢复关闭状态 if self.success_count \u003e= self.half_open_attempts: self.state = CircuitState.CLOSED self.failure_count = 0 elif self.state == CircuitState.CLOSED: self.failure_count = 0 def _on_failure(self): \"\"\"处理失败\"\"\" self.failure_count += 1 self.last_failure_time = datetime.now() # 达到阈值，打开熔断器 if self.failure_count \u003e= self.failure_threshold: self.state = CircuitState.OPEN # 使用示例 async def call_external_service(url): \"\"\"调用外部服务\"\"\" response = await aiohttp.get(url) return await response.json() # 创建熔断器 circuit_breaker = CircuitBreaker( failure_threshold=5, timeout=60, half_open_attempts=3 ) # 通过熔断器调用 try: result = await circuit_breaker.call( call_external_service, 'http://external-service/api/data' ) except CircuitBreakerOpenException: # 熔断器打开，使用降级逻辑 result = get_cached_data() except Exception as e: # 其他错误处理 logger.error(f\"Service call failed: {e}\") 4.2 重试与超时 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 import asyncio from functools import wraps from typing import Callable, Type class RetryConfig: \"\"\"重试配置\"\"\" def __init__( self, max_attempts: int = 3, base_delay: float = 1.0, max_delay: float = 10.0, exponential_base: float = 2, jitter: bool = True, retry_exceptions: list = None ): self.max_attempts = max_attempts self.base_delay = base_delay self.max_delay = max_delay self.exponential_base = exponential_base self.jitter = jitter self.retry_exceptions = retry_exceptions or [Exception] def retry(config: RetryConfig = None): \"\"\"重试装饰器\"\"\" if config is None: config = RetryConfig() def decorator(func: Callable): @wraps(func) async def wrapper(*args, **kwargs): last_exception = None for attempt in range(1, config.max_attempts + 1): try: return await func(*args, **kwargs) except tuple(config.retry_exceptions) as e: last_exception = e if attempt \u003c config.max_attempts: # 计算延迟时间 delay = min( config.base_delay * (config.exponential_base ** (attempt - 1)), config.max_delay ) # 添加抖动 if config.jitter: delay = delay * (0.5 + random.random() * 0.5) logger.warning( f\"Attempt {attempt} failed: {e}. \" f\"Retrying in {delay:.2f}s...\" ) await asyncio.sleep(delay) # 所有尝试都失败 raise last_exception return wrapper return decorator # 超时装饰器 def timeout(seconds: float): \"\"\"超时装饰器\"\"\" def decorator(func: Callable): @wraps(func) async def wrapper(*args, **kwargs): try: return await asyncio.wait_for( func(*args, **kwargs), timeout=seconds ) except asyncio.TimeoutError: raise TimeoutException( f\"Function {func.__name__} timed out after {seconds}s\" ) return wrapper return decorator # 使用示例 @retry(RetryConfig( max_attempts=3, base_delay=1.0, exponential_base=2, retry_exceptions=[ConnectionError, TimeoutError] )) @timeout(seconds=5) async def call_external_api(url): \"\"\"调用外部API，带重试和超时\"\"\" async with aiohttp.ClientSession() as session: async with session.get(url) as response: response.raise_for_status() return await response.json() 4.3 限流与降级 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 import time from collections import deque from typing import Callable, Any class RateLimiter: \"\"\"速率限制器\"\"\" def __init__(self, rate: int, per: float): \"\"\" rate: 允许的请求数 per: 时间窗口（秒） \"\"\" self.rate = rate self.per = per self.allowance = rate self.last_check = time.time() def acquire(self, tokens: int = 1) -\u003e bool: \"\"\"获取令牌\"\"\" current = time.time() elapsed = current - self.last_check # 补充令牌 self.allowance += elapsed * (self.rate / self.per) if self.allowance \u003e self.rate: self.allowance = self.rate self.last_check = current # 检查是否有足够的令牌 if self.allowance \u003c tokens: return False self.allowance -= tokens return True class TokenBucket: \"\"\"令牌桶算法\"\"\" def __init__(self, capacity: int, refill_rate: float): \"\"\" capacity: 桶容量 refill_rate: 填充速率（每秒） \"\"\" self.capacity = capacity self.refill_rate = refill_rate self.tokens = capacity self.last_refill = time.time() def consume(self, tokens: int = 1) -\u003e bool: \"\"\"消费令牌\"\"\" self._refill() if self.tokens \u003e= tokens: self.tokens -= tokens return True return False def _refill(self): \"\"\"补充令牌\"\"\" now = time.time() elapsed = now - self.last_refill refill_amount = elapsed * self.refill_rate self.tokens = min(self.capacity, self.tokens + refill_amount) self.last_refill = now class SlidingWindow: \"\"\"滑动窗口限流\"\"\" def __init__(self, limit: int, window: float): \"\"\" limit: 窗口内最大请求数 window: 时间窗口（秒） \"\"\" self.limit = limit self.window = window self.requests = deque() def is_allowed(self) -\u003e bool: \"\"\"检查是否允许请求\"\"\" now = time.time() # 移除窗口外的请求 while self.requests and self.requests[0] \u003c now - self.window: self.requests.popleft() # 检查是否超过限制 if len(self.requests) \u003e= self.limit: return False self.requests.append(now) return True # 降级装饰器 class FallbackExecutor: \"\"\"降级执行器\"\"\" def __init__(self): self.fallbacks = {} def register_fallback(self, func_name: str, fallback: Callable): \"\"\"注册降级函数\"\"\" self.fallbacks[func_name] = fallback async def execute_with_fallback( self, func: Callable, *args, fallback_result: Any = None, **kwargs ): \"\"\"执行函数，失败时降级\"\"\" try: return await func(*args, **kwargs) except Exception as e: func_name = func.__name__ # 查找注册的降级函数 if func_name in self.fallbacks: logger.warning(f\"Function {func_name} failed, using fallback\") return await self.fallbacks[func_name](*args, **kwargs) # 使用默认降级结果 if fallback_result is not None: logger.warning(f\"Function {func_name} failed, using fallback result\") return fallback_result # 没有降级方案，抛出异常 raise e # 使用示例 # 创建限流器 rate_limiter = RateLimiter(rate=100, per=1) # 100请求/秒 token_bucket = TokenBucket(capacity=10, refill_rate=1) # 10令牌容量，每秒补充1个 sliding_window = SlidingWindow(limit=100, window=60) # 60秒内最多100请求 # 创建降级执行器 fallback_executor = FallbackExecutor() async def get_user_data(user_id): \"\"\"获取用户数据\"\"\" # 检查限流 if not rate_limiter.acquire(): raise RateLimitException(\"Too many requests\") # 调用服务 return await user_service.get_user(user_id) # 注册降级函数 async def get_user_data_fallback(user_id): \"\"\"降级：返回缓存的用户数据\"\"\" return await cache.get(f\"user:{user_id}\") fallback_executor.register_fallback('get_user_data', get_user_data_fallback) # 使用 try: result = await fallback_executor.execute_with_fallback( get_user_data, user_id='123' ) except Exception as e: logger.error(f\"All attempts failed: {e}\") 五、可观测性设计 5.1 日志系统 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 import structlog from typing import Any class LogContext: \"\"\"日志上下文\"\"\" def __init__(self): self.context = {} def set(self, key: str, value: Any): \"\"\"设置上下文\"\"\" self.context[key] = value def get(self, key: str, default=None): \"\"\"获取上下文\"\"\" return self.context.get(key, default) def clear(self): \"\"\"清空上下文\"\"\" self.context.clear() # 全局日志上下文 log_context = LogContext() # 配置structlog structlog.configure( processors=[ structlog.stdlib.filter_by_level, structlog.stdlib.add_logger_name, structlog.stdlib.add_log_level, structlog.stdlib.PositionalArgumentsFormatter(), structlog.processors.TimeStamper(fmt=\"iso\"), structlog.processors.StackInfoRenderer(), structlog.processors.format_exc_info, structlog.processors.UnicodeDecoder(), # 添加上下文 lambda logger, method_name, event_dict: { **event_dict, **log_context.context }, # 格式化输出 structlog.processors.JSONRenderer() ], context_class=dict, logger_factory=structlog.stdlib.LoggerFactory(), cache_logger_on_first_use=True, ) class ServiceLogger: \"\"\"服务日志记录器\"\"\" def __init__(self, service_name: str): self.service_name = service_name self.logger = structlog.get_logger() def log_request(self, request_id: str, method: str, path: str, **kwargs): \"\"\"记录请求\"\"\" self.logger.info( \"incoming_request\", request_id=request_id, service=self.service_name, method=method, path=path, **kwargs ) def log_response( self, request_id: str, status_code: int, duration_ms: float, **kwargs ): \"\"\"记录响应\"\"\" self.logger.info( \"outgoing_response\", request_id=request_id, service=self.service_name, status_code=status_code, duration_ms=duration_ms, **kwargs ) def log_error(self, error: Exception, **kwargs): \"\"\"记录错误\"\"\" self.logger.error( \"error_occurred\", service=self.service_name, error_type=type(error).__name__, error_message=str(error), **kwargs ) def log_service_call( self, service_name: str, method: str, duration_ms: float, success: bool, **kwargs ): \"\"\"记录服务调用\"\"\" self.logger.info( \"service_call\", caller=self.service_name, service=service_name, method=method, duration_ms=duration_ms, success=success, **kwargs ) # 中间件示例 class LoggingMiddleware: \"\"\"日志中间件\"\"\" def __init__(self, logger: ServiceLogger): self.logger = logger async def process_request(self, request, call_next): \"\"\"处理请求\"\"\" request_id = generate_request_id() start_time = time.time() # 设置日志上下文 log_context.set('request_id', request_id) log_context.set('user_id', request.user_id) # 记录请求 self.logger.log_request( request_id=request_id, method=request.method, path=request.path ) try: # 处理请求 response = await call_next(request) # 记录响应 duration_ms = (time.time() - start_time) * 1000 self.logger.log_response( request_id=request_id, status_code=response.status_code, duration_ms=duration_ms ) return response except Exception as e: duration_ms = (time.time() - start_time) * 1000 self.logger.log_error( error=e, request_id=request_id, duration_ms=duration_ms ) raise finally: log_context.clear() 5.2 链路追踪 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 from opentelemetry import trace from opentelemetry.sdk.trace import TracerProvider from opentelemetry.sdk.trace.export import BatchSpanProcessor from opentelemetry.exporter.jaeger.thrift import JaegerExporter # 配置Tracer trace.set_tracer_provider(TracerProvider()) tracer_provider = trace.get_tracer_provider() # 配置Jaeger导出器 jaeger_exporter = JaegerExporter( agent_host_name=\"localhost\", agent_port=6831, ) tracer_provider.add_span_processor( BatchSpanProcessor(jaeger_exporter) ) class TracingClient: \"\"\"带追踪的客户端\"\"\" def __init__(self, service_name: str): self.service_name = service_name self.tracer = trace.get_tracer(__name__) async def call_service( self, service_name: str, method: str, **kwargs ): \"\"\"调用服务并追踪\"\"\" with self.tracer.start_as_current_span( f\"{service_name}.{method}\", kind=trace.SpanKind.CLIENT ) as span: # 添加属性 span.set_attribute(\"service\", self.service_name) span.set_attribute(\"target_service\", service_name) span.set_attribute(\"method\", method) try: # 注入追踪上下文 headers = {} trace.inject(headers) # 调用服务 result = await self._make_request( service_name, method, headers=headers, **kwargs ) span.set_attribute(\"success\", True) return result except Exception as e: span.record_exception(e) span.set_attribute(\"success\", False) raise async def _make_request(self, service_name, method, headers, **kwargs): \"\"\"实际请求逻辑\"\"\" # 实现服务调用 pass # 使用示例 client = TracingClient(\"order-service\") async def create_order(user_id, items): \"\"\"创建订单 - 带追踪\"\"\" with client.tracer.start_as_current_span(\"create_order\") as span: span.set_attribute(\"user_id\", user_id) span.set_attribute(\"item_count\", len(items)) # 调用库存服务 inventory_result = await client.call_service( \"inventory-service\", \"check_stock\", items=items ) # 调用支付服务 payment_result = await client.call_service( \"payment-service\", \"process_payment\", user_id=user_id, amount=calculate_amount(items) ) return { \"inventory\": inventory_result, \"payment\": payment_result } 5.3 指标监控 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 from prometheus_client import Counter, Histogram, Gauge, start_http_server # 定义指标 request_count = Counter( 'http_requests_total', 'Total HTTP requests', ['method', 'endpoint', 'status'] ) request_duration = Histogram( 'http_request_duration_seconds', 'HTTP request duration', ['method', 'endpoint'] ) active_connections = Gauge( 'active_connections', 'Number of active connections' ) business_metric = Counter( 'business_operations_total', 'Total business operations', ['operation', 'status'] ) class MetricsMiddleware: \"\"\"指标收集中间件\"\"\" def __init__(self): self.active_connections = active_connections async def process_request(self, request, call_next): \"\"\"处理请求并收集指标\"\"\" # 增加活跃连接数 self.active_connections.inc() start_time = time.time() try: response = await call_next(request) # 记录请求计数 request_count.labels( method=request.method, endpoint=request.path, status=response.status_code ).inc() # 记录请求耗时 duration = time.time() - start_time request_duration.labels( method=request.method, endpoint=request.path ).observe(duration) return response finally: # 减少活跃连接数 self.active_connections.dec() class BusinessMetrics: \"\"\"业务指标收集\"\"\" @staticmethod def record_operation(operation: str, success: bool): \"\"\"记录业务操作\"\"\" status = \"success\" if success else \"failure\" business_metric.labels( operation=operation, status=status ).inc() @staticmethod def record_order_created(order_value: float): \"\"\"记录订单创建\"\"\" business_metric.labels( operation=\"order_created\", status=\"success\" ).inc() @staticmethod def record_payment_failed(amount: float, reason: str): \"\"\"记录支付失败\"\"\" business_metric.labels( operation=f\"payment_failed_{reason}\", status=\"failure\" ).inc() # 使用示例 async def create_order_logic(user_id, items): \"\"\"创建订单逻辑\"\"\" try: order = await order_service.create(user_id, items) BusinessMetrics.record_operation(\"order_created\", True) return order except InventoryError as e: BusinessMetrics.record_operation(\"order_created\", False) BusinessMetrics.record_operation(\"inventory_check_failed\", False) raise except PaymentError as e: BusinessMetrics.record_operation(\"order_created\", False) BusinessMetrics.record_payment_failed( order.total, e.reason ) raise # 启动指标服务器 start_http_server(8000) 总结 后端系统架构设计是一个复杂的系统工程，需要综合考虑多个维度：\n架构演进：根据业务规模选择合适的架构模式 服务拆分：按照业务领域合理拆分微服务 服务通信：选择合适的同步/异步通信方式 数据一致性：采用Saga、CQRS等模式处理分布式事务 容错设计：熔断、重试、限流、降级保障系统稳定性 可观测性：完善的日志、追踪、监控体系 架构设计没有银弹，需要根据具体业务场景做出权衡和选择。\n相关工具推荐\nJSON格式化工具 - API数据处理 Base64编码工具 - 数据编码 SQL格式化工具 - SQL优化 ","wordCount":"4867","inLanguage":"zh-cn","datePublished":"2025-12-30T11:00:00+08:00","dateModified":"2025-12-30T11:00:00+08:00","author":{"@type":"Person","name":"有条工具团队"},"mainEntityOfPage":{"@type":"WebPage","@id":"/blog/articles/%E5%90%8E%E7%AB%AF%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1%E4%BB%8E%E5%8D%95%E4%BD%93%E5%88%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%E7%9A%84%E6%BC%94%E8%BF%9B%E4%B9%8B%E8%B7%AF/"},"publisher":{"@type":"Organization","name":"技术博客 - 有条工具","logo":{"@type":"ImageObject","url":"/favicon.ico"}}}</script></head><body id=top><header class=header><nav class=nav><div class=logo><a href=/blog/ accesskey=h title="技术博客 - 有条工具 (Alt + H)">技术博客 - 有条工具</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=/blog/posts/ title="所有文章列表 - 有条工具技术博客：查看所有技术文章和教程内容"><span>文章</span></a></li><li><a href=https://www.util.cn title="有条工具 - 开发者的常用工具集合：无广告 · 本地计算 · 即开即用的在线工具平台，提供JSON格式化、SQL格式化、Markdown编辑器等实用工具"><span>有条工具</span>&nbsp;
<svg fill="none" shape-rendering="geometricPrecision" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li><li><a href=/blog/categories/ title="文章分类 - 有条工具技术博客：按技术领域分类的优质文章，包括前端开发、工具使用、编程技巧等"><span>分类</span></a></li><li><a href=/blog/tags/ title="标签云 - 有条工具技术博客：通过标签快速找到感兴趣的技术文章和教程内容"><span>标签</span></a></li><li><a href=/blog/archives/ title="文章归档 - 有条工具技术博客：按时间查看历史文章"><span>归档</span></a></li><li><a href=/blog/search/ title="搜索文章 - 有条工具技术博客：通过关键词搜索找到感兴趣的技术文章和教程内容，支持标题、内容、分类和标签搜索"><span>搜索</span></a></li></ul></nav></header><main class=main><article class=post-single><div class=post-content-wrapper><main class=post-content-main><header class=post-header-main><h1 class="post-title entry-hint-parent">后端系统架构设计：从单体到微服务的演进之路</h1><div class=post-description>深入探讨后端系统架构设计，涵盖单体架构、微服务架构、分布式系统、服务治理、容错设计等核心主题，帮助工程师构建高可用、可扩展的后端系统。</div><div class=post-meta><div class=post-meta-content><div class=post-categories-inline><a href=/blog/categories/%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91/ class=category-link>后端开发</a><a href=/blog/categories/%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1/ class=category-link>架构设计</a></div><span class=post-date>2025-12-30</span><span class=post-author>有条工具团队</span></div><style>.post-meta-content{display:flex;align-items:center;flex-wrap:wrap;gap:.75rem;font-family:sf mono,monaco,courier new,monospace;font-size:.875rem;color:#9ca3af !important}.post-categories-inline{display:inline-flex;align-items:center;gap:.5rem}.category-link{display:inline-flex;align-items:center;gap:.25rem;padding:.25rem .75rem;background:rgba(255,255,255,.1);color:#e5e7eb !important;text-decoration:none;font-size:.75rem;font-weight:600;text-transform:uppercase;letter-spacing:.05em;border:1px solid rgba(255,255,255,.2);border-radius:0;transition:all .3s ease;white-space:nowrap}.category-link:hover{background:rgba(255,255,255,.2);color:#fff !important;border-color:rgba(255,255,255,.3);transform:translateY(-1px)}.category-link::before{content:'📁';font-size:.7rem;opacity:.8}.post-date,.post-reading-time,.post-word-count,.post-author{color:#9ca3af !important}[data-theme=dark] .post-meta-content{color:#9ca3af !important}[data-theme=dark] .category-link{background:rgba(255,255,255,.1);color:#e5e7eb !important;border-color:rgba(255,255,255,.2)}[data-theme=dark] .category-link:hover{background:rgba(255,255,255,.2);color:#fff !important;border-color:rgba(255,255,255,.3)}[data-theme=dark] .post-date,[data-theme=dark] .post-reading-time,[data-theme=dark] .post-word-count,[data-theme=dark] .post-author{color:#9ca3af !important}[data-theme=light] .post-meta-content{color:#6c757d !important}[data-theme=light] .category-link{background:rgba(0,0,0,5%);color:#495057 !important;border-color:rgba(0,0,0,.15)}[data-theme=light] .category-link:hover{background:rgba(0,102,204,.1);color:#212529 !important;border-color:rgba(0,102,204,.3)}[data-theme=light] .post-date,[data-theme=light] .post-reading-time,[data-theme=light] .post-word-count,[data-theme=light] .post-author{color:#6c757d !important}@media(max-width:768px){.post-meta-content{gap:.5rem;font-size:.8rem}.category-link{padding:.2rem .6rem;font-size:.7rem}}</style></div></header><div class=post-content><h2 id=引言>引言<a hidden class=anchor aria-hidden=true href=#引言>#</a></h2><p>随着业务规模的不断扩大，后端系统架构需要不断演进以应对日益增长的挑战。从单体应用到微服务架构，从单机部署到分布式集群，每一次架构演进都是为了解决特定的痛点。本文将深入探讨后端系统架构设计的核心原则、模式与实践。</p><h2 id=一架构演进历程>一、架构演进历程<a hidden class=anchor aria-hidden=true href=#一架构演进历程>#</a></h2><h3 id=11-架构演进路径>1.1 架构演进路径<a hidden class=anchor aria-hidden=true href=#11-架构演进路径>#</a></h3><pre tabindex=0><code>单体应用 → 分层架构 → SOA → 微服务 → Serverless
</code></pre><p><strong>演进阶段对比</strong></p><table><thead><tr><th>架构类型</th><th>特点</th><th>优势</th><th>挑战</th><th>适用场景</th></tr></thead><tbody><tr><td><strong>单体应用</strong></td><td>单一代码库、单一部署</td><td>开发简单、部署容易</td><td>扩展性差、技术栈固定</td><td>小型项目、初创期</td></tr><tr><td><strong>分层架构</strong></td><td>MVC/MVP分层</td><td>职责清晰、易于维护</td><td>层间耦合强</td><td>中小型项目</td></tr><tr><td><strong>SOA</strong></td><td>服务化、ESB总线</td><td>服务复用、松耦合</td><td>ESB单点、复杂度高</td><td>企业级应用</td></tr><tr><td><strong>微服务</strong></td><td>独立服务、自治部署</td><td>独立扩展、技术自由</td><td>运维复杂、分布式事务</td><td>大型复杂系统</td></tr><tr><td><strong>Serverless</strong></td><td>函数级、按需付费</td><td>极致弹性、成本优化</td><td>厂商锁定、冷启动</td><td>事件驱动、波峰明显</td></tr></tbody></table><h3 id=12-单体架构的局限性>1.2 单体架构的局限性<a hidden class=anchor aria-hidden=true href=#12-单体架构的局限性>#</a></h3><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">27
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#8b949e;font-style:italic># 单体应用的典型问题</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># 问题1: 代码耦合严重</span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># 一个请求的处理流程涉及多个模块</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>class</span> <span style=color:#f0883e;font-weight:700>OrderService</span>:
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>create_order</span>(self, user_id, items):
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic># 直接依赖多个模块</span>
</span></span><span style=display:flex><span>        user <span style=color:#ff7b72;font-weight:700>=</span> UserService()<span style=color:#ff7b72;font-weight:700>.</span>get_user(user_id)
</span></span><span style=display:flex><span>        inventory <span style=color:#ff7b72;font-weight:700>=</span> InventoryService()<span style=color:#ff7b72;font-weight:700>.</span>check_stock(items)
</span></span><span style=display:flex><span>        payment <span style=color:#ff7b72;font-weight:700>=</span> PaymentService()<span style=color:#ff7b72;font-weight:700>.</span>process_payment(items)
</span></span><span style=display:flex><span>        shipping <span style=color:#ff7b72;font-weight:700>=</span> ShippingService()<span style=color:#ff7b72;font-weight:700>.</span>calculate_shipping(user<span style=color:#ff7b72;font-weight:700>.</span>address)
</span></span><span style=display:flex><span>        notification <span style=color:#ff7b72;font-weight:700>=</span> NotificationService()<span style=color:#ff7b72;font-weight:700>.</span>send_confirmation(user<span style=color:#ff7b72;font-weight:700>.</span>email)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic># 如果任何一个模块出错，整个订单创建失败</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> Order(user<span style=color:#ff7b72;font-weight:700>=</span>user, items<span style=color:#ff7b72;font-weight:700>=</span>items, payment<span style=color:#ff7b72;font-weight:700>=</span>payment)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># 问题2: 难以独立扩展</span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># 当订单服务压力大时，必须整体扩展</span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># 无法针对特定瓶颈服务单独扩容</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># 问题3: 技术栈锁定</span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># 整个应用必须使用相同的语言和框架</span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># 无法为新服务选择更适合的技术</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># 问题4: 部署风险高</span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># 任何小的修改都需要重新部署整个应用</span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># 一处bug可能影响整个系统</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=二微服务架构设计>二、微服务架构设计<a hidden class=anchor aria-hidden=true href=#二微服务架构设计>#</a></h2><h3 id=21-核心设计原则>2.1 核心设计原则<a hidden class=anchor aria-hidden=true href=#21-核心设计原则>#</a></h3><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">66
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#8b949e;font-style:italic># ========== 服务拆分原则 ==========</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># 1. 单一职责原则</span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># 每个服务专注于一个业务领域</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>class</span> <span style=color:#f0883e;font-weight:700>UserService</span>:
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#34;&#34;&#34;用户服务 - 只负责用户相关的业务&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>create_user</span>(self, data): <span style=color:#ff7b72>pass</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>get_user</span>(self, user_id): <span style=color:#ff7b72>pass</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>update_user</span>(self, user_id, data): <span style=color:#ff7b72>pass</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>class</span> <span style=color:#f0883e;font-weight:700>OrderService</span>:
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#34;&#34;&#34;订单服务 - 只负责订单相关的业务&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>create_order</span>(self, data): <span style=color:#ff7b72>pass</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>get_order</span>(self, order_id): <span style=color:#ff7b72>pass</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>cancel_order</span>(self, order_id): <span style=color:#ff7b72>pass</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># 2. 限界上下文原则</span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># 按照业务领域边界拆分服务</span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># DDD (Domain-Driven Design) 战术模式</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># 3. 数据独立性原则</span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># 每个服务拥有独立的数据库</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>class</span> <span style=color:#f0883e;font-weight:700>UserDatabase</span>:
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#34;&#34;&#34;用户服务的数据库&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>__init__</span>(self):
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>db <span style=color:#ff7b72;font-weight:700>=</span> PostgreSQL(<span style=color:#a5d6ff>&#39;users_db&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>class</span> <span style=color:#f0883e;font-weight:700>OrderDatabase</span>:
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#34;&#34;&#34;订单服务的数据库&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>__init__</span>(self):
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>db <span style=color:#ff7b72;font-weight:700>=</span> MongoDB(<span style=color:#a5d6ff>&#39;orders_db&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># 4. API网关原则</span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># 统一入口，路由转发</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>class</span> <span style=color:#f0883e;font-weight:700>APIGateway</span>:
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#34;&#34;&#34;API网关 - 服务统一入口&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>__init__</span>(self):
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>routes <span style=color:#ff7b72;font-weight:700>=</span> {
</span></span><span style=display:flex><span>            <span style=color:#a5d6ff>&#39;/api/users/*&#39;</span>: UserService(),
</span></span><span style=display:flex><span>            <span style=color:#a5d6ff>&#39;/api/orders/*&#39;</span>: OrderService(),
</span></span><span style=display:flex><span>            <span style=color:#a5d6ff>&#39;/api/products/*&#39;</span>: ProductService(),
</span></span><span style=display:flex><span>            <span style=color:#a5d6ff>&#39;/api/payments/*&#39;</span>: PaymentService()
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>route</span>(self, request):
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic># 路由匹配</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>for</span> pattern, service <span style=color:#ff7b72;font-weight:700>in</span> self<span style=color:#ff7b72;font-weight:700>.</span>routes<span style=color:#ff7b72;font-weight:700>.</span>items():
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>if</span> request<span style=color:#ff7b72;font-weight:700>.</span>path<span style=color:#ff7b72;font-weight:700>.</span><span style=color:#ff7b72>match</span>(pattern):
</span></span><span style=display:flex><span>                <span style=color:#ff7b72>return</span> service<span style=color:#ff7b72;font-weight:700>.</span>handle(request)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic># 聚合多个服务的响应</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>if</span> request<span style=color:#ff7b72;font-weight:700>.</span>path <span style=color:#ff7b72;font-weight:700>==</span> <span style=color:#a5d6ff>&#39;/api/dashboard&#39;</span>:
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>return</span> self<span style=color:#ff7b72;font-weight:700>.</span>aggregate_dashboard(request)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>aggregate_dashboard</span>(self, request):
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;聚合多个服务的数据&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        user_data <span style=color:#ff7b72;font-weight:700>=</span> self<span style=color:#ff7b72;font-weight:700>.</span>call_service(<span style=color:#a5d6ff>&#39;/api/users/me&#39;</span>, request)
</span></span><span style=display:flex><span>        order_data <span style=color:#ff7b72;font-weight:700>=</span> self<span style=color:#ff7b72;font-weight:700>.</span>call_service(<span style=color:#a5d6ff>&#39;/api/orders/recent&#39;</span>, request)
</span></span><span style=display:flex><span>        notification_data <span style=color:#ff7b72;font-weight:700>=</span> self<span style=color:#ff7b72;font-weight:700>.</span>call_service(<span style=color:#a5d6ff>&#39;/api/notifications&#39;</span>, request)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> {
</span></span><span style=display:flex><span>            <span style=color:#a5d6ff>&#39;user&#39;</span>: user_data,
</span></span><span style=display:flex><span>            <span style=color:#a5d6ff>&#39;orders&#39;</span>: order_data,
</span></span><span style=display:flex><span>            <span style=color:#a5d6ff>&#39;notifications&#39;</span>: notification_data
</span></span><span style=display:flex><span>        }
</span></span></code></pre></td></tr></table></div></div><h3 id=22-服务通信模式>2.2 服务通信模式<a hidden class=anchor aria-hidden=true href=#22-服务通信模式>#</a></h3><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 78
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 79
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 80
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 81
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 82
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 83
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 84
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 85
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 86
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 87
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 88
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 89
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 90
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 91
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 92
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 93
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 94
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 95
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 96
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 97
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 98
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 99
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">100
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">101
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">102
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">103
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">104
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">105
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">106
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">107
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">108
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">109
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">110
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">111
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">112
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">113
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">114
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">115
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">116
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">117
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">118
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">119
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">120
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">121
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">122
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">123
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">124
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">125
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">126
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">127
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">128
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">129
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">130
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">131
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">132
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">133
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">134
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">135
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">136
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">137
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">138
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">139
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">140
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">141
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">142
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">143
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">144
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">145
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">146
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">147
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">148
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">149
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">150
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">151
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">152
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">153
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">154
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">155
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">156
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">157
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">158
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">159
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">160
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">161
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">162
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">163
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">164
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">165
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">166
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">167
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">168
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">169
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">170
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">171
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">172
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#8b949e;font-style:italic># ========== 同步通信: REST/gRPC ==========</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>import</span> <span style=color:#ff7b72>requests</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>from</span> <span style=color:#ff7b72>typing</span> <span style=color:#ff7b72>import</span> Protocol
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># REST API调用</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>class</span> <span style=color:#f0883e;font-weight:700>OrderClient</span>:
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#34;&#34;&#34;订单服务客户端&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    BASE_URL <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>&#34;http://order-service:8080&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>create_order</span>(self, order_data: dict) <span style=color:#ff7b72;font-weight:700>-&gt;</span> dict:
</span></span><span style=display:flex><span>        response <span style=color:#ff7b72;font-weight:700>=</span> requests<span style=color:#ff7b72;font-weight:700>.</span>post(
</span></span><span style=display:flex><span>            <span style=color:#79c0ff>f</span><span style=color:#a5d6ff>&#34;</span><span style=color:#a5d6ff>{</span>self<span style=color:#ff7b72;font-weight:700>.</span>BASE_URL<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>/api/orders&#34;</span>,
</span></span><span style=display:flex><span>            json<span style=color:#ff7b72;font-weight:700>=</span>order_data,
</span></span><span style=display:flex><span>            timeout<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>5</span>  <span style=color:#8b949e;font-style:italic># 超时控制</span>
</span></span><span style=display:flex><span>        )
</span></span><span style=display:flex><span>        response<span style=color:#ff7b72;font-weight:700>.</span>raise_for_status()
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> response<span style=color:#ff7b72;font-weight:700>.</span>json()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>get_order</span>(self, order_id: str) <span style=color:#ff7b72;font-weight:700>-&gt;</span> dict:
</span></span><span style=display:flex><span>        response <span style=color:#ff7b72;font-weight:700>=</span> requests<span style=color:#ff7b72;font-weight:700>.</span>get(
</span></span><span style=display:flex><span>            <span style=color:#79c0ff>f</span><span style=color:#a5d6ff>&#34;</span><span style=color:#a5d6ff>{</span>self<span style=color:#ff7b72;font-weight:700>.</span>BASE_URL<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>/api/orders/</span><span style=color:#a5d6ff>{</span>order_id<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>&#34;</span>,
</span></span><span style=display:flex><span>            timeout<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>3</span>
</span></span><span style=display:flex><span>        )
</span></span><span style=display:flex><span>        response<span style=color:#ff7b72;font-weight:700>.</span>raise_for_status()
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> response<span style=color:#ff7b72;font-weight:700>.</span>json()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># gRPC调用 (性能更高)</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>import</span> <span style=color:#ff7b72>grpc</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>from</span> <span style=color:#ff7b72>generated</span> <span style=color:#ff7b72>import</span> order_pb2, order_pb2_grpc
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>class</span> <span style=color:#f0883e;font-weight:700>OrderGRPCClient</span>:
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#34;&#34;&#34;订单服务gRPC客户端&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>__init__</span>(self):
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>channel <span style=color:#ff7b72;font-weight:700>=</span> grpc<span style=color:#ff7b72;font-weight:700>.</span>insecure_channel(<span style=color:#a5d6ff>&#39;order-service:9090&#39;</span>)
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>stub <span style=color:#ff7b72;font-weight:700>=</span> order_pb2_grpc<span style=color:#ff7b72;font-weight:700>.</span>OrderServiceStub(self<span style=color:#ff7b72;font-weight:700>.</span>channel)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>create_order</span>(self, order_data: dict) <span style=color:#ff7b72;font-weight:700>-&gt;</span> order_pb2<span style=color:#ff7b72;font-weight:700>.</span>OrderResponse:
</span></span><span style=display:flex><span>        request <span style=color:#ff7b72;font-weight:700>=</span> order_pb2<span style=color:#ff7b72;font-weight:700>.</span>CreateOrderRequest(
</span></span><span style=display:flex><span>            user_id<span style=color:#ff7b72;font-weight:700>=</span>order_data[<span style=color:#a5d6ff>&#39;user_id&#39;</span>],
</span></span><span style=display:flex><span>            items<span style=color:#ff7b72;font-weight:700>=</span>[
</span></span><span style=display:flex><span>                order_pb2<span style=color:#ff7b72;font-weight:700>.</span>OrderItem(
</span></span><span style=display:flex><span>                    product_id<span style=color:#ff7b72;font-weight:700>=</span>item[<span style=color:#a5d6ff>&#39;product_id&#39;</span>],
</span></span><span style=display:flex><span>                    quantity<span style=color:#ff7b72;font-weight:700>=</span>item[<span style=color:#a5d6ff>&#39;quantity&#39;</span>]
</span></span><span style=display:flex><span>                )
</span></span><span style=display:flex><span>                <span style=color:#ff7b72>for</span> item <span style=color:#ff7b72;font-weight:700>in</span> order_data[<span style=color:#a5d6ff>&#39;items&#39;</span>]
</span></span><span style=display:flex><span>            ]
</span></span><span style=display:flex><span>        )
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> self<span style=color:#ff7b72;font-weight:700>.</span>stub<span style=color:#ff7b72;font-weight:700>.</span>CreateOrder(request, timeout<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>5</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># ========== 异步通信: 消息队列 ==========</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>import</span> <span style=color:#ff7b72>asyncio</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>from</span> <span style=color:#ff7b72>aio_pika</span> <span style=color:#ff7b72>import</span> connect, Message
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>class</span> <span style=color:#f0883e;font-weight:700>EventBus</span>:
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#34;&#34;&#34;事件总线 - 异步消息传递&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>__init__</span>(self, amqp_url: str):
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>connection <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#79c0ff>None</span>
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>channel <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#79c0ff>None</span>
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>amqp_url <span style=color:#ff7b72;font-weight:700>=</span> amqp_url
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>async</span> <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>connect</span>(self):
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;建立连接&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>connection <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>await</span> connect(self<span style=color:#ff7b72;font-weight:700>.</span>amqp_url)
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>channel <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>await</span> self<span style=color:#ff7b72;font-weight:700>.</span>connection<span style=color:#ff7b72;font-weight:700>.</span>channel()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic># 声明交换机</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>await</span> self<span style=color:#ff7b72;font-weight:700>.</span>channel<span style=color:#ff7b72;font-weight:700>.</span>declare_exchange(
</span></span><span style=display:flex><span>            <span style=color:#a5d6ff>&#39;domain-events&#39;</span>,
</span></span><span style=display:flex><span>            <span style=color:#a5d6ff>&#39;topic&#39;</span>,
</span></span><span style=display:flex><span>            durable<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#79c0ff>True</span>
</span></span><span style=display:flex><span>        )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>async</span> <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>publish</span>(self, event_type: str, event_data: dict):
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;发布事件&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        exchange <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>await</span> self<span style=color:#ff7b72;font-weight:700>.</span>get_exchange()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        message <span style=color:#ff7b72;font-weight:700>=</span> Message(
</span></span><span style=display:flex><span>            json<span style=color:#ff7b72;font-weight:700>.</span>dumps(event_data)<span style=color:#ff7b72;font-weight:700>.</span>encode(),
</span></span><span style=display:flex><span>            content_type<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>&#39;application/json&#39;</span>,
</span></span><span style=display:flex><span>            delivery_mode<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>2</span>  <span style=color:#8b949e;font-style:italic># 持久化</span>
</span></span><span style=display:flex><span>        )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>await</span> exchange<span style=color:#ff7b72;font-weight:700>.</span>publish(
</span></span><span style=display:flex><span>            message,
</span></span><span style=display:flex><span>            routing_key<span style=color:#ff7b72;font-weight:700>=</span>event_type
</span></span><span style=display:flex><span>        )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>async</span> <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>subscribe</span>(self, event_pattern: str, handler):
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;订阅事件&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        exchange <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>await</span> self<span style=color:#ff7b72;font-weight:700>.</span>get_exchange()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic># 声明队列</span>
</span></span><span style=display:flex><span>        queue <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>await</span> self<span style=color:#ff7b72;font-weight:700>.</span>channel<span style=color:#ff7b72;font-weight:700>.</span>declare_queue(
</span></span><span style=display:flex><span>            <span style=color:#79c0ff>f</span><span style=color:#a5d6ff>&#39;</span><span style=color:#a5d6ff>{</span>event_pattern<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>-queue&#39;</span>,
</span></span><span style=display:flex><span>            durable<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#79c0ff>True</span>
</span></span><span style=display:flex><span>        )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic># 绑定交换机</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>await</span> queue<span style=color:#ff7b72;font-weight:700>.</span>bind(exchange, routing_key<span style=color:#ff7b72;font-weight:700>=</span>event_pattern)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>async</span> <span style=color:#ff7b72>with</span> queue<span style=color:#ff7b72;font-weight:700>.</span>iterator() <span style=color:#ff7b72>as</span> queue_iter:
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>async</span> <span style=color:#ff7b72>for</span> message <span style=color:#ff7b72;font-weight:700>in</span> queue_iter:
</span></span><span style=display:flex><span>                <span style=color:#ff7b72>try</span>:
</span></span><span style=display:flex><span>                    event_data <span style=color:#ff7b72;font-weight:700>=</span> json<span style=color:#ff7b72;font-weight:700>.</span>loads(message<span style=color:#ff7b72;font-weight:700>.</span>body<span style=color:#ff7b72;font-weight:700>.</span>decode())
</span></span><span style=display:flex><span>                    <span style=color:#ff7b72>await</span> handler(event_data)
</span></span><span style=display:flex><span>                    <span style=color:#ff7b72>await</span> message<span style=color:#ff7b72;font-weight:700>.</span>ack()
</span></span><span style=display:flex><span>                <span style=color:#ff7b72>except</span> <span style=color:#f0883e;font-weight:700>Exception</span> <span style=color:#ff7b72>as</span> e:
</span></span><span style=display:flex><span>                    <span style=color:#ff7b72>await</span> message<span style=color:#ff7b72;font-weight:700>.</span>nack()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># 事件驱动架构示例</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>class</span> <span style=color:#f0883e;font-weight:700>OrderCreatedEvent</span>:
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#34;&#34;&#34;订单创建事件&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>__init__</span>(self, order_id, user_id, items):
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>event_type <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>&#39;order.created&#39;</span>
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>data <span style=color:#ff7b72;font-weight:700>=</span> {
</span></span><span style=display:flex><span>            <span style=color:#a5d6ff>&#39;order_id&#39;</span>: order_id,
</span></span><span style=display:flex><span>            <span style=color:#a5d6ff>&#39;user_id&#39;</span>: user_id,
</span></span><span style=display:flex><span>            <span style=color:#a5d6ff>&#39;items&#39;</span>: items,
</span></span><span style=display:flex><span>            <span style=color:#a5d6ff>&#39;timestamp&#39;</span>: datetime<span style=color:#ff7b72;font-weight:700>.</span>now()<span style=color:#ff7b72;font-weight:700>.</span>isoformat()
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># 订单服务发布事件</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>async</span> <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>create_order_with_event</span>(order_data):
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic># 创建订单</span>
</span></span><span style=display:flex><span>    order <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>await</span> order_repository<span style=color:#ff7b72;font-weight:700>.</span>create(order_data)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic># 发布事件</span>
</span></span><span style=display:flex><span>    event_bus <span style=color:#ff7b72;font-weight:700>=</span> EventBus()
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>await</span> event_bus<span style=color:#ff7b72;font-weight:700>.</span>publish(
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#39;order.created&#39;</span>,
</span></span><span style=display:flex><span>        OrderCreatedEvent(
</span></span><span style=display:flex><span>            order<span style=color:#ff7b72;font-weight:700>.</span>id,
</span></span><span style=display:flex><span>            order<span style=color:#ff7b72;font-weight:700>.</span>user_id,
</span></span><span style=display:flex><span>            order<span style=color:#ff7b72;font-weight:700>.</span>items
</span></span><span style=display:flex><span>        )<span style=color:#ff7b72;font-weight:700>.</span>data
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> order
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># 库存服务监听事件</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>async</span> <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>handle_order_created</span>(event_data):
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#34;&#34;&#34;处理订单创建事件 - 扣减库存&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>    order_id <span style=color:#ff7b72;font-weight:700>=</span> event_data[<span style=color:#a5d6ff>&#39;order_id&#39;</span>]
</span></span><span style=display:flex><span>    items <span style=color:#ff7b72;font-weight:700>=</span> event_data[<span style=color:#a5d6ff>&#39;items&#39;</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>for</span> item <span style=color:#ff7b72;font-weight:700>in</span> items:
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>await</span> inventory_service<span style=color:#ff7b72;font-weight:700>.</span>deduct_stock(
</span></span><span style=display:flex><span>            item[<span style=color:#a5d6ff>&#39;product_id&#39;</span>],
</span></span><span style=display:flex><span>            item[<span style=color:#a5d6ff>&#39;quantity&#39;</span>]
</span></span><span style=display:flex><span>        )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>await</span> event_bus<span style=color:#ff7b72;font-weight:700>.</span>publish(
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#39;inventory.deducted&#39;</span>,
</span></span><span style=display:flex><span>        {<span style=color:#a5d6ff>&#39;order_id&#39;</span>: order_id, <span style=color:#a5d6ff>&#39;status&#39;</span>: <span style=color:#a5d6ff>&#39;completed&#39;</span>}
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># 通知服务监听事件</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>async</span> <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>handle_inventory_deducted</span>(event_data):
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#34;&#34;&#34;处理库存扣减完成事件 - 发送通知&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>    order_id <span style=color:#ff7b72;font-weight:700>=</span> event_data[<span style=color:#a5d6ff>&#39;order_id&#39;</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    order <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>await</span> order_repository<span style=color:#ff7b72;font-weight:700>.</span>get(order_id)
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>await</span> notification_service<span style=color:#ff7b72;font-weight:700>.</span>send_order_confirmation(
</span></span><span style=display:flex><span>        order<span style=color:#ff7b72;font-weight:700>.</span>user_email,
</span></span><span style=display:flex><span>        order_id
</span></span><span style=display:flex><span>    )
</span></span></code></pre></td></tr></table></div></div><h3 id=23-服务发现与注册>2.3 服务发现与注册<a hidden class=anchor aria-hidden=true href=#23-服务发现与注册>#</a></h3><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 78
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 79
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 80
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 81
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 82
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 83
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 84
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 85
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 86
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 87
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 88
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 89
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 90
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 91
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 92
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 93
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 94
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 95
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 96
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 97
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 98
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 99
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">100
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">101
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">102
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">103
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">104
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">105
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">106
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">107
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">108
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">109
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">110
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">111
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">112
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">113
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">114
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">115
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">116
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">117
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">118
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">119
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">120
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">121
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">122
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">123
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">124
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">125
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">126
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">127
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">128
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">129
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">130
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">131
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">132
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">133
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">134
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#8b949e;font-style:italic># ========== 服务注册中心 ==========</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>import</span> <span style=color:#ff7b72>asyncio</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>from</span> <span style=color:#ff7b72>typing</span> <span style=color:#ff7b72>import</span> Dict, List, Optional
</span></span><span style=display:flex><span><span style=color:#ff7b72>from</span> <span style=color:#ff7b72>datetime</span> <span style=color:#ff7b72>import</span> datetime, timedelta
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>class</span> <span style=color:#f0883e;font-weight:700>ServiceInstance</span>:
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#34;&#34;&#34;服务实例&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>__init__</span>(self, service_id: str, address: str, port: int):
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>service_id <span style=color:#ff7b72;font-weight:700>=</span> service_id
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>address <span style=color:#ff7b72;font-weight:700>=</span> address
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>port <span style=color:#ff7b72;font-weight:700>=</span> port
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>last_heartbeat <span style=color:#ff7b72;font-weight:700>=</span> datetime<span style=color:#ff7b72;font-weight:700>.</span>now()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#d2a8ff;font-weight:700>@property</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>url</span>(self) <span style=color:#ff7b72;font-weight:700>-&gt;</span> str:
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> <span style=color:#79c0ff>f</span><span style=color:#a5d6ff>&#34;http://</span><span style=color:#a5d6ff>{</span>self<span style=color:#ff7b72;font-weight:700>.</span>address<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>:</span><span style=color:#a5d6ff>{</span>self<span style=color:#ff7b72;font-weight:700>.</span>port<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>is_alive</span>(self, timeout: int <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>10</span>) <span style=color:#ff7b72;font-weight:700>-&gt;</span> bool:
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;检查实例是否存活&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> (datetime<span style=color:#ff7b72;font-weight:700>.</span>now() <span style=color:#ff7b72;font-weight:700>-</span> self<span style=color:#ff7b72;font-weight:700>.</span>last_heartbeat)<span style=color:#ff7b72;font-weight:700>.</span>seconds <span style=color:#ff7b72;font-weight:700>&lt;</span> timeout
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>class</span> <span style=color:#f0883e;font-weight:700>ServiceRegistry</span>:
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#34;&#34;&#34;服务注册中心&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>__init__</span>(self):
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>services: Dict[str, List[ServiceInstance]] <span style=color:#ff7b72;font-weight:700>=</span> {}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>register</span>(self, service_name: str, instance: ServiceInstance):
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;注册服务实例&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>if</span> service_name <span style=color:#ff7b72;font-weight:700>not</span> <span style=color:#ff7b72;font-weight:700>in</span> self<span style=color:#ff7b72;font-weight:700>.</span>services:
</span></span><span style=display:flex><span>            self<span style=color:#ff7b72;font-weight:700>.</span>services[service_name] <span style=color:#ff7b72;font-weight:700>=</span> []
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic># 检查是否已存在</span>
</span></span><span style=display:flex><span>        existing <span style=color:#ff7b72;font-weight:700>=</span> next(
</span></span><span style=display:flex><span>            (i <span style=color:#ff7b72>for</span> i <span style=color:#ff7b72;font-weight:700>in</span> self<span style=color:#ff7b72;font-weight:700>.</span>services[service_name]
</span></span><span style=display:flex><span>             <span style=color:#ff7b72>if</span> i<span style=color:#ff7b72;font-weight:700>.</span>service_id <span style=color:#ff7b72;font-weight:700>==</span> instance<span style=color:#ff7b72;font-weight:700>.</span>service_id),
</span></span><span style=display:flex><span>            <span style=color:#79c0ff>None</span>
</span></span><span style=display:flex><span>        )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>if</span> existing:
</span></span><span style=display:flex><span>            <span style=color:#8b949e;font-style:italic># 更新心跳时间</span>
</span></span><span style=display:flex><span>            existing<span style=color:#ff7b72;font-weight:700>.</span>last_heartbeat <span style=color:#ff7b72;font-weight:700>=</span> datetime<span style=color:#ff7b72;font-weight:700>.</span>now()
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>else</span>:
</span></span><span style=display:flex><span>            <span style=color:#8b949e;font-style:italic># 新注册</span>
</span></span><span style=display:flex><span>            self<span style=color:#ff7b72;font-weight:700>.</span>services[service_name]<span style=color:#ff7b72;font-weight:700>.</span>append(instance)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        print(<span style=color:#79c0ff>f</span><span style=color:#a5d6ff>&#34;Registered: </span><span style=color:#a5d6ff>{</span>service_name<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff> - </span><span style=color:#a5d6ff>{</span>instance<span style=color:#ff7b72;font-weight:700>.</span>url<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>deregister</span>(self, service_name: str, service_id: str):
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;注销服务实例&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>if</span> service_name <span style=color:#ff7b72;font-weight:700>in</span> self<span style=color:#ff7b72;font-weight:700>.</span>services:
</span></span><span style=display:flex><span>            self<span style=color:#ff7b72;font-weight:700>.</span>services[service_name] <span style=color:#ff7b72;font-weight:700>=</span> [
</span></span><span style=display:flex><span>                i <span style=color:#ff7b72>for</span> i <span style=color:#ff7b72;font-weight:700>in</span> self<span style=color:#ff7b72;font-weight:700>.</span>services[service_name]
</span></span><span style=display:flex><span>                <span style=color:#ff7b72>if</span> i<span style=color:#ff7b72;font-weight:700>.</span>service_id <span style=color:#ff7b72;font-weight:700>!=</span> service_id
</span></span><span style=display:flex><span>            ]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>discover</span>(self, service_name: str) <span style=color:#ff7b72;font-weight:700>-&gt;</span> Optional[ServiceInstance]:
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;服务发现 - 负载均衡&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>if</span> service_name <span style=color:#ff7b72;font-weight:700>not</span> <span style=color:#ff7b72;font-weight:700>in</span> self<span style=color:#ff7b72;font-weight:700>.</span>services:
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>return</span> <span style=color:#79c0ff>None</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic># 过滤掉失效的实例</span>
</span></span><span style=display:flex><span>        alive_instances <span style=color:#ff7b72;font-weight:700>=</span> [
</span></span><span style=display:flex><span>            i <span style=color:#ff7b72>for</span> i <span style=color:#ff7b72;font-weight:700>in</span> self<span style=color:#ff7b72;font-weight:700>.</span>services[service_name]
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>if</span> i<span style=color:#ff7b72;font-weight:700>.</span>is_alive()
</span></span><span style=display:flex><span>        ]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>if</span> <span style=color:#ff7b72;font-weight:700>not</span> alive_instances:
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>return</span> <span style=color:#79c0ff>None</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic># 轮询负载均衡</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> alive_instances[hash(service_name) <span style=color:#ff7b72;font-weight:700>%</span> len(alive_instances)]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic># 或者使用随机选择</span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic># return random.choice(alive_instances)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>heartbeat</span>(self, service_name: str, service_id: str):
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;接收心跳&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>if</span> service_name <span style=color:#ff7b72;font-weight:700>in</span> self<span style=color:#ff7b72;font-weight:700>.</span>services:
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>for</span> instance <span style=color:#ff7b72;font-weight:700>in</span> self<span style=color:#ff7b72;font-weight:700>.</span>services[service_name]:
</span></span><span style=display:flex><span>                <span style=color:#ff7b72>if</span> instance<span style=color:#ff7b72;font-weight:700>.</span>service_id <span style=color:#ff7b72;font-weight:700>==</span> service_id:
</span></span><span style=display:flex><span>                    instance<span style=color:#ff7b72;font-weight:700>.</span>last_heartbeat <span style=color:#ff7b72;font-weight:700>=</span> datetime<span style=color:#ff7b72;font-weight:700>.</span>now()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># ========== 服务客户端 ==========</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>class</span> <span style=color:#f0883e;font-weight:700>ServiceClient</span>:
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#34;&#34;&#34;服务客户端 - 带服务发现&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>__init__</span>(self, registry: ServiceRegistry):
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>registry <span style=color:#ff7b72;font-weight:700>=</span> registry
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>cache <span style=color:#ff7b72;font-weight:700>=</span> {}  <span style=color:#8b949e;font-style:italic># 缓存服务地址</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>async</span> <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>call</span>(self, service_name: str, endpoint: str, <span style=color:#ff7b72;font-weight:700>**</span>kwargs):
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;调用服务&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic># 从缓存或注册中心获取服务地址</span>
</span></span><span style=display:flex><span>        instance <span style=color:#ff7b72;font-weight:700>=</span> self<span style=color:#ff7b72;font-weight:700>.</span>cache<span style=color:#ff7b72;font-weight:700>.</span>get(service_name)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>if</span> <span style=color:#ff7b72;font-weight:700>not</span> instance <span style=color:#ff7b72;font-weight:700>or</span> <span style=color:#ff7b72;font-weight:700>not</span> instance<span style=color:#ff7b72;font-weight:700>.</span>is_alive():
</span></span><span style=display:flex><span>            instance <span style=color:#ff7b72;font-weight:700>=</span> self<span style=color:#ff7b72;font-weight:700>.</span>registry<span style=color:#ff7b72;font-weight:700>.</span>discover(service_name)
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>if</span> <span style=color:#ff7b72;font-weight:700>not</span> instance:
</span></span><span style=display:flex><span>                <span style=color:#ff7b72>raise</span> ServiceUnavailableException(<span style=color:#79c0ff>f</span><span style=color:#a5d6ff>&#34;Service </span><span style=color:#a5d6ff>{</span>service_name<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff> not found&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            self<span style=color:#ff7b72;font-weight:700>.</span>cache[service_name] <span style=color:#ff7b72;font-weight:700>=</span> instance
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic># 构建请求URL</span>
</span></span><span style=display:flex><span>        url <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#79c0ff>f</span><span style=color:#a5d6ff>&#34;</span><span style=color:#a5d6ff>{</span>instance<span style=color:#ff7b72;font-weight:700>.</span>url<span style=color:#a5d6ff>}{</span>endpoint<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>try</span>:
</span></span><span style=display:flex><span>            response <span style=color:#ff7b72;font-weight:700>=</span> requests<span style=color:#ff7b72;font-weight:700>.</span>post(url, json<span style=color:#ff7b72;font-weight:700>=</span>kwargs, timeout<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>5</span>)
</span></span><span style=display:flex><span>            response<span style=color:#ff7b72;font-weight:700>.</span>raise_for_status()
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>return</span> response<span style=color:#ff7b72;font-weight:700>.</span>json()
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>except</span> requests<span style=color:#ff7b72;font-weight:700>.</span>RequestException <span style=color:#ff7b72>as</span> e:
</span></span><span style=display:flex><span>            <span style=color:#8b949e;font-style:italic># 调用失败，清除缓存</span>
</span></span><span style=display:flex><span>            self<span style=color:#ff7b72;font-weight:700>.</span>cache<span style=color:#ff7b72;font-weight:700>.</span>pop(service_name, <span style=color:#79c0ff>None</span>)
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>raise</span> e
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># ========== 使用示例 ==========</span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># 服务启动时注册</span>
</span></span><span style=display:flex><span>registry <span style=color:#ff7b72;font-weight:700>=</span> ServiceRegistry()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>async</span> <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>start_service</span>():
</span></span><span style=display:flex><span>    service_instance <span style=color:#ff7b72;font-weight:700>=</span> ServiceInstance(
</span></span><span style=display:flex><span>        service_id<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#79c0ff>f</span><span style=color:#a5d6ff>&#34;order-service-</span><span style=color:#a5d6ff>{</span>os<span style=color:#ff7b72;font-weight:700>.</span>getenv(<span style=color:#a5d6ff>&#39;INSTANCE_ID&#39;</span>)<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>&#34;</span>,
</span></span><span style=display:flex><span>        address<span style=color:#ff7b72;font-weight:700>=</span>os<span style=color:#ff7b72;font-weight:700>.</span>getenv(<span style=color:#a5d6ff>&#39;SERVICE_ADDRESS&#39;</span>),
</span></span><span style=display:flex><span>        port<span style=color:#ff7b72;font-weight:700>=</span>int(os<span style=color:#ff7b72;font-weight:700>.</span>getenv(<span style=color:#a5d6ff>&#39;SERVICE_PORT&#39;</span>))
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    registry<span style=color:#ff7b72;font-weight:700>.</span>register(<span style=color:#a5d6ff>&#39;order-service&#39;</span>, service_instance)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic># 定期发送心跳</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>while</span> <span style=color:#79c0ff>True</span>:
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>await</span> asyncio<span style=color:#ff7b72;font-weight:700>.</span>sleep(<span style=color:#a5d6ff>5</span>)
</span></span><span style=display:flex><span>        registry<span style=color:#ff7b72;font-weight:700>.</span>heartbeat(<span style=color:#a5d6ff>&#39;order-service&#39;</span>, service_instance<span style=color:#ff7b72;font-weight:700>.</span>service_id)
</span></span></code></pre></td></tr></table></div></div><h3 id=24-分布式配置管理>2.4 分布式配置管理<a hidden class=anchor aria-hidden=true href=#24-分布式配置管理>#</a></h3><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">76
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#8b949e;font-style:italic># ========== 配置中心 ==========</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>import</span> <span style=color:#ff7b72>asyncio</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>import</span> <span style=color:#ff7b72>json</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>from</span> <span style=color:#ff7b72>typing</span> <span style=color:#ff7b72>import</span> Any, Callable
</span></span><span style=display:flex><span><span style=color:#ff7b72>from</span> <span style=color:#ff7b72>watchfiles</span> <span style=color:#ff7b72>import</span> awatch
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>class</span> <span style=color:#f0883e;font-weight:700>ConfigCenter</span>:
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#34;&#34;&#34;分布式配置中心&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>__init__</span>(self, config_dir: str <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>&#39;./config&#39;</span>):
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>config_dir <span style=color:#ff7b72;font-weight:700>=</span> config_dir
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>configs <span style=color:#ff7b72;font-weight:700>=</span> {}
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>watchers <span style=color:#ff7b72;font-weight:700>=</span> {}  <span style=color:#8b949e;font-style:italic># config_key -&gt; [callbacks]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>load_config</span>(self, service_name: str) <span style=color:#ff7b72;font-weight:700>-&gt;</span> dict:
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;加载服务配置&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        config_file <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#79c0ff>f</span><span style=color:#a5d6ff>&#34;</span><span style=color:#a5d6ff>{</span>self<span style=color:#ff7b72;font-weight:700>.</span>config_dir<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>/</span><span style=color:#a5d6ff>{</span>service_name<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>.json&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>try</span>:
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>with</span> open(config_file) <span style=color:#ff7b72>as</span> f:
</span></span><span style=display:flex><span>                config <span style=color:#ff7b72;font-weight:700>=</span> json<span style=color:#ff7b72;font-weight:700>.</span>load(f)
</span></span><span style=display:flex><span>                self<span style=color:#ff7b72;font-weight:700>.</span>configs[service_name] <span style=color:#ff7b72;font-weight:700>=</span> config
</span></span><span style=display:flex><span>                <span style=color:#ff7b72>return</span> config
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>except</span> <span style=color:#f0883e;font-weight:700>FileNotFoundError</span>:
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>return</span> {}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>get_config</span>(self, service_name: str, key: str <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#79c0ff>None</span>) <span style=color:#ff7b72;font-weight:700>-&gt;</span> Any:
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;获取配置&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        config <span style=color:#ff7b72;font-weight:700>=</span> self<span style=color:#ff7b72;font-weight:700>.</span>configs<span style=color:#ff7b72;font-weight:700>.</span>get(service_name, {})
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>if</span> key:
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>return</span> config<span style=color:#ff7b72;font-weight:700>.</span>get(key)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> config
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>watch_config</span>(self, service_name: str, callback: Callable):
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;监听配置变化&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>if</span> service_name <span style=color:#ff7b72;font-weight:700>not</span> <span style=color:#ff7b72;font-weight:700>in</span> self<span style=color:#ff7b72;font-weight:700>.</span>watchers:
</span></span><span style=display:flex><span>            self<span style=color:#ff7b72;font-weight:700>.</span>watchers[service_name] <span style=color:#ff7b72;font-weight:700>=</span> []
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>watchers[service_name]<span style=color:#ff7b72;font-weight:700>.</span>append(callback)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>async</span> <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>watch_changes</span>(self):
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;监听配置文件变化&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>async</span> <span style=color:#ff7b72>for</span> changes <span style=color:#ff7b72;font-weight:700>in</span> awatch(self<span style=color:#ff7b72;font-weight:700>.</span>config_dir):
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>for</span> change_type, config_path <span style=color:#ff7b72;font-weight:700>in</span> changes:
</span></span><span style=display:flex><span>                service_name <span style=color:#ff7b72;font-weight:700>=</span> config_path<span style=color:#ff7b72;font-weight:700>.</span>stem
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#ff7b72>if</span> change_type <span style=color:#ff7b72;font-weight:700>==</span> Change<span style=color:#ff7b72;font-weight:700>.</span>modified:
</span></span><span style=display:flex><span>                    <span style=color:#8b949e;font-style:italic># 重新加载配置</span>
</span></span><span style=display:flex><span>                    old_config <span style=color:#ff7b72;font-weight:700>=</span> self<span style=color:#ff7b72;font-weight:700>.</span>configs<span style=color:#ff7b72;font-weight:700>.</span>get(service_name, {})
</span></span><span style=display:flex><span>                    new_config <span style=color:#ff7b72;font-weight:700>=</span> self<span style=color:#ff7b72;font-weight:700>.</span>load_config(service_name)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                    <span style=color:#8b949e;font-style:italic># 触发回调</span>
</span></span><span style=display:flex><span>                    <span style=color:#ff7b72>if</span> service_name <span style=color:#ff7b72;font-weight:700>in</span> self<span style=color:#ff7b72;font-weight:700>.</span>watchers:
</span></span><span style=display:flex><span>                        <span style=color:#ff7b72>for</span> callback <span style=color:#ff7b72;font-weight:700>in</span> self<span style=color:#ff7b72;font-weight:700>.</span>watchers[service_name]:
</span></span><span style=display:flex><span>                            <span style=color:#ff7b72>await</span> callback(old_config, new_config)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># ========== 使用示例 ==========</span>
</span></span><span style=display:flex><span>config_center <span style=color:#ff7b72;font-weight:700>=</span> ConfigCenter()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># 加载配置</span>
</span></span><span style=display:flex><span>app_config <span style=color:#ff7b72;font-weight:700>=</span> config_center<span style=color:#ff7b72;font-weight:700>.</span>load_config(<span style=color:#a5d6ff>&#39;order-service&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># 监听配置变化</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>async</span> <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>on_config_changed</span>(old_config, new_config):
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#34;&#34;&#34;配置变化处理&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>if</span> old_config<span style=color:#ff7b72;font-weight:700>.</span>get(<span style=color:#a5d6ff>&#39;log_level&#39;</span>) <span style=color:#ff7b72;font-weight:700>!=</span> new_config<span style=color:#ff7b72;font-weight:700>.</span>get(<span style=color:#a5d6ff>&#39;log_level&#39;</span>):
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic># 重新配置日志级别</span>
</span></span><span style=display:flex><span>        logging<span style=color:#ff7b72;font-weight:700>.</span>getLogger()<span style=color:#ff7b72;font-weight:700>.</span>setLevel(new_config[<span style=color:#a5d6ff>&#39;log_level&#39;</span>])
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>if</span> old_config<span style=color:#ff7b72;font-weight:700>.</span>get(<span style=color:#a5d6ff>&#39;database&#39;</span>) <span style=color:#ff7b72;font-weight:700>!=</span> new_config<span style=color:#ff7b72;font-weight:700>.</span>get(<span style=color:#a5d6ff>&#39;database&#39;</span>):
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic># 重新建立数据库连接</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>await</span> reconnect_database(new_config[<span style=color:#a5d6ff>&#39;database&#39;</span>])
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>config_center<span style=color:#ff7b72;font-weight:700>.</span>watch_config(<span style=color:#a5d6ff>&#39;order-service&#39;</span>, on_config_changed)
</span></span></code></pre></td></tr></table></div></div><h2 id=三数据一致性设计>三、数据一致性设计<a hidden class=anchor aria-hidden=true href=#三数据一致性设计>#</a></h2><h3 id=31-分布式事务>3.1 分布式事务<a hidden class=anchor aria-hidden=true href=#31-分布式事务>#</a></h3><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 78
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 79
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 80
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 81
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 82
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 83
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 84
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 85
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 86
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 87
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 88
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 89
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 90
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 91
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 92
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 93
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 94
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 95
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 96
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 97
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 98
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 99
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">100
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">101
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">102
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">103
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">104
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">105
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">106
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">107
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">108
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">109
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">110
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">111
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">112
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">113
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">114
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">115
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">116
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">117
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">118
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">119
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">120
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">121
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">122
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">123
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">124
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">125
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">126
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">127
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">128
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">129
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">130
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">131
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">132
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">133
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">134
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">135
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">136
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">137
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">138
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">139
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">140
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">141
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">142
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">143
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">144
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">145
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">146
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">147
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">148
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">149
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">150
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">151
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">152
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">153
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">154
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">155
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">156
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">157
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">158
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">159
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">160
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">161
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">162
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">163
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">164
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">165
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">166
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">167
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">168
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">169
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#8b949e;font-style:italic># ========== 两阶段提交 (2PC) ==========</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>class</span> <span style=color:#f0883e;font-weight:700>TwoPhaseCommit</span>:
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#34;&#34;&#34;两阶段提交协调者&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>__init__</span>(self):
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>participants <span style=color:#ff7b72;font-weight:700>=</span> []
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>register_participant</span>(self, participant):
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;注册参与者&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>participants<span style=color:#ff7b72;font-weight:700>.</span>append(participant)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>async</span> <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>execute</span>(self, transaction_data):
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;执行分布式事务&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        transaction_id <span style=color:#ff7b72;font-weight:700>=</span> generate_transaction_id()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic># 阶段1: 准备阶段</span>
</span></span><span style=display:flex><span>        prepared <span style=color:#ff7b72;font-weight:700>=</span> []
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>for</span> participant <span style=color:#ff7b72;font-weight:700>in</span> self<span style=color:#ff7b72;font-weight:700>.</span>participants:
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>try</span>:
</span></span><span style=display:flex><span>                result <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>await</span> participant<span style=color:#ff7b72;font-weight:700>.</span>prepare(transaction_id, transaction_data)
</span></span><span style=display:flex><span>                <span style=color:#ff7b72>if</span> result <span style=color:#ff7b72;font-weight:700>==</span> <span style=color:#a5d6ff>&#39;PREPARED&#39;</span>:
</span></span><span style=display:flex><span>                    prepared<span style=color:#ff7b72;font-weight:700>.</span>append(participant)
</span></span><span style=display:flex><span>                <span style=color:#ff7b72>else</span>:
</span></span><span style=display:flex><span>                    <span style=color:#8b949e;font-style:italic># 任何参与者拒绝，回滚所有</span>
</span></span><span style=display:flex><span>                    <span style=color:#ff7b72>await</span> self<span style=color:#ff7b72;font-weight:700>.</span>_rollback_all(transaction_id, prepared)
</span></span><span style=display:flex><span>                    <span style=color:#ff7b72>return</span> <span style=color:#79c0ff>False</span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>except</span> <span style=color:#f0883e;font-weight:700>Exception</span> <span style=color:#ff7b72>as</span> e:
</span></span><span style=display:flex><span>                <span style=color:#ff7b72>await</span> self<span style=color:#ff7b72;font-weight:700>.</span>_rollback_all(transaction_id, prepared)
</span></span><span style=display:flex><span>                <span style=color:#ff7b72>raise</span> e
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic># 阶段2: 提交阶段</span>
</span></span><span style=display:flex><span>        committed <span style=color:#ff7b72;font-weight:700>=</span> []
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>for</span> participant <span style=color:#ff7b72;font-weight:700>in</span> prepared:
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>try</span>:
</span></span><span style=display:flex><span>                <span style=color:#ff7b72>await</span> participant<span style=color:#ff7b72;font-weight:700>.</span>commit(transaction_id)
</span></span><span style=display:flex><span>                committed<span style=color:#ff7b72;font-weight:700>.</span>append(participant)
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>except</span> <span style=color:#f0883e;font-weight:700>Exception</span> <span style=color:#ff7b72>as</span> e:
</span></span><span style=display:flex><span>                <span style=color:#8b949e;font-style:italic># 提交失败，需要人工介入</span>
</span></span><span style=display:flex><span>                <span style=color:#ff7b72>await</span> self<span style=color:#ff7b72;font-weight:700>.</span>_rollback_all(transaction_id, committed)
</span></span><span style=display:flex><span>                <span style=color:#ff7b72>raise</span> <span style=color:#f0883e;font-weight:700>Exception</span>(<span style=color:#79c0ff>f</span><span style=color:#a5d6ff>&#34;Commit failed: </span><span style=color:#a5d6ff>{</span>e<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> <span style=color:#79c0ff>True</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>async</span> <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>_rollback_all</span>(self, transaction_id, participants):
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;回滚所有参与者&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>for</span> participant <span style=color:#ff7b72;font-weight:700>in</span> participants:
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>try</span>:
</span></span><span style=display:flex><span>                <span style=color:#ff7b72>await</span> participant<span style=color:#ff7b72;font-weight:700>.</span>rollback(transaction_id)
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>except</span> <span style=color:#f0883e;font-weight:700>Exception</span> <span style=color:#ff7b72>as</span> e:
</span></span><span style=display:flex><span>                logging<span style=color:#ff7b72;font-weight:700>.</span>error(<span style=color:#79c0ff>f</span><span style=color:#a5d6ff>&#34;Rollback failed: </span><span style=color:#a5d6ff>{</span>e<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># ========== Saga模式 ==========</span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># 长事务的替代方案</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>class</span> <span style=color:#f0883e;font-weight:700>SagaOrchestrator</span>:
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#34;&#34;&#34;Saga编排器&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>__init__</span>(self):
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>steps <span style=color:#ff7b72;font-weight:700>=</span> []
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>compensations <span style=color:#ff7b72;font-weight:700>=</span> []
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>add_step</span>(self, action, compensation):
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;添加步骤&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>steps<span style=color:#ff7b72;font-weight:700>.</span>append(action)
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>compensations<span style=color:#ff7b72;font-weight:700>.</span>append(compensation)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>async</span> <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>execute</span>(self, initial_data):
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;执行Saga&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        context <span style=color:#ff7b72;font-weight:700>=</span> initial_data
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        executed_steps <span style=color:#ff7b72;font-weight:700>=</span> []
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic># 执行每个步骤</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>for</span> i, step <span style=color:#ff7b72;font-weight:700>in</span> enumerate(self<span style=color:#ff7b72;font-weight:700>.</span>steps):
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>try</span>:
</span></span><span style=display:flex><span>                context <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>await</span> step(context)
</span></span><span style=display:flex><span>                executed_steps<span style=color:#ff7b72;font-weight:700>.</span>append(i)
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>except</span> <span style=color:#f0883e;font-weight:700>Exception</span> <span style=color:#ff7b72>as</span> e:
</span></span><span style=display:flex><span>                <span style=color:#8b949e;font-style:italic># 失败，执行补偿</span>
</span></span><span style=display:flex><span>                <span style=color:#ff7b72>await</span> self<span style=color:#ff7b72;font-weight:700>.</span>_compensate(executed_steps, context)
</span></span><span style=display:flex><span>                <span style=color:#ff7b72>raise</span> e
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> context
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>async</span> <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>_compensate</span>(self, executed_steps, context):
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;执行补偿事务&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic># 逆序执行补偿</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>for</span> i <span style=color:#ff7b72;font-weight:700>in</span> reversed(executed_steps):
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>try</span>:
</span></span><span style=display:flex><span>                <span style=color:#ff7b72>await</span> self<span style=color:#ff7b72;font-weight:700>.</span>compensations[i](context)
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>except</span> <span style=color:#f0883e;font-weight:700>Exception</span> <span style=color:#ff7b72>as</span> e:
</span></span><span style=display:flex><span>                logging<span style=color:#ff7b72;font-weight:700>.</span>error(<span style=color:#79c0ff>f</span><span style=color:#a5d6ff>&#34;Compensation failed: </span><span style=color:#a5d6ff>{</span>e<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># 订单Saga示例</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>class</span> <span style=color:#f0883e;font-weight:700>OrderSaga</span>:
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#34;&#34;&#34;订单处理Saga&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>__init__</span>(self):
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>saga <span style=color:#ff7b72;font-weight:700>=</span> SagaOrchestrator()
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>_setup_steps()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>_setup_steps</span>(self):
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;设置Saga步骤&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic># 步骤1: 创建订单</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>async</span> <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>create_order</span>(context):
</span></span><span style=display:flex><span>            order <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>await</span> order_repository<span style=color:#ff7b72;font-weight:700>.</span>create(context[<span style=color:#a5d6ff>&#39;order_data&#39;</span>])
</span></span><span style=display:flex><span>            context[<span style=color:#a5d6ff>&#39;order&#39;</span>] <span style=color:#ff7b72;font-weight:700>=</span> order
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>return</span> context
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>async</span> <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>cancel_order</span>(context):
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>await</span> order_repository<span style=color:#ff7b72;font-weight:700>.</span>update_status(
</span></span><span style=display:flex><span>                context[<span style=color:#a5d6ff>&#39;order&#39;</span>]<span style=color:#ff7b72;font-weight:700>.</span>id,
</span></span><span style=display:flex><span>                <span style=color:#a5d6ff>&#39;CANCELLED&#39;</span>
</span></span><span style=display:flex><span>            )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic># 步骤2: 扣减库存</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>async</span> <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>deduct_inventory</span>(context):
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>for</span> item <span style=color:#ff7b72;font-weight:700>in</span> context[<span style=color:#a5d6ff>&#39;order&#39;</span>]<span style=color:#ff7b72;font-weight:700>.</span>items:
</span></span><span style=display:flex><span>                <span style=color:#ff7b72>await</span> inventory_service<span style=color:#ff7b72;font-weight:700>.</span>deduct_stock(
</span></span><span style=display:flex><span>                    item<span style=color:#ff7b72;font-weight:700>.</span>product_id,
</span></span><span style=display:flex><span>                    item<span style=color:#ff7b72;font-weight:700>.</span>quantity
</span></span><span style=display:flex><span>                )
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>return</span> context
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>async</span> <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>restore_inventory</span>(context):
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>for</span> item <span style=color:#ff7b72;font-weight:700>in</span> context[<span style=color:#a5d6ff>&#39;order&#39;</span>]<span style=color:#ff7b72;font-weight:700>.</span>items:
</span></span><span style=display:flex><span>                <span style=color:#ff7b72>await</span> inventory_service<span style=color:#ff7b72;font-weight:700>.</span>restore_stock(
</span></span><span style=display:flex><span>                    item<span style=color:#ff7b72;font-weight:700>.</span>product_id,
</span></span><span style=display:flex><span>                    item<span style=color:#ff7b72;font-weight:700>.</span>quantity
</span></span><span style=display:flex><span>                )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic># 步骤3: 处理支付</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>async</span> <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>process_payment</span>(context):
</span></span><span style=display:flex><span>            payment <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>await</span> payment_service<span style=color:#ff7b72;font-weight:700>.</span>charge(
</span></span><span style=display:flex><span>                context[<span style=color:#a5d6ff>&#39;order&#39;</span>]<span style=color:#ff7b72;font-weight:700>.</span>user_id,
</span></span><span style=display:flex><span>                context[<span style=color:#a5d6ff>&#39;order&#39;</span>]<span style=color:#ff7b72;font-weight:700>.</span>total_amount
</span></span><span style=display:flex><span>            )
</span></span><span style=display:flex><span>            context[<span style=color:#a5d6ff>&#39;payment&#39;</span>] <span style=color:#ff7b72;font-weight:700>=</span> payment
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>return</span> context
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>async</span> <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>refund_payment</span>(context):
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>await</span> payment_service<span style=color:#ff7b72;font-weight:700>.</span>refund(
</span></span><span style=display:flex><span>                context[<span style=color:#a5d6ff>&#39;payment&#39;</span>]<span style=color:#ff7b72;font-weight:700>.</span>transaction_id
</span></span><span style=display:flex><span>            )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic># 步骤4: 发送通知</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>async</span> <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>send_notification</span>(context):
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>await</span> notification_service<span style=color:#ff7b72;font-weight:700>.</span>send(
</span></span><span style=display:flex><span>                context[<span style=color:#a5d6ff>&#39;order&#39;</span>]<span style=color:#ff7b72;font-weight:700>.</span>user_email,
</span></span><span style=display:flex><span>                <span style=color:#a5d6ff>&#39;Order Created&#39;</span>,
</span></span><span style=display:flex><span>                <span style=color:#79c0ff>f</span><span style=color:#a5d6ff>&#39;Your order </span><span style=color:#a5d6ff>{</span>context[<span style=color:#a5d6ff>&#34;order&#34;</span>]<span style=color:#ff7b72;font-weight:700>.</span>id<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff> has been created&#39;</span>
</span></span><span style=display:flex><span>            )
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>return</span> context
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>async</span> <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>cancel_notification</span>(context):
</span></span><span style=display:flex><span>            <span style=color:#8b949e;font-style:italic># 通知可能不需要补偿</span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>pass</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic># 添加步骤和补偿</span>
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>saga<span style=color:#ff7b72;font-weight:700>.</span>add_step(create_order, cancel_order)
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>saga<span style=color:#ff7b72;font-weight:700>.</span>add_step(deduct_inventory, restore_inventory)
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>saga<span style=color:#ff7b72;font-weight:700>.</span>add_step(process_payment, refund_payment)
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>saga<span style=color:#ff7b72;font-weight:700>.</span>add_step(send_notification, cancel_notification)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>async</span> <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>execute</span>(self, order_data):
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;执行订单Saga&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> <span style=color:#ff7b72>await</span> self<span style=color:#ff7b72;font-weight:700>.</span>saga<span style=color:#ff7b72;font-weight:700>.</span>execute({<span style=color:#a5d6ff>&#39;order_data&#39;</span>: order_data})
</span></span></code></pre></td></tr></table></div></div><h3 id=32-最终一致性>3.2 最终一致性<a hidden class=anchor aria-hidden=true href=#32-最终一致性>#</a></h3><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 78
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 79
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 80
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 81
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 82
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 83
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 84
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 85
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 86
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 87
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 88
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 89
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 90
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 91
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 92
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 93
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 94
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 95
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 96
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 97
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 98
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 99
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">100
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">101
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">102
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">103
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">104
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">105
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">106
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">107
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">108
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">109
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">110
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">111
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">112
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">113
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">114
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">115
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">116
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">117
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">118
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">119
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">120
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">121
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">122
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">123
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">124
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">125
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">126
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">127
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">128
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">129
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">130
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">131
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">132
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">133
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">134
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">135
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">136
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">137
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">138
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">139
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">140
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">141
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">142
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">143
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">144
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">145
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">146
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">147
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">148
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">149
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">150
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">151
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">152
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">153
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">154
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">155
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">156
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">157
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">158
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">159
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">160
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">161
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">162
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">163
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">164
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">165
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">166
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">167
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">168
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">169
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">170
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">171
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">172
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">173
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">174
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">175
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">176
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">177
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">178
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">179
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">180
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">181
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">182
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">183
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">184
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">185
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">186
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">187
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">188
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">189
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">190
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">191
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">192
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">193
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">194
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">195
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">196
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">197
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">198
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">199
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">200
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">201
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">202
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">203
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#8b949e;font-style:italic># ========== 事件溯源 ==========</span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># 通过事件流重建状态</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>class</span> <span style=color:#f0883e;font-weight:700>EventStore</span>:
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#34;&#34;&#34;事件存储&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>__init__</span>(self):
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>events <span style=color:#ff7b72;font-weight:700>=</span> []
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>async</span> <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>append_event</span>(self, aggregate_id: str, event: dict):
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;追加事件&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        event[<span style=color:#a5d6ff>&#39;aggregate_id&#39;</span>] <span style=color:#ff7b72;font-weight:700>=</span> aggregate_id
</span></span><span style=display:flex><span>        event[<span style=color:#a5d6ff>&#39;timestamp&#39;</span>] <span style=color:#ff7b72;font-weight:700>=</span> datetime<span style=color:#ff7b72;font-weight:700>.</span>now()<span style=color:#ff7b72;font-weight:700>.</span>isoformat()
</span></span><span style=display:flex><span>        event[<span style=color:#a5d6ff>&#39;version&#39;</span>] <span style=color:#ff7b72;font-weight:700>=</span> len(self<span style=color:#ff7b72;font-weight:700>.</span>events) <span style=color:#ff7b72;font-weight:700>+</span> <span style=color:#a5d6ff>1</span>
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>events<span style=color:#ff7b72;font-weight:700>.</span>append(event)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>async</span> <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>get_events</span>(self, aggregate_id: str) <span style=color:#ff7b72;font-weight:700>-&gt;</span> List[dict]:
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;获取聚合的所有事件&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> [
</span></span><span style=display:flex><span>            e <span style=color:#ff7b72>for</span> e <span style=color:#ff7b72;font-weight:700>in</span> self<span style=color:#ff7b72;font-weight:700>.</span>events
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>if</span> e[<span style=color:#a5d6ff>&#39;aggregate_id&#39;</span>] <span style=color:#ff7b72;font-weight:700>==</span> aggregate_id
</span></span><span style=display:flex><span>        ]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>class</span> <span style=color:#f0883e;font-weight:700>OrderAggregate</span>:
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#34;&#34;&#34;订单聚合 - 通过事件重建状态&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>__init__</span>(self, event_store: EventStore):
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>event_store <span style=color:#ff7b72;font-weight:700>=</span> event_store
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>state <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#79c0ff>None</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>async</span> <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>rebuild</span>(self, order_id: str):
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;从事件流重建状态&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        events <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>await</span> self<span style=color:#ff7b72;font-weight:700>.</span>event_store<span style=color:#ff7b72;font-weight:700>.</span>get_events(order_id)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        state <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#79c0ff>None</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>for</span> event <span style=color:#ff7b72;font-weight:700>in</span> events:
</span></span><span style=display:flex><span>            state <span style=color:#ff7b72;font-weight:700>=</span> self<span style=color:#ff7b72;font-weight:700>.</span>_apply_event(state, event)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>state <span style=color:#ff7b72;font-weight:700>=</span> state
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> state
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>_apply_event</span>(self, state, event):
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;应用事件到状态&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        event_type <span style=color:#ff7b72;font-weight:700>=</span> event[<span style=color:#a5d6ff>&#39;type&#39;</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>if</span> event_type <span style=color:#ff7b72;font-weight:700>==</span> <span style=color:#a5d6ff>&#39;OrderCreated&#39;</span>:
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>return</span> {
</span></span><span style=display:flex><span>                <span style=color:#a5d6ff>&#39;id&#39;</span>: event[<span style=color:#a5d6ff>&#39;order_id&#39;</span>],
</span></span><span style=display:flex><span>                <span style=color:#a5d6ff>&#39;user_id&#39;</span>: event[<span style=color:#a5d6ff>&#39;user_id&#39;</span>],
</span></span><span style=display:flex><span>                <span style=color:#a5d6ff>&#39;items&#39;</span>: event[<span style=color:#a5d6ff>&#39;items&#39;</span>],
</span></span><span style=display:flex><span>                <span style=color:#a5d6ff>&#39;status&#39;</span>: <span style=color:#a5d6ff>&#39;CREATED&#39;</span>
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>elif</span> event_type <span style=color:#ff7b72;font-weight:700>==</span> <span style=color:#a5d6ff>&#39;PaymentCompleted&#39;</span>:
</span></span><span style=display:flex><span>            state[<span style=color:#a5d6ff>&#39;status&#39;</span>] <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>&#39;PAID&#39;</span>
</span></span><span style=display:flex><span>            state[<span style=color:#a5d6ff>&#39;payment_id&#39;</span>] <span style=color:#ff7b72;font-weight:700>=</span> event[<span style=color:#a5d6ff>&#39;payment_id&#39;</span>]
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>return</span> state
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>elif</span> event_type <span style=color:#ff7b72;font-weight:700>==</span> <span style=color:#a5d6ff>&#39;OrderShipped&#39;</span>:
</span></span><span style=display:flex><span>            state[<span style=color:#a5d6ff>&#39;status&#39;</span>] <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>&#39;SHIPPED&#39;</span>
</span></span><span style=display:flex><span>            state[<span style=color:#a5d6ff>&#39;shipping_id&#39;</span>] <span style=color:#ff7b72;font-weight:700>=</span> event[<span style=color:#a5d6ff>&#39;shipping_id&#39;</span>]
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>return</span> state
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>elif</span> event_type <span style=color:#ff7b72;font-weight:700>==</span> <span style=color:#a5d6ff>&#39;OrderCancelled&#39;</span>:
</span></span><span style=display:flex><span>            state[<span style=color:#a5d6ff>&#39;status&#39;</span>] <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>&#39;CANCELLED&#39;</span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>return</span> state
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> state
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>async</span> <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>create_order</span>(self, user_id, items):
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;创建订单&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        event <span style=color:#ff7b72;font-weight:700>=</span> {
</span></span><span style=display:flex><span>            <span style=color:#a5d6ff>&#39;type&#39;</span>: <span style=color:#a5d6ff>&#39;OrderCreated&#39;</span>,
</span></span><span style=display:flex><span>            <span style=color:#a5d6ff>&#39;order_id&#39;</span>: generate_id(),
</span></span><span style=display:flex><span>            <span style=color:#a5d6ff>&#39;user_id&#39;</span>: user_id,
</span></span><span style=display:flex><span>            <span style=color:#a5d6ff>&#39;items&#39;</span>: items
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>await</span> self<span style=color:#ff7b72;font-weight:700>.</span>event_store<span style=color:#ff7b72;font-weight:700>.</span>append_event(event[<span style=color:#a5d6ff>&#39;order_id&#39;</span>], event)
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> <span style=color:#ff7b72>await</span> self<span style=color:#ff7b72;font-weight:700>.</span>rebuild(event[<span style=color:#a5d6ff>&#39;order_id&#39;</span>])
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># ========== CQRS ==========</span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># 命令查询职责分离</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>class</span> <span style=color:#f0883e;font-weight:700>CommandBus</span>:
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#34;&#34;&#34;命令总线&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>__init__</span>(self):
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>handlers <span style=color:#ff7b72;font-weight:700>=</span> {}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>register</span>(self, command_type: str, handler):
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;注册命令处理器&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>handlers[command_type] <span style=color:#ff7b72;font-weight:700>=</span> handler
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>async</span> <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>execute</span>(self, command: dict):
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;执行命令&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        command_type <span style=color:#ff7b72;font-weight:700>=</span> command[<span style=color:#a5d6ff>&#39;type&#39;</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>if</span> command_type <span style=color:#ff7b72;font-weight:700>not</span> <span style=color:#ff7b72;font-weight:700>in</span> self<span style=color:#ff7b72;font-weight:700>.</span>handlers:
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>raise</span> <span style=color:#f0883e;font-weight:700>ValueError</span>(<span style=color:#79c0ff>f</span><span style=color:#a5d6ff>&#34;Unknown command: </span><span style=color:#a5d6ff>{</span>command_type<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> <span style=color:#ff7b72>await</span> self<span style=color:#ff7b72;font-weight:700>.</span>handlers[command_type](command)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>class</span> <span style=color:#f0883e;font-weight:700>QueryBus</span>:
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#34;&#34;&#34;查询总线&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>__init__</span>(self):
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>handlers <span style=color:#ff7b72;font-weight:700>=</span> {}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>register</span>(self, query_type: str, handler):
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;注册查询处理器&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>handlers[query_type] <span style=color:#ff7b72;font-weight:700>=</span> handler
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>async</span> <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>execute</span>(self, query: dict):
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;执行查询&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        query_type <span style=color:#ff7b72;font-weight:700>=</span> query[<span style=color:#a5d6ff>&#39;type&#39;</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>if</span> query_type <span style=color:#ff7b72;font-weight:700>not</span> <span style=color:#ff7b72;font-weight:700>in</span> self<span style=color:#ff7b72;font-weight:700>.</span>handlers:
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>raise</span> <span style=color:#f0883e;font-weight:700>ValueError</span>(<span style=color:#79c0ff>f</span><span style=color:#a5d6ff>&#34;Unknown query: </span><span style=color:#a5d6ff>{</span>query_type<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> <span style=color:#ff7b72>await</span> self<span style=color:#ff7b72;font-weight:700>.</span>handlers[query_type](query)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># CQRS示例</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>class</span> <span style=color:#f0883e;font-weight:700>OrderService</span>:
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#34;&#34;&#34;订单服务 - CQRS&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>__init__</span>(self):
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>command_bus <span style=color:#ff7b72;font-weight:700>=</span> CommandBus()
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>query_bus <span style=color:#ff7b72;font-weight:700>=</span> QueryBus()
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>event_store <span style=color:#ff7b72;font-weight:700>=</span> EventStore()
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>read_db <span style=color:#ff7b72;font-weight:700>=</span> {}  <span style=color:#8b949e;font-style:italic># 读模型</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>_register_handlers()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>_register_handlers</span>(self):
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;注册处理器&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic># 命令处理器</span>
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>command_bus<span style=color:#ff7b72;font-weight:700>.</span>register(<span style=color:#a5d6ff>&#39;CreateOrder&#39;</span>, self<span style=color:#ff7b72;font-weight:700>.</span>_handle_create_order)
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>command_bus<span style=color:#ff7b72;font-weight:700>.</span>register(<span style=color:#a5d6ff>&#39;CancelOrder&#39;</span>, self<span style=color:#ff7b72;font-weight:700>.</span>_handle_cancel_order)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic># 查询处理器</span>
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>query_bus<span style=color:#ff7b72;font-weight:700>.</span>register(<span style=color:#a5d6ff>&#39;GetOrder&#39;</span>, self<span style=color:#ff7b72;font-weight:700>.</span>_handle_get_order)
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>query_bus<span style=color:#ff7b72;font-weight:700>.</span>register(<span style=color:#a5d6ff>&#39;ListOrders&#39;</span>, self<span style=color:#ff7b72;font-weight:700>.</span>_handle_list_orders)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>async</span> <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>_handle_create_order</span>(self, command):
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;处理创建订单命令&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        event <span style=color:#ff7b72;font-weight:700>=</span> {
</span></span><span style=display:flex><span>            <span style=color:#a5d6ff>&#39;type&#39;</span>: <span style=color:#a5d6ff>&#39;OrderCreated&#39;</span>,
</span></span><span style=display:flex><span>            <span style=color:#a5d6ff>&#39;order_id&#39;</span>: command[<span style=color:#a5d6ff>&#39;order_id&#39;</span>],
</span></span><span style=display:flex><span>            <span style=color:#a5d6ff>&#39;user_id&#39;</span>: command[<span style=color:#a5d6ff>&#39;user_id&#39;</span>],
</span></span><span style=display:flex><span>            <span style=color:#a5d6ff>&#39;items&#39;</span>: command[<span style=color:#a5d6ff>&#39;items&#39;</span>]
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>await</span> self<span style=color:#ff7b72;font-weight:700>.</span>event_store<span style=color:#ff7b72;font-weight:700>.</span>append_event(command[<span style=color:#a5d6ff>&#39;order_id&#39;</span>], event)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic># 更新读模型</span>
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>_update_read_model(event)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> event[<span style=color:#a5d6ff>&#39;order_id&#39;</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>async</span> <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>_handle_cancel_order</span>(self, command):
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;处理取消订单命令&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        event <span style=color:#ff7b72;font-weight:700>=</span> {
</span></span><span style=display:flex><span>            <span style=color:#a5d6ff>&#39;type&#39;</span>: <span style=color:#a5d6ff>&#39;OrderCancelled&#39;</span>,
</span></span><span style=display:flex><span>            <span style=color:#a5d6ff>&#39;order_id&#39;</span>: command[<span style=color:#a5d6ff>&#39;order_id&#39;</span>]
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>await</span> self<span style=color:#ff7b72;font-weight:700>.</span>event_store<span style=color:#ff7b72;font-weight:700>.</span>append_event(command[<span style=color:#a5d6ff>&#39;order_id&#39;</span>], event)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic># 更新读模型</span>
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>_update_read_model(event)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>async</span> <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>_handle_get_order</span>(self, query):
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;处理获取订单查询&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> self<span style=color:#ff7b72;font-weight:700>.</span>read_db<span style=color:#ff7b72;font-weight:700>.</span>get(query[<span style=color:#a5d6ff>&#39;order_id&#39;</span>])
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>async</span> <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>_handle_list_orders</span>(self, query):
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;处理订单列表查询&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        user_id <span style=color:#ff7b72;font-weight:700>=</span> query<span style=color:#ff7b72;font-weight:700>.</span>get(<span style=color:#a5d6ff>&#39;user_id&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        orders <span style=color:#ff7b72;font-weight:700>=</span> [
</span></span><span style=display:flex><span>            order <span style=color:#ff7b72>for</span> order <span style=color:#ff7b72;font-weight:700>in</span> self<span style=color:#ff7b72;font-weight:700>.</span>read_db<span style=color:#ff7b72;font-weight:700>.</span>values()
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>if</span> <span style=color:#ff7b72;font-weight:700>not</span> user_id <span style=color:#ff7b72;font-weight:700>or</span> order[<span style=color:#a5d6ff>&#39;user_id&#39;</span>] <span style=color:#ff7b72;font-weight:700>==</span> user_id
</span></span><span style=display:flex><span>        ]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> orders
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>_update_read_model</span>(self, event):
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;更新读模型&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        order_id <span style=color:#ff7b72;font-weight:700>=</span> event[<span style=color:#a5d6ff>&#39;order_id&#39;</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>if</span> event[<span style=color:#a5d6ff>&#39;type&#39;</span>] <span style=color:#ff7b72;font-weight:700>==</span> <span style=color:#a5d6ff>&#39;OrderCreated&#39;</span>:
</span></span><span style=display:flex><span>            self<span style=color:#ff7b72;font-weight:700>.</span>read_db[order_id] <span style=color:#ff7b72;font-weight:700>=</span> {
</span></span><span style=display:flex><span>                <span style=color:#a5d6ff>&#39;id&#39;</span>: order_id,
</span></span><span style=display:flex><span>                <span style=color:#a5d6ff>&#39;user_id&#39;</span>: event[<span style=color:#a5d6ff>&#39;user_id&#39;</span>],
</span></span><span style=display:flex><span>                <span style=color:#a5d6ff>&#39;items&#39;</span>: event[<span style=color:#a5d6ff>&#39;items&#39;</span>],
</span></span><span style=display:flex><span>                <span style=color:#a5d6ff>&#39;status&#39;</span>: <span style=color:#a5d6ff>&#39;CREATED&#39;</span>
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>elif</span> event[<span style=color:#a5d6ff>&#39;type&#39;</span>] <span style=color:#ff7b72;font-weight:700>==</span> <span style=color:#a5d6ff>&#39;OrderCancelled&#39;</span>:
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>if</span> order_id <span style=color:#ff7b72;font-weight:700>in</span> self<span style=color:#ff7b72;font-weight:700>.</span>read_db:
</span></span><span style=display:flex><span>                self<span style=color:#ff7b72;font-weight:700>.</span>read_db[order_id][<span style=color:#a5d6ff>&#39;status&#39;</span>] <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>&#39;CANCELLED&#39;</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=四容错与高可用设计>四、容错与高可用设计<a hidden class=anchor aria-hidden=true href=#四容错与高可用设计>#</a></h2><h3 id=41-熔断器模式>4.1 熔断器模式<a hidden class=anchor aria-hidden=true href=#41-熔断器模式>#</a></h3><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 78
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 79
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 80
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 81
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 82
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 83
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 84
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 85
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 86
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 87
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 88
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 89
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 90
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 91
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 92
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 93
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 94
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 95
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 96
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 97
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 98
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 99
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">100
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">101
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">102
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">103
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">104
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">105
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">106
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">107
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">108
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#ff7b72>import</span> <span style=color:#ff7b72>asyncio</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>from</span> <span style=color:#ff7b72>enum</span> <span style=color:#ff7b72>import</span> Enum
</span></span><span style=display:flex><span><span style=color:#ff7b72>from</span> <span style=color:#ff7b72>datetime</span> <span style=color:#ff7b72>import</span> datetime, timedelta
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>class</span> <span style=color:#f0883e;font-weight:700>CircuitState</span>(Enum):
</span></span><span style=display:flex><span>    CLOSED <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>&#39;CLOSED&#39;</span>      <span style=color:#8b949e;font-style:italic># 正常状态</span>
</span></span><span style=display:flex><span>    OPEN <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>&#39;OPEN&#39;</span>          <span style=color:#8b949e;font-style:italic># 熔断状态</span>
</span></span><span style=display:flex><span>    HALF_OPEN <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>&#39;HALF_OPEN&#39;</span>  <span style=color:#8b949e;font-style:italic># 半开状态</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>class</span> <span style=color:#f0883e;font-weight:700>CircuitBreaker</span>:
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#34;&#34;&#34;熔断器&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>__init__</span>(
</span></span><span style=display:flex><span>        self,
</span></span><span style=display:flex><span>        failure_threshold: int <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>5</span>,
</span></span><span style=display:flex><span>        timeout: int <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>60</span>,
</span></span><span style=display:flex><span>        half_open_attempts: int <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>3</span>
</span></span><span style=display:flex><span>    ):
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>failure_threshold <span style=color:#ff7b72;font-weight:700>=</span> failure_threshold
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>timeout <span style=color:#ff7b72;font-weight:700>=</span> timeout
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>half_open_attempts <span style=color:#ff7b72;font-weight:700>=</span> half_open_attempts
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>state <span style=color:#ff7b72;font-weight:700>=</span> CircuitState<span style=color:#ff7b72;font-weight:700>.</span>CLOSED
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>failure_count <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>0</span>
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>success_count <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>0</span>
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>last_failure_time <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#79c0ff>None</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>async</span> <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>call</span>(self, func, <span style=color:#ff7b72;font-weight:700>*</span>args, <span style=color:#ff7b72;font-weight:700>**</span>kwargs):
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;通过熔断器调用函数&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>if</span> self<span style=color:#ff7b72;font-weight:700>.</span>state <span style=color:#ff7b72;font-weight:700>==</span> CircuitState<span style=color:#ff7b72;font-weight:700>.</span>OPEN:
</span></span><span style=display:flex><span>            <span style=color:#8b949e;font-style:italic># 熔断状态，检查是否可以进入半开</span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>if</span> self<span style=color:#ff7b72;font-weight:700>.</span>_should_attempt_reset():
</span></span><span style=display:flex><span>                self<span style=color:#ff7b72;font-weight:700>.</span>state <span style=color:#ff7b72;font-weight:700>=</span> CircuitState<span style=color:#ff7b72;font-weight:700>.</span>HALF_OPEN
</span></span><span style=display:flex><span>                self<span style=color:#ff7b72;font-weight:700>.</span>success_count <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>0</span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>else</span>:
</span></span><span style=display:flex><span>                <span style=color:#ff7b72>raise</span> CircuitBreakerOpenException(
</span></span><span style=display:flex><span>                    <span style=color:#79c0ff>f</span><span style=color:#a5d6ff>&#34;Circuit breaker is OPEN. Try again later.&#34;</span>
</span></span><span style=display:flex><span>                )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>try</span>:
</span></span><span style=display:flex><span>            result <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>await</span> func(<span style=color:#ff7b72;font-weight:700>*</span>args, <span style=color:#ff7b72;font-weight:700>**</span>kwargs)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#8b949e;font-style:italic># 成功，重置计数</span>
</span></span><span style=display:flex><span>            self<span style=color:#ff7b72;font-weight:700>.</span>_on_success()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>return</span> result
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>except</span> <span style=color:#f0883e;font-weight:700>Exception</span> <span style=color:#ff7b72>as</span> e:
</span></span><span style=display:flex><span>            <span style=color:#8b949e;font-style:italic># 失败，增加计数</span>
</span></span><span style=display:flex><span>            self<span style=color:#ff7b72;font-weight:700>.</span>_on_failure()
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>raise</span> e
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>_should_attempt_reset</span>(self) <span style=color:#ff7b72;font-weight:700>-&gt;</span> bool:
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;检查是否应该尝试重置&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>if</span> self<span style=color:#ff7b72;font-weight:700>.</span>last_failure_time <span style=color:#ff7b72;font-weight:700>is</span> <span style=color:#79c0ff>None</span>:
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>return</span> <span style=color:#79c0ff>False</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        elapsed <span style=color:#ff7b72;font-weight:700>=</span> (datetime<span style=color:#ff7b72;font-weight:700>.</span>now() <span style=color:#ff7b72;font-weight:700>-</span> self<span style=color:#ff7b72;font-weight:700>.</span>last_failure_time)<span style=color:#ff7b72;font-weight:700>.</span>seconds
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> elapsed <span style=color:#ff7b72;font-weight:700>&gt;=</span> self<span style=color:#ff7b72;font-weight:700>.</span>timeout
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>_on_success</span>(self):
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;处理成功&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>if</span> self<span style=color:#ff7b72;font-weight:700>.</span>state <span style=color:#ff7b72;font-weight:700>==</span> CircuitState<span style=color:#ff7b72;font-weight:700>.</span>HALF_OPEN:
</span></span><span style=display:flex><span>            self<span style=color:#ff7b72;font-weight:700>.</span>success_count <span style=color:#ff7b72;font-weight:700>+=</span> <span style=color:#a5d6ff>1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#8b949e;font-style:italic># 半开状态下连续成功，恢复关闭状态</span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>if</span> self<span style=color:#ff7b72;font-weight:700>.</span>success_count <span style=color:#ff7b72;font-weight:700>&gt;=</span> self<span style=color:#ff7b72;font-weight:700>.</span>half_open_attempts:
</span></span><span style=display:flex><span>                self<span style=color:#ff7b72;font-weight:700>.</span>state <span style=color:#ff7b72;font-weight:700>=</span> CircuitState<span style=color:#ff7b72;font-weight:700>.</span>CLOSED
</span></span><span style=display:flex><span>                self<span style=color:#ff7b72;font-weight:700>.</span>failure_count <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>elif</span> self<span style=color:#ff7b72;font-weight:700>.</span>state <span style=color:#ff7b72;font-weight:700>==</span> CircuitState<span style=color:#ff7b72;font-weight:700>.</span>CLOSED:
</span></span><span style=display:flex><span>            self<span style=color:#ff7b72;font-weight:700>.</span>failure_count <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>_on_failure</span>(self):
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;处理失败&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>failure_count <span style=color:#ff7b72;font-weight:700>+=</span> <span style=color:#a5d6ff>1</span>
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>last_failure_time <span style=color:#ff7b72;font-weight:700>=</span> datetime<span style=color:#ff7b72;font-weight:700>.</span>now()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic># 达到阈值，打开熔断器</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>if</span> self<span style=color:#ff7b72;font-weight:700>.</span>failure_count <span style=color:#ff7b72;font-weight:700>&gt;=</span> self<span style=color:#ff7b72;font-weight:700>.</span>failure_threshold:
</span></span><span style=display:flex><span>            self<span style=color:#ff7b72;font-weight:700>.</span>state <span style=color:#ff7b72;font-weight:700>=</span> CircuitState<span style=color:#ff7b72;font-weight:700>.</span>OPEN
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># 使用示例</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>async</span> <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>call_external_service</span>(url):
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#34;&#34;&#34;调用外部服务&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>    response <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>await</span> aiohttp<span style=color:#ff7b72;font-weight:700>.</span>get(url)
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> <span style=color:#ff7b72>await</span> response<span style=color:#ff7b72;font-weight:700>.</span>json()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># 创建熔断器</span>
</span></span><span style=display:flex><span>circuit_breaker <span style=color:#ff7b72;font-weight:700>=</span> CircuitBreaker(
</span></span><span style=display:flex><span>    failure_threshold<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>5</span>,
</span></span><span style=display:flex><span>    timeout<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>60</span>,
</span></span><span style=display:flex><span>    half_open_attempts<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>3</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># 通过熔断器调用</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>try</span>:
</span></span><span style=display:flex><span>    result <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>await</span> circuit_breaker<span style=color:#ff7b72;font-weight:700>.</span>call(
</span></span><span style=display:flex><span>        call_external_service,
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#39;http://external-service/api/data&#39;</span>
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span><span style=color:#ff7b72>except</span> CircuitBreakerOpenException:
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic># 熔断器打开，使用降级逻辑</span>
</span></span><span style=display:flex><span>    result <span style=color:#ff7b72;font-weight:700>=</span> get_cached_data()
</span></span><span style=display:flex><span><span style=color:#ff7b72>except</span> <span style=color:#f0883e;font-weight:700>Exception</span> <span style=color:#ff7b72>as</span> e:
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic># 其他错误处理</span>
</span></span><span style=display:flex><span>    logger<span style=color:#ff7b72;font-weight:700>.</span>error(<span style=color:#79c0ff>f</span><span style=color:#a5d6ff>&#34;Service call failed: </span><span style=color:#a5d6ff>{</span>e<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>&#34;</span>)
</span></span></code></pre></td></tr></table></div></div><h3 id=42-重试与超时>4.2 重试与超时<a hidden class=anchor aria-hidden=true href=#42-重试与超时>#</a></h3><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 78
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 79
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 80
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 81
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 82
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 83
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 84
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 85
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 86
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 87
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 88
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 89
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 90
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 91
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 92
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 93
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 94
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 95
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 96
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 97
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 98
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 99
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">100
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">101
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">102
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">103
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#ff7b72>import</span> <span style=color:#ff7b72>asyncio</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>from</span> <span style=color:#ff7b72>functools</span> <span style=color:#ff7b72>import</span> wraps
</span></span><span style=display:flex><span><span style=color:#ff7b72>from</span> <span style=color:#ff7b72>typing</span> <span style=color:#ff7b72>import</span> Callable, Type
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>class</span> <span style=color:#f0883e;font-weight:700>RetryConfig</span>:
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#34;&#34;&#34;重试配置&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>__init__</span>(
</span></span><span style=display:flex><span>        self,
</span></span><span style=display:flex><span>        max_attempts: int <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>3</span>,
</span></span><span style=display:flex><span>        base_delay: float <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>1.0</span>,
</span></span><span style=display:flex><span>        max_delay: float <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>10.0</span>,
</span></span><span style=display:flex><span>        exponential_base: float <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>2</span>,
</span></span><span style=display:flex><span>        jitter: bool <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#79c0ff>True</span>,
</span></span><span style=display:flex><span>        retry_exceptions: list <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#79c0ff>None</span>
</span></span><span style=display:flex><span>    ):
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>max_attempts <span style=color:#ff7b72;font-weight:700>=</span> max_attempts
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>base_delay <span style=color:#ff7b72;font-weight:700>=</span> base_delay
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>max_delay <span style=color:#ff7b72;font-weight:700>=</span> max_delay
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>exponential_base <span style=color:#ff7b72;font-weight:700>=</span> exponential_base
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>jitter <span style=color:#ff7b72;font-weight:700>=</span> jitter
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>retry_exceptions <span style=color:#ff7b72;font-weight:700>=</span> retry_exceptions <span style=color:#ff7b72;font-weight:700>or</span> [<span style=color:#f0883e;font-weight:700>Exception</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>retry</span>(config: RetryConfig <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#79c0ff>None</span>):
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#34;&#34;&#34;重试装饰器&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>if</span> config <span style=color:#ff7b72;font-weight:700>is</span> <span style=color:#79c0ff>None</span>:
</span></span><span style=display:flex><span>        config <span style=color:#ff7b72;font-weight:700>=</span> RetryConfig()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>decorator</span>(func: Callable):
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#d2a8ff;font-weight:700>@wraps</span>(func)
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>async</span> <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>wrapper</span>(<span style=color:#ff7b72;font-weight:700>*</span>args, <span style=color:#ff7b72;font-weight:700>**</span>kwargs):
</span></span><span style=display:flex><span>            last_exception <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#79c0ff>None</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>for</span> attempt <span style=color:#ff7b72;font-weight:700>in</span> range(<span style=color:#a5d6ff>1</span>, config<span style=color:#ff7b72;font-weight:700>.</span>max_attempts <span style=color:#ff7b72;font-weight:700>+</span> <span style=color:#a5d6ff>1</span>):
</span></span><span style=display:flex><span>                <span style=color:#ff7b72>try</span>:
</span></span><span style=display:flex><span>                    <span style=color:#ff7b72>return</span> <span style=color:#ff7b72>await</span> func(<span style=color:#ff7b72;font-weight:700>*</span>args, <span style=color:#ff7b72;font-weight:700>**</span>kwargs)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#ff7b72>except</span> tuple(config<span style=color:#ff7b72;font-weight:700>.</span>retry_exceptions) <span style=color:#ff7b72>as</span> e:
</span></span><span style=display:flex><span>                    last_exception <span style=color:#ff7b72;font-weight:700>=</span> e
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                    <span style=color:#ff7b72>if</span> attempt <span style=color:#ff7b72;font-weight:700>&lt;</span> config<span style=color:#ff7b72;font-weight:700>.</span>max_attempts:
</span></span><span style=display:flex><span>                        <span style=color:#8b949e;font-style:italic># 计算延迟时间</span>
</span></span><span style=display:flex><span>                        delay <span style=color:#ff7b72;font-weight:700>=</span> min(
</span></span><span style=display:flex><span>                            config<span style=color:#ff7b72;font-weight:700>.</span>base_delay <span style=color:#ff7b72;font-weight:700>*</span> (config<span style=color:#ff7b72;font-weight:700>.</span>exponential_base <span style=color:#ff7b72;font-weight:700>**</span> (attempt <span style=color:#ff7b72;font-weight:700>-</span> <span style=color:#a5d6ff>1</span>)),
</span></span><span style=display:flex><span>                            config<span style=color:#ff7b72;font-weight:700>.</span>max_delay
</span></span><span style=display:flex><span>                        )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                        <span style=color:#8b949e;font-style:italic># 添加抖动</span>
</span></span><span style=display:flex><span>                        <span style=color:#ff7b72>if</span> config<span style=color:#ff7b72;font-weight:700>.</span>jitter:
</span></span><span style=display:flex><span>                            delay <span style=color:#ff7b72;font-weight:700>=</span> delay <span style=color:#ff7b72;font-weight:700>*</span> (<span style=color:#a5d6ff>0.5</span> <span style=color:#ff7b72;font-weight:700>+</span> random<span style=color:#ff7b72;font-weight:700>.</span>random() <span style=color:#ff7b72;font-weight:700>*</span> <span style=color:#a5d6ff>0.5</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                        logger<span style=color:#ff7b72;font-weight:700>.</span>warning(
</span></span><span style=display:flex><span>                            <span style=color:#79c0ff>f</span><span style=color:#a5d6ff>&#34;Attempt </span><span style=color:#a5d6ff>{</span>attempt<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff> failed: </span><span style=color:#a5d6ff>{</span>e<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>. &#34;</span>
</span></span><span style=display:flex><span>                            <span style=color:#79c0ff>f</span><span style=color:#a5d6ff>&#34;Retrying in </span><span style=color:#a5d6ff>{</span>delay<span style=color:#a5d6ff>:</span><span style=color:#a5d6ff>.2f</span><span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>s...&#34;</span>
</span></span><span style=display:flex><span>                        )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                        <span style=color:#ff7b72>await</span> asyncio<span style=color:#ff7b72;font-weight:700>.</span>sleep(delay)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#8b949e;font-style:italic># 所有尝试都失败</span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>raise</span> last_exception
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> wrapper
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> decorator
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># 超时装饰器</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>timeout</span>(seconds: float):
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#34;&#34;&#34;超时装饰器&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>decorator</span>(func: Callable):
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#d2a8ff;font-weight:700>@wraps</span>(func)
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>async</span> <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>wrapper</span>(<span style=color:#ff7b72;font-weight:700>*</span>args, <span style=color:#ff7b72;font-weight:700>**</span>kwargs):
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>try</span>:
</span></span><span style=display:flex><span>                <span style=color:#ff7b72>return</span> <span style=color:#ff7b72>await</span> asyncio<span style=color:#ff7b72;font-weight:700>.</span>wait_for(
</span></span><span style=display:flex><span>                    func(<span style=color:#ff7b72;font-weight:700>*</span>args, <span style=color:#ff7b72;font-weight:700>**</span>kwargs),
</span></span><span style=display:flex><span>                    timeout<span style=color:#ff7b72;font-weight:700>=</span>seconds
</span></span><span style=display:flex><span>                )
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>except</span> asyncio<span style=color:#ff7b72;font-weight:700>.</span>TimeoutError:
</span></span><span style=display:flex><span>                <span style=color:#ff7b72>raise</span> TimeoutException(
</span></span><span style=display:flex><span>                    <span style=color:#79c0ff>f</span><span style=color:#a5d6ff>&#34;Function </span><span style=color:#a5d6ff>{</span>func<span style=color:#ff7b72;font-weight:700>.</span><span style=color:#79c0ff>__name__</span><span style=color:#a5d6ff>}</span><span style=color:#a5d6ff> timed out after </span><span style=color:#a5d6ff>{</span>seconds<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>s&#34;</span>
</span></span><span style=display:flex><span>                )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> wrapper
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> decorator
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># 使用示例</span>
</span></span><span style=display:flex><span><span style=color:#d2a8ff;font-weight:700>@retry</span>(RetryConfig(
</span></span><span style=display:flex><span>    max_attempts<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>3</span>,
</span></span><span style=display:flex><span>    base_delay<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>1.0</span>,
</span></span><span style=display:flex><span>    exponential_base<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>2</span>,
</span></span><span style=display:flex><span>    retry_exceptions<span style=color:#ff7b72;font-weight:700>=</span>[<span style=color:#f0883e;font-weight:700>ConnectionError</span>, <span style=color:#f0883e;font-weight:700>TimeoutError</span>]
</span></span><span style=display:flex><span>))
</span></span><span style=display:flex><span><span style=color:#d2a8ff;font-weight:700>@timeout</span>(seconds<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>5</span>)
</span></span><span style=display:flex><span><span style=color:#ff7b72>async</span> <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>call_external_api</span>(url):
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#34;&#34;&#34;调用外部API，带重试和超时&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>async</span> <span style=color:#ff7b72>with</span> aiohttp<span style=color:#ff7b72;font-weight:700>.</span>ClientSession() <span style=color:#ff7b72>as</span> session:
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>async</span> <span style=color:#ff7b72>with</span> session<span style=color:#ff7b72;font-weight:700>.</span>get(url) <span style=color:#ff7b72>as</span> response:
</span></span><span style=display:flex><span>            response<span style=color:#ff7b72;font-weight:700>.</span>raise_for_status()
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>return</span> <span style=color:#ff7b72>await</span> response<span style=color:#ff7b72;font-weight:700>.</span>json()
</span></span></code></pre></td></tr></table></div></div><h3 id=43-限流与降级>4.3 限流与降级<a hidden class=anchor aria-hidden=true href=#43-限流与降级>#</a></h3><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 78
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 79
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 80
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 81
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 82
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 83
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 84
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 85
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 86
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 87
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 88
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 89
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 90
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 91
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 92
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 93
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 94
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 95
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 96
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 97
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 98
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 99
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">100
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">101
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">102
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">103
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">104
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">105
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">106
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">107
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">108
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">109
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">110
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">111
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">112
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">113
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">114
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">115
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">116
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">117
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">118
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">119
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">120
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">121
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">122
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">123
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">124
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">125
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">126
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">127
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">128
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">129
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">130
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">131
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">132
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">133
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">134
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">135
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">136
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">137
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">138
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">139
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">140
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">141
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">142
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">143
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">144
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">145
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">146
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">147
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">148
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">149
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">150
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">151
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">152
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">153
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">154
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">155
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">156
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">157
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">158
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">159
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">160
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">161
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">162
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">163
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">164
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">165
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">166
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">167
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">168
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#ff7b72>import</span> <span style=color:#ff7b72>time</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>from</span> <span style=color:#ff7b72>collections</span> <span style=color:#ff7b72>import</span> deque
</span></span><span style=display:flex><span><span style=color:#ff7b72>from</span> <span style=color:#ff7b72>typing</span> <span style=color:#ff7b72>import</span> Callable, Any
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>class</span> <span style=color:#f0883e;font-weight:700>RateLimiter</span>:
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#34;&#34;&#34;速率限制器&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>__init__</span>(self, rate: int, per: float):
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>        rate: 允许的请求数
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>        per: 时间窗口（秒）
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>        &#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>rate <span style=color:#ff7b72;font-weight:700>=</span> rate
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>per <span style=color:#ff7b72;font-weight:700>=</span> per
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>allowance <span style=color:#ff7b72;font-weight:700>=</span> rate
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>last_check <span style=color:#ff7b72;font-weight:700>=</span> time<span style=color:#ff7b72;font-weight:700>.</span>time()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>acquire</span>(self, tokens: int <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>1</span>) <span style=color:#ff7b72;font-weight:700>-&gt;</span> bool:
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;获取令牌&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        current <span style=color:#ff7b72;font-weight:700>=</span> time<span style=color:#ff7b72;font-weight:700>.</span>time()
</span></span><span style=display:flex><span>        elapsed <span style=color:#ff7b72;font-weight:700>=</span> current <span style=color:#ff7b72;font-weight:700>-</span> self<span style=color:#ff7b72;font-weight:700>.</span>last_check
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic># 补充令牌</span>
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>allowance <span style=color:#ff7b72;font-weight:700>+=</span> elapsed <span style=color:#ff7b72;font-weight:700>*</span> (self<span style=color:#ff7b72;font-weight:700>.</span>rate <span style=color:#ff7b72;font-weight:700>/</span> self<span style=color:#ff7b72;font-weight:700>.</span>per)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>if</span> self<span style=color:#ff7b72;font-weight:700>.</span>allowance <span style=color:#ff7b72;font-weight:700>&gt;</span> self<span style=color:#ff7b72;font-weight:700>.</span>rate:
</span></span><span style=display:flex><span>            self<span style=color:#ff7b72;font-weight:700>.</span>allowance <span style=color:#ff7b72;font-weight:700>=</span> self<span style=color:#ff7b72;font-weight:700>.</span>rate
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>last_check <span style=color:#ff7b72;font-weight:700>=</span> current
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic># 检查是否有足够的令牌</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>if</span> self<span style=color:#ff7b72;font-weight:700>.</span>allowance <span style=color:#ff7b72;font-weight:700>&lt;</span> tokens:
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>return</span> <span style=color:#79c0ff>False</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>allowance <span style=color:#ff7b72;font-weight:700>-=</span> tokens
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> <span style=color:#79c0ff>True</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>class</span> <span style=color:#f0883e;font-weight:700>TokenBucket</span>:
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#34;&#34;&#34;令牌桶算法&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>__init__</span>(self, capacity: int, refill_rate: float):
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>        capacity: 桶容量
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>        refill_rate: 填充速率（每秒）
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>        &#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>capacity <span style=color:#ff7b72;font-weight:700>=</span> capacity
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>refill_rate <span style=color:#ff7b72;font-weight:700>=</span> refill_rate
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>tokens <span style=color:#ff7b72;font-weight:700>=</span> capacity
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>last_refill <span style=color:#ff7b72;font-weight:700>=</span> time<span style=color:#ff7b72;font-weight:700>.</span>time()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>consume</span>(self, tokens: int <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>1</span>) <span style=color:#ff7b72;font-weight:700>-&gt;</span> bool:
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;消费令牌&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>_refill()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>if</span> self<span style=color:#ff7b72;font-weight:700>.</span>tokens <span style=color:#ff7b72;font-weight:700>&gt;=</span> tokens:
</span></span><span style=display:flex><span>            self<span style=color:#ff7b72;font-weight:700>.</span>tokens <span style=color:#ff7b72;font-weight:700>-=</span> tokens
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>return</span> <span style=color:#79c0ff>True</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> <span style=color:#79c0ff>False</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>_refill</span>(self):
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;补充令牌&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        now <span style=color:#ff7b72;font-weight:700>=</span> time<span style=color:#ff7b72;font-weight:700>.</span>time()
</span></span><span style=display:flex><span>        elapsed <span style=color:#ff7b72;font-weight:700>=</span> now <span style=color:#ff7b72;font-weight:700>-</span> self<span style=color:#ff7b72;font-weight:700>.</span>last_refill
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        refill_amount <span style=color:#ff7b72;font-weight:700>=</span> elapsed <span style=color:#ff7b72;font-weight:700>*</span> self<span style=color:#ff7b72;font-weight:700>.</span>refill_rate
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>tokens <span style=color:#ff7b72;font-weight:700>=</span> min(self<span style=color:#ff7b72;font-weight:700>.</span>capacity, self<span style=color:#ff7b72;font-weight:700>.</span>tokens <span style=color:#ff7b72;font-weight:700>+</span> refill_amount)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>last_refill <span style=color:#ff7b72;font-weight:700>=</span> now
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>class</span> <span style=color:#f0883e;font-weight:700>SlidingWindow</span>:
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#34;&#34;&#34;滑动窗口限流&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>__init__</span>(self, limit: int, window: float):
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>        limit: 窗口内最大请求数
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>        window: 时间窗口（秒）
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>        &#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>limit <span style=color:#ff7b72;font-weight:700>=</span> limit
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>window <span style=color:#ff7b72;font-weight:700>=</span> window
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>requests <span style=color:#ff7b72;font-weight:700>=</span> deque()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>is_allowed</span>(self) <span style=color:#ff7b72;font-weight:700>-&gt;</span> bool:
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;检查是否允许请求&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        now <span style=color:#ff7b72;font-weight:700>=</span> time<span style=color:#ff7b72;font-weight:700>.</span>time()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic># 移除窗口外的请求</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>while</span> self<span style=color:#ff7b72;font-weight:700>.</span>requests <span style=color:#ff7b72;font-weight:700>and</span> self<span style=color:#ff7b72;font-weight:700>.</span>requests[<span style=color:#a5d6ff>0</span>] <span style=color:#ff7b72;font-weight:700>&lt;</span> now <span style=color:#ff7b72;font-weight:700>-</span> self<span style=color:#ff7b72;font-weight:700>.</span>window:
</span></span><span style=display:flex><span>            self<span style=color:#ff7b72;font-weight:700>.</span>requests<span style=color:#ff7b72;font-weight:700>.</span>popleft()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic># 检查是否超过限制</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>if</span> len(self<span style=color:#ff7b72;font-weight:700>.</span>requests) <span style=color:#ff7b72;font-weight:700>&gt;=</span> self<span style=color:#ff7b72;font-weight:700>.</span>limit:
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>return</span> <span style=color:#79c0ff>False</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>requests<span style=color:#ff7b72;font-weight:700>.</span>append(now)
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> <span style=color:#79c0ff>True</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># 降级装饰器</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>class</span> <span style=color:#f0883e;font-weight:700>FallbackExecutor</span>:
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#34;&#34;&#34;降级执行器&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>__init__</span>(self):
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>fallbacks <span style=color:#ff7b72;font-weight:700>=</span> {}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>register_fallback</span>(self, func_name: str, fallback: Callable):
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;注册降级函数&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>fallbacks[func_name] <span style=color:#ff7b72;font-weight:700>=</span> fallback
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>async</span> <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>execute_with_fallback</span>(
</span></span><span style=display:flex><span>        self,
</span></span><span style=display:flex><span>        func: Callable,
</span></span><span style=display:flex><span>        <span style=color:#ff7b72;font-weight:700>*</span>args,
</span></span><span style=display:flex><span>        fallback_result: Any <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#79c0ff>None</span>,
</span></span><span style=display:flex><span>        <span style=color:#ff7b72;font-weight:700>**</span>kwargs
</span></span><span style=display:flex><span>    ):
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;执行函数，失败时降级&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>try</span>:
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>return</span> <span style=color:#ff7b72>await</span> func(<span style=color:#ff7b72;font-weight:700>*</span>args, <span style=color:#ff7b72;font-weight:700>**</span>kwargs)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>except</span> <span style=color:#f0883e;font-weight:700>Exception</span> <span style=color:#ff7b72>as</span> e:
</span></span><span style=display:flex><span>            func_name <span style=color:#ff7b72;font-weight:700>=</span> func<span style=color:#ff7b72;font-weight:700>.</span><span style=color:#79c0ff>__name__</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#8b949e;font-style:italic># 查找注册的降级函数</span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>if</span> func_name <span style=color:#ff7b72;font-weight:700>in</span> self<span style=color:#ff7b72;font-weight:700>.</span>fallbacks:
</span></span><span style=display:flex><span>                logger<span style=color:#ff7b72;font-weight:700>.</span>warning(<span style=color:#79c0ff>f</span><span style=color:#a5d6ff>&#34;Function </span><span style=color:#a5d6ff>{</span>func_name<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff> failed, using fallback&#34;</span>)
</span></span><span style=display:flex><span>                <span style=color:#ff7b72>return</span> <span style=color:#ff7b72>await</span> self<span style=color:#ff7b72;font-weight:700>.</span>fallbacks[func_name](<span style=color:#ff7b72;font-weight:700>*</span>args, <span style=color:#ff7b72;font-weight:700>**</span>kwargs)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#8b949e;font-style:italic># 使用默认降级结果</span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>if</span> fallback_result <span style=color:#ff7b72;font-weight:700>is</span> <span style=color:#ff7b72;font-weight:700>not</span> <span style=color:#79c0ff>None</span>:
</span></span><span style=display:flex><span>                logger<span style=color:#ff7b72;font-weight:700>.</span>warning(<span style=color:#79c0ff>f</span><span style=color:#a5d6ff>&#34;Function </span><span style=color:#a5d6ff>{</span>func_name<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff> failed, using fallback result&#34;</span>)
</span></span><span style=display:flex><span>                <span style=color:#ff7b72>return</span> fallback_result
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#8b949e;font-style:italic># 没有降级方案，抛出异常</span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>raise</span> e
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># 使用示例</span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># 创建限流器</span>
</span></span><span style=display:flex><span>rate_limiter <span style=color:#ff7b72;font-weight:700>=</span> RateLimiter(rate<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>100</span>, per<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>1</span>)  <span style=color:#8b949e;font-style:italic># 100请求/秒</span>
</span></span><span style=display:flex><span>token_bucket <span style=color:#ff7b72;font-weight:700>=</span> TokenBucket(capacity<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>10</span>, refill_rate<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>1</span>)  <span style=color:#8b949e;font-style:italic># 10令牌容量，每秒补充1个</span>
</span></span><span style=display:flex><span>sliding_window <span style=color:#ff7b72;font-weight:700>=</span> SlidingWindow(limit<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>100</span>, window<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>60</span>)  <span style=color:#8b949e;font-style:italic># 60秒内最多100请求</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># 创建降级执行器</span>
</span></span><span style=display:flex><span>fallback_executor <span style=color:#ff7b72;font-weight:700>=</span> FallbackExecutor()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>async</span> <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>get_user_data</span>(user_id):
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#34;&#34;&#34;获取用户数据&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic># 检查限流</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>if</span> <span style=color:#ff7b72;font-weight:700>not</span> rate_limiter<span style=color:#ff7b72;font-weight:700>.</span>acquire():
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>raise</span> RateLimitException(<span style=color:#a5d6ff>&#34;Too many requests&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic># 调用服务</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> <span style=color:#ff7b72>await</span> user_service<span style=color:#ff7b72;font-weight:700>.</span>get_user(user_id)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># 注册降级函数</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>async</span> <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>get_user_data_fallback</span>(user_id):
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#34;&#34;&#34;降级：返回缓存的用户数据&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> <span style=color:#ff7b72>await</span> cache<span style=color:#ff7b72;font-weight:700>.</span>get(<span style=color:#79c0ff>f</span><span style=color:#a5d6ff>&#34;user:</span><span style=color:#a5d6ff>{</span>user_id<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>fallback_executor<span style=color:#ff7b72;font-weight:700>.</span>register_fallback(<span style=color:#a5d6ff>&#39;get_user_data&#39;</span>, get_user_data_fallback)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># 使用</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>try</span>:
</span></span><span style=display:flex><span>    result <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>await</span> fallback_executor<span style=color:#ff7b72;font-weight:700>.</span>execute_with_fallback(
</span></span><span style=display:flex><span>        get_user_data,
</span></span><span style=display:flex><span>        user_id<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>&#39;123&#39;</span>
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span><span style=color:#ff7b72>except</span> <span style=color:#f0883e;font-weight:700>Exception</span> <span style=color:#ff7b72>as</span> e:
</span></span><span style=display:flex><span>    logger<span style=color:#ff7b72;font-weight:700>.</span>error(<span style=color:#79c0ff>f</span><span style=color:#a5d6ff>&#34;All attempts failed: </span><span style=color:#a5d6ff>{</span>e<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>&#34;</span>)
</span></span></code></pre></td></tr></table></div></div><h2 id=五可观测性设计>五、可观测性设计<a hidden class=anchor aria-hidden=true href=#五可观测性设计>#</a></h2><h3 id=51-日志系统>5.1 日志系统<a hidden class=anchor aria-hidden=true href=#51-日志系统>#</a></h3><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 78
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 79
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 80
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 81
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 82
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 83
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 84
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 85
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 86
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 87
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 88
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 89
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 90
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 91
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 92
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 93
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 94
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 95
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 96
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 97
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 98
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 99
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">100
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">101
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">102
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">103
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">104
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">105
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">106
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">107
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">108
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">109
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">110
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">111
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">112
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">113
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">114
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">115
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">116
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">117
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">118
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">119
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">120
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">121
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">122
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">123
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">124
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">125
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">126
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">127
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">128
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">129
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">130
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">131
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">132
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">133
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">134
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">135
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">136
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">137
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">138
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">139
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">140
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">141
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">142
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">143
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">144
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">145
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">146
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">147
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">148
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">149
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">150
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">151
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">152
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">153
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">154
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">155
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">156
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">157
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">158
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">159
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">160
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#ff7b72>import</span> <span style=color:#ff7b72>structlog</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>from</span> <span style=color:#ff7b72>typing</span> <span style=color:#ff7b72>import</span> Any
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>class</span> <span style=color:#f0883e;font-weight:700>LogContext</span>:
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#34;&#34;&#34;日志上下文&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>__init__</span>(self):
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>context <span style=color:#ff7b72;font-weight:700>=</span> {}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>set</span>(self, key: str, value: Any):
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;设置上下文&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>context[key] <span style=color:#ff7b72;font-weight:700>=</span> value
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>get</span>(self, key: str, default<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#79c0ff>None</span>):
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;获取上下文&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> self<span style=color:#ff7b72;font-weight:700>.</span>context<span style=color:#ff7b72;font-weight:700>.</span>get(key, default)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>clear</span>(self):
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;清空上下文&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>context<span style=color:#ff7b72;font-weight:700>.</span>clear()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># 全局日志上下文</span>
</span></span><span style=display:flex><span>log_context <span style=color:#ff7b72;font-weight:700>=</span> LogContext()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># 配置structlog</span>
</span></span><span style=display:flex><span>structlog<span style=color:#ff7b72;font-weight:700>.</span>configure(
</span></span><span style=display:flex><span>    processors<span style=color:#ff7b72;font-weight:700>=</span>[
</span></span><span style=display:flex><span>        structlog<span style=color:#ff7b72;font-weight:700>.</span>stdlib<span style=color:#ff7b72;font-weight:700>.</span>filter_by_level,
</span></span><span style=display:flex><span>        structlog<span style=color:#ff7b72;font-weight:700>.</span>stdlib<span style=color:#ff7b72;font-weight:700>.</span>add_logger_name,
</span></span><span style=display:flex><span>        structlog<span style=color:#ff7b72;font-weight:700>.</span>stdlib<span style=color:#ff7b72;font-weight:700>.</span>add_log_level,
</span></span><span style=display:flex><span>        structlog<span style=color:#ff7b72;font-weight:700>.</span>stdlib<span style=color:#ff7b72;font-weight:700>.</span>PositionalArgumentsFormatter(),
</span></span><span style=display:flex><span>        structlog<span style=color:#ff7b72;font-weight:700>.</span>processors<span style=color:#ff7b72;font-weight:700>.</span>TimeStamper(fmt<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>&#34;iso&#34;</span>),
</span></span><span style=display:flex><span>        structlog<span style=color:#ff7b72;font-weight:700>.</span>processors<span style=color:#ff7b72;font-weight:700>.</span>StackInfoRenderer(),
</span></span><span style=display:flex><span>        structlog<span style=color:#ff7b72;font-weight:700>.</span>processors<span style=color:#ff7b72;font-weight:700>.</span>format_exc_info,
</span></span><span style=display:flex><span>        structlog<span style=color:#ff7b72;font-weight:700>.</span>processors<span style=color:#ff7b72;font-weight:700>.</span>UnicodeDecoder(),
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic># 添加上下文</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>lambda</span> logger, method_name, event_dict: {
</span></span><span style=display:flex><span>            <span style=color:#ff7b72;font-weight:700>**</span>event_dict,
</span></span><span style=display:flex><span>            <span style=color:#ff7b72;font-weight:700>**</span>log_context<span style=color:#ff7b72;font-weight:700>.</span>context
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic># 格式化输出</span>
</span></span><span style=display:flex><span>        structlog<span style=color:#ff7b72;font-weight:700>.</span>processors<span style=color:#ff7b72;font-weight:700>.</span>JSONRenderer()
</span></span><span style=display:flex><span>    ],
</span></span><span style=display:flex><span>    context_class<span style=color:#ff7b72;font-weight:700>=</span>dict,
</span></span><span style=display:flex><span>    logger_factory<span style=color:#ff7b72;font-weight:700>=</span>structlog<span style=color:#ff7b72;font-weight:700>.</span>stdlib<span style=color:#ff7b72;font-weight:700>.</span>LoggerFactory(),
</span></span><span style=display:flex><span>    cache_logger_on_first_use<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#79c0ff>True</span>,
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>class</span> <span style=color:#f0883e;font-weight:700>ServiceLogger</span>:
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#34;&#34;&#34;服务日志记录器&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>__init__</span>(self, service_name: str):
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>service_name <span style=color:#ff7b72;font-weight:700>=</span> service_name
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>logger <span style=color:#ff7b72;font-weight:700>=</span> structlog<span style=color:#ff7b72;font-weight:700>.</span>get_logger()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>log_request</span>(self, request_id: str, method: str, path: str, <span style=color:#ff7b72;font-weight:700>**</span>kwargs):
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;记录请求&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>logger<span style=color:#ff7b72;font-weight:700>.</span>info(
</span></span><span style=display:flex><span>            <span style=color:#a5d6ff>&#34;incoming_request&#34;</span>,
</span></span><span style=display:flex><span>            request_id<span style=color:#ff7b72;font-weight:700>=</span>request_id,
</span></span><span style=display:flex><span>            service<span style=color:#ff7b72;font-weight:700>=</span>self<span style=color:#ff7b72;font-weight:700>.</span>service_name,
</span></span><span style=display:flex><span>            method<span style=color:#ff7b72;font-weight:700>=</span>method,
</span></span><span style=display:flex><span>            path<span style=color:#ff7b72;font-weight:700>=</span>path,
</span></span><span style=display:flex><span>            <span style=color:#ff7b72;font-weight:700>**</span>kwargs
</span></span><span style=display:flex><span>        )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>log_response</span>(
</span></span><span style=display:flex><span>        self,
</span></span><span style=display:flex><span>        request_id: str,
</span></span><span style=display:flex><span>        status_code: int,
</span></span><span style=display:flex><span>        duration_ms: float,
</span></span><span style=display:flex><span>        <span style=color:#ff7b72;font-weight:700>**</span>kwargs
</span></span><span style=display:flex><span>    ):
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;记录响应&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>logger<span style=color:#ff7b72;font-weight:700>.</span>info(
</span></span><span style=display:flex><span>            <span style=color:#a5d6ff>&#34;outgoing_response&#34;</span>,
</span></span><span style=display:flex><span>            request_id<span style=color:#ff7b72;font-weight:700>=</span>request_id,
</span></span><span style=display:flex><span>            service<span style=color:#ff7b72;font-weight:700>=</span>self<span style=color:#ff7b72;font-weight:700>.</span>service_name,
</span></span><span style=display:flex><span>            status_code<span style=color:#ff7b72;font-weight:700>=</span>status_code,
</span></span><span style=display:flex><span>            duration_ms<span style=color:#ff7b72;font-weight:700>=</span>duration_ms,
</span></span><span style=display:flex><span>            <span style=color:#ff7b72;font-weight:700>**</span>kwargs
</span></span><span style=display:flex><span>        )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>log_error</span>(self, error: <span style=color:#f0883e;font-weight:700>Exception</span>, <span style=color:#ff7b72;font-weight:700>**</span>kwargs):
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;记录错误&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>logger<span style=color:#ff7b72;font-weight:700>.</span>error(
</span></span><span style=display:flex><span>            <span style=color:#a5d6ff>&#34;error_occurred&#34;</span>,
</span></span><span style=display:flex><span>            service<span style=color:#ff7b72;font-weight:700>=</span>self<span style=color:#ff7b72;font-weight:700>.</span>service_name,
</span></span><span style=display:flex><span>            error_type<span style=color:#ff7b72;font-weight:700>=</span>type(error)<span style=color:#ff7b72;font-weight:700>.</span><span style=color:#79c0ff>__name__</span>,
</span></span><span style=display:flex><span>            error_message<span style=color:#ff7b72;font-weight:700>=</span>str(error),
</span></span><span style=display:flex><span>            <span style=color:#ff7b72;font-weight:700>**</span>kwargs
</span></span><span style=display:flex><span>        )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>log_service_call</span>(
</span></span><span style=display:flex><span>        self,
</span></span><span style=display:flex><span>        service_name: str,
</span></span><span style=display:flex><span>        method: str,
</span></span><span style=display:flex><span>        duration_ms: float,
</span></span><span style=display:flex><span>        success: bool,
</span></span><span style=display:flex><span>        <span style=color:#ff7b72;font-weight:700>**</span>kwargs
</span></span><span style=display:flex><span>    ):
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;记录服务调用&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>logger<span style=color:#ff7b72;font-weight:700>.</span>info(
</span></span><span style=display:flex><span>            <span style=color:#a5d6ff>&#34;service_call&#34;</span>,
</span></span><span style=display:flex><span>            caller<span style=color:#ff7b72;font-weight:700>=</span>self<span style=color:#ff7b72;font-weight:700>.</span>service_name,
</span></span><span style=display:flex><span>            service<span style=color:#ff7b72;font-weight:700>=</span>service_name,
</span></span><span style=display:flex><span>            method<span style=color:#ff7b72;font-weight:700>=</span>method,
</span></span><span style=display:flex><span>            duration_ms<span style=color:#ff7b72;font-weight:700>=</span>duration_ms,
</span></span><span style=display:flex><span>            success<span style=color:#ff7b72;font-weight:700>=</span>success,
</span></span><span style=display:flex><span>            <span style=color:#ff7b72;font-weight:700>**</span>kwargs
</span></span><span style=display:flex><span>        )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># 中间件示例</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>class</span> <span style=color:#f0883e;font-weight:700>LoggingMiddleware</span>:
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#34;&#34;&#34;日志中间件&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>__init__</span>(self, logger: ServiceLogger):
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>logger <span style=color:#ff7b72;font-weight:700>=</span> logger
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>async</span> <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>process_request</span>(self, request, call_next):
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;处理请求&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        request_id <span style=color:#ff7b72;font-weight:700>=</span> generate_request_id()
</span></span><span style=display:flex><span>        start_time <span style=color:#ff7b72;font-weight:700>=</span> time<span style=color:#ff7b72;font-weight:700>.</span>time()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic># 设置日志上下文</span>
</span></span><span style=display:flex><span>        log_context<span style=color:#ff7b72;font-weight:700>.</span>set(<span style=color:#a5d6ff>&#39;request_id&#39;</span>, request_id)
</span></span><span style=display:flex><span>        log_context<span style=color:#ff7b72;font-weight:700>.</span>set(<span style=color:#a5d6ff>&#39;user_id&#39;</span>, request<span style=color:#ff7b72;font-weight:700>.</span>user_id)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic># 记录请求</span>
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>logger<span style=color:#ff7b72;font-weight:700>.</span>log_request(
</span></span><span style=display:flex><span>            request_id<span style=color:#ff7b72;font-weight:700>=</span>request_id,
</span></span><span style=display:flex><span>            method<span style=color:#ff7b72;font-weight:700>=</span>request<span style=color:#ff7b72;font-weight:700>.</span>method,
</span></span><span style=display:flex><span>            path<span style=color:#ff7b72;font-weight:700>=</span>request<span style=color:#ff7b72;font-weight:700>.</span>path
</span></span><span style=display:flex><span>        )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>try</span>:
</span></span><span style=display:flex><span>            <span style=color:#8b949e;font-style:italic># 处理请求</span>
</span></span><span style=display:flex><span>            response <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>await</span> call_next(request)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#8b949e;font-style:italic># 记录响应</span>
</span></span><span style=display:flex><span>            duration_ms <span style=color:#ff7b72;font-weight:700>=</span> (time<span style=color:#ff7b72;font-weight:700>.</span>time() <span style=color:#ff7b72;font-weight:700>-</span> start_time) <span style=color:#ff7b72;font-weight:700>*</span> <span style=color:#a5d6ff>1000</span>
</span></span><span style=display:flex><span>            self<span style=color:#ff7b72;font-weight:700>.</span>logger<span style=color:#ff7b72;font-weight:700>.</span>log_response(
</span></span><span style=display:flex><span>                request_id<span style=color:#ff7b72;font-weight:700>=</span>request_id,
</span></span><span style=display:flex><span>                status_code<span style=color:#ff7b72;font-weight:700>=</span>response<span style=color:#ff7b72;font-weight:700>.</span>status_code,
</span></span><span style=display:flex><span>                duration_ms<span style=color:#ff7b72;font-weight:700>=</span>duration_ms
</span></span><span style=display:flex><span>            )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>return</span> response
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>except</span> <span style=color:#f0883e;font-weight:700>Exception</span> <span style=color:#ff7b72>as</span> e:
</span></span><span style=display:flex><span>            duration_ms <span style=color:#ff7b72;font-weight:700>=</span> (time<span style=color:#ff7b72;font-weight:700>.</span>time() <span style=color:#ff7b72;font-weight:700>-</span> start_time) <span style=color:#ff7b72;font-weight:700>*</span> <span style=color:#a5d6ff>1000</span>
</span></span><span style=display:flex><span>            self<span style=color:#ff7b72;font-weight:700>.</span>logger<span style=color:#ff7b72;font-weight:700>.</span>log_error(
</span></span><span style=display:flex><span>                error<span style=color:#ff7b72;font-weight:700>=</span>e,
</span></span><span style=display:flex><span>                request_id<span style=color:#ff7b72;font-weight:700>=</span>request_id,
</span></span><span style=display:flex><span>                duration_ms<span style=color:#ff7b72;font-weight:700>=</span>duration_ms
</span></span><span style=display:flex><span>            )
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>raise</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>finally</span>:
</span></span><span style=display:flex><span>            log_context<span style=color:#ff7b72;font-weight:700>.</span>clear()
</span></span></code></pre></td></tr></table></div></div><h3 id=52-链路追踪>5.2 链路追踪<a hidden class=anchor aria-hidden=true href=#52-链路追踪>#</a></h3><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">78
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">79
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">80
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">81
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">82
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">83
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">84
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">85
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">86
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">87
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">88
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">89
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">90
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">91
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">92
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">93
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">94
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">95
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">96
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">97
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">98
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#ff7b72>from</span> <span style=color:#ff7b72>opentelemetry</span> <span style=color:#ff7b72>import</span> trace
</span></span><span style=display:flex><span><span style=color:#ff7b72>from</span> <span style=color:#ff7b72>opentelemetry.sdk.trace</span> <span style=color:#ff7b72>import</span> TracerProvider
</span></span><span style=display:flex><span><span style=color:#ff7b72>from</span> <span style=color:#ff7b72>opentelemetry.sdk.trace.export</span> <span style=color:#ff7b72>import</span> BatchSpanProcessor
</span></span><span style=display:flex><span><span style=color:#ff7b72>from</span> <span style=color:#ff7b72>opentelemetry.exporter.jaeger.thrift</span> <span style=color:#ff7b72>import</span> JaegerExporter
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># 配置Tracer</span>
</span></span><span style=display:flex><span>trace<span style=color:#ff7b72;font-weight:700>.</span>set_tracer_provider(TracerProvider())
</span></span><span style=display:flex><span>tracer_provider <span style=color:#ff7b72;font-weight:700>=</span> trace<span style=color:#ff7b72;font-weight:700>.</span>get_tracer_provider()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># 配置Jaeger导出器</span>
</span></span><span style=display:flex><span>jaeger_exporter <span style=color:#ff7b72;font-weight:700>=</span> JaegerExporter(
</span></span><span style=display:flex><span>    agent_host_name<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>&#34;localhost&#34;</span>,
</span></span><span style=display:flex><span>    agent_port<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>6831</span>,
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>tracer_provider<span style=color:#ff7b72;font-weight:700>.</span>add_span_processor(
</span></span><span style=display:flex><span>    BatchSpanProcessor(jaeger_exporter)
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>class</span> <span style=color:#f0883e;font-weight:700>TracingClient</span>:
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#34;&#34;&#34;带追踪的客户端&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>__init__</span>(self, service_name: str):
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>service_name <span style=color:#ff7b72;font-weight:700>=</span> service_name
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>tracer <span style=color:#ff7b72;font-weight:700>=</span> trace<span style=color:#ff7b72;font-weight:700>.</span>get_tracer(<span style=color:#79c0ff>__name__</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>async</span> <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>call_service</span>(
</span></span><span style=display:flex><span>        self,
</span></span><span style=display:flex><span>        service_name: str,
</span></span><span style=display:flex><span>        method: str,
</span></span><span style=display:flex><span>        <span style=color:#ff7b72;font-weight:700>**</span>kwargs
</span></span><span style=display:flex><span>    ):
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;调用服务并追踪&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>with</span> self<span style=color:#ff7b72;font-weight:700>.</span>tracer<span style=color:#ff7b72;font-weight:700>.</span>start_as_current_span(
</span></span><span style=display:flex><span>            <span style=color:#79c0ff>f</span><span style=color:#a5d6ff>&#34;</span><span style=color:#a5d6ff>{</span>service_name<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>.</span><span style=color:#a5d6ff>{</span>method<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>&#34;</span>,
</span></span><span style=display:flex><span>            kind<span style=color:#ff7b72;font-weight:700>=</span>trace<span style=color:#ff7b72;font-weight:700>.</span>SpanKind<span style=color:#ff7b72;font-weight:700>.</span>CLIENT
</span></span><span style=display:flex><span>        ) <span style=color:#ff7b72>as</span> span:
</span></span><span style=display:flex><span>            <span style=color:#8b949e;font-style:italic># 添加属性</span>
</span></span><span style=display:flex><span>            span<span style=color:#ff7b72;font-weight:700>.</span>set_attribute(<span style=color:#a5d6ff>&#34;service&#34;</span>, self<span style=color:#ff7b72;font-weight:700>.</span>service_name)
</span></span><span style=display:flex><span>            span<span style=color:#ff7b72;font-weight:700>.</span>set_attribute(<span style=color:#a5d6ff>&#34;target_service&#34;</span>, service_name)
</span></span><span style=display:flex><span>            span<span style=color:#ff7b72;font-weight:700>.</span>set_attribute(<span style=color:#a5d6ff>&#34;method&#34;</span>, method)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>try</span>:
</span></span><span style=display:flex><span>                <span style=color:#8b949e;font-style:italic># 注入追踪上下文</span>
</span></span><span style=display:flex><span>                headers <span style=color:#ff7b72;font-weight:700>=</span> {}
</span></span><span style=display:flex><span>                trace<span style=color:#ff7b72;font-weight:700>.</span>inject(headers)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#8b949e;font-style:italic># 调用服务</span>
</span></span><span style=display:flex><span>                result <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>await</span> self<span style=color:#ff7b72;font-weight:700>.</span>_make_request(
</span></span><span style=display:flex><span>                    service_name,
</span></span><span style=display:flex><span>                    method,
</span></span><span style=display:flex><span>                    headers<span style=color:#ff7b72;font-weight:700>=</span>headers,
</span></span><span style=display:flex><span>                    <span style=color:#ff7b72;font-weight:700>**</span>kwargs
</span></span><span style=display:flex><span>                )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                span<span style=color:#ff7b72;font-weight:700>.</span>set_attribute(<span style=color:#a5d6ff>&#34;success&#34;</span>, <span style=color:#79c0ff>True</span>)
</span></span><span style=display:flex><span>                <span style=color:#ff7b72>return</span> result
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>except</span> <span style=color:#f0883e;font-weight:700>Exception</span> <span style=color:#ff7b72>as</span> e:
</span></span><span style=display:flex><span>                span<span style=color:#ff7b72;font-weight:700>.</span>record_exception(e)
</span></span><span style=display:flex><span>                span<span style=color:#ff7b72;font-weight:700>.</span>set_attribute(<span style=color:#a5d6ff>&#34;success&#34;</span>, <span style=color:#79c0ff>False</span>)
</span></span><span style=display:flex><span>                <span style=color:#ff7b72>raise</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>async</span> <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>_make_request</span>(self, service_name, method, headers, <span style=color:#ff7b72;font-weight:700>**</span>kwargs):
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;实际请求逻辑&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic># 实现服务调用</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>pass</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># 使用示例</span>
</span></span><span style=display:flex><span>client <span style=color:#ff7b72;font-weight:700>=</span> TracingClient(<span style=color:#a5d6ff>&#34;order-service&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>async</span> <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>create_order</span>(user_id, items):
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#34;&#34;&#34;创建订单 - 带追踪&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>with</span> client<span style=color:#ff7b72;font-weight:700>.</span>tracer<span style=color:#ff7b72;font-weight:700>.</span>start_as_current_span(<span style=color:#a5d6ff>&#34;create_order&#34;</span>) <span style=color:#ff7b72>as</span> span:
</span></span><span style=display:flex><span>        span<span style=color:#ff7b72;font-weight:700>.</span>set_attribute(<span style=color:#a5d6ff>&#34;user_id&#34;</span>, user_id)
</span></span><span style=display:flex><span>        span<span style=color:#ff7b72;font-weight:700>.</span>set_attribute(<span style=color:#a5d6ff>&#34;item_count&#34;</span>, len(items))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic># 调用库存服务</span>
</span></span><span style=display:flex><span>        inventory_result <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>await</span> client<span style=color:#ff7b72;font-weight:700>.</span>call_service(
</span></span><span style=display:flex><span>            <span style=color:#a5d6ff>&#34;inventory-service&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#a5d6ff>&#34;check_stock&#34;</span>,
</span></span><span style=display:flex><span>            items<span style=color:#ff7b72;font-weight:700>=</span>items
</span></span><span style=display:flex><span>        )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic># 调用支付服务</span>
</span></span><span style=display:flex><span>        payment_result <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>await</span> client<span style=color:#ff7b72;font-weight:700>.</span>call_service(
</span></span><span style=display:flex><span>            <span style=color:#a5d6ff>&#34;payment-service&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#a5d6ff>&#34;process_payment&#34;</span>,
</span></span><span style=display:flex><span>            user_id<span style=color:#ff7b72;font-weight:700>=</span>user_id,
</span></span><span style=display:flex><span>            amount<span style=color:#ff7b72;font-weight:700>=</span>calculate_amount(items)
</span></span><span style=display:flex><span>        )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> {
</span></span><span style=display:flex><span>            <span style=color:#a5d6ff>&#34;inventory&#34;</span>: inventory_result,
</span></span><span style=display:flex><span>            <span style=color:#a5d6ff>&#34;payment&#34;</span>: payment_result
</span></span><span style=display:flex><span>        }
</span></span></code></pre></td></tr></table></div></div><h3 id=53-指标监控>5.3 指标监控<a hidden class=anchor aria-hidden=true href=#53-指标监控>#</a></h3><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 78
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 79
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 80
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 81
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 82
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 83
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 84
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 85
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 86
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 87
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 88
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 89
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 90
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 91
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 92
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 93
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 94
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 95
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 96
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 97
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 98
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 99
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">100
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">101
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">102
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">103
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">104
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">105
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">106
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">107
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">108
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">109
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">110
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">111
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">112
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">113
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">114
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">115
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">116
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">117
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#ff7b72>from</span> <span style=color:#ff7b72>prometheus_client</span> <span style=color:#ff7b72>import</span> Counter, Histogram, Gauge, start_http_server
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># 定义指标</span>
</span></span><span style=display:flex><span>request_count <span style=color:#ff7b72;font-weight:700>=</span> Counter(
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#39;http_requests_total&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#39;Total HTTP requests&#39;</span>,
</span></span><span style=display:flex><span>    [<span style=color:#a5d6ff>&#39;method&#39;</span>, <span style=color:#a5d6ff>&#39;endpoint&#39;</span>, <span style=color:#a5d6ff>&#39;status&#39;</span>]
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>request_duration <span style=color:#ff7b72;font-weight:700>=</span> Histogram(
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#39;http_request_duration_seconds&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#39;HTTP request duration&#39;</span>,
</span></span><span style=display:flex><span>    [<span style=color:#a5d6ff>&#39;method&#39;</span>, <span style=color:#a5d6ff>&#39;endpoint&#39;</span>]
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>active_connections <span style=color:#ff7b72;font-weight:700>=</span> Gauge(
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#39;active_connections&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#39;Number of active connections&#39;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>business_metric <span style=color:#ff7b72;font-weight:700>=</span> Counter(
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#39;business_operations_total&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#39;Total business operations&#39;</span>,
</span></span><span style=display:flex><span>    [<span style=color:#a5d6ff>&#39;operation&#39;</span>, <span style=color:#a5d6ff>&#39;status&#39;</span>]
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>class</span> <span style=color:#f0883e;font-weight:700>MetricsMiddleware</span>:
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#34;&#34;&#34;指标收集中间件&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>__init__</span>(self):
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>active_connections <span style=color:#ff7b72;font-weight:700>=</span> active_connections
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>async</span> <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>process_request</span>(self, request, call_next):
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;处理请求并收集指标&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic># 增加活跃连接数</span>
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>active_connections<span style=color:#ff7b72;font-weight:700>.</span>inc()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        start_time <span style=color:#ff7b72;font-weight:700>=</span> time<span style=color:#ff7b72;font-weight:700>.</span>time()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>try</span>:
</span></span><span style=display:flex><span>            response <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>await</span> call_next(request)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#8b949e;font-style:italic># 记录请求计数</span>
</span></span><span style=display:flex><span>            request_count<span style=color:#ff7b72;font-weight:700>.</span>labels(
</span></span><span style=display:flex><span>                method<span style=color:#ff7b72;font-weight:700>=</span>request<span style=color:#ff7b72;font-weight:700>.</span>method,
</span></span><span style=display:flex><span>                endpoint<span style=color:#ff7b72;font-weight:700>=</span>request<span style=color:#ff7b72;font-weight:700>.</span>path,
</span></span><span style=display:flex><span>                status<span style=color:#ff7b72;font-weight:700>=</span>response<span style=color:#ff7b72;font-weight:700>.</span>status_code
</span></span><span style=display:flex><span>            )<span style=color:#ff7b72;font-weight:700>.</span>inc()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#8b949e;font-style:italic># 记录请求耗时</span>
</span></span><span style=display:flex><span>            duration <span style=color:#ff7b72;font-weight:700>=</span> time<span style=color:#ff7b72;font-weight:700>.</span>time() <span style=color:#ff7b72;font-weight:700>-</span> start_time
</span></span><span style=display:flex><span>            request_duration<span style=color:#ff7b72;font-weight:700>.</span>labels(
</span></span><span style=display:flex><span>                method<span style=color:#ff7b72;font-weight:700>=</span>request<span style=color:#ff7b72;font-weight:700>.</span>method,
</span></span><span style=display:flex><span>                endpoint<span style=color:#ff7b72;font-weight:700>=</span>request<span style=color:#ff7b72;font-weight:700>.</span>path
</span></span><span style=display:flex><span>            )<span style=color:#ff7b72;font-weight:700>.</span>observe(duration)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>return</span> response
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>finally</span>:
</span></span><span style=display:flex><span>            <span style=color:#8b949e;font-style:italic># 减少活跃连接数</span>
</span></span><span style=display:flex><span>            self<span style=color:#ff7b72;font-weight:700>.</span>active_connections<span style=color:#ff7b72;font-weight:700>.</span>dec()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>class</span> <span style=color:#f0883e;font-weight:700>BusinessMetrics</span>:
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#34;&#34;&#34;业务指标收集&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#d2a8ff;font-weight:700>@staticmethod</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>record_operation</span>(operation: str, success: bool):
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;记录业务操作&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        status <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>&#34;success&#34;</span> <span style=color:#ff7b72>if</span> success <span style=color:#ff7b72>else</span> <span style=color:#a5d6ff>&#34;failure&#34;</span>
</span></span><span style=display:flex><span>        business_metric<span style=color:#ff7b72;font-weight:700>.</span>labels(
</span></span><span style=display:flex><span>            operation<span style=color:#ff7b72;font-weight:700>=</span>operation,
</span></span><span style=display:flex><span>            status<span style=color:#ff7b72;font-weight:700>=</span>status
</span></span><span style=display:flex><span>        )<span style=color:#ff7b72;font-weight:700>.</span>inc()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#d2a8ff;font-weight:700>@staticmethod</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>record_order_created</span>(order_value: float):
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;记录订单创建&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        business_metric<span style=color:#ff7b72;font-weight:700>.</span>labels(
</span></span><span style=display:flex><span>            operation<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>&#34;order_created&#34;</span>,
</span></span><span style=display:flex><span>            status<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>&#34;success&#34;</span>
</span></span><span style=display:flex><span>        )<span style=color:#ff7b72;font-weight:700>.</span>inc()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#d2a8ff;font-weight:700>@staticmethod</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>record_payment_failed</span>(amount: float, reason: str):
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;记录支付失败&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        business_metric<span style=color:#ff7b72;font-weight:700>.</span>labels(
</span></span><span style=display:flex><span>            operation<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#79c0ff>f</span><span style=color:#a5d6ff>&#34;payment_failed_</span><span style=color:#a5d6ff>{</span>reason<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>&#34;</span>,
</span></span><span style=display:flex><span>            status<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>&#34;failure&#34;</span>
</span></span><span style=display:flex><span>        )<span style=color:#ff7b72;font-weight:700>.</span>inc()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># 使用示例</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>async</span> <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>create_order_logic</span>(user_id, items):
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#34;&#34;&#34;创建订单逻辑&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>try</span>:
</span></span><span style=display:flex><span>        order <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>await</span> order_service<span style=color:#ff7b72;font-weight:700>.</span>create(user_id, items)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        BusinessMetrics<span style=color:#ff7b72;font-weight:700>.</span>record_operation(<span style=color:#a5d6ff>&#34;order_created&#34;</span>, <span style=color:#79c0ff>True</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> order
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>except</span> InventoryError <span style=color:#ff7b72>as</span> e:
</span></span><span style=display:flex><span>        BusinessMetrics<span style=color:#ff7b72;font-weight:700>.</span>record_operation(<span style=color:#a5d6ff>&#34;order_created&#34;</span>, <span style=color:#79c0ff>False</span>)
</span></span><span style=display:flex><span>        BusinessMetrics<span style=color:#ff7b72;font-weight:700>.</span>record_operation(<span style=color:#a5d6ff>&#34;inventory_check_failed&#34;</span>, <span style=color:#79c0ff>False</span>)
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>raise</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>except</span> PaymentError <span style=color:#ff7b72>as</span> e:
</span></span><span style=display:flex><span>        BusinessMetrics<span style=color:#ff7b72;font-weight:700>.</span>record_operation(<span style=color:#a5d6ff>&#34;order_created&#34;</span>, <span style=color:#79c0ff>False</span>)
</span></span><span style=display:flex><span>        BusinessMetrics<span style=color:#ff7b72;font-weight:700>.</span>record_payment_failed(
</span></span><span style=display:flex><span>            order<span style=color:#ff7b72;font-weight:700>.</span>total,
</span></span><span style=display:flex><span>            e<span style=color:#ff7b72;font-weight:700>.</span>reason
</span></span><span style=display:flex><span>        )
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>raise</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># 启动指标服务器</span>
</span></span><span style=display:flex><span>start_http_server(<span style=color:#a5d6ff>8000</span>)
</span></span></code></pre></td></tr></table></div></div><h2 id=总结>总结<a hidden class=anchor aria-hidden=true href=#总结>#</a></h2><p>后端系统架构设计是一个复杂的系统工程，需要综合考虑多个维度：</p><ol><li><strong>架构演进</strong>：根据业务规模选择合适的架构模式</li><li><strong>服务拆分</strong>：按照业务领域合理拆分微服务</li><li><strong>服务通信</strong>：选择合适的同步/异步通信方式</li><li><strong>数据一致性</strong>：采用Saga、CQRS等模式处理分布式事务</li><li><strong>容错设计</strong>：熔断、重试、限流、降级保障系统稳定性</li><li><strong>可观测性</strong>：完善的日志、追踪、监控体系</li></ol><p>架构设计没有银弹，需要根据具体业务场景做出权衡和选择。</p><blockquote><p><strong>相关工具推荐</strong></p><ul><li><a href=https://www.util.cn/tools/json-formatter/>JSON格式化工具</a> - API数据处理</li><li><a href=https://www.util.cn/tools/base64-encode/>Base64编码工具</a> - 数据编码</li><li><a href=https://www.util.cn/tools/sql-formatter/>SQL格式化工具</a> - SQL优化</li></ul></blockquote></div><footer class=post-footer-modern><div class=post-tags-modern><span class=tags-label>🏷️ 标签</span><div class=tags-list><a href=/blog/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/ class=tag-pill>微服务
</a><a href=/blog/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F/ class=tag-pill>分布式系统
</a><a href=/blog/tags/%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/ class=tag-pill>系统设计
</a><a href=/blog/tags/%E6%9C%8D%E5%8A%A1%E6%B2%BB%E7%90%86/ class=tag-pill>服务治理
</a><a href=/blog/tags/%E9%AB%98%E5%8F%AF%E7%94%A8/ class=tag-pill>高可用</a></div></div><style>.post-footer-modern{margin-top:3rem;padding-top:2rem;border-top:1px solid var(--border,#333333)}.post-tags-modern{display:flex;align-items:center;gap:1rem;margin-bottom:2rem;flex-wrap:wrap}.tags-label{font-size:.875rem;font-weight:600;color:var(--secondary,#999999) !important;white-space:nowrap}.tags-list{display:flex;flex-wrap:wrap;gap:.5rem;flex:1}.tag-pill{display:inline-block;padding:.25rem .75rem;background:rgba(255,255,255,5%);border:1px solid var(--border,#333333);border-radius:0;color:var(--secondary,#cccccc) !important;text-decoration:none;font-size:.8rem;font-weight:500;transition:all .2s ease}.tag-pill:hover{background:var(--primary,#ffffff);color:var(--background,#000000) !important;border-color:var(--primary,#ffffff);transform:translateY(-1px)}.post-nav-modern{margin-top:2rem}.nav-grid{display:grid;grid-template-columns:1fr 1fr;gap:1rem}.nav-card{display:flex;align-items:center;gap:1rem;padding:1.25rem;background:rgba(255,255,255,2%);border:1px solid var(--border,#333333);border-radius:12px;text-decoration:none;transition:all .2s ease;min-height:80px}.nav-card:hover{background:rgba(255,255,255,5%);border-color:var(--primary,#ffffff);transform:translateY(-2px)}.nav-card.nav-prev{justify-content:flex-start}.nav-card.nav-next{justify-content:flex-end;text-align:right}.nav-card.nav-next .nav-content{text-align:right}.nav-empty{display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,1%);border:1px dashed var(--border,#333333);color:var(--secondary,#666666)}.nav-arrow{font-size:1.5rem;color:var(--primary,#ffffff);font-weight:300}.nav-content{flex:1}.nav-title{font-size:.95rem;font-weight:600;color:var(--primary,#ffffff) !important;line-height:1.4;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}[data-theme=light] .post-footer-modern{border-color:var(--border-light,#dee2e6)}[data-theme=light] .tags-label{color:var(--secondary-light,#6c757d) !important}[data-theme=light] .tag-pill{background:rgba(0,0,0,5%);border-color:var(--border-light,#dee2e6);color:var(--secondary-light,#495057) !important}[data-theme=light] .tag-pill:hover{background:var(--primary-light,#0066cc);color:var(--background-light,#ffffff) !important;border-color:var(--primary-light,#0066cc)}[data-theme=light] .nav-card{background:rgba(0,0,0,2%);border-color:var(--border-light,#dee2e6)}[data-theme=light] .nav-card:hover{background:rgba(0,102,204,5%);border-color:var(--primary-light,#0066cc)}[data-theme=light] .nav-empty{background:rgba(0,0,0,1%);border-color:var(--border-light,#dee2e6);color:var(--secondary-light,#6c757d)}[data-theme=light] .nav-arrow{color:var(--primary-light,#0066cc)}[data-theme=light] .nav-title{color:var(--primary-light,#212529) !important}@media(max-width:768px){.nav-grid{grid-template-columns:1fr;gap:.75rem}.nav-card{padding:1rem;min-height:70px}.nav-card.nav-next{text-align:left}.nav-card.nav-next .nav-content{text-align:left}.nav-title{font-size:.875rem}.post-tags-modern{flex-direction:column;gap:.75rem}}@media(max-width:480px){.nav-arrow{font-size:1.25rem}.nav-card{padding:.875rem}.nav-title{font-size:.8rem;-webkit-line-clamp:1}}</style><nav class=post-nav-modern><div class=nav-grid><a href=/blog/articles/%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F%E4%B8%80%E8%87%B4%E6%80%A7%E7%AE%97%E6%B3%95%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90%E4%BB%8Epaxos%E5%88%B0raft/ class="nav-card nav-prev"><div class=nav-arrow>←</div><div class=nav-content><div class=nav-title>分布式系统一致性算法深度解析：从Paxos到Raft</div></div></a><a href=/blog/articles/ai%E4%B8%8E%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E5%B7%A5%E7%A8%8B%E5%8C%96%E5%AE%9E%E8%B7%B5%E4%BB%8E%E6%A8%A1%E5%9E%8B%E5%88%B0%E7%94%9F%E4%BA%A7%E7%B3%BB%E7%BB%9F%E7%9A%84%E5%AE%8C%E6%95%B4%E6%8C%87%E5%8D%97/ class="nav-card nav-next"><div class=nav-content><div class=nav-title>AI与机器学习工程化实践：从模型到生产系统的完整指南</div></div><div class=nav-arrow>→</div></a></div></nav></footer></main><aside class=post-sidebar><div class=sidebar-toc id=sidebar-toc><div class=toc-header><div class=toc-title>目录</div><button class=toc-toggle id=toc-toggle aria-label="Toggle TOC">
<svg class="toc-toggle-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6 6 18M6 6l12 12"/></svg></button></div><div class=toc-content id=toc-content><ul class=toc-list><li class="toc-item toc-h2"><a href=#h2-0 class=toc-item-link><span class=toc-item-text>引言</span></a></li><li class="toc-item toc-h2"><a href=#h2-1 class=toc-item-link><span class=toc-item-text>一、架构演进历程</span></a></li><li class="toc-item toc-h2"><a href=#h2-2 class=toc-item-link><span class=toc-item-text>二、微服务架构设计</span></a></li><li class="toc-item toc-h2"><a href=#h2-3 class=toc-item-link><span class=toc-item-text>三、数据一致性设计</span></a></li><li class="toc-item toc-h2"><a href=#h2-4 class=toc-item-link><span class=toc-item-text>四、容错与高可用设计</span></a></li><li class="toc-item toc-h2"><a href=#h2-5 class=toc-item-link><span class=toc-item-text>五、可观测性设计</span></a></li><li class="toc-item toc-h2"><a href=#h2-6 class=toc-item-link><span class=toc-item-text>总结</span></a></li></ul></div></div><script>document.addEventListener("DOMContentLoaded",function(){const e=document.getElementById("sidebar-toc"),t=document.getElementById("toc-toggle"),o=document.getElementById("toc-content"),i=t?.querySelector(".toc-toggle-icon");if(!e)return;let n=!1;t&&t.addEventListener("click",function(){n=!n,n?(o.style.display="none",e.style.width="auto",i.innerHTML='<path d="M9 18l6-6-6-6"/>'):(o.style.display="block",e.style.width="200px",i.innerHTML='<path d="M18 6L6 18M6 6l12 12"/>')});const s=document.querySelector(".post-content");if(s){const e=s.querySelectorAll("h1");e.forEach((e,t)=>{e.id=`h1-${t}`});const t=s.querySelectorAll("h2");t.forEach((e,t)=>{e.id=`h2-${t}`})}const a=document.querySelectorAll(".toc-item-link");a.forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();const n=this.getAttribute("href").substring(1),t=document.getElementById(n);if(t){const e=document.querySelector(".post-header-main")?.offsetHeight||0,n=t.offsetTop-e-20;window.scrollTo({top:n,behavior:"smooth"})}})})})</script><style>.sidebar-toc{position:sticky;top:2rem;width:200px;background:#fff;border:1px solid #e5e7eb;border-radius:4px;overflow:hidden;box-shadow:0 1px 3px rgba(0,0,0,.1);z-index:100}.sidebar-toc.hidden{display:none}.toc-header{padding:12px 16px;border-bottom:1px solid #e5e7eb;background:#fafbfc;display:flex;align-items:center;justify-content:space-between}.toc-title{margin:0;font-size:13px;font-weight:500;color:#374151 !important;font-family:-apple-system,BlinkMacSystemFont,segoe ui,Roboto,sans-serif;text-transform:uppercase;letter-spacing:1px}.toc-toggle{background:0 0;border:none;cursor:pointer;padding:4px;border-radius:4px;display:flex;align-items:center;justify-content:center;transition:all .2s ease;color:#6b7280}.toc-toggle:hover{background:#e5e7eb;color:#374151}.toc-toggle-icon{transition:transform .2s ease}.toc-content{padding:12px 0}.toc-list{list-style:none;margin:0;padding:0}.toc-item{margin-bottom:4px;display:block !important;visibility:visible !important}.toc-h1,.toc-h2{display:block !important}.toc-h2{margin-left:0}.toc-item-link{display:flex;align-items:center;gap:8px;padding:8px 12px;color:#374151 !important;text-decoration:none;font-size:13px;line-height:1.4;border-radius:3px;transition:all .2s ease;font-weight:400}.toc-item-link:hover{background:#f8fafc;color:#1f2937 !important}.toc-item-link.active{background:#e0f2fe;color:#01579b !important;font-weight:500}.toc-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}.dot-red{background:#ef4444}.dot-blue{background:#2196f3}.toc-item-text{color:#1f2937 !important;font-weight:400;flex:1;display:inline !important;visibility:visible !important;opacity:1 !important;font-size:13px !important;line-height:1.4 !important}.toc-item-link .toc-item-text{color:#1f2937 !important;display:inline !important;visibility:visible !important;opacity:1 !important}.toc-item.active .dot-red{background:#d32f2f}.toc-item.active .dot-blue{background:#1976d2}[data-theme=dark] .sidebar-toc{background:#1f2937;border-color:#374151;box-shadow:0 1px 3px rgba(0,0,0,.3)}[data-theme=dark] .toc-header{background:#111827;border-color:#374151}[data-theme=dark] .toc-title{color:#f3f4f6 !important}[data-theme=dark] .toc-toggle{color:#9ca3af}[data-theme=dark] .toc-toggle:hover{background:#374151;color:#f3f4f6}[data-theme=dark] .toc-item-link{color:#e5e7eb !important}[data-theme=dark] .toc-item-link:hover{background:#374151;color:#f9fafb !important}[data-theme=dark] .toc-item-link.active{background:#0d47a1;color:#fff !important}[data-theme=dark] .toc-item-text{color:#f9fafb !important;display:inline !important;visibility:visible !important;opacity:1 !important}[data-theme=dark] .toc-item-link .toc-item-text{color:#f9fafb !important;display:inline !important;visibility:visible !important;opacity:1 !important}@media(max-width:1024px){.sidebar-toc{display:none}.post-content-wrapper{grid-template-columns:1fr !important;padding:0 1rem !important}}</style><style>.post-content-wrapper{display:grid;grid-template-columns:1fr 200px;gap:2rem;padding:0 2rem;max-width:100%}.post-content-main{min-width:0}.post-sidebar{position:sticky;top:2rem;height:fit-content;min-width:0}.post-header-main{margin-bottom:2rem;padding-bottom:1rem;border-bottom:1px solid var(--border,#333333)}.post-header-main .post-title{color:var(--primary,#ffffff) !important;font-size:2.5rem;font-weight:700;line-height:1.2;margin-bottom:1rem}.post-header-main .post-description{color:var(--secondary,#cccccc) !important;font-size:1.1rem;line-height:1.6;margin-bottom:1rem}.post-header-main .post-meta{margin-bottom:0}@media(max-width:1024px){.post-content-wrapper{grid-template-columns:1fr !important;gap:1rem;padding:0 1rem !important}.post-sidebar{display:none}}@media(max-width:768px){.post-header-main .post-title{font-size:2rem}.post-header-main .post-description{font-size:1rem}}</style></aside></div></article></main><footer class=footer><span>© 2024-2025 有条工具技术博客</span> ·</footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");if(menu){const e=localStorage.getItem("menu-scroll-position");e&&(menu.scrollLeft=parseInt(e,10)),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}}document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{const e=document.querySelector("html");e.dataset.theme==="dark"?(e.dataset.theme="light",localStorage.setItem("pref-theme","light")):(e.dataset.theme="dark",localStorage.setItem("pref-theme","dark"))})</script></body></html>