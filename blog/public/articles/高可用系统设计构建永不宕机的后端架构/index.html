<!doctype html><html lang=zh-cn dir=auto data-theme=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>é«˜å¯ç”¨ç³»ç»Ÿè®¾è®¡ï¼šæ„å»ºæ°¸ä¸å®•æœºçš„åç«¯æ¶æ„ | æŠ€æœ¯åšå®¢ - æœ‰æ¡å·¥å…·</title><meta name=keywords content="é«˜å¯ç”¨,ç³»ç»Ÿæ¶æ„,å®¹é”™è®¾è®¡,SLA,è´Ÿè½½å‡è¡¡"><meta name=description content="å…¨é¢è§£æé«˜å¯ç”¨ç³»ç»Ÿè®¾è®¡çš„åŸåˆ™ã€æ¨¡å¼å’Œå®æˆ˜æŠ€å·§ï¼ŒåŒ…æ‹¬å†—ä½™è®¾è®¡ã€æ•…éšœè½¬ç§»ã€é™æµé™çº§ã€å®¹é”™æœºåˆ¶ç­‰ï¼Œå¸®åŠ©ä½ æ„å»º99.99%å¯ç”¨æ€§çš„ç³»ç»Ÿã€‚"><meta name=author content="æœ‰æ¡å·¥å…·å›¢é˜Ÿ"><link rel=canonical href=/blog/articles/%E9%AB%98%E5%8F%AF%E7%94%A8%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1%E6%9E%84%E5%BB%BA%E6%B0%B8%E4%B8%8D%E5%AE%95%E6%9C%BA%E7%9A%84%E5%90%8E%E7%AB%AF%E6%9E%B6%E6%9E%84/><link crossorigin=anonymous href=/blog/assets/css/stylesheet.7e8505b7cdf8bb22ab2305e53c2700bb06c7e64faeb72cd3468823a9a3bd3d6e.css integrity="sha256-foUFt834uyKrIwXlPCcAuwbH5k+utyzTRogjqaO9PW4=" rel="preload stylesheet" as=style><link rel=icon href=/favicon.ico><link rel=icon type=image/png sizes=16x16 href=/blog/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=/blog/favicon-32x32.png><link rel=apple-touch-icon href=/blog/apple-touch-icon.png><link rel=mask-icon href=/blog/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate type=application/rss+xml href=/blog/articles/%E9%AB%98%E5%8F%AF%E7%94%A8%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1%E6%9E%84%E5%BB%BA%E6%B0%B8%E4%B8%8D%E5%AE%95%E6%9C%BA%E7%9A%84%E5%90%8E%E7%AB%AF%E6%9E%B6%E6%9E%84/feed.xml title=rss><link rel=alternate hreflang=zh-cn href=/blog/articles/%E9%AB%98%E5%8F%AF%E7%94%A8%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1%E6%9E%84%E5%BB%BA%E6%B0%B8%E4%B8%8D%E5%AE%95%E6%9C%BA%E7%9A%84%E5%90%8E%E7%AB%AF%E6%9E%B6%E6%9E%84/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51);color-scheme:dark}.list{background:var(--theme)}.toc{background:var(--entry)}}@media(prefers-color-scheme:light){.list::-webkit-scrollbar-thumb{border-color:var(--code-bg)}}</style></noscript><script>localStorage.getItem("pref-theme")==="dark"?document.querySelector("html").dataset.theme="dark":localStorage.getItem("pref-theme")==="light"?document.querySelector("html").dataset.theme="light":window.matchMedia("(prefers-color-scheme: dark)").matches?document.querySelector("html").dataset.theme="dark":document.querySelector("html").dataset.theme="light"</script><script src=/js/external-link-config.js></script><script src=/js/external-link-interceptor.js></script><link rel=stylesheet href=/blog/css/custom.css media=screen><script type=application/ld+json>{"@context":"https://schema.org","@type":"WebSite","name":"æŠ€æœ¯åšå®¢ - æœ‰æ¡å·¥å…· | å¼€å‘è€…å·¥å…·ä½¿ç”¨æ•™ç¨‹ & ç¼–ç¨‹æŠ€å·§åˆ†äº«","url":"https://www.util.cn/blog/","description":"æœ‰æ¡å·¥å…·æŠ€æœ¯åšå®¢ - åˆ†äº«å¼€å‘è€…å·¥å…·ä½¿ç”¨æ•™ç¨‹ã€ç¼–ç¨‹æŠ€å·§å’Œå®æˆ˜å¼€å‘ç»éªŒã€‚æä¾›JSONæ ¼å¼åŒ–ã€SQLä¼˜åŒ–ã€Markdownç¼–è¾‘å™¨ç­‰åœ¨çº¿å·¥å…·çš„è¯¦ç»†ä½¿ç”¨æŒ‡å—ï¼Œå¸®åŠ©å¼€å‘è€…æå‡å·¥ä½œæ•ˆç‡ã€‚","publisher":{"@type":"Organization","name":"æœ‰æ¡å·¥å…·","url":"https://www.util.cn","logo":{"@type":"ImageObject","url":"https://www.util.cn/blog/logo/logo-256.png","width":256,"height":256}},"potentialAction":[{"@type":"SearchAction","target":"https://www.util.cn/blog/search?q={search_term_string}","query-input":"required name=search_term_string"}]}</script><meta property="og:type" content="website"><meta property="og:title" content="æŠ€æœ¯åšå®¢ - æœ‰æ¡å·¥å…· | å¼€å‘è€…å·¥å…·ä½¿ç”¨æ•™ç¨‹ & ç¼–ç¨‹æŠ€å·§åˆ†äº«"><meta property="og:description" content="æœ‰æ¡å·¥å…·æŠ€æœ¯åšå®¢ - åˆ†äº«å¼€å‘è€…å·¥å…·ä½¿ç”¨æ•™ç¨‹ã€ç¼–ç¨‹æŠ€å·§å’Œå®æˆ˜å¼€å‘ç»éªŒã€‚æä¾›JSONæ ¼å¼åŒ–ã€SQLä¼˜åŒ–ã€Markdownç¼–è¾‘å™¨ç­‰åœ¨çº¿å·¥å…·çš„è¯¦ç»†ä½¿ç”¨æŒ‡å—ï¼Œå¸®åŠ©å¼€å‘è€…æå‡å·¥ä½œæ•ˆç‡ã€‚"><meta property="og:url" content="https://www.util.cn/blog/"><meta property="og:site_name" content="æœ‰æ¡å·¥å…·æŠ€æœ¯åšå®¢"><meta property="og:image" content="https://www.util.cn/blog/logo/logo-256.png"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="630"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="æŠ€æœ¯åšå®¢ - æœ‰æ¡å·¥å…· | å¼€å‘è€…å·¥å…·ä½¿ç”¨æ•™ç¨‹ & ç¼–ç¨‹æŠ€å·§åˆ†äº«"><meta name=twitter:description content="æœ‰æ¡å·¥å…·æŠ€æœ¯åšå®¢ - åˆ†äº«å¼€å‘è€…å·¥å…·ä½¿ç”¨æ•™ç¨‹ã€ç¼–ç¨‹æŠ€å·§å’Œå®æˆ˜å¼€å‘ç»éªŒã€‚"><meta name=twitter:image content="https://www.util.cn/blog/logo/logo-256.png"><meta name=baidu-site-verification content><meta name=category content="æŠ€æœ¯åšå®¢,å¼€å‘è€…å·¥å…·,ç¼–ç¨‹æ•™ç¨‹"><meta name=coverage content="Worldwide"><meta name=distribution content="Global"><meta name=rating content="General"><script id=51la_code async crossorigin=anonymous src="https://sdk.51.la/js-sdk-pro.min.js?id=3OM52V0xJAPv6ozF&hash=pro"></script><script>window.addEventListener("load",function(){setTimeout(function(){typeof la!="undefined"?console.log("51laç»Ÿè®¡å·²åŠ è½½"):(console.warn("51laç»Ÿè®¡åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ"),function(){var e=document.createElement("script");e.src="https://sdk.51.la/js-sdk-pro.min.js?id=3OM52V0xJAPv6ozF&hash=backup",e.async=!0,document.head.appendChild(e)}())},3e3)})</script><meta property="og:url" content="/blog/articles/%E9%AB%98%E5%8F%AF%E7%94%A8%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1%E6%9E%84%E5%BB%BA%E6%B0%B8%E4%B8%8D%E5%AE%95%E6%9C%BA%E7%9A%84%E5%90%8E%E7%AB%AF%E6%9E%B6%E6%9E%84/"><meta property="og:site_name" content="æŠ€æœ¯åšå®¢ - æœ‰æ¡å·¥å…·"><meta property="og:title" content="é«˜å¯ç”¨ç³»ç»Ÿè®¾è®¡ï¼šæ„å»ºæ°¸ä¸å®•æœºçš„åç«¯æ¶æ„"><meta property="og:description" content="å…¨é¢è§£æé«˜å¯ç”¨ç³»ç»Ÿè®¾è®¡çš„åŸåˆ™ã€æ¨¡å¼å’Œå®æˆ˜æŠ€å·§ï¼ŒåŒ…æ‹¬å†—ä½™è®¾è®¡ã€æ•…éšœè½¬ç§»ã€é™æµé™çº§ã€å®¹é”™æœºåˆ¶ç­‰ï¼Œå¸®åŠ©ä½ æ„å»º99.99%å¯ç”¨æ€§çš„ç³»ç»Ÿã€‚"><meta property="og:locale" content="zh-cn"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-12-25T17:00:00+08:00"><meta property="article:modified_time" content="2025-12-25T17:00:00+08:00"><meta property="article:tag" content="é«˜å¯ç”¨"><meta property="article:tag" content="ç³»ç»Ÿæ¶æ„"><meta property="article:tag" content="å®¹é”™è®¾è®¡"><meta property="article:tag" content="SLA"><meta property="article:tag" content="è´Ÿè½½å‡è¡¡"><meta name=twitter:card content="summary"><meta name=twitter:title content="é«˜å¯ç”¨ç³»ç»Ÿè®¾è®¡ï¼šæ„å»ºæ°¸ä¸å®•æœºçš„åç«¯æ¶æ„"><meta name=twitter:description content="å…¨é¢è§£æé«˜å¯ç”¨ç³»ç»Ÿè®¾è®¡çš„åŸåˆ™ã€æ¨¡å¼å’Œå®æˆ˜æŠ€å·§ï¼ŒåŒ…æ‹¬å†—ä½™è®¾è®¡ã€æ•…éšœè½¬ç§»ã€é™æµé™çº§ã€å®¹é”™æœºåˆ¶ç­‰ï¼Œå¸®åŠ©ä½ æ„å»º99.99%å¯ç”¨æ€§çš„ç³»ç»Ÿã€‚"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"æ‰€æœ‰æ–‡ç« ","item":"/blog/posts/"},{"@type":"ListItem","position":2,"name":"é«˜å¯ç”¨ç³»ç»Ÿè®¾è®¡ï¼šæ„å»ºæ°¸ä¸å®•æœºçš„åç«¯æ¶æ„","item":"/blog/articles/%E9%AB%98%E5%8F%AF%E7%94%A8%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1%E6%9E%84%E5%BB%BA%E6%B0%B8%E4%B8%8D%E5%AE%95%E6%9C%BA%E7%9A%84%E5%90%8E%E7%AB%AF%E6%9E%B6%E6%9E%84/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"é«˜å¯ç”¨ç³»ç»Ÿè®¾è®¡ï¼šæ„å»ºæ°¸ä¸å®•æœºçš„åç«¯æ¶æ„","name":"é«˜å¯ç”¨ç³»ç»Ÿè®¾è®¡ï¼šæ„å»ºæ°¸ä¸å®•æœºçš„åç«¯æ¶æ„","description":"å…¨é¢è§£æé«˜å¯ç”¨ç³»ç»Ÿè®¾è®¡çš„åŸåˆ™ã€æ¨¡å¼å’Œå®æˆ˜æŠ€å·§ï¼ŒåŒ…æ‹¬å†—ä½™è®¾è®¡ã€æ•…éšœè½¬ç§»ã€é™æµé™çº§ã€å®¹é”™æœºåˆ¶ç­‰ï¼Œå¸®åŠ©ä½ æ„å»º99.99%å¯ç”¨æ€§çš„ç³»ç»Ÿã€‚","keywords":["é«˜å¯ç”¨","ç³»ç»Ÿæ¶æ„","å®¹é”™è®¾è®¡","SLA","è´Ÿè½½å‡è¡¡"],"articleBody":"ç³»ç»Ÿå¯ç”¨æ€§æ˜¯è¡¡é‡æœåŠ¡è´¨é‡çš„æ ¸å¿ƒæŒ‡æ ‡ã€‚ä¸€ä¸ª99.9%å¯ç”¨æ€§çš„ç³»ç»Ÿæ„å‘³ç€æ¯å¹´åªèƒ½æœ‰8.76å°æ—¶çš„åœæœºæ—¶é—´ï¼Œè€Œ99.99%åˆ™åªèƒ½æœ‰52.56åˆ†é’Ÿã€‚æœ¬æ–‡å°†ç³»ç»Ÿæ€§åœ°ä»‹ç»å¦‚ä½•è®¾è®¡çœŸæ­£é«˜å¯ç”¨çš„åç«¯ç³»ç»Ÿã€‚\nå¯ç”¨æ€§åº¦é‡ SLAä¸è®¡ç®— å¯ç”¨æ€§ç­‰çº§å¯¹æ¯”ï¼š â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ å¯ç”¨æ€§ â”‚ å¹´åœæœºæ—¶é—´ â”‚ æœˆåœæœºæ—¶é—´ â”‚ å‘¨åœæœºæ—¶é—´ â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚ 99% â”‚ 3.65å¤© â”‚ 7.31å°æ—¶ â”‚ 1.68å°æ—¶ â”‚ â”‚ 99.9% â”‚ 8.77å°æ—¶ â”‚ 43.83åˆ†é’Ÿ â”‚ 10.08åˆ†é’Ÿ â”‚ â”‚ 99.99% â”‚ 52.60åˆ†é’Ÿ â”‚ 4.38åˆ†é’Ÿ â”‚ 1.01åˆ†é’Ÿ â”‚ â”‚ 99.999% â”‚ 5.26åˆ†é’Ÿ â”‚ 26.30ç§’ â”‚ 6.05ç§’ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ MTTRä¸MTBF 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 // å¯é æ€§æŒ‡æ ‡è®¡ç®— interface ReliabilityMetrics { mtbf: number; // Mean Time Between Failures - å¹³å‡æ•…éšœé—´éš” mttr: number; // Mean Time To Repair - å¹³å‡ä¿®å¤æ—¶é—´ availability: number; // å¯ç”¨æ€§ = MTBF / (MTBF + MTTR) } class AvailabilityCalculator { calculate(metrics: ReliabilityMetrics): number { return metrics.mtbf / (metrics.mtbf + metrics.mttr); } // ç¤ºä¾‹ï¼šç³»ç»Ÿå¹³å‡è¿è¡Œ720å°æ—¶æ•…éšœä¸€æ¬¡ï¼Œä¿®å¤éœ€è¦1å°æ—¶ example(): void { const metrics: ReliabilityMetrics = { mtbf: 720 * 3600 * 1000, // 720å°æ—¶ï¼ˆæ¯«ç§’ï¼‰ mttr: 1 * 3600 * 1000 // 1å°æ—¶ï¼ˆæ¯«ç§’ï¼‰ }; const availability = this.calculate(metrics); // å¯ç”¨æ€§ = 720 / (720 + 1) â‰ˆ 99.86% // è¦è¾¾åˆ°99.99%ï¼ŒMTTRéœ€è¦é™è‡³ï¼š // 0.9999 = 720 / (720 + x) // x = 720 / 0.9999 - 720 â‰ˆ 0.072å°æ—¶ â‰ˆ 4.3åˆ†é’Ÿ } } æ ¸å¿ƒè®¾è®¡åŸåˆ™ 1. æ¶ˆé™¤å•ç‚¹æ•…éšœï¼ˆSPOFï¼‰ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 // å•ç‚¹æ•…éšœç¤ºä¾‹ class BadArchitecture { // âŒ å•æ•°æ®åº“å®ä¾‹ private db: Database = new SingleDatabaseInstance(); // âŒ å•ç¼“å­˜æœåŠ¡å™¨ private cache: Cache = new SingleRedisServer(); // âŒ å•æ–‡ä»¶å­˜å‚¨ private storage: Storage = new SingleNFSServer(); } // é«˜å¯ç”¨æ¶æ„ class GoodArchitecture { // âœ… æ•°æ®åº“ä¸»ä»å¤åˆ¶ private db: DatabaseCluster = new DatabaseCluster({ primary: 'db-primary', replicas: ['db-replica-1', 'db-replica-2'], autoFailover: true }); // âœ… ç¼“å­˜é›†ç¾¤ private cache: CacheCluster = new RedisCluster({ nodes: ['redis-1', 'redis-2', 'redis-3'], replicationFactor: 2 }); // âœ… åˆ†å¸ƒå¼å­˜å‚¨ private storage: Storage = new S3Storage({ region: 'us-east-1', availabilityZones: ['us-east-1a', 'us-east-1b', 'us-east-1c'] }); } 2. å†—ä½™è®¾è®¡ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 // æœåŠ¡å†—ä½™ - å¤šå‰¯æœ¬éƒ¨ç½² class ServiceDeployment { async deploy(service: Service): Promise\u003cvoid\u003e { // åœ¨å¤šä¸ªå¯ç”¨åŒºéƒ¨ç½²å‰¯æœ¬ const zones = ['us-east-1a', 'us-east-1b', 'us-east-1c']; for (const zone of zones) { await this.k8s.deploy({ service: service.name, replicas: 3, // æ¯ä¸ªåŒºåŸŸ3ä¸ªå‰¯æœ¬ affinity: { podAntiAffinity: { requiredDuringSchedulingIgnoredDuringExecution: [{ labelSelector: { matchLabels: { app: service.name } }, topologyKey: 'kubernetes.io/hostname' }] } } }); } } } // æ•°æ®å†—ä½™ - ä¸»ä»å¤åˆ¶ class DatabaseReplication { async setupReplication(): Promise\u003cvoid\u003e { const primary = new PostgreSQL('db-primary'); const standby1 = new PostgreSQL('db-standby-1'); const standby2 = new PostgreSQL('db-standby-2'); // é…ç½®æµå¤åˆ¶ await primary.config({ wal_level: 'replica', max_wal_senders: 10, wal_keep_size: '1GB' }); await standby1.config({ hot_standby: 'on', primary_conninfo: 'host=db-primary port=5432' }); await standby2.config({ hot_standby: 'on', primary_conninfo: 'host=db-primary port=5432' }); } } 3. æ•…éšœæ£€æµ‹ä¸è½¬ç§» 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 // å¥åº·æ£€æŸ¥ç³»ç»Ÿ class HealthChecker { private services = new Map\u003cstring, ServiceHealth\u003e(); async checkAll(): Promise\u003cHealthReport\u003e { const results = await Promise.allSettled( Array.from(this.services.values()).map(svc =\u003e this.checkService(svc) ) ); const report: HealthReport = { healthy: 0, unhealthy: 0, details: [] }; for (const result of results) { if (result.status === 'fulfilled') { report.healthy++; report.details.push({ service: result.value.name, status: 'healthy', responseTime: result.value.responseTime }); } else { report.unhealthy++; report.details.push({ service: result.reason.service, status: 'unhealthy', error: result.reason.message }); } } return report; } private async checkService( service: ServiceHealth ): Promise\u003cServiceHealth\u003e { const start = Date.now(); try { // TCPæ£€æŸ¥ await this.tcpCheck(service.host, service.port); // HTTPæ£€æŸ¥ await this.httpCheck(`${service.url}/health`); // å“åº”æ—¶é—´ const responseTime = Date.now() - start; if (responseTime \u003e service.timeout) { throw new Error('Response timeout'); } return { ...service, status: 'healthy', responseTime, lastCheck: Date.now() }; } catch (error) { throw { service: service.name, message: error.message }; } } } // è‡ªåŠ¨æ•…éšœè½¬ç§» class FailoverController { private primary: string; private secondaries: string[]; private currentPrimary: string; async monitorAndFailover(): Promise\u003cvoid\u003e { setInterval(async () =\u003e { const isHealthy = await this.checkHealth(this.currentPrimary); if (!isHealthy) { console.warn('Primary unhealthy, initiating failover'); await this.failover(); } }, 5000); // æ¯5ç§’æ£€æŸ¥ä¸€æ¬¡ } private async failover(): Promise\u003cvoid\u003e { // 1. é€‰æ‹©æ–°çš„ä¸»èŠ‚ç‚¹ const newPrimary = await this.selectBestSecondary(); // 2. æå‡æ–°ä¸»èŠ‚ç‚¹ await this.promoteToPrimary(newPrimary); // 3. æ›´æ–°DNS/è´Ÿè½½å‡è¡¡ await this.updateRouting(newPrimary); // 4. é‡æ–°é…ç½®å¤åˆ¶ await this.reconfigureReplication(newPrimary); this.currentPrimary = newPrimary; console.log(`Failover completed: ${newPrimary} is now primary`); } private async selectBestSecondary(): Promise\u003cstring\u003e { const candidates = await Promise.all( this.secondaries.map(async (sec) =\u003e ({ id: sec, health: await this.checkHealth(sec), replicationLag: await this.getReplicationLag(sec) })) ); // é€‰æ‹©å¥åº·ä¸”å»¶è¿Ÿæœ€å°çš„ return candidates .filter(c =\u003e c.health) .sort((a, b) =\u003e a.replicationLag - b.replicationLag)[0].id; } } è´Ÿè½½å‡è¡¡ å¤šå±‚è´Ÿè½½å‡è¡¡ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 // å››å±‚è´Ÿè½½å‡è¡¡ï¼ˆTCP/UDPï¼‰ class L4LoadBalancer { private backendServers: string[]; distributeTraffic(sourceIP: string, sourcePort: number): string { // ä½¿ç”¨ä¸€è‡´æ€§å“ˆå¸Œ const hash = this.consistentHash(`${sourceIP}:${sourcePort}`); const index = hash % this.backendServers.length; return this.backendServers[index]; } } // ä¸ƒå±‚è´Ÿè½½å‡è¡¡ï¼ˆHTTPï¼‰ class L7LoadBalancer { private backends: Backend[]; selectBackend(request: HttpRequest): Backend { // åŸºäºè¯·æ±‚è·¯å¾„çš„è·¯ç”± if (request.path.startsWith('/api/')) { return this.backends.find(b =\u003e b.name === 'api-server'); } // åŸºäºHTTPå¤´çš„è·¯ç”± if (request.headers['x-api-version'] === 'v2') { return this.backends.find(b =\u003e b.name === 'api-v2-server'); } // åŸºäºå†…å®¹ç±»å‹çš„è·¯ç”± if (request.headers['content-type'] === 'application/grpc') { return this.backends.find(b =\u003e b.name === 'grpc-server'); } // é»˜è®¤è½®è¯¢ return this.roundRobin(); } } // è´Ÿè½½å‡è¡¡ç®—æ³• class LoadBalancingAlgorithms { // è½®è¯¢ private roundRobinIndex = 0; roundRobin(servers: Server[]): Server { const server = servers[this.roundRobinIndex]; this.roundRobinIndex = (this.roundRobinIndex + 1) % servers.length; return server; } // æœ€å°‘è¿æ¥ leastConnections(servers: Server[]): Server { return servers.reduce((min, server) =\u003e server.connections \u003c min.connections ? server : min ); } // åŠ æƒè½®è¯¢ weightedRoundRobin(servers: WeightedServer[]): Server { const totalWeight = servers.reduce((sum, s) =\u003e sum + s.weight, 0); let random = Math.random() * totalWeight; for (const server of servers) { random -= server.weight; if (random \u003c= 0) { return server; } } return servers[0]; } // ä¸€è‡´æ€§å“ˆå¸Œ consistentHash(key: string, servers: Server[]): Server { const hash = this.md5(key); const index = parseInt(hash.substring(0, 8), 16) % servers.length; return servers[index]; } } é™æµä¸é™çº§ é™æµç­–ç•¥ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 // ä»¤ç‰Œæ¡¶ç®—æ³• class TokenBucket { private tokens: number; private lastRefill: number; constructor( private capacity: number, private refillRate: number // æ¯ç§’ä»¤ç‰Œæ•° ) { this.tokens = capacity; this.lastRefill = Date.now(); } async consume(tokens: number = 1): Promise\u003cboolean\u003e { this.refill(); if (this.tokens \u003e= tokens) { this.tokens -= tokens; return true; } return false; } private refill(): void { const now = Date.now(); const elapsed = (now - this.lastRefill) / 1000; const newTokens = elapsed * this.refillRate; this.tokens = Math.min(this.capacity, this.tokens + newTokens); this.lastRefill = now; } } // é™æµä¸­é—´ä»¶ class RateLimitMiddleware { private limiters = new Map\u003cstring, TokenBucket\u003e(); async handle( request: Request, next: () =\u003e Promise\u003cResponse\u003e ): Promise\u003cResponse\u003e { const key = this.getClientKey(request); const limiter = this.getLimiter(key); // å°è¯•è·å–ä»¤ç‰Œ const allowed = await limiter.consume(); if (!allowed) { throw new RateLimitError({ limit: limiter['capacity'], retryAfter: this.calculateRetryAfter(limiter) }); } return await next(); } private getClientKey(request: Request): string { // æŒ‰ç”¨æˆ·é™æµ if (request.userId) { return `user:${request.userId}`; } // æŒ‰IPé™æµ return `ip:${request.ip}`; } } æœåŠ¡é™çº§ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 // é™çº§ç­–ç•¥ç®¡ç† class DegradationManager { private strategies = new Map\u003cstring, DegradationStrategy\u003e(); async execute( feature: string, normal: () =\u003e Promise\u003cany\u003e, fallback: () =\u003e Promise\u003cany\u003e ): Promise\u003cany\u003e { const strategy = this.strategies.get(feature); // æ£€æŸ¥ç³»ç»Ÿè´Ÿè½½ const load = await this.getSystemLoad(); if (strategy \u0026\u0026 load \u003e strategy.threshold) { console.log(`System under load, degrading ${feature}`); // æ‰§è¡Œé™çº§é€»è¾‘ return await fallback(); } // æ­£å¸¸æ‰§è¡Œ try { return await normal(); } catch (error) { // å¤±è´¥æ—¶é™çº§ if (strategy?.fallbackOnError) { return await fallback(); } throw error; } } } // é™çº§ç­–ç•¥ç¤ºä¾‹ class FeatureFlags { // æ¨èç³»ç»Ÿé™çº§ async getRecommendations(userId: string): Promise\u003cProduct[]\u003e { return await this.degradation.execute( 'recommendations', // æ­£å¸¸ï¼šè°ƒç”¨æ¨èå¼•æ“ async () =\u003e { return await this.recommendationEngine.getForUser(userId); }, // é™çº§ï¼šè¿”å›çƒ­é—¨å•†å“ async () =\u003e { return await this.cache.get('popular_products'); } ); } // æœç´¢æœåŠ¡é™çº§ async search(query: string): Promise\u003cSearchResult[]\u003e { return await this.degradation.execute( 'search', // æ­£å¸¸ï¼šå…¨æ–‡æœç´¢ async () =\u003e { return await this.elasticsearch.search(query); }, // é™çº§ï¼šç®€å•åŒ¹é… async () =\u003e { return await this.database.simpleSearch(query); } ); } } ç†”æ–­æœºåˆ¶ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 // ç†”æ–­å™¨å®ç° enum CircuitState { CLOSED = 'CLOSED', // æ­£å¸¸çŠ¶æ€ OPEN = 'OPEN', // ç†”æ–­å¼€å¯ HALF_OPEN = 'HALF_OPEN' // åŠå¼€ï¼ˆå°è¯•æ¢å¤ï¼‰ } class CircuitBreaker { private state: CircuitState = CircuitState.CLOSED; private failureCount = 0; private lastFailureTime = 0; private successCount = 0; constructor( private threshold: number = 5, // å¤±è´¥é˜ˆå€¼ private timeout: number = 60000, // ç†”æ–­è¶…æ—¶ï¼ˆæ¯«ç§’ï¼‰ private halfOpenMaxCalls: number = 3 // åŠå¼€çŠ¶æ€æœ€å¤§è°ƒç”¨æ•° ) {} async execute\u003cT\u003e( fn: () =\u003e Promise\u003cT\u003e ): Promise\u003cT\u003e { if (this.state === CircuitState.OPEN) { // æ£€æŸ¥æ˜¯å¦å¯ä»¥å°è¯•æ¢å¤ if (this.shouldAttemptReset()) { this.state = CircuitState.HALF_OPEN; this.successCount = 0; } else { throw new CircuitBreakerOpenError(); } } try { const result = await fn(); // æˆåŠŸï¼Œè®°å½• this.onSuccess(); return result; } catch (error) { // å¤±è´¥ï¼Œè®°å½• this.onFailure(); throw error; } } private onSuccess(): void { if (this.state === CircuitState.HALF_OPEN) { this.successCount++; // åŠå¼€çŠ¶æ€è¿ç»­æˆåŠŸï¼Œæ¢å¤ if (this.successCount \u003e= this.halfOpenMaxCalls) { this.state = CircuitState.CLOSED; this.failureCount = 0; } } else { this.failureCount = 0; } } private onFailure(): void { this.failureCount++; this.lastFailureTime = Date.now(); // è¾¾åˆ°é˜ˆå€¼ï¼Œå¼€å¯ç†”æ–­ if (this.failureCount \u003e= this.threshold) { this.state = CircuitState.OPEN; } } private shouldAttemptReset(): boolean { return Date.now() - this.lastFailureTime \u003e this.timeout; } } // ä½¿ç”¨ç†”æ–­å™¨ä¿æŠ¤å¤–éƒ¨æœåŠ¡è°ƒç”¨ class ProtectedServiceClient { private breaker = new CircuitBreaker(5, 60000); async callExternalAPI(url: string): Promise\u003cany\u003e { return await this.breaker.execute(async () =\u003e { const response = await fetch(url); if (!response.ok) { throw new Error(`API failed: ${response.status}`); } return await response.json(); }); } } è¶…æ—¶ä¸é‡è¯• 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 // æŒ‡æ•°é€€é¿é‡è¯• class RetryPolicy { async execute\u003cT\u003e( fn: () =\u003e Promise\u003cT\u003e, options: RetryOptions = {} ): Promise\u003cT\u003e { const { maxAttempts = 3, baseDelay = 1000, maxDelay = 10000, backoffMultiplier = 2, retryableErrors = [TimeoutError, NetworkError] } = options; let lastError: Error; for (let attempt = 1; attempt \u003c= maxAttempts; attempt++) { try { return await fn(); } catch (error) { lastError = error; // æ£€æŸ¥æ˜¯å¦å¯é‡è¯• const isRetryable = retryableErrors.some( ErrorClass =\u003e error instanceof ErrorClass ); if (!isRetryable || attempt === maxAttempts) { throw error; } // è®¡ç®—é€€é¿æ—¶é—´ const delay = Math.min( baseDelay * Math.pow(backoffMultiplier, attempt - 1), maxDelay ); console.log(`Attempt ${attempt} failed, retrying in ${delay}ms`); await this.sleep(delay); } } throw lastError; } private sleep(ms: number): Promise\u003cvoid\u003e { return new Promise(resolve =\u003e setTimeout(resolve, ms)); } } // è¶…æ—¶æ§åˆ¶ class TimeoutController { async executeWithTimeout\u003cT\u003e( fn: () =\u003e Promise\u003cT\u003e, timeout: number ): Promise\u003cT\u003e { return Promise.race([ fn(), new Promise\u003cT\u003e((_, reject) =\u003e setTimeout(() =\u003e reject(new TimeoutError()), timeout) ) ]); } } æ•°æ®åº“é«˜å¯ç”¨ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 # PostgreSQLé«˜å¯ç”¨é…ç½®ï¼ˆPatroniï¼‰ apiVersion: 'v1' kind: ConfigMap metadata: name: patroni-config data: patroni.yml: | scope: postgres-cluster name: postgres-0 restapi: listen: 0.0.0.0:8008 connect_address: postgres-0:8008 etcd3: hosts: - etcd-0.etcd:2379 - etcd-1.etcd:2379 - etcd-2.etcd:2379 bootstrap: dcs: ttl: 30 loop_wait: 10 retry_timeout: 10 maximum_lag_on_failover: 1048576 postgresql: use_pg_rewind: true remove_data_directory_on_rewind_failure: true parameters: max_connections: 200 shared_buffers: 2GB effective_cache_size: 6GB maintenance_work_mem: 512MB checkpoint_completion_target: 0.9 wal_buffers: 16MB default_statistics_target: 100 random_page_cost: 1.1 effective_io_concurrency: 200 work_mem: 4MB min_wal_size: 1GB max_wal_size: 4GB pg_hba: - host replication replicator all md5 - host all all all md5 tags: nofailover: false noloadbalance: false clonefrom: false nostream: false æ€»ç»“ é«˜å¯ç”¨ç³»ç»Ÿè®¾è®¡çš„å…³é”®è¦ç´ ï¼š\nå†—ä½™ï¼šæ¶ˆé™¤æ‰€æœ‰å•ç‚¹æ•…éšœ æ•…éšœæ£€æµ‹ï¼šå¿«é€Ÿå‘ç°é—®é¢˜ è‡ªåŠ¨æ¢å¤ï¼šæœ€å°åŒ–äººå·¥ä»‹å…¥ é™çº§ç­–ç•¥ï¼šä¿è¯æ ¸å¿ƒåŠŸèƒ½ å®¹é‡è§„åˆ’ï¼šé¢„ç•™å®‰å…¨è¾¹é™… æŒç»­æ¼”ç»ƒï¼šå®šæœŸæ•…éšœæµ‹è¯• è®°ä½ï¼šæ•…éšœä¸å¯é¿å…ï¼Œä½†å¯ä»¥é€šè¿‡è®¾è®¡æœ€å°åŒ–å…¶å½±å“ã€‚\n","wordCount":"2289","inLanguage":"zh-cn","datePublished":"2025-12-25T17:00:00+08:00","dateModified":"2025-12-25T17:00:00+08:00","author":{"@type":"Person","name":"æœ‰æ¡å·¥å…·å›¢é˜Ÿ"},"mainEntityOfPage":{"@type":"WebPage","@id":"/blog/articles/%E9%AB%98%E5%8F%AF%E7%94%A8%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1%E6%9E%84%E5%BB%BA%E6%B0%B8%E4%B8%8D%E5%AE%95%E6%9C%BA%E7%9A%84%E5%90%8E%E7%AB%AF%E6%9E%B6%E6%9E%84/"},"publisher":{"@type":"Organization","name":"æŠ€æœ¯åšå®¢ - æœ‰æ¡å·¥å…·","logo":{"@type":"ImageObject","url":"/favicon.ico"}}}</script></head><body id=top><header class=header><nav class=nav><div class=logo><a href=/blog/ accesskey=h title="æŠ€æœ¯åšå®¢ - æœ‰æ¡å·¥å…· (Alt + H)">æŠ€æœ¯åšå®¢ - æœ‰æ¡å·¥å…·</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=/blog/posts/ title="æ‰€æœ‰æ–‡ç« åˆ—è¡¨ - æœ‰æ¡å·¥å…·æŠ€æœ¯åšå®¢ï¼šæŸ¥çœ‹æ‰€æœ‰æŠ€æœ¯æ–‡ç« å’Œæ•™ç¨‹å†…å®¹"><span>æ–‡ç« </span></a></li><li><a href=https://www.util.cn title="æœ‰æ¡å·¥å…· - å¼€å‘è€…çš„å¸¸ç”¨å·¥å…·é›†åˆï¼šæ— å¹¿å‘Š Â· æœ¬åœ°è®¡ç®— Â· å³å¼€å³ç”¨çš„åœ¨çº¿å·¥å…·å¹³å°ï¼Œæä¾›JSONæ ¼å¼åŒ–ã€SQLæ ¼å¼åŒ–ã€Markdownç¼–è¾‘å™¨ç­‰å®ç”¨å·¥å…·"><span>æœ‰æ¡å·¥å…·</span>&nbsp;
<svg fill="none" shape-rendering="geometricPrecision" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li><li><a href=/blog/categories/ title="æ–‡ç« åˆ†ç±» - æœ‰æ¡å·¥å…·æŠ€æœ¯åšå®¢ï¼šæŒ‰æŠ€æœ¯é¢†åŸŸåˆ†ç±»çš„ä¼˜è´¨æ–‡ç« ï¼ŒåŒ…æ‹¬å‰ç«¯å¼€å‘ã€å·¥å…·ä½¿ç”¨ã€ç¼–ç¨‹æŠ€å·§ç­‰"><span>åˆ†ç±»</span></a></li><li><a href=/blog/tags/ title="æ ‡ç­¾äº‘ - æœ‰æ¡å·¥å…·æŠ€æœ¯åšå®¢ï¼šé€šè¿‡æ ‡ç­¾å¿«é€Ÿæ‰¾åˆ°æ„Ÿå…´è¶£çš„æŠ€æœ¯æ–‡ç« å’Œæ•™ç¨‹å†…å®¹"><span>æ ‡ç­¾</span></a></li><li><a href=/blog/archives/ title="æ–‡ç« å½’æ¡£ - æœ‰æ¡å·¥å…·æŠ€æœ¯åšå®¢ï¼šæŒ‰æ—¶é—´æŸ¥çœ‹å†å²æ–‡ç« "><span>å½’æ¡£</span></a></li><li><a href=/blog/search/ title="æœç´¢æ–‡ç«  - æœ‰æ¡å·¥å…·æŠ€æœ¯åšå®¢ï¼šé€šè¿‡å…³é”®è¯æœç´¢æ‰¾åˆ°æ„Ÿå…´è¶£çš„æŠ€æœ¯æ–‡ç« å’Œæ•™ç¨‹å†…å®¹ï¼Œæ”¯æŒæ ‡é¢˜ã€å†…å®¹ã€åˆ†ç±»å’Œæ ‡ç­¾æœç´¢"><span>æœç´¢</span></a></li></ul></nav></header><main class=main><article class=post-single><div class=post-content-wrapper><main class=post-content-main><header class=post-header-main><h1 class="post-title entry-hint-parent">é«˜å¯ç”¨ç³»ç»Ÿè®¾è®¡ï¼šæ„å»ºæ°¸ä¸å®•æœºçš„åç«¯æ¶æ„</h1><div class=post-meta><div class=post-meta-content><div class=post-categories-inline><a href=/blog/categories/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/ class=category-link>ç³»ç»Ÿæ¶æ„</a></div><span class=post-date>2025-12-25</span><span class=post-author>æœ‰æ¡å·¥å…·å›¢é˜Ÿ</span></div><style>.post-meta-content{display:flex;align-items:center;flex-wrap:wrap;gap:.75rem;font-family:sf mono,monaco,courier new,monospace;font-size:.875rem;color:#9ca3af !important}.post-categories-inline{display:inline-flex;align-items:center;gap:.5rem}.category-link{display:inline-flex;align-items:center;gap:.25rem;padding:.25rem .75rem;background:rgba(255,255,255,.1);color:#e5e7eb !important;text-decoration:none;font-size:.75rem;font-weight:600;text-transform:uppercase;letter-spacing:.05em;border:1px solid rgba(255,255,255,.2);border-radius:0;transition:all .3s ease;white-space:nowrap}.category-link:hover{background:rgba(255,255,255,.2);color:#fff !important;border-color:rgba(255,255,255,.3);transform:translateY(-1px)}.category-link::before{content:'ğŸ“';font-size:.7rem;opacity:.8}.post-date,.post-reading-time,.post-word-count,.post-author{color:#9ca3af !important}[data-theme=dark] .post-meta-content{color:#9ca3af !important}[data-theme=dark] .category-link{background:rgba(255,255,255,.1);color:#e5e7eb !important;border-color:rgba(255,255,255,.2)}[data-theme=dark] .category-link:hover{background:rgba(255,255,255,.2);color:#fff !important;border-color:rgba(255,255,255,.3)}[data-theme=dark] .post-date,[data-theme=dark] .post-reading-time,[data-theme=dark] .post-word-count,[data-theme=dark] .post-author{color:#9ca3af !important}[data-theme=light] .post-meta-content{color:#6c757d !important}[data-theme=light] .category-link{background:rgba(0,0,0,5%);color:#495057 !important;border-color:rgba(0,0,0,.15)}[data-theme=light] .category-link:hover{background:rgba(0,102,204,.1);color:#212529 !important;border-color:rgba(0,102,204,.3)}[data-theme=light] .post-date,[data-theme=light] .post-reading-time,[data-theme=light] .post-word-count,[data-theme=light] .post-author{color:#6c757d !important}@media(max-width:768px){.post-meta-content{gap:.5rem;font-size:.8rem}.category-link{padding:.2rem .6rem;font-size:.7rem}}</style></div></header><div class=post-content><p>ç³»ç»Ÿå¯ç”¨æ€§æ˜¯è¡¡é‡æœåŠ¡è´¨é‡çš„æ ¸å¿ƒæŒ‡æ ‡ã€‚ä¸€ä¸ª99.9%å¯ç”¨æ€§çš„ç³»ç»Ÿæ„å‘³ç€æ¯å¹´åªèƒ½æœ‰8.76å°æ—¶çš„åœæœºæ—¶é—´ï¼Œè€Œ99.99%åˆ™åªèƒ½æœ‰52.56åˆ†é’Ÿã€‚æœ¬æ–‡å°†ç³»ç»Ÿæ€§åœ°ä»‹ç»å¦‚ä½•è®¾è®¡çœŸæ­£é«˜å¯ç”¨çš„åç«¯ç³»ç»Ÿã€‚</p><h2 id=å¯ç”¨æ€§åº¦é‡>å¯ç”¨æ€§åº¦é‡<a hidden class=anchor aria-hidden=true href=#å¯ç”¨æ€§åº¦é‡>#</a></h2><h3 id=slaä¸è®¡ç®—>SLAä¸è®¡ç®—<a hidden class=anchor aria-hidden=true href=#slaä¸è®¡ç®—>#</a></h3><pre tabindex=0><code>å¯ç”¨æ€§ç­‰çº§å¯¹æ¯”ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å¯ç”¨æ€§   â”‚ å¹´åœæœºæ—¶é—´ â”‚ æœˆåœæœºæ—¶é—´   â”‚ å‘¨åœæœºæ—¶é—´  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 99%      â”‚ 3.65å¤©    â”‚ 7.31å°æ—¶     â”‚ 1.68å°æ—¶    â”‚
â”‚ 99.9%    â”‚ 8.77å°æ—¶  â”‚ 43.83åˆ†é’Ÿ    â”‚ 10.08åˆ†é’Ÿ   â”‚
â”‚ 99.99%   â”‚ 52.60åˆ†é’Ÿ â”‚ 4.38åˆ†é’Ÿ     â”‚ 1.01åˆ†é’Ÿ    â”‚
â”‚ 99.999%  â”‚ 5.26åˆ†é’Ÿ  â”‚ 26.30ç§’      â”‚ 6.05ç§’      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre><h3 id=mtträ¸mtbf>MTTRä¸MTBF<a hidden class=anchor aria-hidden=true href=#mtträ¸mtbf>#</a></h3><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">27
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// å¯é æ€§æŒ‡æ ‡è®¡ç®—
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>interface</span> ReliabilityMetrics {
</span></span><span style=display:flex><span>  mtbf: <span style=color:#ff7b72>number</span>; <span style=color:#8b949e;font-style:italic>// Mean Time Between Failures - å¹³å‡æ•…éšœé—´éš”
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>  mttr: <span style=color:#ff7b72>number</span>; <span style=color:#8b949e;font-style:italic>// Mean Time To Repair - å¹³å‡ä¿®å¤æ—¶é—´
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>  availability: <span style=color:#ff7b72>number</span>; <span style=color:#8b949e;font-style:italic>// å¯ç”¨æ€§ = MTBF / (MTBF + MTTR)
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>class</span> AvailabilityCalculator {
</span></span><span style=display:flex><span>  calculate(metrics: <span style=color:#ff7b72>ReliabilityMetrics</span>)<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#ff7b72>number</span> {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> metrics.mtbf <span style=color:#ff7b72;font-weight:700>/</span> (metrics.mtbf <span style=color:#ff7b72;font-weight:700>+</span> metrics.mttr);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#8b949e;font-style:italic>// ç¤ºä¾‹ï¼šç³»ç»Ÿå¹³å‡è¿è¡Œ720å°æ—¶æ•…éšœä¸€æ¬¡ï¼Œä¿®å¤éœ€è¦1å°æ—¶
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>  example()<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#ff7b72>void</span> {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>const</span> metrics: <span style=color:#ff7b72>ReliabilityMetrics</span> <span style=color:#ff7b72;font-weight:700>=</span> {
</span></span><span style=display:flex><span>      mtbf: <span style=color:#ff7b72>720</span> <span style=color:#ff7b72;font-weight:700>*</span> <span style=color:#a5d6ff>3600</span> <span style=color:#ff7b72;font-weight:700>*</span> <span style=color:#a5d6ff>1000</span>, <span style=color:#8b949e;font-style:italic>// 720å°æ—¶ï¼ˆæ¯«ç§’ï¼‰
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>      mttr: <span style=color:#ff7b72>1</span> <span style=color:#ff7b72;font-weight:700>*</span> <span style=color:#a5d6ff>3600</span> <span style=color:#ff7b72;font-weight:700>*</span> <span style=color:#a5d6ff>1000</span>     <span style=color:#8b949e;font-style:italic>// 1å°æ—¶ï¼ˆæ¯«ç§’ï¼‰
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>const</span> availability <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>this</span>.calculate(metrics);
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>// å¯ç”¨æ€§ = 720 / (720 + 1) â‰ˆ 99.86%
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>// è¦è¾¾åˆ°99.99%ï¼ŒMTTRéœ€è¦é™è‡³ï¼š
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    <span style=color:#8b949e;font-style:italic>// 0.9999 = 720 / (720 + x)
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    <span style=color:#8b949e;font-style:italic>// x = 720 / 0.9999 - 720 â‰ˆ 0.072å°æ—¶ â‰ˆ 4.3åˆ†é’Ÿ
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h2 id=æ ¸å¿ƒè®¾è®¡åŸåˆ™>æ ¸å¿ƒè®¾è®¡åŸåˆ™<a hidden class=anchor aria-hidden=true href=#æ ¸å¿ƒè®¾è®¡åŸåˆ™>#</a></h2><h3 id=1-æ¶ˆé™¤å•ç‚¹æ•…éšœspof>1. æ¶ˆé™¤å•ç‚¹æ•…éšœï¼ˆSPOFï¼‰<a hidden class=anchor aria-hidden=true href=#1-æ¶ˆé™¤å•ç‚¹æ•…éšœspof>#</a></h3><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">33
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// å•ç‚¹æ•…éšœç¤ºä¾‹
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>class</span> BadArchitecture {
</span></span><span style=display:flex><span>  <span style=color:#8b949e;font-style:italic>// âŒ å•æ•°æ®åº“å®ä¾‹
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>  <span style=color:#ff7b72>private</span> db: <span style=color:#ff7b72>Database</span> <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>new</span> SingleDatabaseInstance();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#8b949e;font-style:italic>// âŒ å•ç¼“å­˜æœåŠ¡å™¨
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>  <span style=color:#ff7b72>private</span> cache: <span style=color:#ff7b72>Cache</span> <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>new</span> SingleRedisServer();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#8b949e;font-style:italic>// âŒ å•æ–‡ä»¶å­˜å‚¨
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>  <span style=color:#ff7b72>private</span> storage: <span style=color:#ff7b72>Storage</span> <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>new</span> SingleNFSServer();
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// é«˜å¯ç”¨æ¶æ„
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>class</span> GoodArchitecture {
</span></span><span style=display:flex><span>  <span style=color:#8b949e;font-style:italic>// âœ… æ•°æ®åº“ä¸»ä»å¤åˆ¶
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>  <span style=color:#ff7b72>private</span> db: <span style=color:#ff7b72>DatabaseCluster</span> <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>new</span> DatabaseCluster({
</span></span><span style=display:flex><span>    primary<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>&#39;db-primary&#39;</span>,
</span></span><span style=display:flex><span>    replicas<span style=color:#ff7b72;font-weight:700>:</span> [<span style=color:#a5d6ff>&#39;db-replica-1&#39;</span>, <span style=color:#a5d6ff>&#39;db-replica-2&#39;</span>],
</span></span><span style=display:flex><span>    autoFailover: <span style=color:#ff7b72>true</span>
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#8b949e;font-style:italic>// âœ… ç¼“å­˜é›†ç¾¤
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>  <span style=color:#ff7b72>private</span> cache: <span style=color:#ff7b72>CacheCluster</span> <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>new</span> RedisCluster({
</span></span><span style=display:flex><span>    nodes<span style=color:#ff7b72;font-weight:700>:</span> [<span style=color:#a5d6ff>&#39;redis-1&#39;</span>, <span style=color:#a5d6ff>&#39;redis-2&#39;</span>, <span style=color:#a5d6ff>&#39;redis-3&#39;</span>],
</span></span><span style=display:flex><span>    replicationFactor: <span style=color:#ff7b72>2</span>
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#8b949e;font-style:italic>// âœ… åˆ†å¸ƒå¼å­˜å‚¨
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>  <span style=color:#ff7b72>private</span> storage: <span style=color:#ff7b72>Storage</span> <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>new</span> S3Storage({
</span></span><span style=display:flex><span>    region<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>&#39;us-east-1&#39;</span>,
</span></span><span style=display:flex><span>    availabilityZones<span style=color:#ff7b72;font-weight:700>:</span> [<span style=color:#a5d6ff>&#39;us-east-1a&#39;</span>, <span style=color:#a5d6ff>&#39;us-east-1b&#39;</span>, <span style=color:#a5d6ff>&#39;us-east-1c&#39;</span>]
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h3 id=2-å†—ä½™è®¾è®¡>2. å†—ä½™è®¾è®¡<a hidden class=anchor aria-hidden=true href=#2-å†—ä½™è®¾è®¡>#</a></h3><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">50
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// æœåŠ¡å†—ä½™ - å¤šå‰¯æœ¬éƒ¨ç½²
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>class</span> ServiceDeployment {
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>async</span> deploy(service: <span style=color:#ff7b72>Service</span>)<span style=color:#ff7b72;font-weight:700>:</span> Promise&lt;<span style=color:#7ee787>void</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>// åœ¨å¤šä¸ªå¯ç”¨åŒºéƒ¨ç½²å‰¯æœ¬
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    <span style=color:#ff7b72>const</span> zones <span style=color:#ff7b72;font-weight:700>=</span> [<span style=color:#a5d6ff>&#39;us-east-1a&#39;</span>, <span style=color:#a5d6ff>&#39;us-east-1b&#39;</span>, <span style=color:#a5d6ff>&#39;us-east-1c&#39;</span>];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>for</span> (<span style=color:#ff7b72>const</span> zone <span style=color:#ff7b72>of</span> zones) {
</span></span><span style=display:flex><span>      <span style=color:#ff7b72>await</span> <span style=color:#ff7b72>this</span>.k8s.deploy({
</span></span><span style=display:flex><span>        service: <span style=color:#ff7b72>service.name</span>,
</span></span><span style=display:flex><span>        replicas: <span style=color:#ff7b72>3</span>, <span style=color:#8b949e;font-style:italic>// æ¯ä¸ªåŒºåŸŸ3ä¸ªå‰¯æœ¬
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>        affinity<span style=color:#ff7b72;font-weight:700>:</span> {
</span></span><span style=display:flex><span>          podAntiAffinity<span style=color:#ff7b72;font-weight:700>:</span> {
</span></span><span style=display:flex><span>            requiredDuringSchedulingIgnoredDuringExecution<span style=color:#ff7b72;font-weight:700>:</span> [{
</span></span><span style=display:flex><span>              labelSelector<span style=color:#ff7b72;font-weight:700>:</span> {
</span></span><span style=display:flex><span>                matchLabels<span style=color:#ff7b72;font-weight:700>:</span> { app: <span style=color:#ff7b72>service.name</span> }
</span></span><span style=display:flex><span>              },
</span></span><span style=display:flex><span>              topologyKey<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>&#39;kubernetes.io/hostname&#39;</span>
</span></span><span style=display:flex><span>            }]
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// æ•°æ®å†—ä½™ - ä¸»ä»å¤åˆ¶
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>class</span> DatabaseReplication {
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>async</span> setupReplication()<span style=color:#ff7b72;font-weight:700>:</span> Promise&lt;<span style=color:#7ee787>void</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>const</span> primary <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>new</span> PostgreSQL(<span style=color:#a5d6ff>&#39;db-primary&#39;</span>);
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>const</span> standby1 <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>new</span> PostgreSQL(<span style=color:#a5d6ff>&#39;db-standby-1&#39;</span>);
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>const</span> standby2 <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>new</span> PostgreSQL(<span style=color:#a5d6ff>&#39;db-standby-2&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>// é…ç½®æµå¤åˆ¶
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    <span style=color:#ff7b72>await</span> primary.config({
</span></span><span style=display:flex><span>      wal_level<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>&#39;replica&#39;</span>,
</span></span><span style=display:flex><span>      max_wal_senders: <span style=color:#ff7b72>10</span>,
</span></span><span style=display:flex><span>      wal_keep_size<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>&#39;1GB&#39;</span>
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>await</span> standby1.config({
</span></span><span style=display:flex><span>      hot_standby<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>&#39;on&#39;</span>,
</span></span><span style=display:flex><span>      primary_conninfo<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>&#39;host=db-primary port=5432&#39;</span>
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>await</span> standby2.config({
</span></span><span style=display:flex><span>      hot_standby<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>&#39;on&#39;</span>,
</span></span><span style=display:flex><span>      primary_conninfo<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>&#39;host=db-primary port=5432&#39;</span>
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h3 id=3-æ•…éšœæ£€æµ‹ä¸è½¬ç§»>3. æ•…éšœæ£€æµ‹ä¸è½¬ç§»<a hidden class=anchor aria-hidden=true href=#3-æ•…éšœæ£€æµ‹ä¸è½¬ç§»>#</a></h3><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 78
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 79
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 80
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 81
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 82
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 83
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 84
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 85
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 86
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 87
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 88
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 89
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 90
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 91
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 92
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 93
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 94
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 95
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 96
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 97
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 98
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 99
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">100
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">101
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">102
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">103
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">104
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">105
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">106
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">107
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">108
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">109
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">110
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">111
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">112
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">113
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">114
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">115
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">116
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">117
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">118
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">119
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">120
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">121
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">122
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">123
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// å¥åº·æ£€æŸ¥ç³»ç»Ÿ
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>class</span> HealthChecker {
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>private</span> services <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>new</span> Map&lt;<span style=color:#7ee787>string</span>, ServiceHealth&gt;();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>async</span> checkAll()<span style=color:#ff7b72;font-weight:700>:</span> Promise&lt;<span style=color:#7ee787>HealthReport</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>const</span> results <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>await</span> Promise.allSettled(
</span></span><span style=display:flex><span>      Array.<span style=color:#ff7b72>from</span>(<span style=color:#ff7b72>this</span>.services.values()).map(svc <span style=color:#ff7b72;font-weight:700>=&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>this</span>.checkService(svc)
</span></span><span style=display:flex><span>      )
</span></span><span style=display:flex><span>    );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>const</span> report: <span style=color:#ff7b72>HealthReport</span> <span style=color:#ff7b72;font-weight:700>=</span> {
</span></span><span style=display:flex><span>      healthy: <span style=color:#ff7b72>0</span>,
</span></span><span style=display:flex><span>      unhealthy: <span style=color:#ff7b72>0</span>,
</span></span><span style=display:flex><span>      details<span style=color:#ff7b72;font-weight:700>:</span> []
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>for</span> (<span style=color:#ff7b72>const</span> result <span style=color:#ff7b72>of</span> results) {
</span></span><span style=display:flex><span>      <span style=color:#ff7b72>if</span> (result.status <span style=color:#ff7b72;font-weight:700>===</span> <span style=color:#a5d6ff>&#39;fulfilled&#39;</span>) {
</span></span><span style=display:flex><span>        report.healthy<span style=color:#ff7b72;font-weight:700>++</span>;
</span></span><span style=display:flex><span>        report.details.push({
</span></span><span style=display:flex><span>          service: <span style=color:#ff7b72>result.value.name</span>,
</span></span><span style=display:flex><span>          status<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>&#39;healthy&#39;</span>,
</span></span><span style=display:flex><span>          responseTime: <span style=color:#ff7b72>result.value.responseTime</span>
</span></span><span style=display:flex><span>        });
</span></span><span style=display:flex><span>      } <span style=color:#ff7b72>else</span> {
</span></span><span style=display:flex><span>        report.unhealthy<span style=color:#ff7b72;font-weight:700>++</span>;
</span></span><span style=display:flex><span>        report.details.push({
</span></span><span style=display:flex><span>          service: <span style=color:#ff7b72>result.reason.service</span>,
</span></span><span style=display:flex><span>          status<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>&#39;unhealthy&#39;</span>,
</span></span><span style=display:flex><span>          error: <span style=color:#ff7b72>result.reason.message</span>
</span></span><span style=display:flex><span>        });
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> report;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>private</span> <span style=color:#ff7b72>async</span> checkService(
</span></span><span style=display:flex><span>    service: <span style=color:#ff7b72>ServiceHealth</span>
</span></span><span style=display:flex><span>  )<span style=color:#ff7b72;font-weight:700>:</span> Promise&lt;<span style=color:#7ee787>ServiceHealth</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>const</span> start <span style=color:#ff7b72;font-weight:700>=</span> Date.now();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>try</span> {
</span></span><span style=display:flex><span>      <span style=color:#8b949e;font-style:italic>// TCPæ£€æŸ¥
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>      <span style=color:#ff7b72>await</span> <span style=color:#ff7b72>this</span>.tcpCheck(service.host, service.port);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#8b949e;font-style:italic>// HTTPæ£€æŸ¥
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>      <span style=color:#ff7b72>await</span> <span style=color:#ff7b72>this</span>.httpCheck(<span style=color:#a5d6ff>`</span><span style=color:#a5d6ff>${</span>service.url<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>/health`</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#8b949e;font-style:italic>// å“åº”æ—¶é—´
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>      <span style=color:#ff7b72>const</span> responseTime <span style=color:#ff7b72;font-weight:700>=</span> Date.now() <span style=color:#ff7b72;font-weight:700>-</span> start;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#ff7b72>if</span> (responseTime <span style=color:#ff7b72;font-weight:700>&gt;</span> service.timeout) {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>throw</span> <span style=color:#ff7b72>new</span> Error(<span style=color:#a5d6ff>&#39;Response timeout&#39;</span>);
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#ff7b72>return</span> {
</span></span><span style=display:flex><span>        ...service,
</span></span><span style=display:flex><span>        status<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>&#39;healthy&#39;</span>,
</span></span><span style=display:flex><span>        responseTime,
</span></span><span style=display:flex><span>        lastCheck: <span style=color:#ff7b72>Date.now</span>()
</span></span><span style=display:flex><span>      };
</span></span><span style=display:flex><span>    } <span style=color:#ff7b72>catch</span> (error) {
</span></span><span style=display:flex><span>      <span style=color:#ff7b72>throw</span> {
</span></span><span style=display:flex><span>        service: <span style=color:#ff7b72>service.name</span>,
</span></span><span style=display:flex><span>        message: <span style=color:#ff7b72>error.message</span>
</span></span><span style=display:flex><span>      };
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// è‡ªåŠ¨æ•…éšœè½¬ç§»
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>class</span> FailoverController {
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>private</span> primary: <span style=color:#ff7b72>string</span>;
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>private</span> secondaries: <span style=color:#ff7b72>string</span>[];
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>private</span> currentPrimary: <span style=color:#ff7b72>string</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>async</span> monitorAndFailover()<span style=color:#ff7b72;font-weight:700>:</span> Promise&lt;<span style=color:#7ee787>void</span>&gt; {
</span></span><span style=display:flex><span>    setInterval(<span style=color:#ff7b72>async</span> () <span style=color:#ff7b72;font-weight:700>=&gt;</span> {
</span></span><span style=display:flex><span>      <span style=color:#ff7b72>const</span> isHealthy <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>await</span> <span style=color:#ff7b72>this</span>.checkHealth(<span style=color:#ff7b72>this</span>.currentPrimary);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#ff7b72>if</span> (<span style=color:#ff7b72;font-weight:700>!</span>isHealthy) {
</span></span><span style=display:flex><span>        console.warn(<span style=color:#a5d6ff>&#39;Primary unhealthy, initiating failover&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>await</span> <span style=color:#ff7b72>this</span>.failover();
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }, <span style=color:#a5d6ff>5000</span>); <span style=color:#8b949e;font-style:italic>// æ¯5ç§’æ£€æŸ¥ä¸€æ¬¡
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>private</span> <span style=color:#ff7b72>async</span> failover()<span style=color:#ff7b72;font-weight:700>:</span> Promise&lt;<span style=color:#7ee787>void</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>// 1. é€‰æ‹©æ–°çš„ä¸»èŠ‚ç‚¹
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    <span style=color:#ff7b72>const</span> newPrimary <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>await</span> <span style=color:#ff7b72>this</span>.selectBestSecondary();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>// 2. æå‡æ–°ä¸»èŠ‚ç‚¹
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    <span style=color:#ff7b72>await</span> <span style=color:#ff7b72>this</span>.promoteToPrimary(newPrimary);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>// 3. æ›´æ–°DNS/è´Ÿè½½å‡è¡¡
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    <span style=color:#ff7b72>await</span> <span style=color:#ff7b72>this</span>.updateRouting(newPrimary);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>// 4. é‡æ–°é…ç½®å¤åˆ¶
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    <span style=color:#ff7b72>await</span> <span style=color:#ff7b72>this</span>.reconfigureReplication(newPrimary);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>this</span>.currentPrimary <span style=color:#ff7b72;font-weight:700>=</span> newPrimary;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    console.log(<span style=color:#a5d6ff>`Failover completed: </span><span style=color:#a5d6ff>${</span>newPrimary<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff> is now primary`</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>private</span> <span style=color:#ff7b72>async</span> selectBestSecondary()<span style=color:#ff7b72;font-weight:700>:</span> Promise&lt;<span style=color:#7ee787>string</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>const</span> candidates <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>await</span> Promise.all(
</span></span><span style=display:flex><span>      <span style=color:#ff7b72>this</span>.secondaries.map(<span style=color:#ff7b72>async</span> (sec) <span style=color:#ff7b72;font-weight:700>=&gt;</span> ({
</span></span><span style=display:flex><span>        id: <span style=color:#ff7b72>sec</span>,
</span></span><span style=display:flex><span>        health: <span style=color:#ff7b72>await</span> <span style=color:#ff7b72>this</span>.checkHealth(sec),
</span></span><span style=display:flex><span>        replicationLag: <span style=color:#ff7b72>await</span> <span style=color:#ff7b72>this</span>.getReplicationLag(sec)
</span></span><span style=display:flex><span>      }))
</span></span><span style=display:flex><span>    );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>// é€‰æ‹©å¥åº·ä¸”å»¶è¿Ÿæœ€å°çš„
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    <span style=color:#ff7b72>return</span> candidates
</span></span><span style=display:flex><span>      .filter(c <span style=color:#ff7b72;font-weight:700>=&gt;</span> c.health)
</span></span><span style=display:flex><span>      .sort((a, b) <span style=color:#ff7b72;font-weight:700>=&gt;</span> a.replicationLag <span style=color:#ff7b72;font-weight:700>-</span> b.replicationLag)[<span style=color:#a5d6ff>0</span>].id;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h2 id=è´Ÿè½½å‡è¡¡>è´Ÿè½½å‡è¡¡<a hidden class=anchor aria-hidden=true href=#è´Ÿè½½å‡è¡¡>#</a></h2><h3 id=å¤šå±‚è´Ÿè½½å‡è¡¡>å¤šå±‚è´Ÿè½½å‡è¡¡<a hidden class=anchor aria-hidden=true href=#å¤šå±‚è´Ÿè½½å‡è¡¡>#</a></h3><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">77
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// å››å±‚è´Ÿè½½å‡è¡¡ï¼ˆTCP/UDPï¼‰
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>class</span> L4LoadBalancer {
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>private</span> backendServers: <span style=color:#ff7b72>string</span>[];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  distributeTraffic(sourceIP: <span style=color:#ff7b72>string</span>, sourcePort: <span style=color:#ff7b72>number</span>)<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#ff7b72>string</span> {
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>// ä½¿ç”¨ä¸€è‡´æ€§å“ˆå¸Œ
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    <span style=color:#ff7b72>const</span> hash <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>this</span>.consistentHash(<span style=color:#a5d6ff>`</span><span style=color:#a5d6ff>${</span>sourceIP<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>:</span><span style=color:#a5d6ff>${</span>sourcePort<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>`</span>);
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>const</span> index <span style=color:#ff7b72;font-weight:700>=</span> hash <span style=color:#ff7b72;font-weight:700>%</span> <span style=color:#ff7b72>this</span>.backendServers.length;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> <span style=color:#ff7b72>this</span>.backendServers[index];
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// ä¸ƒå±‚è´Ÿè½½å‡è¡¡ï¼ˆHTTPï¼‰
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>class</span> L7LoadBalancer {
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>private</span> backends: <span style=color:#ff7b72>Backend</span>[];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  selectBackend(request: <span style=color:#ff7b72>HttpRequest</span>)<span style=color:#ff7b72;font-weight:700>:</span> Backend {
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>// åŸºäºè¯·æ±‚è·¯å¾„çš„è·¯ç”±
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    <span style=color:#ff7b72>if</span> (request.path.startsWith(<span style=color:#a5d6ff>&#39;/api/&#39;</span>)) {
</span></span><span style=display:flex><span>      <span style=color:#ff7b72>return</span> <span style=color:#ff7b72>this</span>.backends.find(b <span style=color:#ff7b72;font-weight:700>=&gt;</span> b.name <span style=color:#ff7b72;font-weight:700>===</span> <span style=color:#a5d6ff>&#39;api-server&#39;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>// åŸºäºHTTPå¤´çš„è·¯ç”±
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    <span style=color:#ff7b72>if</span> (request.headers[<span style=color:#a5d6ff>&#39;x-api-version&#39;</span>] <span style=color:#ff7b72;font-weight:700>===</span> <span style=color:#a5d6ff>&#39;v2&#39;</span>) {
</span></span><span style=display:flex><span>      <span style=color:#ff7b72>return</span> <span style=color:#ff7b72>this</span>.backends.find(b <span style=color:#ff7b72;font-weight:700>=&gt;</span> b.name <span style=color:#ff7b72;font-weight:700>===</span> <span style=color:#a5d6ff>&#39;api-v2-server&#39;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>// åŸºäºå†…å®¹ç±»å‹çš„è·¯ç”±
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    <span style=color:#ff7b72>if</span> (request.headers[<span style=color:#a5d6ff>&#39;content-type&#39;</span>] <span style=color:#ff7b72;font-weight:700>===</span> <span style=color:#a5d6ff>&#39;application/grpc&#39;</span>) {
</span></span><span style=display:flex><span>      <span style=color:#ff7b72>return</span> <span style=color:#ff7b72>this</span>.backends.find(b <span style=color:#ff7b72;font-weight:700>=&gt;</span> b.name <span style=color:#ff7b72;font-weight:700>===</span> <span style=color:#a5d6ff>&#39;grpc-server&#39;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>// é»˜è®¤è½®è¯¢
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    <span style=color:#ff7b72>return</span> <span style=color:#ff7b72>this</span>.roundRobin();
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// è´Ÿè½½å‡è¡¡ç®—æ³•
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>class</span> LoadBalancingAlgorithms {
</span></span><span style=display:flex><span>  <span style=color:#8b949e;font-style:italic>// è½®è¯¢
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>  <span style=color:#ff7b72>private</span> roundRobinIndex <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>0</span>;
</span></span><span style=display:flex><span>  roundRobin(servers: <span style=color:#ff7b72>Server</span>[])<span style=color:#ff7b72;font-weight:700>:</span> Server {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>const</span> server <span style=color:#ff7b72;font-weight:700>=</span> servers[<span style=color:#ff7b72>this</span>.roundRobinIndex];
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>this</span>.roundRobinIndex <span style=color:#ff7b72;font-weight:700>=</span> (<span style=color:#ff7b72>this</span>.roundRobinIndex <span style=color:#ff7b72;font-weight:700>+</span> <span style=color:#a5d6ff>1</span>) <span style=color:#ff7b72;font-weight:700>%</span> servers.length;
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> server;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#8b949e;font-style:italic>// æœ€å°‘è¿æ¥
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>  leastConnections(servers: <span style=color:#ff7b72>Server</span>[])<span style=color:#ff7b72;font-weight:700>:</span> Server {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> servers.reduce((min, server) <span style=color:#ff7b72;font-weight:700>=&gt;</span>
</span></span><span style=display:flex><span>      server.connections <span style=color:#ff7b72;font-weight:700>&lt;</span> min.connections <span style=color:#ff7b72;font-weight:700>?</span> server : <span style=color:#ff7b72>min</span>
</span></span><span style=display:flex><span>    );
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#8b949e;font-style:italic>// åŠ æƒè½®è¯¢
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>  weightedRoundRobin(servers: <span style=color:#ff7b72>WeightedServer</span>[])<span style=color:#ff7b72;font-weight:700>:</span> Server {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>const</span> totalWeight <span style=color:#ff7b72;font-weight:700>=</span> servers.reduce((sum, s) <span style=color:#ff7b72;font-weight:700>=&gt;</span> sum <span style=color:#ff7b72;font-weight:700>+</span> s.weight, <span style=color:#a5d6ff>0</span>);
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>let</span> random <span style=color:#ff7b72;font-weight:700>=</span> Math.random() <span style=color:#ff7b72;font-weight:700>*</span> totalWeight;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>for</span> (<span style=color:#ff7b72>const</span> server <span style=color:#ff7b72>of</span> servers) {
</span></span><span style=display:flex><span>      random <span style=color:#ff7b72;font-weight:700>-=</span> server.weight;
</span></span><span style=display:flex><span>      <span style=color:#ff7b72>if</span> (random <span style=color:#ff7b72;font-weight:700>&lt;=</span> <span style=color:#a5d6ff>0</span>) {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> server;
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> servers[<span style=color:#a5d6ff>0</span>];
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#8b949e;font-style:italic>// ä¸€è‡´æ€§å“ˆå¸Œ
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>  consistentHash(key: <span style=color:#ff7b72>string</span>, servers: <span style=color:#ff7b72>Server</span>[])<span style=color:#ff7b72;font-weight:700>:</span> Server {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>const</span> hash <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>this</span>.md5(key);
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>const</span> index <span style=color:#ff7b72;font-weight:700>=</span> parseInt(hash.substring(<span style=color:#a5d6ff>0</span>, <span style=color:#a5d6ff>8</span>), <span style=color:#a5d6ff>16</span>) <span style=color:#ff7b72;font-weight:700>%</span> servers.length;
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> servers[index];
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h2 id=é™æµä¸é™çº§>é™æµä¸é™çº§<a hidden class=anchor aria-hidden=true href=#é™æµä¸é™çº§>#</a></h2><h3 id=é™æµç­–ç•¥>é™æµç­–ç•¥<a hidden class=anchor aria-hidden=true href=#é™æµç­–ç•¥>#</a></h3><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">68
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// ä»¤ç‰Œæ¡¶ç®—æ³•
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>class</span> TokenBucket {
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>private</span> tokens: <span style=color:#ff7b72>number</span>;
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>private</span> lastRefill: <span style=color:#ff7b72>number</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>constructor</span>(
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>private</span> capacity: <span style=color:#ff7b72>number</span>,
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>private</span> refillRate: <span style=color:#ff7b72>number</span> <span style=color:#8b949e;font-style:italic>// æ¯ç§’ä»¤ç‰Œæ•°
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>  ) {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>this</span>.tokens <span style=color:#ff7b72;font-weight:700>=</span> capacity;
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>this</span>.lastRefill <span style=color:#ff7b72;font-weight:700>=</span> Date.now();
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>async</span> consume(tokens: <span style=color:#ff7b72>number</span> <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>1</span>)<span style=color:#ff7b72;font-weight:700>:</span> Promise&lt;<span style=color:#7ee787>boolean</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>this</span>.refill();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>if</span> (<span style=color:#ff7b72>this</span>.tokens <span style=color:#ff7b72;font-weight:700>&gt;=</span> tokens) {
</span></span><span style=display:flex><span>      <span style=color:#ff7b72>this</span>.tokens <span style=color:#ff7b72;font-weight:700>-=</span> tokens;
</span></span><span style=display:flex><span>      <span style=color:#ff7b72>return</span> <span style=color:#79c0ff>true</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> <span style=color:#79c0ff>false</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>private</span> refill()<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#ff7b72>void</span> {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>const</span> now <span style=color:#ff7b72;font-weight:700>=</span> Date.now();
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>const</span> elapsed <span style=color:#ff7b72;font-weight:700>=</span> (now <span style=color:#ff7b72;font-weight:700>-</span> <span style=color:#ff7b72>this</span>.lastRefill) <span style=color:#ff7b72;font-weight:700>/</span> <span style=color:#a5d6ff>1000</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>const</span> newTokens <span style=color:#ff7b72;font-weight:700>=</span> elapsed <span style=color:#ff7b72;font-weight:700>*</span> <span style=color:#ff7b72>this</span>.refillRate;
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>this</span>.tokens <span style=color:#ff7b72;font-weight:700>=</span> Math.min(<span style=color:#ff7b72>this</span>.capacity, <span style=color:#ff7b72>this</span>.tokens <span style=color:#ff7b72;font-weight:700>+</span> newTokens);
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>this</span>.lastRefill <span style=color:#ff7b72;font-weight:700>=</span> now;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// é™æµä¸­é—´ä»¶
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>class</span> RateLimitMiddleware {
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>private</span> limiters <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>new</span> Map&lt;<span style=color:#7ee787>string</span>, TokenBucket&gt;();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>async</span> handle(
</span></span><span style=display:flex><span>    request: <span style=color:#ff7b72>Request</span>,
</span></span><span style=display:flex><span>    next<span style=color:#ff7b72;font-weight:700>:</span> () <span style=color:#ff7b72;font-weight:700>=&gt;</span> Promise&lt;<span style=color:#7ee787>Response</span>&gt;
</span></span><span style=display:flex><span>  )<span style=color:#ff7b72;font-weight:700>:</span> Promise&lt;<span style=color:#7ee787>Response</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>const</span> key <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>this</span>.getClientKey(request);
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>const</span> limiter <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>this</span>.getLimiter(key);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>// å°è¯•è·å–ä»¤ç‰Œ
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    <span style=color:#ff7b72>const</span> allowed <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>await</span> limiter.consume();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>if</span> (<span style=color:#ff7b72;font-weight:700>!</span>allowed) {
</span></span><span style=display:flex><span>      <span style=color:#ff7b72>throw</span> <span style=color:#ff7b72>new</span> RateLimitError({
</span></span><span style=display:flex><span>        limit: <span style=color:#ff7b72>limiter</span>[<span style=color:#a5d6ff>&#39;capacity&#39;</span>],
</span></span><span style=display:flex><span>        retryAfter: <span style=color:#ff7b72>this.calculateRetryAfter</span>(limiter)
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> <span style=color:#ff7b72>await</span> next();
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>private</span> getClientKey(request: <span style=color:#ff7b72>Request</span>)<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#ff7b72>string</span> {
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>// æŒ‰ç”¨æˆ·é™æµ
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    <span style=color:#ff7b72>if</span> (request.userId) {
</span></span><span style=display:flex><span>      <span style=color:#ff7b72>return</span> <span style=color:#a5d6ff>`user:</span><span style=color:#a5d6ff>${</span>request.userId<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>`</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>// æŒ‰IPé™æµ
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    <span style=color:#ff7b72>return</span> <span style=color:#a5d6ff>`ip:</span><span style=color:#a5d6ff>${</span>request.ip<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>`</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h3 id=æœåŠ¡é™çº§>æœåŠ¡é™çº§<a hidden class=anchor aria-hidden=true href=#æœåŠ¡é™çº§>#</a></h3><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">66
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// é™çº§ç­–ç•¥ç®¡ç†
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>class</span> DegradationManager {
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>private</span> strategies <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>new</span> Map&lt;<span style=color:#7ee787>string</span>, DegradationStrategy&gt;();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>async</span> execute(
</span></span><span style=display:flex><span>    feature: <span style=color:#ff7b72>string</span>,
</span></span><span style=display:flex><span>    normal<span style=color:#ff7b72;font-weight:700>:</span> () <span style=color:#ff7b72;font-weight:700>=&gt;</span> Promise&lt;<span style=color:#7ee787>any</span>&gt;,
</span></span><span style=display:flex><span>    fallback<span style=color:#ff7b72;font-weight:700>:</span> () <span style=color:#ff7b72;font-weight:700>=&gt;</span> Promise&lt;<span style=color:#7ee787>any</span>&gt;
</span></span><span style=display:flex><span>  )<span style=color:#ff7b72;font-weight:700>:</span> Promise&lt;<span style=color:#7ee787>any</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>const</span> strategy <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>this</span>.strategies.<span style=color:#ff7b72>get</span>(feature);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>// æ£€æŸ¥ç³»ç»Ÿè´Ÿè½½
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    <span style=color:#ff7b72>const</span> load <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>await</span> <span style=color:#ff7b72>this</span>.getSystemLoad();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>if</span> (strategy <span style=color:#ff7b72;font-weight:700>&amp;&amp;</span> load <span style=color:#ff7b72;font-weight:700>&gt;</span> strategy.threshold) {
</span></span><span style=display:flex><span>      console.log(<span style=color:#a5d6ff>`System under load, degrading </span><span style=color:#a5d6ff>${</span>feature<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>`</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#8b949e;font-style:italic>// æ‰§è¡Œé™çº§é€»è¾‘
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>      <span style=color:#ff7b72>return</span> <span style=color:#ff7b72>await</span> fallback();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>// æ­£å¸¸æ‰§è¡Œ
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    <span style=color:#ff7b72>try</span> {
</span></span><span style=display:flex><span>      <span style=color:#ff7b72>return</span> <span style=color:#ff7b72>await</span> normal();
</span></span><span style=display:flex><span>    } <span style=color:#ff7b72>catch</span> (error) {
</span></span><span style=display:flex><span>      <span style=color:#8b949e;font-style:italic>// å¤±è´¥æ—¶é™çº§
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>      <span style=color:#ff7b72>if</span> (strategy<span style=color:#ff7b72;font-weight:700>?</span>.fallbackOnError) {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> <span style=color:#ff7b72>await</span> fallback();
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>      <span style=color:#ff7b72>throw</span> error;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// é™çº§ç­–ç•¥ç¤ºä¾‹
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>class</span> FeatureFlags {
</span></span><span style=display:flex><span>  <span style=color:#8b949e;font-style:italic>// æ¨èç³»ç»Ÿé™çº§
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>  <span style=color:#ff7b72>async</span> getRecommendations(userId: <span style=color:#ff7b72>string</span>)<span style=color:#ff7b72;font-weight:700>:</span> Promise&lt;<span style=color:#7ee787>Product</span><span style=color:#f85149>[]</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> <span style=color:#ff7b72>await</span> <span style=color:#ff7b72>this</span>.degradation.execute(
</span></span><span style=display:flex><span>      <span style=color:#a5d6ff>&#39;recommendations&#39;</span>,
</span></span><span style=display:flex><span>      <span style=color:#8b949e;font-style:italic>// æ­£å¸¸ï¼šè°ƒç”¨æ¨èå¼•æ“
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>      <span style=color:#ff7b72>async</span> () <span style=color:#ff7b72;font-weight:700>=&gt;</span> {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> <span style=color:#ff7b72>await</span> <span style=color:#ff7b72>this</span>.recommendationEngine.getForUser(userId);
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>      <span style=color:#8b949e;font-style:italic>// é™çº§ï¼šè¿”å›çƒ­é—¨å•†å“
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>      <span style=color:#ff7b72>async</span> () <span style=color:#ff7b72;font-weight:700>=&gt;</span> {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> <span style=color:#ff7b72>await</span> <span style=color:#ff7b72>this</span>.cache.<span style=color:#ff7b72>get</span>(<span style=color:#a5d6ff>&#39;popular_products&#39;</span>);
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    );
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#8b949e;font-style:italic>// æœç´¢æœåŠ¡é™çº§
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>  <span style=color:#ff7b72>async</span> search(query: <span style=color:#ff7b72>string</span>)<span style=color:#ff7b72;font-weight:700>:</span> Promise&lt;<span style=color:#7ee787>SearchResult</span><span style=color:#f85149>[]</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> <span style=color:#ff7b72>await</span> <span style=color:#ff7b72>this</span>.degradation.execute(
</span></span><span style=display:flex><span>      <span style=color:#a5d6ff>&#39;search&#39;</span>,
</span></span><span style=display:flex><span>      <span style=color:#8b949e;font-style:italic>// æ­£å¸¸ï¼šå…¨æ–‡æœç´¢
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>      <span style=color:#ff7b72>async</span> () <span style=color:#ff7b72;font-weight:700>=&gt;</span> {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> <span style=color:#ff7b72>await</span> <span style=color:#ff7b72>this</span>.elasticsearch.search(query);
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>      <span style=color:#8b949e;font-style:italic>// é™çº§ï¼šç®€å•åŒ¹é…
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>      <span style=color:#ff7b72>async</span> () <span style=color:#ff7b72;font-weight:700>=&gt;</span> {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> <span style=color:#ff7b72>await</span> <span style=color:#ff7b72>this</span>.database.simpleSearch(query);
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    );
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h2 id=ç†”æ–­æœºåˆ¶>ç†”æ–­æœºåˆ¶<a hidden class=anchor aria-hidden=true href=#ç†”æ–­æœºåˆ¶>#</a></h2><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">78
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">79
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">80
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">81
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">82
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">83
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">84
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">85
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">86
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">87
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">88
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">89
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">90
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">91
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">92
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// ç†”æ–­å™¨å®ç°
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>enum</span> CircuitState {
</span></span><span style=display:flex><span>  CLOSED <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>&#39;CLOSED&#39;</span>,     <span style=color:#8b949e;font-style:italic>// æ­£å¸¸çŠ¶æ€
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>  OPEN <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>&#39;OPEN&#39;</span>,         <span style=color:#8b949e;font-style:italic>// ç†”æ–­å¼€å¯
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>  HALF_OPEN <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>&#39;HALF_OPEN&#39;</span> <span style=color:#8b949e;font-style:italic>// åŠå¼€ï¼ˆå°è¯•æ¢å¤ï¼‰
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>class</span> CircuitBreaker {
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>private</span> state: <span style=color:#ff7b72>CircuitState</span> <span style=color:#ff7b72;font-weight:700>=</span> CircuitState.CLOSED;
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>private</span> failureCount <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>0</span>;
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>private</span> lastFailureTime <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>0</span>;
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>private</span> successCount <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>0</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>constructor</span>(
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>private</span> threshold: <span style=color:#ff7b72>number</span> <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>5</span>,      <span style=color:#8b949e;font-style:italic>// å¤±è´¥é˜ˆå€¼
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    <span style=color:#ff7b72>private</span> timeout: <span style=color:#ff7b72>number</span> <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>60000</span>,     <span style=color:#8b949e;font-style:italic>// ç†”æ–­è¶…æ—¶ï¼ˆæ¯«ç§’ï¼‰
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    <span style=color:#ff7b72>private</span> halfOpenMaxCalls: <span style=color:#ff7b72>number</span> <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>3</span> <span style=color:#8b949e;font-style:italic>// åŠå¼€çŠ¶æ€æœ€å¤§è°ƒç”¨æ•°
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>  ) {}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>async</span> execute&lt;<span style=color:#7ee787>T</span>&gt;(
</span></span><span style=display:flex><span>    fn<span style=color:#ff7b72;font-weight:700>:</span> () <span style=color:#ff7b72;font-weight:700>=&gt;</span> Promise&lt;<span style=color:#7ee787>T</span>&gt;
</span></span><span style=display:flex><span>  )<span style=color:#ff7b72;font-weight:700>:</span> Promise&lt;<span style=color:#7ee787>T</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>if</span> (<span style=color:#ff7b72>this</span>.state <span style=color:#ff7b72;font-weight:700>===</span> CircuitState.OPEN) {
</span></span><span style=display:flex><span>      <span style=color:#8b949e;font-style:italic>// æ£€æŸ¥æ˜¯å¦å¯ä»¥å°è¯•æ¢å¤
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>      <span style=color:#ff7b72>if</span> (<span style=color:#ff7b72>this</span>.shouldAttemptReset()) {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>this</span>.state <span style=color:#ff7b72;font-weight:700>=</span> CircuitState.HALF_OPEN;
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>this</span>.successCount <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>0</span>;
</span></span><span style=display:flex><span>      } <span style=color:#ff7b72>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>throw</span> <span style=color:#ff7b72>new</span> CircuitBreakerOpenError();
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>try</span> {
</span></span><span style=display:flex><span>      <span style=color:#ff7b72>const</span> result <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>await</span> fn();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#8b949e;font-style:italic>// æˆåŠŸï¼Œè®°å½•
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>      <span style=color:#ff7b72>this</span>.onSuccess();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#ff7b72>return</span> result;
</span></span><span style=display:flex><span>    } <span style=color:#ff7b72>catch</span> (error) {
</span></span><span style=display:flex><span>      <span style=color:#8b949e;font-style:italic>// å¤±è´¥ï¼Œè®°å½•
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>      <span style=color:#ff7b72>this</span>.onFailure();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#ff7b72>throw</span> error;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>private</span> onSuccess()<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#ff7b72>void</span> {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>if</span> (<span style=color:#ff7b72>this</span>.state <span style=color:#ff7b72;font-weight:700>===</span> CircuitState.HALF_OPEN) {
</span></span><span style=display:flex><span>      <span style=color:#ff7b72>this</span>.successCount<span style=color:#ff7b72;font-weight:700>++</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#8b949e;font-style:italic>// åŠå¼€çŠ¶æ€è¿ç»­æˆåŠŸï¼Œæ¢å¤
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>      <span style=color:#ff7b72>if</span> (<span style=color:#ff7b72>this</span>.successCount <span style=color:#ff7b72;font-weight:700>&gt;=</span> <span style=color:#ff7b72>this</span>.halfOpenMaxCalls) {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>this</span>.state <span style=color:#ff7b72;font-weight:700>=</span> CircuitState.CLOSED;
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>this</span>.failureCount <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>0</span>;
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    } <span style=color:#ff7b72>else</span> {
</span></span><span style=display:flex><span>      <span style=color:#ff7b72>this</span>.failureCount <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>0</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>private</span> onFailure()<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#ff7b72>void</span> {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>this</span>.failureCount<span style=color:#ff7b72;font-weight:700>++</span>;
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>this</span>.lastFailureTime <span style=color:#ff7b72;font-weight:700>=</span> Date.now();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>// è¾¾åˆ°é˜ˆå€¼ï¼Œå¼€å¯ç†”æ–­
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    <span style=color:#ff7b72>if</span> (<span style=color:#ff7b72>this</span>.failureCount <span style=color:#ff7b72;font-weight:700>&gt;=</span> <span style=color:#ff7b72>this</span>.threshold) {
</span></span><span style=display:flex><span>      <span style=color:#ff7b72>this</span>.state <span style=color:#ff7b72;font-weight:700>=</span> CircuitState.OPEN;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>private</span> shouldAttemptReset()<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#ff7b72>boolean</span> {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> Date.now() <span style=color:#ff7b72;font-weight:700>-</span> <span style=color:#ff7b72>this</span>.lastFailureTime <span style=color:#ff7b72;font-weight:700>&gt;</span> <span style=color:#ff7b72>this</span>.timeout;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// ä½¿ç”¨ç†”æ–­å™¨ä¿æŠ¤å¤–éƒ¨æœåŠ¡è°ƒç”¨
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>class</span> ProtectedServiceClient {
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>private</span> breaker <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>new</span> CircuitBreaker(<span style=color:#a5d6ff>5</span>, <span style=color:#a5d6ff>60000</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>async</span> callExternalAPI(url: <span style=color:#ff7b72>string</span>)<span style=color:#ff7b72;font-weight:700>:</span> Promise&lt;<span style=color:#7ee787>any</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> <span style=color:#ff7b72>await</span> <span style=color:#ff7b72>this</span>.breaker.execute(<span style=color:#ff7b72>async</span> () <span style=color:#ff7b72;font-weight:700>=&gt;</span> {
</span></span><span style=display:flex><span>      <span style=color:#ff7b72>const</span> response <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>await</span> fetch(url);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#ff7b72>if</span> (<span style=color:#ff7b72;font-weight:700>!</span>response.ok) {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>throw</span> <span style=color:#ff7b72>new</span> Error(<span style=color:#a5d6ff>`API failed: </span><span style=color:#a5d6ff>${</span>response.status<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>`</span>);
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#ff7b72>return</span> <span style=color:#ff7b72>await</span> response.json();
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h2 id=è¶…æ—¶ä¸é‡è¯•>è¶…æ—¶ä¸é‡è¯•<a hidden class=anchor aria-hidden=true href=#è¶…æ—¶ä¸é‡è¯•>#</a></h2><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">65
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// æŒ‡æ•°é€€é¿é‡è¯•
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>class</span> RetryPolicy {
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>async</span> execute&lt;<span style=color:#7ee787>T</span>&gt;(
</span></span><span style=display:flex><span>    fn<span style=color:#ff7b72;font-weight:700>:</span> () <span style=color:#ff7b72;font-weight:700>=&gt;</span> Promise&lt;<span style=color:#7ee787>T</span>&gt;,
</span></span><span style=display:flex><span>    options: <span style=color:#ff7b72>RetryOptions</span> <span style=color:#ff7b72;font-weight:700>=</span> {}
</span></span><span style=display:flex><span>  )<span style=color:#ff7b72;font-weight:700>:</span> Promise&lt;<span style=color:#7ee787>T</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>const</span> {
</span></span><span style=display:flex><span>      maxAttempts <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>3</span>,
</span></span><span style=display:flex><span>      baseDelay <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>1000</span>,
</span></span><span style=display:flex><span>      maxDelay <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>10000</span>,
</span></span><span style=display:flex><span>      backoffMultiplier <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>2</span>,
</span></span><span style=display:flex><span>      retryableErrors <span style=color:#ff7b72;font-weight:700>=</span> [TimeoutError, NetworkError]
</span></span><span style=display:flex><span>    } <span style=color:#ff7b72;font-weight:700>=</span> options;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>let</span> lastError: <span style=color:#ff7b72>Error</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>for</span> (<span style=color:#ff7b72>let</span> attempt <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>1</span>; attempt <span style=color:#ff7b72;font-weight:700>&lt;=</span> maxAttempts; attempt<span style=color:#ff7b72;font-weight:700>++</span>) {
</span></span><span style=display:flex><span>      <span style=color:#ff7b72>try</span> {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> <span style=color:#ff7b72>await</span> fn();
</span></span><span style=display:flex><span>      } <span style=color:#ff7b72>catch</span> (error) {
</span></span><span style=display:flex><span>        lastError <span style=color:#ff7b72;font-weight:700>=</span> error;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic>// æ£€æŸ¥æ˜¯å¦å¯é‡è¯•
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>        <span style=color:#ff7b72>const</span> isRetryable <span style=color:#ff7b72;font-weight:700>=</span> retryableErrors.some(
</span></span><span style=display:flex><span>          ErrorClass <span style=color:#ff7b72;font-weight:700>=&gt;</span> error <span style=color:#ff7b72>instanceof</span> ErrorClass
</span></span><span style=display:flex><span>        );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>if</span> (<span style=color:#ff7b72;font-weight:700>!</span>isRetryable <span style=color:#ff7b72;font-weight:700>||</span> attempt <span style=color:#ff7b72;font-weight:700>===</span> maxAttempts) {
</span></span><span style=display:flex><span>          <span style=color:#ff7b72>throw</span> error;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic>// è®¡ç®—é€€é¿æ—¶é—´
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>        <span style=color:#ff7b72>const</span> delay <span style=color:#ff7b72;font-weight:700>=</span> Math.min(
</span></span><span style=display:flex><span>          baseDelay <span style=color:#ff7b72;font-weight:700>*</span> Math.pow(backoffMultiplier, attempt <span style=color:#ff7b72;font-weight:700>-</span> <span style=color:#a5d6ff>1</span>),
</span></span><span style=display:flex><span>          maxDelay
</span></span><span style=display:flex><span>        );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        console.log(<span style=color:#a5d6ff>`Attempt </span><span style=color:#a5d6ff>${</span>attempt<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff> failed, retrying in </span><span style=color:#a5d6ff>${</span>delay<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>ms`</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>await</span> <span style=color:#ff7b72>this</span>.sleep(delay);
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>throw</span> lastError;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>private</span> sleep(ms: <span style=color:#ff7b72>number</span>)<span style=color:#ff7b72;font-weight:700>:</span> Promise&lt;<span style=color:#7ee787>void</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> <span style=color:#ff7b72>new</span> Promise(resolve <span style=color:#ff7b72;font-weight:700>=&gt;</span> setTimeout(resolve, ms));
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// è¶…æ—¶æ§åˆ¶
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>class</span> TimeoutController {
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>async</span> executeWithTimeout&lt;<span style=color:#7ee787>T</span>&gt;(
</span></span><span style=display:flex><span>    fn<span style=color:#ff7b72;font-weight:700>:</span> () <span style=color:#ff7b72;font-weight:700>=&gt;</span> Promise&lt;<span style=color:#7ee787>T</span>&gt;,
</span></span><span style=display:flex><span>    timeout: <span style=color:#ff7b72>number</span>
</span></span><span style=display:flex><span>  )<span style=color:#ff7b72;font-weight:700>:</span> Promise&lt;<span style=color:#7ee787>T</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> Promise.race([
</span></span><span style=display:flex><span>      fn(),
</span></span><span style=display:flex><span>      <span style=color:#ff7b72>new</span> Promise&lt;<span style=color:#7ee787>T</span>&gt;((_, reject) <span style=color:#ff7b72;font-weight:700>=&gt;</span>
</span></span><span style=display:flex><span>        setTimeout(() <span style=color:#ff7b72;font-weight:700>=&gt;</span> reject(<span style=color:#ff7b72>new</span> TimeoutError()), timeout)
</span></span><span style=display:flex><span>      )
</span></span><span style=display:flex><span>    ]);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h2 id=æ•°æ®åº“é«˜å¯ç”¨>æ•°æ®åº“é«˜å¯ç”¨<a hidden class=anchor aria-hidden=true href=#æ•°æ®åº“é«˜å¯ç”¨>#</a></h2><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">54
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#8b949e;font-style:italic># PostgreSQLé«˜å¯ç”¨é…ç½®ï¼ˆPatroniï¼‰</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>apiVersion</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>&#39;v1&#39;</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>kind</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>ConfigMap</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>metadata</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>name</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>patroni-config</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>data</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>patroni.yml</span>:<span style=color:#6e7681> </span>|<span style=color:#a5d6ff>
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>    scope: postgres-cluster
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>    name: postgres-0
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>    restapi:
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>      listen: 0.0.0.0:8008
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>      connect_address: postgres-0:8008
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>    etcd3:
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>      hosts:
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>        - etcd-0.etcd:2379
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>        - etcd-1.etcd:2379
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>        - etcd-2.etcd:2379
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>    bootstrap:
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>      dcs:
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>        ttl: 30
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>        loop_wait: 10
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>        retry_timeout: 10
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>        maximum_lag_on_failover: 1048576
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>      postgresql:
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>        use_pg_rewind: true
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>        remove_data_directory_on_rewind_failure: true
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>        parameters:
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>          max_connections: 200
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>          shared_buffers: 2GB
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>          effective_cache_size: 6GB
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>          maintenance_work_mem: 512MB
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>          checkpoint_completion_target: 0.9
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>          wal_buffers: 16MB
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>          default_statistics_target: 100
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>          random_page_cost: 1.1
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>          effective_io_concurrency: 200
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>          work_mem: 4MB
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>          min_wal_size: 1GB
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>          max_wal_size: 4GB
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>        pg_hba:
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>          - host replication replicator all md5
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>          - host all all all md5
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>    tags:
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>      nofailover: false
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>      noloadbalance: false
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>      clonefrom: false
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>      nostream: false</span><span style=color:#6e7681>
</span></span></span></code></pre></td></tr></table></div></div><h2 id=æ€»ç»“>æ€»ç»“<a hidden class=anchor aria-hidden=true href=#æ€»ç»“>#</a></h2><p>é«˜å¯ç”¨ç³»ç»Ÿè®¾è®¡çš„å…³é”®è¦ç´ ï¼š</p><ol><li><strong>å†—ä½™</strong>ï¼šæ¶ˆé™¤æ‰€æœ‰å•ç‚¹æ•…éšœ</li><li><strong>æ•…éšœæ£€æµ‹</strong>ï¼šå¿«é€Ÿå‘ç°é—®é¢˜</li><li><strong>è‡ªåŠ¨æ¢å¤</strong>ï¼šæœ€å°åŒ–äººå·¥ä»‹å…¥</li><li><strong>é™çº§ç­–ç•¥</strong>ï¼šä¿è¯æ ¸å¿ƒåŠŸèƒ½</li><li><strong>å®¹é‡è§„åˆ’</strong>ï¼šé¢„ç•™å®‰å…¨è¾¹é™…</li><li><strong>æŒç»­æ¼”ç»ƒ</strong>ï¼šå®šæœŸæ•…éšœæµ‹è¯•</li></ol><p>è®°ä½ï¼š<strong>æ•…éšœä¸å¯é¿å…ï¼Œä½†å¯ä»¥é€šè¿‡è®¾è®¡æœ€å°åŒ–å…¶å½±å“</strong>ã€‚</p></div><footer class=post-footer-modern><div class=post-tags-modern><span class=tags-label>ğŸ·ï¸ æ ‡ç­¾</span><div class=tags-list><a href=/blog/tags/%E9%AB%98%E5%8F%AF%E7%94%A8/ class=tag-pill>é«˜å¯ç”¨
</a><a href=/blog/tags/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/ class=tag-pill>ç³»ç»Ÿæ¶æ„
</a><a href=/blog/tags/%E5%AE%B9%E9%94%99%E8%AE%BE%E8%AE%A1/ class=tag-pill>å®¹é”™è®¾è®¡
</a><a href=/blog/tags/sla/ class=tag-pill>SLA
</a><a href=/blog/tags/%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/ class=tag-pill>è´Ÿè½½å‡è¡¡</a></div></div><style>.post-footer-modern{margin-top:3rem;padding-top:2rem;border-top:1px solid var(--border,#333333)}.post-tags-modern{display:flex;align-items:center;gap:1rem;margin-bottom:2rem;flex-wrap:wrap}.tags-label{font-size:.875rem;font-weight:600;color:var(--secondary,#999999) !important;white-space:nowrap}.tags-list{display:flex;flex-wrap:wrap;gap:.5rem;flex:1}.tag-pill{display:inline-block;padding:.25rem .75rem;background:rgba(255,255,255,5%);border:1px solid var(--border,#333333);border-radius:0;color:var(--secondary,#cccccc) !important;text-decoration:none;font-size:.8rem;font-weight:500;transition:all .2s ease}.tag-pill:hover{background:var(--primary,#ffffff);color:var(--background,#000000) !important;border-color:var(--primary,#ffffff);transform:translateY(-1px)}.post-nav-modern{margin-top:2rem}.nav-grid{display:grid;grid-template-columns:1fr 1fr;gap:1rem}.nav-card{display:flex;align-items:center;gap:1rem;padding:1.25rem;background:rgba(255,255,255,2%);border:1px solid var(--border,#333333);border-radius:12px;text-decoration:none;transition:all .2s ease;min-height:80px}.nav-card:hover{background:rgba(255,255,255,5%);border-color:var(--primary,#ffffff);transform:translateY(-2px)}.nav-card.nav-prev{justify-content:flex-start}.nav-card.nav-next{justify-content:flex-end;text-align:right}.nav-card.nav-next .nav-content{text-align:right}.nav-empty{display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,1%);border:1px dashed var(--border,#333333);color:var(--secondary,#666666)}.nav-arrow{font-size:1.5rem;color:var(--primary,#ffffff);font-weight:300}.nav-content{flex:1}.nav-title{font-size:.95rem;font-weight:600;color:var(--primary,#ffffff) !important;line-height:1.4;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}[data-theme=light] .post-footer-modern{border-color:var(--border-light,#dee2e6)}[data-theme=light] .tags-label{color:var(--secondary-light,#6c757d) !important}[data-theme=light] .tag-pill{background:rgba(0,0,0,5%);border-color:var(--border-light,#dee2e6);color:var(--secondary-light,#495057) !important}[data-theme=light] .tag-pill:hover{background:var(--primary-light,#0066cc);color:var(--background-light,#ffffff) !important;border-color:var(--primary-light,#0066cc)}[data-theme=light] .nav-card{background:rgba(0,0,0,2%);border-color:var(--border-light,#dee2e6)}[data-theme=light] .nav-card:hover{background:rgba(0,102,204,5%);border-color:var(--primary-light,#0066cc)}[data-theme=light] .nav-empty{background:rgba(0,0,0,1%);border-color:var(--border-light,#dee2e6);color:var(--secondary-light,#6c757d)}[data-theme=light] .nav-arrow{color:var(--primary-light,#0066cc)}[data-theme=light] .nav-title{color:var(--primary-light,#212529) !important}@media(max-width:768px){.nav-grid{grid-template-columns:1fr;gap:.75rem}.nav-card{padding:1rem;min-height:70px}.nav-card.nav-next{text-align:left}.nav-card.nav-next .nav-content{text-align:left}.nav-title{font-size:.875rem}.post-tags-modern{flex-direction:column;gap:.75rem}}@media(max-width:480px){.nav-arrow{font-size:1.25rem}.nav-card{padding:.875rem}.nav-title{font-size:.8rem;-webkit-line-clamp:1}}</style><nav class=post-nav-modern><div class=nav-grid><a href=/blog/articles/%E5%A4%9A%E6%99%BA%E8%83%BD%E4%BD%93%E5%8D%8F%E4%BD%9C%E7%B3%BB%E7%BB%9F%E6%9E%84%E5%BB%BA%E5%9B%A2%E9%98%9F%E5%8D%8F%E4%BD%9C%E5%BC%8Fai%E5%BA%94%E7%94%A8/ class="nav-card nav-prev"><div class=nav-arrow>â†</div><div class=nav-content><div class=nav-title>å¤šæ™ºèƒ½ä½“åä½œç³»ç»Ÿï¼šæ„å»ºå›¢é˜Ÿåä½œå¼AIåº”ç”¨</div></div></a><a href=/blog/articles/web%E5%8F%AF%E8%AE%BF%E9%97%AE%E6%80%A7%E8%AE%BE%E8%AE%A1%E5%AE%9E%E8%B7%B5%E6%9E%84%E5%BB%BA%E4%BA%BA%E4%BA%BA%E5%8F%AF%E7%94%A8%E7%9A%84%E6%95%B0%E5%AD%97%E4%BA%A7%E5%93%81/ class="nav-card nav-next"><div class=nav-content><div class=nav-title>Webå¯è®¿é—®æ€§è®¾è®¡å®è·µï¼šæ„å»ºäººäººå¯ç”¨çš„æ•°å­—äº§å“</div></div><div class=nav-arrow>â†’</div></a></div></nav></footer></main><aside class=post-sidebar><div class=sidebar-toc id=sidebar-toc><div class=toc-header><div class=toc-title>ç›®å½•</div><button class=toc-toggle id=toc-toggle aria-label="Toggle TOC">
<svg class="toc-toggle-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6 6 18M6 6l12 12"/></svg></button></div><div class=toc-content id=toc-content><ul class=toc-list><li class="toc-item toc-h2"><a href=#h2-0 class=toc-item-link><span class=toc-item-text>å¯ç”¨æ€§åº¦é‡</span></a></li><li class="toc-item toc-h2"><a href=#h2-1 class=toc-item-link><span class=toc-item-text>æ ¸å¿ƒè®¾è®¡åŸåˆ™</span></a></li><li class="toc-item toc-h2"><a href=#h2-2 class=toc-item-link><span class=toc-item-text>è´Ÿè½½å‡è¡¡</span></a></li><li class="toc-item toc-h2"><a href=#h2-3 class=toc-item-link><span class=toc-item-text>é™æµä¸é™çº§</span></a></li><li class="toc-item toc-h2"><a href=#h2-4 class=toc-item-link><span class=toc-item-text>ç†”æ–­æœºåˆ¶</span></a></li><li class="toc-item toc-h2"><a href=#h2-5 class=toc-item-link><span class=toc-item-text>è¶…æ—¶ä¸é‡è¯•</span></a></li><li class="toc-item toc-h2"><a href=#h2-6 class=toc-item-link><span class=toc-item-text>æ•°æ®åº“é«˜å¯ç”¨</span></a></li><li class="toc-item toc-h2"><a href=#h2-7 class=toc-item-link><span class=toc-item-text>æ€»ç»“</span></a></li></ul></div></div><script>document.addEventListener("DOMContentLoaded",function(){const e=document.getElementById("sidebar-toc"),t=document.getElementById("toc-toggle"),o=document.getElementById("toc-content"),i=t?.querySelector(".toc-toggle-icon");if(!e)return;let n=!1;t&&t.addEventListener("click",function(){n=!n,n?(o.style.display="none",e.style.width="auto",i.innerHTML='<path d="M9 18l6-6-6-6"/>'):(o.style.display="block",e.style.width="200px",i.innerHTML='<path d="M18 6L6 18M6 6l12 12"/>')});const s=document.querySelector(".post-content");if(s){const e=s.querySelectorAll("h1");e.forEach((e,t)=>{e.id=`h1-${t}`});const t=s.querySelectorAll("h2");t.forEach((e,t)=>{e.id=`h2-${t}`})}const a=document.querySelectorAll(".toc-item-link");a.forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();const n=this.getAttribute("href").substring(1),t=document.getElementById(n);if(t){const e=document.querySelector(".post-header-main")?.offsetHeight||0,n=t.offsetTop-e-20;window.scrollTo({top:n,behavior:"smooth"})}})})})</script><style>.sidebar-toc{position:sticky;top:2rem;width:200px;background:#fff;border:1px solid #e5e7eb;border-radius:4px;overflow:hidden;box-shadow:0 1px 3px rgba(0,0,0,.1);z-index:100}.sidebar-toc.hidden{display:none}.toc-header{padding:12px 16px;border-bottom:1px solid #e5e7eb;background:#fafbfc;display:flex;align-items:center;justify-content:space-between}.toc-title{margin:0;font-size:13px;font-weight:500;color:#374151 !important;font-family:-apple-system,BlinkMacSystemFont,segoe ui,Roboto,sans-serif;text-transform:uppercase;letter-spacing:1px}.toc-toggle{background:0 0;border:none;cursor:pointer;padding:4px;border-radius:4px;display:flex;align-items:center;justify-content:center;transition:all .2s ease;color:#6b7280}.toc-toggle:hover{background:#e5e7eb;color:#374151}.toc-toggle-icon{transition:transform .2s ease}.toc-content{padding:12px 0}.toc-list{list-style:none;margin:0;padding:0}.toc-item{margin-bottom:4px;display:block !important;visibility:visible !important}.toc-h1,.toc-h2{display:block !important}.toc-h2{margin-left:0}.toc-item-link{display:flex;align-items:center;gap:8px;padding:8px 12px;color:#374151 !important;text-decoration:none;font-size:13px;line-height:1.4;border-radius:3px;transition:all .2s ease;font-weight:400}.toc-item-link:hover{background:#f8fafc;color:#1f2937 !important}.toc-item-link.active{background:#e0f2fe;color:#01579b !important;font-weight:500}.toc-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}.dot-red{background:#ef4444}.dot-blue{background:#2196f3}.toc-item-text{color:#1f2937 !important;font-weight:400;flex:1;display:inline !important;visibility:visible !important;opacity:1 !important;font-size:13px !important;line-height:1.4 !important}.toc-item-link .toc-item-text{color:#1f2937 !important;display:inline !important;visibility:visible !important;opacity:1 !important}.toc-item.active .dot-red{background:#d32f2f}.toc-item.active .dot-blue{background:#1976d2}[data-theme=dark] .sidebar-toc{background:#1f2937;border-color:#374151;box-shadow:0 1px 3px rgba(0,0,0,.3)}[data-theme=dark] .toc-header{background:#111827;border-color:#374151}[data-theme=dark] .toc-title{color:#f3f4f6 !important}[data-theme=dark] .toc-toggle{color:#9ca3af}[data-theme=dark] .toc-toggle:hover{background:#374151;color:#f3f4f6}[data-theme=dark] .toc-item-link{color:#e5e7eb !important}[data-theme=dark] .toc-item-link:hover{background:#374151;color:#f9fafb !important}[data-theme=dark] .toc-item-link.active{background:#0d47a1;color:#fff !important}[data-theme=dark] .toc-item-text{color:#f9fafb !important;display:inline !important;visibility:visible !important;opacity:1 !important}[data-theme=dark] .toc-item-link .toc-item-text{color:#f9fafb !important;display:inline !important;visibility:visible !important;opacity:1 !important}@media(max-width:1024px){.sidebar-toc{display:none}.post-content-wrapper{grid-template-columns:1fr !important;padding:0 1rem !important}}</style><style>.post-content-wrapper{display:grid;grid-template-columns:1fr 200px;gap:2rem;padding:0 2rem;max-width:100%}.post-content-main{min-width:0}.post-sidebar{position:sticky;top:2rem;height:fit-content;min-width:0}.post-header-main{margin-bottom:2rem;padding-bottom:1rem;border-bottom:1px solid var(--border,#333333)}.post-header-main .post-title{color:var(--primary,#ffffff) !important;font-size:2.5rem;font-weight:700;line-height:1.2;margin-bottom:1rem}.post-header-main .post-description{color:var(--secondary,#cccccc) !important;font-size:1.1rem;line-height:1.6;margin-bottom:1rem}.post-header-main .post-meta{margin-bottom:0}@media(max-width:1024px){.post-content-wrapper{grid-template-columns:1fr !important;gap:1rem;padding:0 1rem !important}.post-sidebar{display:none}}@media(max-width:768px){.post-header-main .post-title{font-size:2rem}.post-header-main .post-description{font-size:1rem}}</style></aside></div></article></main><footer class=footer><span>Â© 2024-2025 æœ‰æ¡å·¥å…·æŠ€æœ¯åšå®¢</span> Â·</footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");if(menu){const e=localStorage.getItem("menu-scroll-position");e&&(menu.scrollLeft=parseInt(e,10)),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}}document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{const e=document.querySelector("html");e.dataset.theme==="dark"?(e.dataset.theme="light",localStorage.setItem("pref-theme","light")):(e.dataset.theme="dark",localStorage.setItem("pref-theme","dark"))})</script></body></html>