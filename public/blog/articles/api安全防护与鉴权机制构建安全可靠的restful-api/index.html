<!doctype html><html lang=zh-cn dir=auto data-theme=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>APIå®‰å…¨é˜²æŠ¤ä¸é‰´æƒæœºåˆ¶ï¼šæ„å»ºå®‰å…¨å¯é çš„RESTful API | æŠ€æœ¯åšå®¢ - æœ‰æ¡å·¥å…·</title><meta name=keywords content="APIå®‰å…¨é˜²æŠ¤,JWTè®¤è¯,OAuth2æˆæƒ,APIé‰´æƒ,æ•°æ®åŠ å¯†,CORSé…ç½®,APIé™æµ"><meta name=description content="æ·±å…¥æ¢è®¨APIå®‰å…¨çš„å„ä¸ªæ–¹é¢ï¼ŒåŒ…æ‹¬èº«ä»½è®¤è¯ã€æˆæƒæœºåˆ¶ã€æ•°æ®åŠ å¯†ã€é˜²æ­¢å¸¸è§æ”»å‡»ã€å®‰å…¨æœ€ä½³å®è·µç­‰ï¼Œå¸®åŠ©å¼€å‘è€…æ„å»ºå®‰å…¨å¯é çš„APIç³»ç»Ÿã€‚"><meta name=author content="æœ‰æ¡å·¥å…·å›¢é˜Ÿ"><link rel=canonical href=/blog/articles/api%E5%AE%89%E5%85%A8%E9%98%B2%E6%8A%A4%E4%B8%8E%E9%89%B4%E6%9D%83%E6%9C%BA%E5%88%B6%E6%9E%84%E5%BB%BA%E5%AE%89%E5%85%A8%E5%8F%AF%E9%9D%A0%E7%9A%84restful-api/><link crossorigin=anonymous href=/blog/assets/css/stylesheet.7e8505b7cdf8bb22ab2305e53c2700bb06c7e64faeb72cd3468823a9a3bd3d6e.css integrity="sha256-foUFt834uyKrIwXlPCcAuwbH5k+utyzTRogjqaO9PW4=" rel="preload stylesheet" as=style><link rel=icon href=/favicon.ico><link rel=icon type=image/png sizes=16x16 href=/blog/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=/blog/favicon-32x32.png><link rel=apple-touch-icon href=/blog/apple-touch-icon.png><link rel=mask-icon href=/blog/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate type=application/rss+xml href=/blog/articles/api%E5%AE%89%E5%85%A8%E9%98%B2%E6%8A%A4%E4%B8%8E%E9%89%B4%E6%9D%83%E6%9C%BA%E5%88%B6%E6%9E%84%E5%BB%BA%E5%AE%89%E5%85%A8%E5%8F%AF%E9%9D%A0%E7%9A%84restful-api/feed.xml title=rss><link rel=alternate hreflang=zh-cn href=/blog/articles/api%E5%AE%89%E5%85%A8%E9%98%B2%E6%8A%A4%E4%B8%8E%E9%89%B4%E6%9D%83%E6%9C%BA%E5%88%B6%E6%9E%84%E5%BB%BA%E5%AE%89%E5%85%A8%E5%8F%AF%E9%9D%A0%E7%9A%84restful-api/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51);color-scheme:dark}.list{background:var(--theme)}.toc{background:var(--entry)}}@media(prefers-color-scheme:light){.list::-webkit-scrollbar-thumb{border-color:var(--code-bg)}}</style></noscript><script>localStorage.getItem("pref-theme")==="dark"?document.querySelector("html").dataset.theme="dark":localStorage.getItem("pref-theme")==="light"?document.querySelector("html").dataset.theme="light":window.matchMedia("(prefers-color-scheme: dark)").matches?document.querySelector("html").dataset.theme="dark":document.querySelector("html").dataset.theme="light"</script><script src=/js/external-link-config.js></script><script src=/js/external-link-interceptor.js></script><link rel=stylesheet href=/blog/css/custom.css media=screen><script type=application/ld+json>{"@context":"https://schema.org","@type":"WebSite","name":"æŠ€æœ¯åšå®¢ - æœ‰æ¡å·¥å…· | å¼€å‘è€…å·¥å…·ä½¿ç”¨æ•™ç¨‹ & ç¼–ç¨‹æŠ€å·§åˆ†äº«","url":"https://www.util.cn/blog/","description":"æœ‰æ¡å·¥å…·æŠ€æœ¯åšå®¢ - åˆ†äº«å¼€å‘è€…å·¥å…·ä½¿ç”¨æ•™ç¨‹ã€ç¼–ç¨‹æŠ€å·§å’Œå®æˆ˜å¼€å‘ç»éªŒã€‚æä¾›JSONæ ¼å¼åŒ–ã€SQLä¼˜åŒ–ã€Markdownç¼–è¾‘å™¨ç­‰åœ¨çº¿å·¥å…·çš„è¯¦ç»†ä½¿ç”¨æŒ‡å—ï¼Œå¸®åŠ©å¼€å‘è€…æå‡å·¥ä½œæ•ˆç‡ã€‚","publisher":{"@type":"Organization","name":"æœ‰æ¡å·¥å…·","url":"https://www.util.cn","logo":{"@type":"ImageObject","url":"https://www.util.cn/blog/logo/logo-256.png","width":256,"height":256}},"potentialAction":[{"@type":"SearchAction","target":"https://www.util.cn/blog/search?q={search_term_string}","query-input":"required name=search_term_string"}]}</script><meta property="og:type" content="website"><meta property="og:title" content="æŠ€æœ¯åšå®¢ - æœ‰æ¡å·¥å…· | å¼€å‘è€…å·¥å…·ä½¿ç”¨æ•™ç¨‹ & ç¼–ç¨‹æŠ€å·§åˆ†äº«"><meta property="og:description" content="æœ‰æ¡å·¥å…·æŠ€æœ¯åšå®¢ - åˆ†äº«å¼€å‘è€…å·¥å…·ä½¿ç”¨æ•™ç¨‹ã€ç¼–ç¨‹æŠ€å·§å’Œå®æˆ˜å¼€å‘ç»éªŒã€‚æä¾›JSONæ ¼å¼åŒ–ã€SQLä¼˜åŒ–ã€Markdownç¼–è¾‘å™¨ç­‰åœ¨çº¿å·¥å…·çš„è¯¦ç»†ä½¿ç”¨æŒ‡å—ï¼Œå¸®åŠ©å¼€å‘è€…æå‡å·¥ä½œæ•ˆç‡ã€‚"><meta property="og:url" content="https://www.util.cn/blog/"><meta property="og:site_name" content="æœ‰æ¡å·¥å…·æŠ€æœ¯åšå®¢"><meta property="og:image" content="https://www.util.cn/blog/logo/logo-256.png"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="630"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="æŠ€æœ¯åšå®¢ - æœ‰æ¡å·¥å…· | å¼€å‘è€…å·¥å…·ä½¿ç”¨æ•™ç¨‹ & ç¼–ç¨‹æŠ€å·§åˆ†äº«"><meta name=twitter:description content="æœ‰æ¡å·¥å…·æŠ€æœ¯åšå®¢ - åˆ†äº«å¼€å‘è€…å·¥å…·ä½¿ç”¨æ•™ç¨‹ã€ç¼–ç¨‹æŠ€å·§å’Œå®æˆ˜å¼€å‘ç»éªŒã€‚"><meta name=twitter:image content="https://www.util.cn/blog/logo/logo-256.png"><meta name=baidu-site-verification content><meta name=category content="æŠ€æœ¯åšå®¢,å¼€å‘è€…å·¥å…·,ç¼–ç¨‹æ•™ç¨‹"><meta name=coverage content="Worldwide"><meta name=distribution content="Global"><meta name=rating content="General"><script id=51la_code async crossorigin=anonymous src="https://sdk.51.la/js-sdk-pro.min.js?id=3OM52V0xJAPv6ozF&hash=pro"></script><script>window.addEventListener("load",function(){setTimeout(function(){typeof la!="undefined"?console.log("51laç»Ÿè®¡å·²åŠ è½½"):(console.warn("51laç»Ÿè®¡åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ"),function(){var e=document.createElement("script");e.src="https://sdk.51.la/js-sdk-pro.min.js?id=3OM52V0xJAPv6ozF&hash=backup",e.async=!0,document.head.appendChild(e)}())},3e3)})</script><meta property="og:url" content="/blog/articles/api%E5%AE%89%E5%85%A8%E9%98%B2%E6%8A%A4%E4%B8%8E%E9%89%B4%E6%9D%83%E6%9C%BA%E5%88%B6%E6%9E%84%E5%BB%BA%E5%AE%89%E5%85%A8%E5%8F%AF%E9%9D%A0%E7%9A%84restful-api/"><meta property="og:site_name" content="æŠ€æœ¯åšå®¢ - æœ‰æ¡å·¥å…·"><meta property="og:title" content="APIå®‰å…¨é˜²æŠ¤ä¸é‰´æƒæœºåˆ¶ï¼šæ„å»ºå®‰å…¨å¯é çš„RESTful API"><meta property="og:description" content="æ·±å…¥æ¢è®¨APIå®‰å…¨çš„å„ä¸ªæ–¹é¢ï¼ŒåŒ…æ‹¬èº«ä»½è®¤è¯ã€æˆæƒæœºåˆ¶ã€æ•°æ®åŠ å¯†ã€é˜²æ­¢å¸¸è§æ”»å‡»ã€å®‰å…¨æœ€ä½³å®è·µç­‰ï¼Œå¸®åŠ©å¼€å‘è€…æ„å»ºå®‰å…¨å¯é çš„APIç³»ç»Ÿã€‚"><meta property="og:locale" content="zh-cn"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-12-24T16:00:00+08:00"><meta property="article:modified_time" content="2025-12-24T16:00:00+08:00"><meta property="article:tag" content="APIå®‰å…¨"><meta property="article:tag" content="JWTè®¤è¯"><meta property="article:tag" content="OAuth2"><meta property="article:tag" content="æ•°æ®åŠ å¯†"><meta property="article:tag" content="OWASP"><meta name=twitter:card content="summary"><meta name=twitter:title content="APIå®‰å…¨é˜²æŠ¤ä¸é‰´æƒæœºåˆ¶ï¼šæ„å»ºå®‰å…¨å¯é çš„RESTful API"><meta name=twitter:description content="æ·±å…¥æ¢è®¨APIå®‰å…¨çš„å„ä¸ªæ–¹é¢ï¼ŒåŒ…æ‹¬èº«ä»½è®¤è¯ã€æˆæƒæœºåˆ¶ã€æ•°æ®åŠ å¯†ã€é˜²æ­¢å¸¸è§æ”»å‡»ã€å®‰å…¨æœ€ä½³å®è·µç­‰ï¼Œå¸®åŠ©å¼€å‘è€…æ„å»ºå®‰å…¨å¯é çš„APIç³»ç»Ÿã€‚"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"æ‰€æœ‰æ–‡ç« ","item":"/blog/posts/"},{"@type":"ListItem","position":2,"name":"APIå®‰å…¨é˜²æŠ¤ä¸é‰´æƒæœºåˆ¶ï¼šæ„å»ºå®‰å…¨å¯é çš„RESTful API","item":"/blog/articles/api%E5%AE%89%E5%85%A8%E9%98%B2%E6%8A%A4%E4%B8%8E%E9%89%B4%E6%9D%83%E6%9C%BA%E5%88%B6%E6%9E%84%E5%BB%BA%E5%AE%89%E5%85%A8%E5%8F%AF%E9%9D%A0%E7%9A%84restful-api/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"APIå®‰å…¨é˜²æŠ¤ä¸é‰´æƒæœºåˆ¶ï¼šæ„å»ºå®‰å…¨å¯é çš„RESTful API","name":"APIå®‰å…¨é˜²æŠ¤ä¸é‰´æƒæœºåˆ¶ï¼šæ„å»ºå®‰å…¨å¯é çš„RESTful API","description":"æ·±å…¥æ¢è®¨APIå®‰å…¨çš„å„ä¸ªæ–¹é¢ï¼ŒåŒ…æ‹¬èº«ä»½è®¤è¯ã€æˆæƒæœºåˆ¶ã€æ•°æ®åŠ å¯†ã€é˜²æ­¢å¸¸è§æ”»å‡»ã€å®‰å…¨æœ€ä½³å®è·µç­‰ï¼Œå¸®åŠ©å¼€å‘è€…æ„å»ºå®‰å…¨å¯é çš„APIç³»ç»Ÿã€‚","keywords":["APIå®‰å…¨é˜²æŠ¤","JWTè®¤è¯","OAuth2æˆæƒ","APIé‰´æƒ","æ•°æ®åŠ å¯†","CORSé…ç½®","APIé™æµ"],"articleBody":"å¼•è¨€ APIå®‰å…¨æ˜¯ç°ä»£åº”ç”¨å¼€å‘ä¸­çš„æ ¸å¿ƒè®®é¢˜ã€‚éšç€å¾®æœåŠ¡æ¶æ„çš„æ™®åŠï¼ŒAPIä½œä¸ºç³»ç»Ÿé—´çš„é€šä¿¡æ¡¥æ¢ï¼Œå…¶å®‰å…¨æ€§ç›´æ¥å½±å“æ•´ä¸ªç³»ç»Ÿçš„å®‰å…¨ã€‚æœ¬æ–‡å°†å…¨é¢è®²è§£APIå®‰å…¨çš„å„ä¸ªæ–¹é¢ï¼Œä»è®¤è¯æˆæƒåˆ°é˜²æŠ¤ç­–ç•¥ã€‚\nä¸€ã€èº«ä»½è®¤è¯æœºåˆ¶ 1.1 JWTï¼ˆJSON Web Tokenï¼‰ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 // JWTæœåŠ¡å®ç° import jwt from 'jsonwebtoken' import bcrypt from 'bcrypt' interface JWTPayload { userId: string email: string role: string } class AuthService { private readonly JWT_SECRET = process.env.JWT_SECRET || 'your-secret-key' private readonly JWT_REFRESH_SECRET = process.env.JWT_REFRESH_SECRET || 'your-refresh-secret' private readonly JWT_EXPIRES_IN = '15m' private readonly JWT_REFRESH_EXPIRES_IN = '7d' // ç”Ÿæˆè®¿é—®ä»¤ç‰Œ generateAccessToken(payload: JWTPayload): string { return jwt.sign(payload, this.JWT_SECRET, { expiresIn: this.JWT_EXPIRES_IN, issuer: 'myapp.com', audience: 'myapp-api' }) } // ç”Ÿæˆåˆ·æ–°ä»¤ç‰Œ generateRefreshToken(payload: JWTPayload): string { return jwt.sign( { userId: payload.userId }, this.JWT_REFRESH_SECRET, { expiresIn: this.JWT_REFRESH_EXPIRES_IN } ) } // éªŒè¯è®¿é—®ä»¤ç‰Œ verifyAccessToken(token: string): JWTPayload | null { try { return jwt.verify(token, this.JWT_SECRET) as JWTPayload } catch (error) { return null } } // éªŒè¯åˆ·æ–°ä»¤ç‰Œ verifyRefreshToken(token: string): { userId: string } | null { try { return jwt.verify(token, this.JWT_REFRESH_SECRET) as { userId: string } } catch (error) { return null } } // å¯†ç å“ˆå¸Œ async hashPassword(password: string): Promise\u003cstring\u003e { return bcrypt.hash(password, 12) } // å¯†ç éªŒè¯ async comparePassword(password: string, hash: string): Promise\u003cboolean\u003e { return bcrypt.compare(password, hash) } // ç™»å½•æµç¨‹ async login(email: string, password: string) { const user = await this.findUserByEmail(email) if (!user) { throw new Error('User not found') } const isValid = await this.comparePassword(password, user.passwordHash) if (!isValid) { throw new Error('Invalid password') } const payload: JWTPayload = { userId: user.id, email: user.email, role: user.role } return { accessToken: this.generateAccessToken(payload), refreshToken: this.generateRefreshToken(payload), expiresIn: 15 * 60 // 15åˆ†é’Ÿ } } // åˆ·æ–°ä»¤ç‰Œ async refreshTokens(refreshToken: string) { const payload = this.verifyRefreshToken(refreshToken) if (!payload) { throw new Error('Invalid refresh token') } const user = await this.findUserById(payload.userId) if (!user) { throw new Error('User not found') } const jwtPayload: JWTPayload = { userId: user.id, email: user.email, role: user.role } return { accessToken: this.generateAccessToken(jwtPayload), refreshToken: this.generateRefreshToken(jwtPayload) } } private async findUserByEmail(email: string) { // æ•°æ®åº“æŸ¥è¯¢å®ç° return null } private async findUserById(userId: string) { // æ•°æ®åº“æŸ¥è¯¢å®ç° return null } } export const authService = new AuthService() 1.2 Expressä¸­é—´ä»¶ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 // è®¤è¯ä¸­é—´ä»¶ import { Request, Response, NextFunction } from 'express' declare global { namespace Express { interface Request { user?: { userId: string email: string role: string } } } } // JWTè®¤è¯ä¸­é—´ä»¶ export function authenticate(req: Request, res: Response, next: NextFunction) { const authHeader = req.headers.authorization if (!authHeader || !authHeader.startsWith('Bearer ')) { return res.status(401).json({ error: 'Unauthorized', message: 'Missing or invalid authorization header' }) } const token = authHeader.substring(7) const payload = authService.verifyAccessToken(token) if (!payload) { return res.status(401).json({ error: 'Unauthorized', message: 'Invalid or expired token' }) } req.user = payload next() } // è§’è‰²æˆæƒä¸­é—´ä»¶ export function authorize(...roles: string[]) { return (req: Request, res: Response, next: NextFunction) =\u003e { if (!req.user) { return res.status(401).json({ error: 'Unauthorized', message: 'Authentication required' }) } if (!roles.includes(req.user.role)) { return res.status(403).json({ error: 'Forbidden', message: 'Insufficient permissions' }) } next() } } // å¯é€‰è®¤è¯ä¸­é—´ä»¶ï¼ˆå…è®¸æœªç™»å½•ç”¨æˆ·è®¿é—®ï¼‰ export function optionalAuthenticate(req: Request, res: Response, next: NextFunction) { const authHeader = req.headers.authorization if (authHeader \u0026\u0026 authHeader.startsWith('Bearer ')) { const token = authHeader.substring(7) const payload = authService.verifyAccessToken(token) if (payload) { req.user = payload } } next() } // ä½¿ç”¨ç¤ºä¾‹ import express from 'express' const router = express.Router() // å…¬å¼€è·¯ç”± router.get('/public', (req, res) =\u003e { res.json({ message: 'Public endpoint' }) }) // éœ€è¦è®¤è¯ router.get('/profile', authenticate, (req, res) =\u003e { res.json({ user: req.user }) }) // éœ€è¦ç‰¹å®šè§’è‰² router.delete('/users/:id', authenticate, authorize('admin'), (req, res) =\u003e { res.json({ message: 'User deleted' }) }) // å¯é€‰è®¤è¯ï¼ˆç™»å½•å’Œæœªç™»å½•éƒ½å¯ä»¥è®¿é—®ï¼‰ router.get('/content', optionalAuthenticate, (req, res) =\u003e { if (req.user) { res.json({ content: 'premium content', user: req.user }) } else { res.json({ content: 'free content' }) } }) 1.3 OAuth 2.0å®ç° 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 // OAuth 2.0æˆæƒç æ¨¡å¼ import crypto from 'crypto' import { OAuth2Client } from 'google-auth-library' class OAuthService { private clients = new Map() private authorizationCodes = new Map() private accessTokens = new Map() // æ³¨å†ŒOAuthå®¢æˆ·ç«¯ registerClient(clientId: string, redirectUris: string[], scopes: string[]) { const clientSecret = crypto.randomBytes(32).toString('hex') this.clients.set(clientId, { clientId, clientSecret, redirectUris, scopes }) return { clientId, clientSecret } } // ç”Ÿæˆæˆæƒç  generateAuthorizationCode(userId: string, clientId: string, scopes: string[]): string { const code = crypto.randomBytes(32).toString('hex') this.authorizationCodes.set(code, { userId, clientId, scopes, expiresAt: Date.now() + 10 * 60 * 1000 // 10åˆ†é’Ÿè¿‡æœŸ }) return code } // éªŒè¯æˆæƒç å¹¶ç”Ÿæˆè®¿é—®ä»¤ç‰Œ async exchangeCodeForToken(code: string, clientId: string, clientSecret: string, redirectUri: string) { const authCode = this.authorizationCodes.get(code) if (!authCode) { throw new Error('Invalid authorization code') } if (authCode.clientId !== clientId) { throw new Error('Client ID mismatch') } if (Date.now() \u003e authCode.expiresAt) { this.authorizationCodes.delete(code) throw new Error('Authorization code expired') } const client = this.clients.get(clientId) if (client.clientSecret !== clientSecret) { throw new Error('Invalid client secret') } if (!client.redirectUris.includes(redirectUri)) { throw new Error('Invalid redirect URI') } // ç”Ÿæˆè®¿é—®ä»¤ç‰Œ const accessToken = crypto.randomBytes(32).toString('hex') this.accessTokens.set(accessToken, { userId: authCode.userId, clientId, scopes: authCode.scopes, expiresAt: Date.now() + 60 * 60 * 1000 // 1å°æ—¶è¿‡æœŸ }) // åˆ é™¤å·²ä½¿ç”¨çš„æˆæƒç  this.authorizationCodes.delete(code) return { access_token: accessToken, token_type: 'Bearer', expires_in: 3600, scope: authCode.scopes.join(' ') } } // éªŒè¯è®¿é—®ä»¤ç‰Œ verifyAccessToken(accessToken: string) { const token = this.accessTokens.get(accessToken) if (!token) { return null } if (Date.now() \u003e token.expiresAt) { this.accessTokens.delete(accessToken) return null } return token } // Google OAuthé›†æˆ async verifyGoogleToken(idToken: string) { const client = new OAuth2Client(process.env.GOOGLE_CLIENT_ID) const ticket = await client.verifyIdToken({ idToken, audience: process.env.GOOGLE_CLIENT_ID }) const payload = ticket.getPayload() return { userId: payload.sub, email: payload.email, name: payload.name, picture: payload.picture } } } export const oauthService = new OAuthService() äºŒã€æ•°æ®å®‰å…¨ 2.1 æ•æ„Ÿæ•°æ®åŠ å¯† 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 // åŠ å¯†æœåŠ¡ import crypto from 'crypto' class EncryptionService { private readonly ALGORITHM = 'aes-256-gcm' private readonly KEY_LENGTH = 32 private readonly IV_LENGTH = 16 private readonly AUTH_TAG_LENGTH = 16 private key: Buffer constructor() { // ä»ç¯å¢ƒå˜é‡è·å–åŠ å¯†å¯†é’¥ const keyString = process.env.ENCRYPTION_KEY || 'default-key-change-in-production' this.key = crypto.scryptSync(keyString, 'salt', this.KEY_LENGTH) } // åŠ å¯†æ•°æ® encrypt(plaintext: string): string { const iv = crypto.randomBytes(this.IV_LENGTH) const cipher = crypto.createCipheriv(this.ALGORITHM, this.key, iv) let encrypted = cipher.update(plaintext, 'utf8', 'hex') encrypted += cipher.final('hex') const authTag = cipher.getAuthTag() // ç»„åˆï¼šiv + authTag + encrypted return iv.toString('hex') + authTag.toString('hex') + encrypted } // è§£å¯†æ•°æ® decrypt(ciphertext: string): string { const iv = Buffer.from(ciphertext.slice(0, this.IV_LENGTH * 2), 'hex') const authTag = Buffer.from( ciphertext.slice(this.IV_LENGTH * 2, (this.IV_LENGTH + this.AUTH_TAG_LENGTH) * 2), 'hex' ) const encrypted = ciphertext.slice((this.IV_LENGTH + this.AUTH_TAG_LENGTH) * 2) const decipher = crypto.createDecipheriv(this.ALGORITHM, this.key, iv) decipher.setAuthTag(authTag) let decrypted = decipher.update(encrypted, 'hex', 'utf8') decrypted += decipher.final('utf8') return decrypted } // å“ˆå¸Œæ•°æ®ï¼ˆå•å‘ï¼‰ hash(data: string): string { return crypto.createHash('sha256').update(data).digest('hex') } // ç”ŸæˆHMAC generateHMAC(data: string, secret: string): string { return crypto.createHmac('sha256', secret).update(data).digest('hex') } // éªŒè¯HMAC verifyHMAC(data: string, hmac: string, secret: string): boolean { const computedHMAC = this.generateHMAC(data, secret) return crypto.timingSafeEqual( Buffer.from(computedHMAC, 'hex'), Buffer.from(hmac, 'hex') ) } } export const encryptionService = new EncryptionService() // ä½¿ç”¨ç¤ºä¾‹ const sensitiveData = 'user-ssn-123-45-6789' const encrypted = encryptionService.encrypt(sensitiveData) const decrypted = encryptionService.decrypt(encrypted) // æ•°æ®åº“ä¸­å­˜å‚¨åŠ å¯†æ•°æ® async function saveUserWithEncryptedData(userData: any) { const encrypted = encryptionService.encrypt(userData.ssn) await db.users.create({ ...userData, ssn: encrypted, ssnHash: encryptionService.hash(userData.ssn) // ç”¨äºæŸ¥è¯¢ }) } 2.2 ç­¾åéªŒè¯ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 // Webhookç­¾åéªŒè¯ import crypto from 'crypto' import { Request, Response } from 'express' function verifyWebhookSignature(req: Request, res: Response, next: NextFunction) { const signature = req.headers['x-webhook-signature'] as string const timestamp = req.headers['x-webhook-timestamp'] as string if (!signature || !timestamp) { return res.status(401).json({ error: 'Missing signature headers' }) } // æ£€æŸ¥æ—¶é—´æˆ³ï¼ˆé˜²é‡æ”¾æ”»å‡»ï¼‰ const now = Date.now() const webhookTime = parseInt(timestamp) if (Math.abs(now - webhookTime) \u003e 5 * 60 * 1000) { // 5åˆ†é’Ÿçª—å£ return res.status(401).json({ error: 'Request too old' }) } // ç”Ÿæˆé¢„æœŸç­¾å const payload = `${timestamp}.${req.body}` const expectedSignature = crypto .createHmac('sha256', process.env.WEBHOOK_SECRET!) .update(payload) .digest('hex') // å®‰å…¨æ¯”è¾ƒç­¾å const isValid = crypto.timingSafeEqual( Buffer.from(signature, 'hex'), Buffer.from(expectedSignature, 'hex') ) if (!isValid) { return res.status(401).json({ error: 'Invalid signature' }) } next() } ä¸‰ã€é˜²æŠ¤ç­–ç•¥ 3.1 SQLæ³¨å…¥é˜²æŠ¤ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 // ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢ import { Pool } from 'pg' class UserRepository { private pool: Pool constructor(pool: Pool) { this.pool = pool } // å®‰å…¨çš„æŸ¥è¯¢ async findById(id: string) { const query = 'SELECT * FROM users WHERE id = $1' const result = await this.pool.query(query, [id]) return result.rows[0] } async findByEmail(email: string) { const query = 'SELECT * FROM users WHERE email = $1' const result = await this.pool.query(query, [email]) return result.rows[0] } // ä½¿ç”¨æŸ¥è¯¢æ„å»ºå™¨ï¼ˆå¦‚Knex.jsï¼‰ async findWithFilters(filters: any) { const query = this.pool .select('*') .from('users') if (filters.email) { query = query.where('email', filters.email) } if (filters.role) { query = query.where('role', filters.role) } if (filters.minAge) { query = query.where('age', '\u003e=', filters.minAge) } return await query } // ä½¿ç”¨ORMï¼ˆå¦‚Prismaã€TypeORMï¼‰ async create(data: any) { // ORMè‡ªåŠ¨å¤„ç†å‚æ•°åŒ–æŸ¥è¯¢ return await this.pool.query( 'INSERT INTO users (name, email, password_hash) VALUES ($1, $2, $3) RETURNING *', [data.name, data.email, data.passwordHash] ) } } 3.2 XSSé˜²æŠ¤ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 // è¾“å…¥éªŒè¯å’Œè¾“å‡ºç¼–ç  import validator from 'validator' import xss from 'xss' class SecurityMiddleware { // è¾“å…¥éªŒè¯ static validateInput(req: Request, res: Response, next: NextFunction) { const { name, email, bio } = req.body // éªŒè¯å’Œæ¸…ç†è¾“å…¥ if (name \u0026\u0026 !validator.isLength(name, { min: 1, max: 100 })) { return res.status(400).json({ error: 'Invalid name length' }) } if (email \u0026\u0026 !validator.isEmail(email)) { return res.status(400).json({ error: 'Invalid email format' }) } if (bio \u0026\u0026 !validator.isLength(bio, { max: 500 })) { return res.status(400).json({ error: 'Bio too long' }) } // æ¸…ç†XSS if (name) req.body.name = xss(name) if (bio) req.body.bio = xss(bio) next() } // è®¾ç½®CSPå¤´ static setSecurityHeaders(req: Request, res: Response, next: NextFunction) { // å†…å®¹å®‰å…¨ç­–ç•¥ res.setHeader('Content-Security-Policy', \"default-src 'self'; \" + \"script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.example.com; \" + \"style-src 'self' 'unsafe-inline'; \" + \"img-src 'self' data: https:; \" + \"font-src 'self'; \" + \"connect-src 'self' https://api.example.com; \" + \"frame-ancestors 'none';\" ) // å…¶ä»–å®‰å…¨å¤´ res.setHeader('X-Content-Type-Options', 'nosniff') res.setHeader('X-Frame-Options', 'DENY') res.setHeader('X-XSS-Protection', '1; mode=block') res.setHeader('Referrer-Policy', 'strict-origin-when-cross-origin') res.setHeader('Permissions-Policy', 'geolocation=(), microphone=(), camera=()') next() } } 3.3 CORSé…ç½® 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 // CORSé…ç½® import express from 'express' import cors from 'cors' const app = express() // ç”Ÿäº§ç¯å¢ƒCORSé…ç½® const corsOptions = { origin: function (origin: string | undefined, callback: Function) { const allowedOrigins = [ 'https://example.com', 'https://www.example.com', 'https://app.example.com' ] // å…è®¸æ— originçš„è¯·æ±‚ï¼ˆå¦‚ç§»åŠ¨åº”ç”¨ã€Postmanï¼‰ if (!origin) return callback(null, true) if (allowedOrigins.indexOf(origin) !== -1) { callback(null, true) } else { callback(new Error('Not allowed by CORS')) } }, credentials: true, // å…è®¸æºå¸¦cookie methods: ['GET', 'POST', 'PUT', 'DELETE', 'OPTIONS'], allowedHeaders: ['Content-Type', 'Authorization'], exposedHeaders: ['X-Total-Count'], maxAge: 86400 // é¢„æ£€è¯·æ±‚ç¼“å­˜24å°æ—¶ } app.use(cors(corsOptions)) // æˆ–è€…é’ˆå¯¹ç‰¹å®šè·¯ç”± app.options('/api/*', cors(corsOptions)) app.get('/api/data', cors(corsOptions), (req, res) =\u003e { res.json({ data: 'sensitive data' }) }) 3.4 é€Ÿç‡é™åˆ¶ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 // APIé€Ÿç‡é™åˆ¶ import rateLimit from 'express-rate-limit' import RedisStore from 'rate-limit-redis' import Redis from 'ioredis' // ä¸åŒåœºæ™¯çš„é€Ÿç‡é™åˆ¶ // 1. é€šç”¨APIé™åˆ¶ const generalLimiter = rateLimit({ store: new RedisStore({ client: new Redis(process.env.REDIS_URL) }), windowMs: 15 * 60 * 1000, // 15åˆ†é’Ÿ max: 100, // é™åˆ¶100æ¬¡è¯·æ±‚ standardHeaders: true, legacyHeaders: false, message: 'Too many requests from this IP, please try again later.', handler: (req, res) =\u003e { res.status(429).json({ error: 'Too many requests', message: 'Rate limit exceeded, please try again later.', retryAfter: 900 // ç§’ }) } }) // 2. ç™»å½•é™æµï¼ˆæ›´ä¸¥æ ¼ï¼‰ const loginLimiter = rateLimit({ windowMs: 15 * 60 * 1000, max: 5, // 15åˆ†é’Ÿå†…æœ€å¤š5æ¬¡ç™»å½•å°è¯• skipSuccessfulRequests: true, // æˆåŠŸçš„è¯·æ±‚ä¸è®¡å…¥é™åˆ¶ message: 'Too many login attempts, please try again later.' }) // 3. APIå¯†é’¥é™æµ const apiKeyLimiter = rateLimit({ store: new RedisStore({ client: new Redis(process.env.REDIS_URL), prefix: 'limiter:apikey:' }), windowMs: 60 * 1000, // 1åˆ†é’Ÿ max: 60, // æ¯åˆ†é’Ÿ60æ¬¡ keyGenerator: (req) =\u003e { return req.headers['x-api-key'] as string } }) // åº”ç”¨é™æµ app.use('/api/', generalLimiter) app.post('/api/auth/login', loginLimiter) app.use('/api/v2/', apiKeyLimiter) // åŸºäºç”¨æˆ·çš„é™æµ async function getUserRateLimit(userId: string) { const user = await db.users.findById(userId) // ä¸åŒç”¨æˆ·ç­‰çº§æœ‰ä¸åŒé™åˆ¶ const limits = { free: { windowMs: 60 * 1000, max: 10 }, pro: { windowMs: 60 * 1000, max: 100 }, enterprise: { windowMs: 60 * 1000, max: 1000 } } return limits[user.plan] || limits.free } å››ã€å®‰å…¨æœ€ä½³å®è·µ 4.1 å®‰å…¨é…ç½® 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 // helmetå®‰å…¨å¤´é…ç½® import helmet from 'helmet' app.use(helmet({ contentSecurityPolicy: { directives: { defaultSrc: [\"'self'\"], styleSrc: [\"'self'\", \"'unsafe-inline'\"], scriptSrc: [\"'self'\"], imgSrc: [\"'self'\", \"data:\", \"https:\"], } }, hsts: { maxAge: 31536000, includeSubDomains: true, preload: true }, noSniff: true, xssFilter: true, frameguard: { action: 'deny' } })) // ç¦ç”¨ä¸å¿…è¦çš„å¤´ app.disable('x-powered-by') 4.2 å®‰å…¨æ—¥å¿— 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 // å®‰å…¨å®¡è®¡æ—¥å¿— class SecurityAuditLogger { private auditLog: any constructor(auditLog: any) { this.auditLog = auditLog } logAuthenticationAttempt(userId: string, success: boolean, ip: string) { this.auditLog.create({ eventType: 'AUTH_ATTEMPT', userId, success, ip, timestamp: new Date(), userAgent: undefined }) } logAuthorizationAttempt(userId: string, resource: string, action: string, success: boolean) { this.auditLog.create({ eventType: 'AUTHZ_ATTEMPT', userId, resource, action, success, timestamp: new Date() }) } logDataAccess(userId: string, resourceType: string, resourceId: string) { this.auditLog.create({ eventType: 'DATA_ACCESS', userId, resourceType, resourceId, timestamp: new Date() }) } logSecurityEvent(eventType: string, details: any) { this.auditLog.create({ eventType, details, timestamp: new Date() }) } } // ä½¿ç”¨ç¤ºä¾‹ const securityLogger = new SecurityAuditLogger(auditLog) app.post('/api/auth/login', async (req, res) =\u003e { const { email, password } = req.body const ip = req.ip try { const result = await authService.login(email, password) securityLogger.logAuthenticationAttempt(result.user.id, true, ip) res.json(result) } catch (error) { securityLogger.logAuthenticationAttempt(email, false, ip) res.status(401).json({ error: 'Invalid credentials' }) } }) 4.3 è¾“å…¥éªŒè¯ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 // ä½¿ç”¨Joiè¿›è¡Œè¾“å…¥éªŒè¯ import Joi from 'joi' // éªŒè¯schemas const schemas = { register: Joi.object({ name: Joi.string().min(2).max(50).required(), email: Joi.string().email().required(), password: Joi.string() .min(8) .pattern(/^(?=.*[a-z])(?=.*[A-Z])(?=.*\\d)(?=.*[@$!%*?\u0026])[A-Za-z\\d@$!%*?\u0026]/) .required() .messages({ 'string.pattern.base': 'Password must contain uppercase, lowercase, number, and special character' }), confirmPassword: Joi.string().valid(Joi.ref('password')).required(), age: Joi.number().integer().min(13).max(120) }), createPost: Joi.object({ title: Joi.string().min(5).max(200).required(), content: Joi.string().min(10).max(10000).required(), tags: Joi.array().items(Joi.string().max(30)).max(10), published: Joi.boolean().default(false) }), updateProfile: Joi.object({ name: Joi.string().min(2).max(50), bio: Joi.string().max(500), website: Joi.string().uri(), avatar: Joi.string().uri() }) } // éªŒè¯ä¸­é—´ä»¶ function validate(schemaName: keyof typeof schemas) { return (req: Request, res: Response, next: NextFunction) =\u003e { const { error, value } = schemas[schemaName].validate(req.body, { abortEarly: false, stripUnknown: true }) if (error) { const errors = error.details.map(detail =\u003e ({ field: detail.path.join('.'), message: detail.message })) return res.status(400).json({ errors }) } req.body = value next() } } // ä½¿ç”¨ app.post('/api/auth/register', validate('register'), authController.register) app.post('/api/posts', authenticate, validate('createPost'), postController.create) æ€»ç»“ APIå®‰å…¨æ˜¯ä¸€ä¸ªå¤šå±‚æ¬¡çš„ä¸»é¢˜ï¼š\nèº«ä»½è®¤è¯ - JWTã€OAuth 2.0å®ç°å®‰å…¨è®¤è¯ æ•°æ®åŠ å¯† - æ•æ„Ÿæ•°æ®åŠ å¯†å­˜å‚¨å’Œä¼ è¾“ è¾“å…¥éªŒè¯ - é˜²æ­¢æ³¨å…¥æ”»å‡»å’Œæ•°æ®ç¯¡æ”¹ é˜²æŠ¤ç­–ç•¥ - CORSã€é€Ÿç‡é™åˆ¶ã€CSPç­‰ å®‰å…¨å®¡è®¡ - è®°å½•å’Œåˆ†æå®‰å…¨äº‹ä»¶ æœ€ä½³å®è·µ - éµå¾ªOWASPå®‰å…¨æ ‡å‡† APIå®‰å…¨éœ€è¦æŒç»­å…³æ³¨å’Œæ”¹è¿›ï¼Œéšç€å¨èƒç¯å¢ƒçš„å˜åŒ–ä¸æ–­è°ƒæ•´é˜²æŠ¤ç­–ç•¥ã€‚\nç›¸å…³å·¥å…·æ¨è\nJWTè§£æå·¥å…· - JWTè°ƒè¯•å’ŒéªŒè¯ JSONæ ¼å¼åŒ–å·¥å…· - JSONæ•°æ®å¤„ç† Base64ç¼–ç å·¥å…· - ç¼–ç è½¬æ¢ ","wordCount":"2974","inLanguage":"zh-cn","datePublished":"2025-12-24T16:00:00+08:00","dateModified":"2025-12-24T16:00:00+08:00","author":{"@type":"Person","name":"æœ‰æ¡å·¥å…·å›¢é˜Ÿ"},"mainEntityOfPage":{"@type":"WebPage","@id":"/blog/articles/api%E5%AE%89%E5%85%A8%E9%98%B2%E6%8A%A4%E4%B8%8E%E9%89%B4%E6%9D%83%E6%9C%BA%E5%88%B6%E6%9E%84%E5%BB%BA%E5%AE%89%E5%85%A8%E5%8F%AF%E9%9D%A0%E7%9A%84restful-api/"},"publisher":{"@type":"Organization","name":"æŠ€æœ¯åšå®¢ - æœ‰æ¡å·¥å…·","logo":{"@type":"ImageObject","url":"/favicon.ico"}}}</script></head><body id=top><header class=header><nav class=nav><div class=logo><a href=/blog/ accesskey=h title="æŠ€æœ¯åšå®¢ - æœ‰æ¡å·¥å…· (Alt + H)">æŠ€æœ¯åšå®¢ - æœ‰æ¡å·¥å…·</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=/blog/posts/ title="æ‰€æœ‰æ–‡ç« åˆ—è¡¨ - æœ‰æ¡å·¥å…·æŠ€æœ¯åšå®¢ï¼šæŸ¥çœ‹æ‰€æœ‰æŠ€æœ¯æ–‡ç« å’Œæ•™ç¨‹å†…å®¹"><span>æ–‡ç« </span></a></li><li><a href=https://www.util.cn title="æœ‰æ¡å·¥å…· - å¼€å‘è€…çš„å¸¸ç”¨å·¥å…·é›†åˆï¼šæ— å¹¿å‘Š Â· æœ¬åœ°è®¡ç®— Â· å³å¼€å³ç”¨çš„åœ¨çº¿å·¥å…·å¹³å°ï¼Œæä¾›JSONæ ¼å¼åŒ–ã€SQLæ ¼å¼åŒ–ã€Markdownç¼–è¾‘å™¨ç­‰å®ç”¨å·¥å…·"><span>æœ‰æ¡å·¥å…·</span>&nbsp;
<svg fill="none" shape-rendering="geometricPrecision" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li><li><a href=/blog/categories/ title="æ–‡ç« åˆ†ç±» - æœ‰æ¡å·¥å…·æŠ€æœ¯åšå®¢ï¼šæŒ‰æŠ€æœ¯é¢†åŸŸåˆ†ç±»çš„ä¼˜è´¨æ–‡ç« ï¼ŒåŒ…æ‹¬å‰ç«¯å¼€å‘ã€å·¥å…·ä½¿ç”¨ã€ç¼–ç¨‹æŠ€å·§ç­‰"><span>åˆ†ç±»</span></a></li><li><a href=/blog/tags/ title="æ ‡ç­¾äº‘ - æœ‰æ¡å·¥å…·æŠ€æœ¯åšå®¢ï¼šé€šè¿‡æ ‡ç­¾å¿«é€Ÿæ‰¾åˆ°æ„Ÿå…´è¶£çš„æŠ€æœ¯æ–‡ç« å’Œæ•™ç¨‹å†…å®¹"><span>æ ‡ç­¾</span></a></li><li><a href=/blog/archives/ title="æ–‡ç« å½’æ¡£ - æœ‰æ¡å·¥å…·æŠ€æœ¯åšå®¢ï¼šæŒ‰æ—¶é—´æŸ¥çœ‹å†å²æ–‡ç« "><span>å½’æ¡£</span></a></li><li><a href=/blog/search/ title="æœç´¢æ–‡ç«  - æœ‰æ¡å·¥å…·æŠ€æœ¯åšå®¢ï¼šé€šè¿‡å…³é”®è¯æœç´¢æ‰¾åˆ°æ„Ÿå…´è¶£çš„æŠ€æœ¯æ–‡ç« å’Œæ•™ç¨‹å†…å®¹ï¼Œæ”¯æŒæ ‡é¢˜ã€å†…å®¹ã€åˆ†ç±»å’Œæ ‡ç­¾æœç´¢"><span>æœç´¢</span></a></li></ul></nav></header><main class=main><article class=post-single><div class=post-content-wrapper><main class=post-content-main><header class=post-header-main><h1 class="post-title entry-hint-parent">APIå®‰å…¨é˜²æŠ¤ä¸é‰´æƒæœºåˆ¶ï¼šæ„å»ºå®‰å…¨å¯é çš„RESTful API</h1><div class=post-description>æ·±å…¥æ¢è®¨APIå®‰å…¨çš„å„ä¸ªæ–¹é¢ï¼ŒåŒ…æ‹¬èº«ä»½è®¤è¯ã€æˆæƒæœºåˆ¶ã€æ•°æ®åŠ å¯†ã€é˜²æ­¢å¸¸è§æ”»å‡»ã€å®‰å…¨æœ€ä½³å®è·µç­‰ï¼Œå¸®åŠ©å¼€å‘è€…æ„å»ºå®‰å…¨å¯é çš„APIç³»ç»Ÿã€‚</div><div class=post-meta><div class=post-meta-content><div class=post-categories-inline><a href=/blog/categories/api%E5%AE%89%E5%85%A8/ class=category-link>APIå®‰å…¨</a><a href=/blog/categories/%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91/ class=category-link>åç«¯å¼€å‘</a></div><span class=post-date>2025-12-24</span><span class=post-author>æœ‰æ¡å·¥å…·å›¢é˜Ÿ</span></div><style>.post-meta-content{display:flex;align-items:center;flex-wrap:wrap;gap:.75rem;font-family:sf mono,monaco,courier new,monospace;font-size:.875rem;color:#9ca3af !important}.post-categories-inline{display:inline-flex;align-items:center;gap:.5rem}.category-link{display:inline-flex;align-items:center;gap:.25rem;padding:.25rem .75rem;background:rgba(255,255,255,.1);color:#e5e7eb !important;text-decoration:none;font-size:.75rem;font-weight:600;text-transform:uppercase;letter-spacing:.05em;border:1px solid rgba(255,255,255,.2);border-radius:0;transition:all .3s ease;white-space:nowrap}.category-link:hover{background:rgba(255,255,255,.2);color:#fff !important;border-color:rgba(255,255,255,.3);transform:translateY(-1px)}.category-link::before{content:'ğŸ“';font-size:.7rem;opacity:.8}.post-date,.post-reading-time,.post-word-count,.post-author{color:#9ca3af !important}[data-theme=dark] .post-meta-content{color:#9ca3af !important}[data-theme=dark] .category-link{background:rgba(255,255,255,.1);color:#e5e7eb !important;border-color:rgba(255,255,255,.2)}[data-theme=dark] .category-link:hover{background:rgba(255,255,255,.2);color:#fff !important;border-color:rgba(255,255,255,.3)}[data-theme=dark] .post-date,[data-theme=dark] .post-reading-time,[data-theme=dark] .post-word-count,[data-theme=dark] .post-author{color:#9ca3af !important}[data-theme=light] .post-meta-content{color:#6c757d !important}[data-theme=light] .category-link{background:rgba(0,0,0,5%);color:#495057 !important;border-color:rgba(0,0,0,.15)}[data-theme=light] .category-link:hover{background:rgba(0,102,204,.1);color:#212529 !important;border-color:rgba(0,102,204,.3)}[data-theme=light] .post-date,[data-theme=light] .post-reading-time,[data-theme=light] .post-word-count,[data-theme=light] .post-author{color:#6c757d !important}@media(max-width:768px){.post-meta-content{gap:.5rem;font-size:.8rem}.category-link{padding:.2rem .6rem;font-size:.7rem}}</style></div></header><div class=post-content><h2 id=å¼•è¨€>å¼•è¨€<a hidden class=anchor aria-hidden=true href=#å¼•è¨€>#</a></h2><p>APIå®‰å…¨æ˜¯ç°ä»£åº”ç”¨å¼€å‘ä¸­çš„æ ¸å¿ƒè®®é¢˜ã€‚éšç€å¾®æœåŠ¡æ¶æ„çš„æ™®åŠï¼ŒAPIä½œä¸ºç³»ç»Ÿé—´çš„é€šä¿¡æ¡¥æ¢ï¼Œå…¶å®‰å…¨æ€§ç›´æ¥å½±å“æ•´ä¸ªç³»ç»Ÿçš„å®‰å…¨ã€‚æœ¬æ–‡å°†å…¨é¢è®²è§£APIå®‰å…¨çš„å„ä¸ªæ–¹é¢ï¼Œä»è®¤è¯æˆæƒåˆ°é˜²æŠ¤ç­–ç•¥ã€‚</p><h2 id=ä¸€èº«ä»½è®¤è¯æœºåˆ¶>ä¸€ã€èº«ä»½è®¤è¯æœºåˆ¶<a hidden class=anchor aria-hidden=true href=#ä¸€èº«ä»½è®¤è¯æœºåˆ¶>#</a></h2><h3 id=11-jwtjson-web-token>1.1 JWTï¼ˆJSON Web Tokenï¼‰<a hidden class=anchor aria-hidden=true href=#11-jwtjson-web-token>#</a></h3><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 78
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 79
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 80
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 81
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 82
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 83
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 84
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 85
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 86
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 87
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 88
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 89
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 90
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 91
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 92
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 93
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 94
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 95
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 96
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 97
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 98
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 99
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">100
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">101
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">102
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">103
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">104
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">105
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">106
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">107
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">108
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">109
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">110
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">111
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">112
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">113
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">114
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">115
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">116
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">117
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">118
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">119
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">120
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">121
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">122
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">123
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// JWTæœåŠ¡å®ç°
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>import</span> jwt <span style=color:#ff7b72>from</span> <span style=color:#a5d6ff>&#39;jsonwebtoken&#39;</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>import</span> bcrypt <span style=color:#ff7b72>from</span> <span style=color:#a5d6ff>&#39;bcrypt&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>interface</span> JWTPayload {
</span></span><span style=display:flex><span>  userId: <span style=color:#ff7b72>string</span>
</span></span><span style=display:flex><span>  email: <span style=color:#ff7b72>string</span>
</span></span><span style=display:flex><span>  role: <span style=color:#ff7b72>string</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>class</span> AuthService {
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>private</span> <span style=color:#ff7b72>readonly</span> JWT_SECRET <span style=color:#ff7b72;font-weight:700>=</span> process.env.JWT_SECRET <span style=color:#ff7b72;font-weight:700>||</span> <span style=color:#a5d6ff>&#39;your-secret-key&#39;</span>
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>private</span> <span style=color:#ff7b72>readonly</span> JWT_REFRESH_SECRET <span style=color:#ff7b72;font-weight:700>=</span> process.env.JWT_REFRESH_SECRET <span style=color:#ff7b72;font-weight:700>||</span> <span style=color:#a5d6ff>&#39;your-refresh-secret&#39;</span>
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>private</span> <span style=color:#ff7b72>readonly</span> JWT_EXPIRES_IN <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>&#39;15m&#39;</span>
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>private</span> <span style=color:#ff7b72>readonly</span> JWT_REFRESH_EXPIRES_IN <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>&#39;7d&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#8b949e;font-style:italic>// ç”Ÿæˆè®¿é—®ä»¤ç‰Œ
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>  generateAccessToken(payload: <span style=color:#ff7b72>JWTPayload</span>)<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#ff7b72>string</span> {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> jwt.sign(payload, <span style=color:#ff7b72>this</span>.JWT_SECRET, {
</span></span><span style=display:flex><span>      expiresIn: <span style=color:#ff7b72>this.JWT_EXPIRES_IN</span>,
</span></span><span style=display:flex><span>      issuer<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>&#39;myapp.com&#39;</span>,
</span></span><span style=display:flex><span>      audience<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>&#39;myapp-api&#39;</span>
</span></span><span style=display:flex><span>    })
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#8b949e;font-style:italic>// ç”Ÿæˆåˆ·æ–°ä»¤ç‰Œ
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>  generateRefreshToken(payload: <span style=color:#ff7b72>JWTPayload</span>)<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#ff7b72>string</span> {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> jwt.sign(
</span></span><span style=display:flex><span>      { userId: <span style=color:#ff7b72>payload.userId</span> },
</span></span><span style=display:flex><span>      <span style=color:#ff7b72>this</span>.JWT_REFRESH_SECRET,
</span></span><span style=display:flex><span>      { expiresIn: <span style=color:#ff7b72>this.JWT_REFRESH_EXPIRES_IN</span> }
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#8b949e;font-style:italic>// éªŒè¯è®¿é—®ä»¤ç‰Œ
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>  verifyAccessToken(token: <span style=color:#ff7b72>string</span>)<span style=color:#ff7b72;font-weight:700>:</span> JWTPayload <span style=color:#ff7b72;font-weight:700>|</span> <span style=color:#79c0ff>null</span> {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>try</span> {
</span></span><span style=display:flex><span>      <span style=color:#ff7b72>return</span> jwt.verify(token, <span style=color:#ff7b72>this</span>.JWT_SECRET) <span style=color:#ff7b72>as</span> JWTPayload
</span></span><span style=display:flex><span>    } <span style=color:#ff7b72>catch</span> (error) {
</span></span><span style=display:flex><span>      <span style=color:#ff7b72>return</span> <span style=color:#79c0ff>null</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#8b949e;font-style:italic>// éªŒè¯åˆ·æ–°ä»¤ç‰Œ
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>  verifyRefreshToken(token: <span style=color:#ff7b72>string</span>)<span style=color:#ff7b72;font-weight:700>:</span> { userId: <span style=color:#ff7b72>string</span> } <span style=color:#ff7b72;font-weight:700>|</span> <span style=color:#79c0ff>null</span> {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>try</span> {
</span></span><span style=display:flex><span>      <span style=color:#ff7b72>return</span> jwt.verify(token, <span style=color:#ff7b72>this</span>.JWT_REFRESH_SECRET) <span style=color:#ff7b72>as</span> { userId: <span style=color:#ff7b72>string</span> }
</span></span><span style=display:flex><span>    } <span style=color:#ff7b72>catch</span> (error) {
</span></span><span style=display:flex><span>      <span style=color:#ff7b72>return</span> <span style=color:#79c0ff>null</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#8b949e;font-style:italic>// å¯†ç å“ˆå¸Œ
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>  <span style=color:#ff7b72>async</span> hashPassword(password: <span style=color:#ff7b72>string</span>)<span style=color:#ff7b72;font-weight:700>:</span> Promise&lt;<span style=color:#7ee787>string</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> bcrypt.hash(password, <span style=color:#a5d6ff>12</span>)
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#8b949e;font-style:italic>// å¯†ç éªŒè¯
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>  <span style=color:#ff7b72>async</span> comparePassword(password: <span style=color:#ff7b72>string</span>, hash: <span style=color:#ff7b72>string</span>)<span style=color:#ff7b72;font-weight:700>:</span> Promise&lt;<span style=color:#7ee787>boolean</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> bcrypt.compare(password, hash)
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#8b949e;font-style:italic>// ç™»å½•æµç¨‹
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>  <span style=color:#ff7b72>async</span> login(email: <span style=color:#ff7b72>string</span>, password: <span style=color:#ff7b72>string</span>) {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>const</span> user <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>await</span> <span style=color:#ff7b72>this</span>.findUserByEmail(email)
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>if</span> (<span style=color:#ff7b72;font-weight:700>!</span>user) {
</span></span><span style=display:flex><span>      <span style=color:#ff7b72>throw</span> <span style=color:#ff7b72>new</span> Error(<span style=color:#a5d6ff>&#39;User not found&#39;</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>const</span> isValid <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>await</span> <span style=color:#ff7b72>this</span>.comparePassword(password, user.passwordHash)
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>if</span> (<span style=color:#ff7b72;font-weight:700>!</span>isValid) {
</span></span><span style=display:flex><span>      <span style=color:#ff7b72>throw</span> <span style=color:#ff7b72>new</span> Error(<span style=color:#a5d6ff>&#39;Invalid password&#39;</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>const</span> payload: <span style=color:#ff7b72>JWTPayload</span> <span style=color:#ff7b72;font-weight:700>=</span> {
</span></span><span style=display:flex><span>      userId: <span style=color:#ff7b72>user.id</span>,
</span></span><span style=display:flex><span>      email: <span style=color:#ff7b72>user.email</span>,
</span></span><span style=display:flex><span>      role: <span style=color:#ff7b72>user.role</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> {
</span></span><span style=display:flex><span>      accessToken: <span style=color:#ff7b72>this.generateAccessToken</span>(payload),
</span></span><span style=display:flex><span>      refreshToken: <span style=color:#ff7b72>this.generateRefreshToken</span>(payload),
</span></span><span style=display:flex><span>      expiresIn: <span style=color:#ff7b72>15</span> <span style=color:#ff7b72;font-weight:700>*</span> <span style=color:#a5d6ff>60</span>  <span style=color:#8b949e;font-style:italic>// 15åˆ†é’Ÿ
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#8b949e;font-style:italic>// åˆ·æ–°ä»¤ç‰Œ
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>  <span style=color:#ff7b72>async</span> refreshTokens(refreshToken: <span style=color:#ff7b72>string</span>) {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>const</span> payload <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>this</span>.verifyRefreshToken(refreshToken)
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>if</span> (<span style=color:#ff7b72;font-weight:700>!</span>payload) {
</span></span><span style=display:flex><span>      <span style=color:#ff7b72>throw</span> <span style=color:#ff7b72>new</span> Error(<span style=color:#a5d6ff>&#39;Invalid refresh token&#39;</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>const</span> user <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>await</span> <span style=color:#ff7b72>this</span>.findUserById(payload.userId)
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>if</span> (<span style=color:#ff7b72;font-weight:700>!</span>user) {
</span></span><span style=display:flex><span>      <span style=color:#ff7b72>throw</span> <span style=color:#ff7b72>new</span> Error(<span style=color:#a5d6ff>&#39;User not found&#39;</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>const</span> jwtPayload: <span style=color:#ff7b72>JWTPayload</span> <span style=color:#ff7b72;font-weight:700>=</span> {
</span></span><span style=display:flex><span>      userId: <span style=color:#ff7b72>user.id</span>,
</span></span><span style=display:flex><span>      email: <span style=color:#ff7b72>user.email</span>,
</span></span><span style=display:flex><span>      role: <span style=color:#ff7b72>user.role</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> {
</span></span><span style=display:flex><span>      accessToken: <span style=color:#ff7b72>this.generateAccessToken</span>(jwtPayload),
</span></span><span style=display:flex><span>      refreshToken: <span style=color:#ff7b72>this.generateRefreshToken</span>(jwtPayload)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>private</span> <span style=color:#ff7b72>async</span> findUserByEmail(email: <span style=color:#ff7b72>string</span>) {
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>// æ•°æ®åº“æŸ¥è¯¢å®ç°
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    <span style=color:#ff7b72>return</span> <span style=color:#79c0ff>null</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>private</span> <span style=color:#ff7b72>async</span> findUserById(userId: <span style=color:#ff7b72>string</span>) {
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>// æ•°æ®åº“æŸ¥è¯¢å®ç°
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    <span style=color:#ff7b72>return</span> <span style=color:#79c0ff>null</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>export</span> <span style=color:#ff7b72>const</span> authService <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>new</span> AuthService()
</span></span></code></pre></td></tr></table></div></div><h3 id=12-expressä¸­é—´ä»¶>1.2 Expressä¸­é—´ä»¶<a hidden class=anchor aria-hidden=true href=#12-expressä¸­é—´ä»¶>#</a></h3><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 78
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 79
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 80
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 81
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 82
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 83
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 84
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 85
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 86
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 87
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 88
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 89
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 90
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 91
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 92
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 93
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 94
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 95
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 96
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 97
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 98
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 99
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">100
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">101
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">102
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">103
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">104
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// è®¤è¯ä¸­é—´ä»¶
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>import</span> { Request, Response, NextFunction } <span style=color:#ff7b72>from</span> <span style=color:#a5d6ff>&#39;express&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>declare</span> <span style=color:#ff7b72>global</span> {
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>namespace</span> Express {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>interface</span> Request {
</span></span><span style=display:flex><span>      user<span style=color:#ff7b72;font-weight:700>?:</span> {
</span></span><span style=display:flex><span>        userId: <span style=color:#ff7b72>string</span>
</span></span><span style=display:flex><span>        email: <span style=color:#ff7b72>string</span>
</span></span><span style=display:flex><span>        role: <span style=color:#ff7b72>string</span>
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// JWTè®¤è¯ä¸­é—´ä»¶
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>export</span> <span style=color:#ff7b72>function</span> authenticate(req: <span style=color:#ff7b72>Request</span>, res: <span style=color:#ff7b72>Response</span>, next: <span style=color:#ff7b72>NextFunction</span>) {
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>const</span> authHeader <span style=color:#ff7b72;font-weight:700>=</span> req.headers.authorization
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>if</span> (<span style=color:#ff7b72;font-weight:700>!</span>authHeader <span style=color:#ff7b72;font-weight:700>||</span> <span style=color:#ff7b72;font-weight:700>!</span>authHeader.startsWith(<span style=color:#a5d6ff>&#39;Bearer &#39;</span>)) {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> res.status(<span style=color:#a5d6ff>401</span>).json({
</span></span><span style=display:flex><span>      error<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>&#39;Unauthorized&#39;</span>,
</span></span><span style=display:flex><span>      message<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>&#39;Missing or invalid authorization header&#39;</span>
</span></span><span style=display:flex><span>    })
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>const</span> token <span style=color:#ff7b72;font-weight:700>=</span> authHeader.substring(<span style=color:#a5d6ff>7</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>const</span> payload <span style=color:#ff7b72;font-weight:700>=</span> authService.verifyAccessToken(token)
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>if</span> (<span style=color:#ff7b72;font-weight:700>!</span>payload) {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> res.status(<span style=color:#a5d6ff>401</span>).json({
</span></span><span style=display:flex><span>      error<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>&#39;Unauthorized&#39;</span>,
</span></span><span style=display:flex><span>      message<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>&#39;Invalid or expired token&#39;</span>
</span></span><span style=display:flex><span>    })
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  req.user <span style=color:#ff7b72;font-weight:700>=</span> payload
</span></span><span style=display:flex><span>  next()
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// è§’è‰²æˆæƒä¸­é—´ä»¶
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>export</span> <span style=color:#ff7b72>function</span> authorize(...roles: <span style=color:#ff7b72>string</span>[]) {
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>return</span> (req: <span style=color:#ff7b72>Request</span>, res: <span style=color:#ff7b72>Response</span>, next: <span style=color:#ff7b72>NextFunction</span>) <span style=color:#ff7b72;font-weight:700>=&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>if</span> (<span style=color:#ff7b72;font-weight:700>!</span>req.user) {
</span></span><span style=display:flex><span>      <span style=color:#ff7b72>return</span> res.status(<span style=color:#a5d6ff>401</span>).json({
</span></span><span style=display:flex><span>        error<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>&#39;Unauthorized&#39;</span>,
</span></span><span style=display:flex><span>        message<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>&#39;Authentication required&#39;</span>
</span></span><span style=display:flex><span>      })
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>if</span> (<span style=color:#ff7b72;font-weight:700>!</span>roles.includes(req.user.role)) {
</span></span><span style=display:flex><span>      <span style=color:#ff7b72>return</span> res.status(<span style=color:#a5d6ff>403</span>).json({
</span></span><span style=display:flex><span>        error<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>&#39;Forbidden&#39;</span>,
</span></span><span style=display:flex><span>        message<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>&#39;Insufficient permissions&#39;</span>
</span></span><span style=display:flex><span>      })
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    next()
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// å¯é€‰è®¤è¯ä¸­é—´ä»¶ï¼ˆå…è®¸æœªç™»å½•ç”¨æˆ·è®¿é—®ï¼‰
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>export</span> <span style=color:#ff7b72>function</span> optionalAuthenticate(req: <span style=color:#ff7b72>Request</span>, res: <span style=color:#ff7b72>Response</span>, next: <span style=color:#ff7b72>NextFunction</span>) {
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>const</span> authHeader <span style=color:#ff7b72;font-weight:700>=</span> req.headers.authorization
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>if</span> (authHeader <span style=color:#ff7b72;font-weight:700>&amp;&amp;</span> authHeader.startsWith(<span style=color:#a5d6ff>&#39;Bearer &#39;</span>)) {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>const</span> token <span style=color:#ff7b72;font-weight:700>=</span> authHeader.substring(<span style=color:#a5d6ff>7</span>)
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>const</span> payload <span style=color:#ff7b72;font-weight:700>=</span> authService.verifyAccessToken(token)
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>if</span> (payload) {
</span></span><span style=display:flex><span>      req.user <span style=color:#ff7b72;font-weight:700>=</span> payload
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  next()
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// ä½¿ç”¨ç¤ºä¾‹
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>import</span> express <span style=color:#ff7b72>from</span> <span style=color:#a5d6ff>&#39;express&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>const</span> router <span style=color:#ff7b72;font-weight:700>=</span> express.Router()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// å…¬å¼€è·¯ç”±
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>router.<span style=color:#ff7b72>get</span>(<span style=color:#a5d6ff>&#39;/public&#39;</span>, (req, res) <span style=color:#ff7b72;font-weight:700>=&gt;</span> {
</span></span><span style=display:flex><span>  res.json({ message<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>&#39;Public endpoint&#39;</span> })
</span></span><span style=display:flex><span>})
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// éœ€è¦è®¤è¯
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>router.<span style=color:#ff7b72>get</span>(<span style=color:#a5d6ff>&#39;/profile&#39;</span>, authenticate, (req, res) <span style=color:#ff7b72;font-weight:700>=&gt;</span> {
</span></span><span style=display:flex><span>  res.json({ user: <span style=color:#ff7b72>req.user</span> })
</span></span><span style=display:flex><span>})
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// éœ€è¦ç‰¹å®šè§’è‰²
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>router.<span style=color:#ff7b72>delete</span>(<span style=color:#a5d6ff>&#39;/users/:id&#39;</span>, authenticate, authorize(<span style=color:#a5d6ff>&#39;admin&#39;</span>), (req, res) <span style=color:#ff7b72;font-weight:700>=&gt;</span> {
</span></span><span style=display:flex><span>  res.json({ message<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>&#39;User deleted&#39;</span> })
</span></span><span style=display:flex><span>})
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// å¯é€‰è®¤è¯ï¼ˆç™»å½•å’Œæœªç™»å½•éƒ½å¯ä»¥è®¿é—®ï¼‰
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>router.<span style=color:#ff7b72>get</span>(<span style=color:#a5d6ff>&#39;/content&#39;</span>, optionalAuthenticate, (req, res) <span style=color:#ff7b72;font-weight:700>=&gt;</span> {
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>if</span> (req.user) {
</span></span><span style=display:flex><span>    res.json({ content<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>&#39;premium content&#39;</span>, user: <span style=color:#ff7b72>req.user</span> })
</span></span><span style=display:flex><span>  } <span style=color:#ff7b72>else</span> {
</span></span><span style=display:flex><span>    res.json({ content<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>&#39;free content&#39;</span> })
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>})
</span></span></code></pre></td></tr></table></div></div><h3 id=13-oauth-20å®ç°>1.3 OAuth 2.0å®ç°<a hidden class=anchor aria-hidden=true href=#13-oauth-20å®ç°>#</a></h3><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 78
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 79
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 80
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 81
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 82
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 83
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 84
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 85
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 86
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 87
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 88
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 89
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 90
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 91
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 92
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 93
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 94
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 95
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 96
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 97
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 98
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 99
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">100
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">101
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">102
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">103
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">104
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">105
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">106
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">107
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">108
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">109
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">110
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">111
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">112
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// OAuth 2.0æˆæƒç æ¨¡å¼
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>import</span> crypto <span style=color:#ff7b72>from</span> <span style=color:#a5d6ff>&#39;crypto&#39;</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>import</span> { OAuth2Client } <span style=color:#ff7b72>from</span> <span style=color:#a5d6ff>&#39;google-auth-library&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>class</span> OAuthService {
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>private</span> clients <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>new</span> Map()
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>private</span> authorizationCodes <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>new</span> Map()
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>private</span> accessTokens <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>new</span> Map()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#8b949e;font-style:italic>// æ³¨å†ŒOAuthå®¢æˆ·ç«¯
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>  registerClient(clientId: <span style=color:#ff7b72>string</span>, redirectUris: <span style=color:#ff7b72>string</span>[], scopes: <span style=color:#ff7b72>string</span>[]) {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>const</span> clientSecret <span style=color:#ff7b72;font-weight:700>=</span> crypto.randomBytes(<span style=color:#a5d6ff>32</span>).toString(<span style=color:#a5d6ff>&#39;hex&#39;</span>)
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>this</span>.clients.<span style=color:#ff7b72>set</span>(clientId, {
</span></span><span style=display:flex><span>      clientId,
</span></span><span style=display:flex><span>      clientSecret,
</span></span><span style=display:flex><span>      redirectUris,
</span></span><span style=display:flex><span>      scopes
</span></span><span style=display:flex><span>    })
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> { clientId, clientSecret }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#8b949e;font-style:italic>// ç”Ÿæˆæˆæƒç 
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>  generateAuthorizationCode(userId: <span style=color:#ff7b72>string</span>, clientId: <span style=color:#ff7b72>string</span>, scopes: <span style=color:#ff7b72>string</span>[])<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#ff7b72>string</span> {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>const</span> code <span style=color:#ff7b72;font-weight:700>=</span> crypto.randomBytes(<span style=color:#a5d6ff>32</span>).toString(<span style=color:#a5d6ff>&#39;hex&#39;</span>)
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>this</span>.authorizationCodes.<span style=color:#ff7b72>set</span>(code, {
</span></span><span style=display:flex><span>      userId,
</span></span><span style=display:flex><span>      clientId,
</span></span><span style=display:flex><span>      scopes,
</span></span><span style=display:flex><span>      expiresAt: <span style=color:#ff7b72>Date.now</span>() <span style=color:#ff7b72;font-weight:700>+</span> <span style=color:#a5d6ff>10</span> <span style=color:#ff7b72;font-weight:700>*</span> <span style=color:#a5d6ff>60</span> <span style=color:#ff7b72;font-weight:700>*</span> <span style=color:#a5d6ff>1000</span>  <span style=color:#8b949e;font-style:italic>// 10åˆ†é’Ÿè¿‡æœŸ
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    })
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> code
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#8b949e;font-style:italic>// éªŒè¯æˆæƒç å¹¶ç”Ÿæˆè®¿é—®ä»¤ç‰Œ
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>  <span style=color:#ff7b72>async</span> exchangeCodeForToken(code: <span style=color:#ff7b72>string</span>, clientId: <span style=color:#ff7b72>string</span>, clientSecret: <span style=color:#ff7b72>string</span>, redirectUri: <span style=color:#ff7b72>string</span>) {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>const</span> authCode <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>this</span>.authorizationCodes.<span style=color:#ff7b72>get</span>(code)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>if</span> (<span style=color:#ff7b72;font-weight:700>!</span>authCode) {
</span></span><span style=display:flex><span>      <span style=color:#ff7b72>throw</span> <span style=color:#ff7b72>new</span> Error(<span style=color:#a5d6ff>&#39;Invalid authorization code&#39;</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>if</span> (authCode.clientId <span style=color:#ff7b72;font-weight:700>!==</span> clientId) {
</span></span><span style=display:flex><span>      <span style=color:#ff7b72>throw</span> <span style=color:#ff7b72>new</span> Error(<span style=color:#a5d6ff>&#39;Client ID mismatch&#39;</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>if</span> (Date.now() <span style=color:#ff7b72;font-weight:700>&gt;</span> authCode.expiresAt) {
</span></span><span style=display:flex><span>      <span style=color:#ff7b72>this</span>.authorizationCodes.<span style=color:#ff7b72>delete</span>(code)
</span></span><span style=display:flex><span>      <span style=color:#ff7b72>throw</span> <span style=color:#ff7b72>new</span> Error(<span style=color:#a5d6ff>&#39;Authorization code expired&#39;</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>const</span> client <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>this</span>.clients.<span style=color:#ff7b72>get</span>(clientId)
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>if</span> (client.clientSecret <span style=color:#ff7b72;font-weight:700>!==</span> clientSecret) {
</span></span><span style=display:flex><span>      <span style=color:#ff7b72>throw</span> <span style=color:#ff7b72>new</span> Error(<span style=color:#a5d6ff>&#39;Invalid client secret&#39;</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>if</span> (<span style=color:#ff7b72;font-weight:700>!</span>client.redirectUris.includes(redirectUri)) {
</span></span><span style=display:flex><span>      <span style=color:#ff7b72>throw</span> <span style=color:#ff7b72>new</span> Error(<span style=color:#a5d6ff>&#39;Invalid redirect URI&#39;</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>// ç”Ÿæˆè®¿é—®ä»¤ç‰Œ
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    <span style=color:#ff7b72>const</span> accessToken <span style=color:#ff7b72;font-weight:700>=</span> crypto.randomBytes(<span style=color:#a5d6ff>32</span>).toString(<span style=color:#a5d6ff>&#39;hex&#39;</span>)
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>this</span>.accessTokens.<span style=color:#ff7b72>set</span>(accessToken, {
</span></span><span style=display:flex><span>      userId: <span style=color:#ff7b72>authCode.userId</span>,
</span></span><span style=display:flex><span>      clientId,
</span></span><span style=display:flex><span>      scopes: <span style=color:#ff7b72>authCode.scopes</span>,
</span></span><span style=display:flex><span>      expiresAt: <span style=color:#ff7b72>Date.now</span>() <span style=color:#ff7b72;font-weight:700>+</span> <span style=color:#a5d6ff>60</span> <span style=color:#ff7b72;font-weight:700>*</span> <span style=color:#a5d6ff>60</span> <span style=color:#ff7b72;font-weight:700>*</span> <span style=color:#a5d6ff>1000</span>  <span style=color:#8b949e;font-style:italic>// 1å°æ—¶è¿‡æœŸ
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    })
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>// åˆ é™¤å·²ä½¿ç”¨çš„æˆæƒç 
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    <span style=color:#ff7b72>this</span>.authorizationCodes.<span style=color:#ff7b72>delete</span>(code)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> {
</span></span><span style=display:flex><span>      access_token: <span style=color:#ff7b72>accessToken</span>,
</span></span><span style=display:flex><span>      token_type<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>&#39;Bearer&#39;</span>,
</span></span><span style=display:flex><span>      expires_in: <span style=color:#ff7b72>3600</span>,
</span></span><span style=display:flex><span>      scope: <span style=color:#ff7b72>authCode.scopes.join</span>(<span style=color:#a5d6ff>&#39; &#39;</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#8b949e;font-style:italic>// éªŒè¯è®¿é—®ä»¤ç‰Œ
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>  verifyAccessToken(accessToken: <span style=color:#ff7b72>string</span>) {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>const</span> token <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>this</span>.accessTokens.<span style=color:#ff7b72>get</span>(accessToken)
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>if</span> (<span style=color:#ff7b72;font-weight:700>!</span>token) {
</span></span><span style=display:flex><span>      <span style=color:#ff7b72>return</span> <span style=color:#79c0ff>null</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>if</span> (Date.now() <span style=color:#ff7b72;font-weight:700>&gt;</span> token.expiresAt) {
</span></span><span style=display:flex><span>      <span style=color:#ff7b72>this</span>.accessTokens.<span style=color:#ff7b72>delete</span>(accessToken)
</span></span><span style=display:flex><span>      <span style=color:#ff7b72>return</span> <span style=color:#79c0ff>null</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> token
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#8b949e;font-style:italic>// Google OAuthé›†æˆ
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>  <span style=color:#ff7b72>async</span> verifyGoogleToken(idToken: <span style=color:#ff7b72>string</span>) {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>const</span> client <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>new</span> OAuth2Client(process.env.GOOGLE_CLIENT_ID)
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>const</span> ticket <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>await</span> client.verifyIdToken({
</span></span><span style=display:flex><span>      idToken,
</span></span><span style=display:flex><span>      audience: <span style=color:#ff7b72>process.env.GOOGLE_CLIENT_ID</span>
</span></span><span style=display:flex><span>    })
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>const</span> payload <span style=color:#ff7b72;font-weight:700>=</span> ticket.getPayload()
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> {
</span></span><span style=display:flex><span>      userId: <span style=color:#ff7b72>payload.sub</span>,
</span></span><span style=display:flex><span>      email: <span style=color:#ff7b72>payload.email</span>,
</span></span><span style=display:flex><span>      name: <span style=color:#ff7b72>payload.name</span>,
</span></span><span style=display:flex><span>      picture: <span style=color:#ff7b72>payload.picture</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>export</span> <span style=color:#ff7b72>const</span> oauthService <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>new</span> OAuthService()
</span></span></code></pre></td></tr></table></div></div><h2 id=äºŒæ•°æ®å®‰å…¨>äºŒã€æ•°æ®å®‰å…¨<a hidden class=anchor aria-hidden=true href=#äºŒæ•°æ®å®‰å…¨>#</a></h2><h3 id=21-æ•æ„Ÿæ•°æ®åŠ å¯†>2.1 æ•æ„Ÿæ•°æ®åŠ å¯†<a hidden class=anchor aria-hidden=true href=#21-æ•æ„Ÿæ•°æ®åŠ å¯†>#</a></h3><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">78
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">79
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">80
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">81
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">82
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">83
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">84
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// åŠ å¯†æœåŠ¡
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>import</span> crypto <span style=color:#ff7b72>from</span> <span style=color:#a5d6ff>&#39;crypto&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>class</span> EncryptionService {
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>private</span> <span style=color:#ff7b72>readonly</span> ALGORITHM <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>&#39;aes-256-gcm&#39;</span>
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>private</span> <span style=color:#ff7b72>readonly</span> KEY_LENGTH <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>32</span>
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>private</span> <span style=color:#ff7b72>readonly</span> IV_LENGTH <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>16</span>
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>private</span> <span style=color:#ff7b72>readonly</span> AUTH_TAG_LENGTH <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>16</span>
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>private</span> key: <span style=color:#ff7b72>Buffer</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>constructor</span>() {
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>// ä»ç¯å¢ƒå˜é‡è·å–åŠ å¯†å¯†é’¥
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    <span style=color:#ff7b72>const</span> keyString <span style=color:#ff7b72;font-weight:700>=</span> process.env.ENCRYPTION_KEY <span style=color:#ff7b72;font-weight:700>||</span> <span style=color:#a5d6ff>&#39;default-key-change-in-production&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>this</span>.key <span style=color:#ff7b72;font-weight:700>=</span> crypto.scryptSync(keyString, <span style=color:#a5d6ff>&#39;salt&#39;</span>, <span style=color:#ff7b72>this</span>.KEY_LENGTH)
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#8b949e;font-style:italic>// åŠ å¯†æ•°æ®
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>  encrypt(plaintext: <span style=color:#ff7b72>string</span>)<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#ff7b72>string</span> {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>const</span> iv <span style=color:#ff7b72;font-weight:700>=</span> crypto.randomBytes(<span style=color:#ff7b72>this</span>.IV_LENGTH)
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>const</span> cipher <span style=color:#ff7b72;font-weight:700>=</span> crypto.createCipheriv(<span style=color:#ff7b72>this</span>.ALGORITHM, <span style=color:#ff7b72>this</span>.key, iv)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>let</span> encrypted <span style=color:#ff7b72;font-weight:700>=</span> cipher.update(plaintext, <span style=color:#a5d6ff>&#39;utf8&#39;</span>, <span style=color:#a5d6ff>&#39;hex&#39;</span>)
</span></span><span style=display:flex><span>    encrypted <span style=color:#ff7b72;font-weight:700>+=</span> cipher.final(<span style=color:#a5d6ff>&#39;hex&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>const</span> authTag <span style=color:#ff7b72;font-weight:700>=</span> cipher.getAuthTag()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>// ç»„åˆï¼šiv + authTag + encrypted
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    <span style=color:#ff7b72>return</span> iv.toString(<span style=color:#a5d6ff>&#39;hex&#39;</span>) <span style=color:#ff7b72;font-weight:700>+</span> authTag.toString(<span style=color:#a5d6ff>&#39;hex&#39;</span>) <span style=color:#ff7b72;font-weight:700>+</span> encrypted
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#8b949e;font-style:italic>// è§£å¯†æ•°æ®
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>  decrypt(ciphertext: <span style=color:#ff7b72>string</span>)<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#ff7b72>string</span> {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>const</span> iv <span style=color:#ff7b72;font-weight:700>=</span> Buffer.<span style=color:#ff7b72>from</span>(ciphertext.slice(<span style=color:#a5d6ff>0</span>, <span style=color:#ff7b72>this</span>.IV_LENGTH <span style=color:#ff7b72;font-weight:700>*</span> <span style=color:#a5d6ff>2</span>), <span style=color:#a5d6ff>&#39;hex&#39;</span>)
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>const</span> authTag <span style=color:#ff7b72;font-weight:700>=</span> Buffer.<span style=color:#ff7b72>from</span>(
</span></span><span style=display:flex><span>      ciphertext.slice(<span style=color:#ff7b72>this</span>.IV_LENGTH <span style=color:#ff7b72;font-weight:700>*</span> <span style=color:#a5d6ff>2</span>, (<span style=color:#ff7b72>this</span>.IV_LENGTH <span style=color:#ff7b72;font-weight:700>+</span> <span style=color:#ff7b72>this</span>.AUTH_TAG_LENGTH) <span style=color:#ff7b72;font-weight:700>*</span> <span style=color:#a5d6ff>2</span>),
</span></span><span style=display:flex><span>      <span style=color:#a5d6ff>&#39;hex&#39;</span>
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>const</span> encrypted <span style=color:#ff7b72;font-weight:700>=</span> ciphertext.slice((<span style=color:#ff7b72>this</span>.IV_LENGTH <span style=color:#ff7b72;font-weight:700>+</span> <span style=color:#ff7b72>this</span>.AUTH_TAG_LENGTH) <span style=color:#ff7b72;font-weight:700>*</span> <span style=color:#a5d6ff>2</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>const</span> decipher <span style=color:#ff7b72;font-weight:700>=</span> crypto.createDecipheriv(<span style=color:#ff7b72>this</span>.ALGORITHM, <span style=color:#ff7b72>this</span>.key, iv)
</span></span><span style=display:flex><span>    decipher.setAuthTag(authTag)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>let</span> decrypted <span style=color:#ff7b72;font-weight:700>=</span> decipher.update(encrypted, <span style=color:#a5d6ff>&#39;hex&#39;</span>, <span style=color:#a5d6ff>&#39;utf8&#39;</span>)
</span></span><span style=display:flex><span>    decrypted <span style=color:#ff7b72;font-weight:700>+=</span> decipher.final(<span style=color:#a5d6ff>&#39;utf8&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> decrypted
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#8b949e;font-style:italic>// å“ˆå¸Œæ•°æ®ï¼ˆå•å‘ï¼‰
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>  hash(data: <span style=color:#ff7b72>string</span>)<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#ff7b72>string</span> {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> crypto.createHash(<span style=color:#a5d6ff>&#39;sha256&#39;</span>).update(data).digest(<span style=color:#a5d6ff>&#39;hex&#39;</span>)
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#8b949e;font-style:italic>// ç”ŸæˆHMAC
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>  generateHMAC(data: <span style=color:#ff7b72>string</span>, secret: <span style=color:#ff7b72>string</span>)<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#ff7b72>string</span> {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> crypto.createHmac(<span style=color:#a5d6ff>&#39;sha256&#39;</span>, secret).update(data).digest(<span style=color:#a5d6ff>&#39;hex&#39;</span>)
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#8b949e;font-style:italic>// éªŒè¯HMAC
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>  verifyHMAC(data: <span style=color:#ff7b72>string</span>, hmac: <span style=color:#ff7b72>string</span>, secret: <span style=color:#ff7b72>string</span>)<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#ff7b72>boolean</span> {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>const</span> computedHMAC <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>this</span>.generateHMAC(data, secret)
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> crypto.timingSafeEqual(
</span></span><span style=display:flex><span>      Buffer.<span style=color:#ff7b72>from</span>(computedHMAC, <span style=color:#a5d6ff>&#39;hex&#39;</span>),
</span></span><span style=display:flex><span>      Buffer.<span style=color:#ff7b72>from</span>(hmac, <span style=color:#a5d6ff>&#39;hex&#39;</span>)
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>export</span> <span style=color:#ff7b72>const</span> encryptionService <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>new</span> EncryptionService()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// ä½¿ç”¨ç¤ºä¾‹
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>const</span> sensitiveData <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>&#39;user-ssn-123-45-6789&#39;</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>const</span> encrypted <span style=color:#ff7b72;font-weight:700>=</span> encryptionService.encrypt(sensitiveData)
</span></span><span style=display:flex><span><span style=color:#ff7b72>const</span> decrypted <span style=color:#ff7b72;font-weight:700>=</span> encryptionService.decrypt(encrypted)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// æ•°æ®åº“ä¸­å­˜å‚¨åŠ å¯†æ•°æ®
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>async</span> <span style=color:#ff7b72>function</span> saveUserWithEncryptedData(userData: <span style=color:#ff7b72>any</span>) {
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>const</span> encrypted <span style=color:#ff7b72;font-weight:700>=</span> encryptionService.encrypt(userData.ssn)
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>await</span> db.users.create({
</span></span><span style=display:flex><span>    ...userData,
</span></span><span style=display:flex><span>    ssn: <span style=color:#ff7b72>encrypted</span>,
</span></span><span style=display:flex><span>    ssnHash: <span style=color:#ff7b72>encryptionService.hash</span>(userData.ssn)  <span style=color:#8b949e;font-style:italic>// ç”¨äºæŸ¥è¯¢
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>  })
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h3 id=22-ç­¾åéªŒè¯>2.2 ç­¾åéªŒè¯<a hidden class=anchor aria-hidden=true href=#22-ç­¾åéªŒè¯>#</a></h3><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">38
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// Webhookç­¾åéªŒè¯
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>import</span> crypto <span style=color:#ff7b72>from</span> <span style=color:#a5d6ff>&#39;crypto&#39;</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>import</span> { Request, Response } <span style=color:#ff7b72>from</span> <span style=color:#a5d6ff>&#39;express&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>function</span> verifyWebhookSignature(req: <span style=color:#ff7b72>Request</span>, res: <span style=color:#ff7b72>Response</span>, next: <span style=color:#ff7b72>NextFunction</span>) {
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>const</span> signature <span style=color:#ff7b72;font-weight:700>=</span> req.headers[<span style=color:#a5d6ff>&#39;x-webhook-signature&#39;</span>] <span style=color:#ff7b72>as</span> <span style=color:#ff7b72>string</span>
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>const</span> timestamp <span style=color:#ff7b72;font-weight:700>=</span> req.headers[<span style=color:#a5d6ff>&#39;x-webhook-timestamp&#39;</span>] <span style=color:#ff7b72>as</span> <span style=color:#ff7b72>string</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>if</span> (<span style=color:#ff7b72;font-weight:700>!</span>signature <span style=color:#ff7b72;font-weight:700>||</span> <span style=color:#ff7b72;font-weight:700>!</span>timestamp) {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> res.status(<span style=color:#a5d6ff>401</span>).json({ error<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>&#39;Missing signature headers&#39;</span> })
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#8b949e;font-style:italic>// æ£€æŸ¥æ—¶é—´æˆ³ï¼ˆé˜²é‡æ”¾æ”»å‡»ï¼‰
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>  <span style=color:#ff7b72>const</span> now <span style=color:#ff7b72;font-weight:700>=</span> Date.now()
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>const</span> webhookTime <span style=color:#ff7b72;font-weight:700>=</span> parseInt(timestamp)
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>if</span> (Math.abs(now <span style=color:#ff7b72;font-weight:700>-</span> webhookTime) <span style=color:#ff7b72;font-weight:700>&gt;</span> <span style=color:#a5d6ff>5</span> <span style=color:#ff7b72;font-weight:700>*</span> <span style=color:#a5d6ff>60</span> <span style=color:#ff7b72;font-weight:700>*</span> <span style=color:#a5d6ff>1000</span>) {  <span style=color:#8b949e;font-style:italic>// 5åˆ†é’Ÿçª—å£
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    <span style=color:#ff7b72>return</span> res.status(<span style=color:#a5d6ff>401</span>).json({ error<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>&#39;Request too old&#39;</span> })
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#8b949e;font-style:italic>// ç”Ÿæˆé¢„æœŸç­¾å
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>  <span style=color:#ff7b72>const</span> payload <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>`</span><span style=color:#a5d6ff>${</span>timestamp<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>.</span><span style=color:#a5d6ff>${</span>req.body<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>`</span>
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>const</span> expectedSignature <span style=color:#ff7b72;font-weight:700>=</span> crypto
</span></span><span style=display:flex><span>    .createHmac(<span style=color:#a5d6ff>&#39;sha256&#39;</span>, process.env.WEBHOOK_SECRET<span style=color:#ff7b72;font-weight:700>!</span>)
</span></span><span style=display:flex><span>    .update(payload)
</span></span><span style=display:flex><span>    .digest(<span style=color:#a5d6ff>&#39;hex&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#8b949e;font-style:italic>// å®‰å…¨æ¯”è¾ƒç­¾å
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>  <span style=color:#ff7b72>const</span> isValid <span style=color:#ff7b72;font-weight:700>=</span> crypto.timingSafeEqual(
</span></span><span style=display:flex><span>    Buffer.<span style=color:#ff7b72>from</span>(signature, <span style=color:#a5d6ff>&#39;hex&#39;</span>),
</span></span><span style=display:flex><span>    Buffer.<span style=color:#ff7b72>from</span>(expectedSignature, <span style=color:#a5d6ff>&#39;hex&#39;</span>)
</span></span><span style=display:flex><span>  )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>if</span> (<span style=color:#ff7b72;font-weight:700>!</span>isValid) {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> res.status(<span style=color:#a5d6ff>401</span>).json({ error<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>&#39;Invalid signature&#39;</span> })
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  next()
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h2 id=ä¸‰é˜²æŠ¤ç­–ç•¥>ä¸‰ã€é˜²æŠ¤ç­–ç•¥<a hidden class=anchor aria-hidden=true href=#ä¸‰é˜²æŠ¤ç­–ç•¥>#</a></h2><h3 id=31-sqlæ³¨å…¥é˜²æŠ¤>3.1 SQLæ³¨å…¥é˜²æŠ¤<a hidden class=anchor aria-hidden=true href=#31-sqlæ³¨å…¥é˜²æŠ¤>#</a></h3><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">53
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>import</span> { Pool } <span style=color:#ff7b72>from</span> <span style=color:#a5d6ff>&#39;pg&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>class</span> UserRepository {
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>private</span> pool: <span style=color:#ff7b72>Pool</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>constructor</span>(pool: <span style=color:#ff7b72>Pool</span>) {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>this</span>.pool <span style=color:#ff7b72;font-weight:700>=</span> pool
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#8b949e;font-style:italic>// å®‰å…¨çš„æŸ¥è¯¢
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>  <span style=color:#ff7b72>async</span> findById(id: <span style=color:#ff7b72>string</span>) {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>const</span> query <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>&#39;SELECT * FROM users WHERE id = $1&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>const</span> result <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>await</span> <span style=color:#ff7b72>this</span>.pool.query(query, [id])
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> result.rows[<span style=color:#a5d6ff>0</span>]
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>async</span> findByEmail(email: <span style=color:#ff7b72>string</span>) {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>const</span> query <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>&#39;SELECT * FROM users WHERE email = $1&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>const</span> result <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>await</span> <span style=color:#ff7b72>this</span>.pool.query(query, [email])
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> result.rows[<span style=color:#a5d6ff>0</span>]
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#8b949e;font-style:italic>// ä½¿ç”¨æŸ¥è¯¢æ„å»ºå™¨ï¼ˆå¦‚Knex.jsï¼‰
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>  <span style=color:#ff7b72>async</span> findWithFilters(filters: <span style=color:#ff7b72>any</span>) {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>const</span> query <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>this</span>.pool
</span></span><span style=display:flex><span>      .select(<span style=color:#a5d6ff>&#39;*&#39;</span>)
</span></span><span style=display:flex><span>      .<span style=color:#ff7b72>from</span>(<span style=color:#a5d6ff>&#39;users&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>if</span> (filters.email) {
</span></span><span style=display:flex><span>      query <span style=color:#ff7b72;font-weight:700>=</span> query.where(<span style=color:#a5d6ff>&#39;email&#39;</span>, filters.email)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>if</span> (filters.role) {
</span></span><span style=display:flex><span>      query <span style=color:#ff7b72;font-weight:700>=</span> query.where(<span style=color:#a5d6ff>&#39;role&#39;</span>, filters.role)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>if</span> (filters.minAge) {
</span></span><span style=display:flex><span>      query <span style=color:#ff7b72;font-weight:700>=</span> query.where(<span style=color:#a5d6ff>&#39;age&#39;</span>, <span style=color:#a5d6ff>&#39;&gt;=&#39;</span>, filters.minAge)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> <span style=color:#ff7b72>await</span> query
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#8b949e;font-style:italic>// ä½¿ç”¨ORMï¼ˆå¦‚Prismaã€TypeORMï¼‰
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>  <span style=color:#ff7b72>async</span> create(data: <span style=color:#ff7b72>any</span>) {
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>// ORMè‡ªåŠ¨å¤„ç†å‚æ•°åŒ–æŸ¥è¯¢
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    <span style=color:#ff7b72>return</span> <span style=color:#ff7b72>await</span> <span style=color:#ff7b72>this</span>.pool.query(
</span></span><span style=display:flex><span>      <span style=color:#a5d6ff>&#39;INSERT INTO users (name, email, password_hash) VALUES ($1, $2, $3) RETURNING *&#39;</span>,
</span></span><span style=display:flex><span>      [data.name, data.email, data.passwordHash]
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h3 id=32-xssé˜²æŠ¤>3.2 XSSé˜²æŠ¤<a hidden class=anchor aria-hidden=true href=#32-xssé˜²æŠ¤>#</a></h3><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">52
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// è¾“å…¥éªŒè¯å’Œè¾“å‡ºç¼–ç 
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>import</span> validator <span style=color:#ff7b72>from</span> <span style=color:#a5d6ff>&#39;validator&#39;</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>import</span> xss <span style=color:#ff7b72>from</span> <span style=color:#a5d6ff>&#39;xss&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>class</span> SecurityMiddleware {
</span></span><span style=display:flex><span>  <span style=color:#8b949e;font-style:italic>// è¾“å…¥éªŒè¯
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>  <span style=color:#ff7b72>static</span> validateInput(req: <span style=color:#ff7b72>Request</span>, res: <span style=color:#ff7b72>Response</span>, next: <span style=color:#ff7b72>NextFunction</span>) {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>const</span> { name, email, bio } <span style=color:#ff7b72;font-weight:700>=</span> req.body
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>// éªŒè¯å’Œæ¸…ç†è¾“å…¥
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    <span style=color:#ff7b72>if</span> (name <span style=color:#ff7b72;font-weight:700>&amp;&amp;</span> <span style=color:#ff7b72;font-weight:700>!</span>validator.isLength(name, { min: <span style=color:#ff7b72>1</span>, max: <span style=color:#ff7b72>100</span> })) {
</span></span><span style=display:flex><span>      <span style=color:#ff7b72>return</span> res.status(<span style=color:#a5d6ff>400</span>).json({ error<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>&#39;Invalid name length&#39;</span> })
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>if</span> (email <span style=color:#ff7b72;font-weight:700>&amp;&amp;</span> <span style=color:#ff7b72;font-weight:700>!</span>validator.isEmail(email)) {
</span></span><span style=display:flex><span>      <span style=color:#ff7b72>return</span> res.status(<span style=color:#a5d6ff>400</span>).json({ error<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>&#39;Invalid email format&#39;</span> })
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>if</span> (bio <span style=color:#ff7b72;font-weight:700>&amp;&amp;</span> <span style=color:#ff7b72;font-weight:700>!</span>validator.isLength(bio, { max: <span style=color:#ff7b72>500</span> })) {
</span></span><span style=display:flex><span>      <span style=color:#ff7b72>return</span> res.status(<span style=color:#a5d6ff>400</span>).json({ error<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>&#39;Bio too long&#39;</span> })
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>// æ¸…ç†XSS
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    <span style=color:#ff7b72>if</span> (name) req.body.name <span style=color:#ff7b72;font-weight:700>=</span> xss(name)
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>if</span> (bio) req.body.bio <span style=color:#ff7b72;font-weight:700>=</span> xss(bio)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    next()
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#8b949e;font-style:italic>// è®¾ç½®CSPå¤´
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>  <span style=color:#ff7b72>static</span> setSecurityHeaders(req: <span style=color:#ff7b72>Request</span>, res: <span style=color:#ff7b72>Response</span>, next: <span style=color:#ff7b72>NextFunction</span>) {
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>// å†…å®¹å®‰å…¨ç­–ç•¥
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    res.setHeader(<span style=color:#a5d6ff>&#39;Content-Security-Policy&#39;</span>,
</span></span><span style=display:flex><span>      <span style=color:#a5d6ff>&#34;default-src &#39;self&#39;; &#34;</span> <span style=color:#ff7b72;font-weight:700>+</span>
</span></span><span style=display:flex><span>      <span style=color:#a5d6ff>&#34;script-src &#39;self&#39; &#39;unsafe-inline&#39; &#39;unsafe-eval&#39; https://cdn.example.com; &#34;</span> <span style=color:#ff7b72;font-weight:700>+</span>
</span></span><span style=display:flex><span>      <span style=color:#a5d6ff>&#34;style-src &#39;self&#39; &#39;unsafe-inline&#39;; &#34;</span> <span style=color:#ff7b72;font-weight:700>+</span>
</span></span><span style=display:flex><span>      <span style=color:#a5d6ff>&#34;img-src &#39;self&#39; data: https:; &#34;</span> <span style=color:#ff7b72;font-weight:700>+</span>
</span></span><span style=display:flex><span>      <span style=color:#a5d6ff>&#34;font-src &#39;self&#39;; &#34;</span> <span style=color:#ff7b72;font-weight:700>+</span>
</span></span><span style=display:flex><span>      <span style=color:#a5d6ff>&#34;connect-src &#39;self&#39; https://api.example.com; &#34;</span> <span style=color:#ff7b72;font-weight:700>+</span>
</span></span><span style=display:flex><span>      <span style=color:#a5d6ff>&#34;frame-ancestors &#39;none&#39;;&#34;</span>
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>// å…¶ä»–å®‰å…¨å¤´
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    res.setHeader(<span style=color:#a5d6ff>&#39;X-Content-Type-Options&#39;</span>, <span style=color:#a5d6ff>&#39;nosniff&#39;</span>)
</span></span><span style=display:flex><span>    res.setHeader(<span style=color:#a5d6ff>&#39;X-Frame-Options&#39;</span>, <span style=color:#a5d6ff>&#39;DENY&#39;</span>)
</span></span><span style=display:flex><span>    res.setHeader(<span style=color:#a5d6ff>&#39;X-XSS-Protection&#39;</span>, <span style=color:#a5d6ff>&#39;1; mode=block&#39;</span>)
</span></span><span style=display:flex><span>    res.setHeader(<span style=color:#a5d6ff>&#39;Referrer-Policy&#39;</span>, <span style=color:#a5d6ff>&#39;strict-origin-when-cross-origin&#39;</span>)
</span></span><span style=display:flex><span>    res.setHeader(<span style=color:#a5d6ff>&#39;Permissions-Policy&#39;</span>, <span style=color:#a5d6ff>&#39;geolocation=(), microphone=(), camera=()&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    next()
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h3 id=33-corsé…ç½®>3.3 CORSé…ç½®<a hidden class=anchor aria-hidden=true href=#33-corsé…ç½®>#</a></h3><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">39
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// CORSé…ç½®
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>import</span> express <span style=color:#ff7b72>from</span> <span style=color:#a5d6ff>&#39;express&#39;</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>import</span> cors <span style=color:#ff7b72>from</span> <span style=color:#a5d6ff>&#39;cors&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>const</span> app <span style=color:#ff7b72;font-weight:700>=</span> express()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// ç”Ÿäº§ç¯å¢ƒCORSé…ç½®
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>const</span> corsOptions <span style=color:#ff7b72;font-weight:700>=</span> {
</span></span><span style=display:flex><span>  origin: <span style=color:#ff7b72>function</span> (origin: <span style=color:#ff7b72>string</span> <span style=color:#ff7b72;font-weight:700>|</span> <span style=color:#79c0ff>undefined</span>, callback: <span style=color:#ff7b72>Function</span>) {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>const</span> allowedOrigins <span style=color:#ff7b72;font-weight:700>=</span> [
</span></span><span style=display:flex><span>      <span style=color:#a5d6ff>&#39;https://example.com&#39;</span>,
</span></span><span style=display:flex><span>      <span style=color:#a5d6ff>&#39;https://www.example.com&#39;</span>,
</span></span><span style=display:flex><span>      <span style=color:#a5d6ff>&#39;https://app.example.com&#39;</span>
</span></span><span style=display:flex><span>    ]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>// å…è®¸æ— originçš„è¯·æ±‚ï¼ˆå¦‚ç§»åŠ¨åº”ç”¨ã€Postmanï¼‰
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    <span style=color:#ff7b72>if</span> (<span style=color:#ff7b72;font-weight:700>!</span>origin) <span style=color:#ff7b72>return</span> callback(<span style=color:#79c0ff>null</span>, <span style=color:#79c0ff>true</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>if</span> (allowedOrigins.indexOf(origin) <span style=color:#ff7b72;font-weight:700>!==</span> <span style=color:#ff7b72;font-weight:700>-</span><span style=color:#a5d6ff>1</span>) {
</span></span><span style=display:flex><span>      callback(<span style=color:#79c0ff>null</span>, <span style=color:#79c0ff>true</span>)
</span></span><span style=display:flex><span>    } <span style=color:#ff7b72>else</span> {
</span></span><span style=display:flex><span>      callback(<span style=color:#ff7b72>new</span> Error(<span style=color:#a5d6ff>&#39;Not allowed by CORS&#39;</span>))
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  credentials: <span style=color:#ff7b72>true</span>,  <span style=color:#8b949e;font-style:italic>// å…è®¸æºå¸¦cookie
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>  methods<span style=color:#ff7b72;font-weight:700>:</span> [<span style=color:#a5d6ff>&#39;GET&#39;</span>, <span style=color:#a5d6ff>&#39;POST&#39;</span>, <span style=color:#a5d6ff>&#39;PUT&#39;</span>, <span style=color:#a5d6ff>&#39;DELETE&#39;</span>, <span style=color:#a5d6ff>&#39;OPTIONS&#39;</span>],
</span></span><span style=display:flex><span>  allowedHeaders<span style=color:#ff7b72;font-weight:700>:</span> [<span style=color:#a5d6ff>&#39;Content-Type&#39;</span>, <span style=color:#a5d6ff>&#39;Authorization&#39;</span>],
</span></span><span style=display:flex><span>  exposedHeaders<span style=color:#ff7b72;font-weight:700>:</span> [<span style=color:#a5d6ff>&#39;X-Total-Count&#39;</span>],
</span></span><span style=display:flex><span>  maxAge: <span style=color:#ff7b72>86400</span>  <span style=color:#8b949e;font-style:italic>// é¢„æ£€è¯·æ±‚ç¼“å­˜24å°æ—¶
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>app.use(cors(corsOptions))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// æˆ–è€…é’ˆå¯¹ç‰¹å®šè·¯ç”±
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>app.options(<span style=color:#a5d6ff>&#39;/api/*&#39;</span>, cors(corsOptions))
</span></span><span style=display:flex><span>app.<span style=color:#ff7b72>get</span>(<span style=color:#a5d6ff>&#39;/api/data&#39;</span>, cors(corsOptions), (req, res) <span style=color:#ff7b72;font-weight:700>=&gt;</span> {
</span></span><span style=display:flex><span>  res.json({ data<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>&#39;sensitive data&#39;</span> })
</span></span><span style=display:flex><span>})
</span></span></code></pre></td></tr></table></div></div><h3 id=34-é€Ÿç‡é™åˆ¶>3.4 é€Ÿç‡é™åˆ¶<a hidden class=anchor aria-hidden=true href=#34-é€Ÿç‡é™åˆ¶>#</a></h3><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">65
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// APIé€Ÿç‡é™åˆ¶
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>import</span> rateLimit <span style=color:#ff7b72>from</span> <span style=color:#a5d6ff>&#39;express-rate-limit&#39;</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>import</span> RedisStore <span style=color:#ff7b72>from</span> <span style=color:#a5d6ff>&#39;rate-limit-redis&#39;</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>import</span> Redis <span style=color:#ff7b72>from</span> <span style=color:#a5d6ff>&#39;ioredis&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// ä¸åŒåœºæ™¯çš„é€Ÿç‡é™åˆ¶
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// 1. é€šç”¨APIé™åˆ¶
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>const</span> generalLimiter <span style=color:#ff7b72;font-weight:700>=</span> rateLimit({
</span></span><span style=display:flex><span>  store: <span style=color:#ff7b72>new</span> RedisStore({
</span></span><span style=display:flex><span>    client: <span style=color:#ff7b72>new</span> Redis(process.env.REDIS_URL)
</span></span><span style=display:flex><span>  }),
</span></span><span style=display:flex><span>  windowMs: <span style=color:#ff7b72>15</span> <span style=color:#ff7b72;font-weight:700>*</span> <span style=color:#a5d6ff>60</span> <span style=color:#ff7b72;font-weight:700>*</span> <span style=color:#a5d6ff>1000</span>,  <span style=color:#8b949e;font-style:italic>// 15åˆ†é’Ÿ
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>  max: <span style=color:#ff7b72>100</span>,  <span style=color:#8b949e;font-style:italic>// é™åˆ¶100æ¬¡è¯·æ±‚
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>  standardHeaders: <span style=color:#ff7b72>true</span>,
</span></span><span style=display:flex><span>  legacyHeaders: <span style=color:#ff7b72>false</span>,
</span></span><span style=display:flex><span>  message<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>&#39;Too many requests from this IP, please try again later.&#39;</span>,
</span></span><span style=display:flex><span>  handler<span style=color:#ff7b72;font-weight:700>:</span> (req, res) <span style=color:#ff7b72;font-weight:700>=&gt;</span> {
</span></span><span style=display:flex><span>    res.status(<span style=color:#a5d6ff>429</span>).json({
</span></span><span style=display:flex><span>      error<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>&#39;Too many requests&#39;</span>,
</span></span><span style=display:flex><span>      message<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>&#39;Rate limit exceeded, please try again later.&#39;</span>,
</span></span><span style=display:flex><span>      retryAfter: <span style=color:#ff7b72>900</span>  <span style=color:#8b949e;font-style:italic>// ç§’
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    })
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>})
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// 2. ç™»å½•é™æµï¼ˆæ›´ä¸¥æ ¼ï¼‰
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>const</span> loginLimiter <span style=color:#ff7b72;font-weight:700>=</span> rateLimit({
</span></span><span style=display:flex><span>  windowMs: <span style=color:#ff7b72>15</span> <span style=color:#ff7b72;font-weight:700>*</span> <span style=color:#a5d6ff>60</span> <span style=color:#ff7b72;font-weight:700>*</span> <span style=color:#a5d6ff>1000</span>,
</span></span><span style=display:flex><span>  max: <span style=color:#ff7b72>5</span>,  <span style=color:#8b949e;font-style:italic>// 15åˆ†é’Ÿå†…æœ€å¤š5æ¬¡ç™»å½•å°è¯•
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>  skipSuccessfulRequests: <span style=color:#ff7b72>true</span>,  <span style=color:#8b949e;font-style:italic>// æˆåŠŸçš„è¯·æ±‚ä¸è®¡å…¥é™åˆ¶
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>  message<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>&#39;Too many login attempts, please try again later.&#39;</span>
</span></span><span style=display:flex><span>})
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// 3. APIå¯†é’¥é™æµ
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>const</span> apiKeyLimiter <span style=color:#ff7b72;font-weight:700>=</span> rateLimit({
</span></span><span style=display:flex><span>  store: <span style=color:#ff7b72>new</span> RedisStore({
</span></span><span style=display:flex><span>    client: <span style=color:#ff7b72>new</span> Redis(process.env.REDIS_URL),
</span></span><span style=display:flex><span>    prefix<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>&#39;limiter:apikey:&#39;</span>
</span></span><span style=display:flex><span>  }),
</span></span><span style=display:flex><span>  windowMs: <span style=color:#ff7b72>60</span> <span style=color:#ff7b72;font-weight:700>*</span> <span style=color:#a5d6ff>1000</span>,  <span style=color:#8b949e;font-style:italic>// 1åˆ†é’Ÿ
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>  max: <span style=color:#ff7b72>60</span>,  <span style=color:#8b949e;font-style:italic>// æ¯åˆ†é’Ÿ60æ¬¡
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>  keyGenerator<span style=color:#ff7b72;font-weight:700>:</span> (req) <span style=color:#ff7b72;font-weight:700>=&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> req.headers[<span style=color:#a5d6ff>&#39;x-api-key&#39;</span>] <span style=color:#ff7b72>as</span> <span style=color:#ff7b72>string</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>})
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// åº”ç”¨é™æµ
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>app.use(<span style=color:#a5d6ff>&#39;/api/&#39;</span>, generalLimiter)
</span></span><span style=display:flex><span>app.post(<span style=color:#a5d6ff>&#39;/api/auth/login&#39;</span>, loginLimiter)
</span></span><span style=display:flex><span>app.use(<span style=color:#a5d6ff>&#39;/api/v2/&#39;</span>, apiKeyLimiter)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// åŸºäºç”¨æˆ·çš„é™æµ
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>async</span> <span style=color:#ff7b72>function</span> getUserRateLimit(userId: <span style=color:#ff7b72>string</span>) {
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>const</span> user <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>await</span> db.users.findById(userId)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#8b949e;font-style:italic>// ä¸åŒç”¨æˆ·ç­‰çº§æœ‰ä¸åŒé™åˆ¶
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>  <span style=color:#ff7b72>const</span> limits <span style=color:#ff7b72;font-weight:700>=</span> {
</span></span><span style=display:flex><span>    free<span style=color:#ff7b72;font-weight:700>:</span> { windowMs: <span style=color:#ff7b72>60</span> <span style=color:#ff7b72;font-weight:700>*</span> <span style=color:#a5d6ff>1000</span>, max: <span style=color:#ff7b72>10</span> },
</span></span><span style=display:flex><span>    pro<span style=color:#ff7b72;font-weight:700>:</span> { windowMs: <span style=color:#ff7b72>60</span> <span style=color:#ff7b72;font-weight:700>*</span> <span style=color:#a5d6ff>1000</span>, max: <span style=color:#ff7b72>100</span> },
</span></span><span style=display:flex><span>    enterprise<span style=color:#ff7b72;font-weight:700>:</span> { windowMs: <span style=color:#ff7b72>60</span> <span style=color:#ff7b72;font-weight:700>*</span> <span style=color:#a5d6ff>1000</span>, max: <span style=color:#ff7b72>1000</span> }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>return</span> limits[user.plan] <span style=color:#ff7b72;font-weight:700>||</span> limits.free
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h2 id=å››å®‰å…¨æœ€ä½³å®è·µ>å››ã€å®‰å…¨æœ€ä½³å®è·µ<a hidden class=anchor aria-hidden=true href=#å››å®‰å…¨æœ€ä½³å®è·µ>#</a></h2><h3 id=41-å®‰å…¨é…ç½®>4.1 å®‰å…¨é…ç½®<a hidden class=anchor aria-hidden=true href=#41-å®‰å…¨é…ç½®>#</a></h3><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">24
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// helmetå®‰å…¨å¤´é…ç½®
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>import</span> helmet <span style=color:#ff7b72>from</span> <span style=color:#a5d6ff>&#39;helmet&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>app.use(helmet({
</span></span><span style=display:flex><span>  contentSecurityPolicy<span style=color:#ff7b72;font-weight:700>:</span> {
</span></span><span style=display:flex><span>    directives<span style=color:#ff7b72;font-weight:700>:</span> {
</span></span><span style=display:flex><span>      defaultSrc<span style=color:#ff7b72;font-weight:700>:</span> [<span style=color:#a5d6ff>&#34;&#39;self&#39;&#34;</span>],
</span></span><span style=display:flex><span>      styleSrc<span style=color:#ff7b72;font-weight:700>:</span> [<span style=color:#a5d6ff>&#34;&#39;self&#39;&#34;</span>, <span style=color:#a5d6ff>&#34;&#39;unsafe-inline&#39;&#34;</span>],
</span></span><span style=display:flex><span>      scriptSrc<span style=color:#ff7b72;font-weight:700>:</span> [<span style=color:#a5d6ff>&#34;&#39;self&#39;&#34;</span>],
</span></span><span style=display:flex><span>      imgSrc<span style=color:#ff7b72;font-weight:700>:</span> [<span style=color:#a5d6ff>&#34;&#39;self&#39;&#34;</span>, <span style=color:#a5d6ff>&#34;data:&#34;</span>, <span style=color:#a5d6ff>&#34;https:&#34;</span>],
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>  hsts<span style=color:#ff7b72;font-weight:700>:</span> {
</span></span><span style=display:flex><span>    maxAge: <span style=color:#ff7b72>31536000</span>,
</span></span><span style=display:flex><span>    includeSubDomains: <span style=color:#ff7b72>true</span>,
</span></span><span style=display:flex><span>    preload: <span style=color:#ff7b72>true</span>
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>  noSniff: <span style=color:#ff7b72>true</span>,
</span></span><span style=display:flex><span>  xssFilter: <span style=color:#ff7b72>true</span>,
</span></span><span style=display:flex><span>  frameguard<span style=color:#ff7b72;font-weight:700>:</span> { action<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>&#39;deny&#39;</span> }
</span></span><span style=display:flex><span>}))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// ç¦ç”¨ä¸å¿…è¦çš„å¤´
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>app.disable(<span style=color:#a5d6ff>&#39;x-powered-by&#39;</span>)
</span></span></code></pre></td></tr></table></div></div><h3 id=42-å®‰å…¨æ—¥å¿—>4.2 å®‰å…¨æ—¥å¿—<a hidden class=anchor aria-hidden=true href=#42-å®‰å…¨æ—¥å¿—>#</a></h3><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">65
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// å®‰å…¨å®¡è®¡æ—¥å¿—
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>class</span> SecurityAuditLogger {
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>private</span> auditLog: <span style=color:#ff7b72>any</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>constructor</span>(auditLog: <span style=color:#ff7b72>any</span>) {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>this</span>.auditLog <span style=color:#ff7b72;font-weight:700>=</span> auditLog
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  logAuthenticationAttempt(userId: <span style=color:#ff7b72>string</span>, success: <span style=color:#ff7b72>boolean</span>, ip: <span style=color:#ff7b72>string</span>) {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>this</span>.auditLog.create({
</span></span><span style=display:flex><span>      eventType<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>&#39;AUTH_ATTEMPT&#39;</span>,
</span></span><span style=display:flex><span>      userId,
</span></span><span style=display:flex><span>      success,
</span></span><span style=display:flex><span>      ip,
</span></span><span style=display:flex><span>      timestamp: <span style=color:#ff7b72>new</span> Date(),
</span></span><span style=display:flex><span>      userAgent: <span style=color:#ff7b72>undefined</span>
</span></span><span style=display:flex><span>    })
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  logAuthorizationAttempt(userId: <span style=color:#ff7b72>string</span>, resource: <span style=color:#ff7b72>string</span>, action: <span style=color:#ff7b72>string</span>, success: <span style=color:#ff7b72>boolean</span>) {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>this</span>.auditLog.create({
</span></span><span style=display:flex><span>      eventType<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>&#39;AUTHZ_ATTEMPT&#39;</span>,
</span></span><span style=display:flex><span>      userId,
</span></span><span style=display:flex><span>      resource,
</span></span><span style=display:flex><span>      action,
</span></span><span style=display:flex><span>      success,
</span></span><span style=display:flex><span>      timestamp: <span style=color:#ff7b72>new</span> Date()
</span></span><span style=display:flex><span>    })
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  logDataAccess(userId: <span style=color:#ff7b72>string</span>, resourceType: <span style=color:#ff7b72>string</span>, resourceId: <span style=color:#ff7b72>string</span>) {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>this</span>.auditLog.create({
</span></span><span style=display:flex><span>      eventType<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>&#39;DATA_ACCESS&#39;</span>,
</span></span><span style=display:flex><span>      userId,
</span></span><span style=display:flex><span>      resourceType,
</span></span><span style=display:flex><span>      resourceId,
</span></span><span style=display:flex><span>      timestamp: <span style=color:#ff7b72>new</span> Date()
</span></span><span style=display:flex><span>    })
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  logSecurityEvent(eventType: <span style=color:#ff7b72>string</span>, details: <span style=color:#ff7b72>any</span>) {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>this</span>.auditLog.create({
</span></span><span style=display:flex><span>      eventType,
</span></span><span style=display:flex><span>      details,
</span></span><span style=display:flex><span>      timestamp: <span style=color:#ff7b72>new</span> Date()
</span></span><span style=display:flex><span>    })
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// ä½¿ç”¨ç¤ºä¾‹
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>const</span> securityLogger <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>new</span> SecurityAuditLogger(auditLog)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>app.post(<span style=color:#a5d6ff>&#39;/api/auth/login&#39;</span>, <span style=color:#ff7b72>async</span> (req, res) <span style=color:#ff7b72;font-weight:700>=&gt;</span> {
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>const</span> { email, password } <span style=color:#ff7b72;font-weight:700>=</span> req.body
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>const</span> ip <span style=color:#ff7b72;font-weight:700>=</span> req.ip
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>try</span> {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>const</span> result <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>await</span> authService.login(email, password)
</span></span><span style=display:flex><span>    securityLogger.logAuthenticationAttempt(result.user.id, <span style=color:#79c0ff>true</span>, ip)
</span></span><span style=display:flex><span>    res.json(result)
</span></span><span style=display:flex><span>  } <span style=color:#ff7b72>catch</span> (error) {
</span></span><span style=display:flex><span>    securityLogger.logAuthenticationAttempt(email, <span style=color:#79c0ff>false</span>, ip)
</span></span><span style=display:flex><span>    res.status(<span style=color:#a5d6ff>401</span>).json({ error<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>&#39;Invalid credentials&#39;</span> })
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>})
</span></span></code></pre></td></tr></table></div></div><h3 id=43-è¾“å…¥éªŒè¯>4.3 è¾“å…¥éªŒè¯<a hidden class=anchor aria-hidden=true href=#43-è¾“å…¥éªŒè¯>#</a></h3><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">58
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// ä½¿ç”¨Joiè¿›è¡Œè¾“å…¥éªŒè¯
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>import</span> Joi <span style=color:#ff7b72>from</span> <span style=color:#a5d6ff>&#39;joi&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// éªŒè¯schemas
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>const</span> schemas <span style=color:#ff7b72;font-weight:700>=</span> {
</span></span><span style=display:flex><span>  register: <span style=color:#ff7b72>Joi.object</span>({
</span></span><span style=display:flex><span>    name: <span style=color:#ff7b72>Joi.string</span>().min(<span style=color:#a5d6ff>2</span>).max(<span style=color:#a5d6ff>50</span>).required(),
</span></span><span style=display:flex><span>    email: <span style=color:#ff7b72>Joi.string</span>().email().required(),
</span></span><span style=display:flex><span>    password: <span style=color:#ff7b72>Joi.string</span>()
</span></span><span style=display:flex><span>      .min(<span style=color:#a5d6ff>8</span>)
</span></span><span style=display:flex><span>      .pattern(<span style=color:#79c0ff>/^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&amp;])[A-Za-z\d@$!%*?&amp;]/</span>)
</span></span><span style=display:flex><span>      .required()
</span></span><span style=display:flex><span>      .messages({
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#39;string.pattern.base&#39;</span><span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>&#39;Password must contain uppercase, lowercase, number, and special character&#39;</span>
</span></span><span style=display:flex><span>      }),
</span></span><span style=display:flex><span>    confirmPassword: <span style=color:#ff7b72>Joi.string</span>().valid(Joi.ref(<span style=color:#a5d6ff>&#39;password&#39;</span>)).required(),
</span></span><span style=display:flex><span>    age: <span style=color:#ff7b72>Joi.number</span>().integer().min(<span style=color:#a5d6ff>13</span>).max(<span style=color:#a5d6ff>120</span>)
</span></span><span style=display:flex><span>  }),
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  createPost: <span style=color:#ff7b72>Joi.object</span>({
</span></span><span style=display:flex><span>    title: <span style=color:#ff7b72>Joi.string</span>().min(<span style=color:#a5d6ff>5</span>).max(<span style=color:#a5d6ff>200</span>).required(),
</span></span><span style=display:flex><span>    content: <span style=color:#ff7b72>Joi.string</span>().min(<span style=color:#a5d6ff>10</span>).max(<span style=color:#a5d6ff>10000</span>).required(),
</span></span><span style=display:flex><span>    tags: <span style=color:#ff7b72>Joi.array</span>().items(Joi.<span style=color:#ff7b72>string</span>().max(<span style=color:#a5d6ff>30</span>)).max(<span style=color:#a5d6ff>10</span>),
</span></span><span style=display:flex><span>    published: <span style=color:#ff7b72>Joi.boolean</span>().<span style=color:#ff7b72>default</span>(<span style=color:#79c0ff>false</span>)
</span></span><span style=display:flex><span>  }),
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  updateProfile: <span style=color:#ff7b72>Joi.object</span>({
</span></span><span style=display:flex><span>    name: <span style=color:#ff7b72>Joi.string</span>().min(<span style=color:#a5d6ff>2</span>).max(<span style=color:#a5d6ff>50</span>),
</span></span><span style=display:flex><span>    bio: <span style=color:#ff7b72>Joi.string</span>().max(<span style=color:#a5d6ff>500</span>),
</span></span><span style=display:flex><span>    website: <span style=color:#ff7b72>Joi.string</span>().uri(),
</span></span><span style=display:flex><span>    avatar: <span style=color:#ff7b72>Joi.string</span>().uri()
</span></span><span style=display:flex><span>  })
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// éªŒè¯ä¸­é—´ä»¶
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>function</span> validate(schemaName: <span style=color:#ff7b72>keyof</span> <span style=color:#ff7b72>typeof</span> schemas) {
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>return</span> (req: <span style=color:#ff7b72>Request</span>, res: <span style=color:#ff7b72>Response</span>, next: <span style=color:#ff7b72>NextFunction</span>) <span style=color:#ff7b72;font-weight:700>=&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>const</span> { error, value } <span style=color:#ff7b72;font-weight:700>=</span> schemas[schemaName].validate(req.body, {
</span></span><span style=display:flex><span>      abortEarly: <span style=color:#ff7b72>false</span>,
</span></span><span style=display:flex><span>      stripUnknown: <span style=color:#ff7b72>true</span>
</span></span><span style=display:flex><span>    })
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>if</span> (error) {
</span></span><span style=display:flex><span>      <span style=color:#ff7b72>const</span> errors <span style=color:#ff7b72;font-weight:700>=</span> error.details.map(detail <span style=color:#ff7b72;font-weight:700>=&gt;</span> ({
</span></span><span style=display:flex><span>        field: <span style=color:#ff7b72>detail.path.join</span>(<span style=color:#a5d6ff>&#39;.&#39;</span>),
</span></span><span style=display:flex><span>        message: <span style=color:#ff7b72>detail.message</span>
</span></span><span style=display:flex><span>      }))
</span></span><span style=display:flex><span>      <span style=color:#ff7b72>return</span> res.status(<span style=color:#a5d6ff>400</span>).json({ errors })
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    req.body <span style=color:#ff7b72;font-weight:700>=</span> value
</span></span><span style=display:flex><span>    next()
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// ä½¿ç”¨
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>app.post(<span style=color:#a5d6ff>&#39;/api/auth/register&#39;</span>, validate(<span style=color:#a5d6ff>&#39;register&#39;</span>), authController.register)
</span></span><span style=display:flex><span>app.post(<span style=color:#a5d6ff>&#39;/api/posts&#39;</span>, authenticate, validate(<span style=color:#a5d6ff>&#39;createPost&#39;</span>), postController.create)
</span></span></code></pre></td></tr></table></div></div><h2 id=æ€»ç»“>æ€»ç»“<a hidden class=anchor aria-hidden=true href=#æ€»ç»“>#</a></h2><p>APIå®‰å…¨æ˜¯ä¸€ä¸ªå¤šå±‚æ¬¡çš„ä¸»é¢˜ï¼š</p><ol><li><strong>èº«ä»½è®¤è¯</strong> - JWTã€OAuth 2.0å®ç°å®‰å…¨è®¤è¯</li><li><strong>æ•°æ®åŠ å¯†</strong> - æ•æ„Ÿæ•°æ®åŠ å¯†å­˜å‚¨å’Œä¼ è¾“</li><li><strong>è¾“å…¥éªŒè¯</strong> - é˜²æ­¢æ³¨å…¥æ”»å‡»å’Œæ•°æ®ç¯¡æ”¹</li><li><strong>é˜²æŠ¤ç­–ç•¥</strong> - CORSã€é€Ÿç‡é™åˆ¶ã€CSPç­‰</li><li><strong>å®‰å…¨å®¡è®¡</strong> - è®°å½•å’Œåˆ†æå®‰å…¨äº‹ä»¶</li><li><strong>æœ€ä½³å®è·µ</strong> - éµå¾ªOWASPå®‰å…¨æ ‡å‡†</li></ol><p>APIå®‰å…¨éœ€è¦æŒç»­å…³æ³¨å’Œæ”¹è¿›ï¼Œéšç€å¨èƒç¯å¢ƒçš„å˜åŒ–ä¸æ–­è°ƒæ•´é˜²æŠ¤ç­–ç•¥ã€‚</p><blockquote><p><strong>ç›¸å…³å·¥å…·æ¨è</strong></p><ul><li><a href=https://www.util.cn/tools/jwt-decoder/>JWTè§£æå·¥å…·</a> - JWTè°ƒè¯•å’ŒéªŒè¯</li><li><a href=https://www.util.cn/tools/json-formatter/>JSONæ ¼å¼åŒ–å·¥å…·</a> - JSONæ•°æ®å¤„ç†</li><li><a href=https://www.util.cn/tools/base64-encode/>Base64ç¼–ç å·¥å…·</a> - ç¼–ç è½¬æ¢</li></ul></blockquote></div><footer class=post-footer-modern><div class=post-tags-modern><span class=tags-label>ğŸ·ï¸ æ ‡ç­¾</span><div class=tags-list><a href=/blog/tags/api%E5%AE%89%E5%85%A8/ class=tag-pill>APIå®‰å…¨
</a><a href=/blog/tags/jwt%E8%AE%A4%E8%AF%81/ class=tag-pill>JWTè®¤è¯
</a><a href=/blog/tags/oauth2/ class=tag-pill>OAuth2
</a><a href=/blog/tags/%E6%95%B0%E6%8D%AE%E5%8A%A0%E5%AF%86/ class=tag-pill>æ•°æ®åŠ å¯†
</a><a href=/blog/tags/owasp/ class=tag-pill>OWASP</a></div></div><style>.post-footer-modern{margin-top:3rem;padding-top:2rem;border-top:1px solid var(--border,#333333)}.post-tags-modern{display:flex;align-items:center;gap:1rem;margin-bottom:2rem;flex-wrap:wrap}.tags-label{font-size:.875rem;font-weight:600;color:var(--secondary,#999999) !important;white-space:nowrap}.tags-list{display:flex;flex-wrap:wrap;gap:.5rem;flex:1}.tag-pill{display:inline-block;padding:.25rem .75rem;background:rgba(255,255,255,5%);border:1px solid var(--border,#333333);border-radius:0;color:var(--secondary,#cccccc) !important;text-decoration:none;font-size:.8rem;font-weight:500;transition:all .2s ease}.tag-pill:hover{background:var(--primary,#ffffff);color:var(--background,#000000) !important;border-color:var(--primary,#ffffff);transform:translateY(-1px)}.post-nav-modern{margin-top:2rem}.nav-grid{display:grid;grid-template-columns:1fr 1fr;gap:1rem}.nav-card{display:flex;align-items:center;gap:1rem;padding:1.25rem;background:rgba(255,255,255,2%);border:1px solid var(--border,#333333);border-radius:12px;text-decoration:none;transition:all .2s ease;min-height:80px}.nav-card:hover{background:rgba(255,255,255,5%);border-color:var(--primary,#ffffff);transform:translateY(-2px)}.nav-card.nav-prev{justify-content:flex-start}.nav-card.nav-next{justify-content:flex-end;text-align:right}.nav-card.nav-next .nav-content{text-align:right}.nav-empty{display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,1%);border:1px dashed var(--border,#333333);color:var(--secondary,#666666)}.nav-arrow{font-size:1.5rem;color:var(--primary,#ffffff);font-weight:300}.nav-content{flex:1}.nav-title{font-size:.95rem;font-weight:600;color:var(--primary,#ffffff) !important;line-height:1.4;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}[data-theme=light] .post-footer-modern{border-color:var(--border-light,#dee2e6)}[data-theme=light] .tags-label{color:var(--secondary-light,#6c757d) !important}[data-theme=light] .tag-pill{background:rgba(0,0,0,5%);border-color:var(--border-light,#dee2e6);color:var(--secondary-light,#495057) !important}[data-theme=light] .tag-pill:hover{background:var(--primary-light,#0066cc);color:var(--background-light,#ffffff) !important;border-color:var(--primary-light,#0066cc)}[data-theme=light] .nav-card{background:rgba(0,0,0,2%);border-color:var(--border-light,#dee2e6)}[data-theme=light] .nav-card:hover{background:rgba(0,102,204,5%);border-color:var(--primary-light,#0066cc)}[data-theme=light] .nav-empty{background:rgba(0,0,0,1%);border-color:var(--border-light,#dee2e6);color:var(--secondary-light,#6c757d)}[data-theme=light] .nav-arrow{color:var(--primary-light,#0066cc)}[data-theme=light] .nav-title{color:var(--primary-light,#212529) !important}@media(max-width:768px){.nav-grid{grid-template-columns:1fr;gap:.75rem}.nav-card{padding:1rem;min-height:70px}.nav-card.nav-next{text-align:left}.nav-card.nav-next .nav-content{text-align:left}.nav-title{font-size:.875rem}.post-tags-modern{flex-direction:column;gap:.75rem}}@media(max-width:480px){.nav-arrow{font-size:1.25rem}.nav-card{padding:.875rem}.nav-title{font-size:.8rem;-webkit-line-clamp:1}}</style><nav class=post-nav-modern><div class=nav-grid><a href=/blog/articles/docker%E4%B8%8Ekubernetes%E5%AE%B9%E5%99%A8%E5%8C%96%E9%83%A8%E7%BD%B2%E4%BB%8E%E9%9B%B6%E6%90%AD%E5%BB%BA%E7%94%9F%E4%BA%A7%E7%BA%A7%E5%AE%B9%E5%99%A8%E5%8C%96%E7%B3%BB%E7%BB%9F/ class="nav-card nav-prev"><div class=nav-arrow>â†</div><div class=nav-content><div class=nav-title>Dockerä¸Kuberneteså®¹å™¨åŒ–éƒ¨ç½²ï¼šä»é›¶æ­å»ºç”Ÿäº§çº§å®¹å™¨åŒ–ç³»ç»Ÿ</div></div></a><a href=/blog/articles/%E7%8E%B0%E4%BB%A3%E5%89%8D%E7%AB%AF%E5%B7%A5%E7%A8%8B%E5%8C%96%E4%BD%93%E7%B3%BB%E6%90%AD%E5%BB%BA%E4%BB%8E%E9%9B%B6%E6%9E%84%E5%BB%BA%E4%BC%81%E4%B8%9A%E7%BA%A7%E5%89%8D%E7%AB%AF%E9%A1%B9%E7%9B%AE%E6%9E%B6%E6%9E%84/ class="nav-card nav-next"><div class=nav-content><div class=nav-title>ç°ä»£å‰ç«¯å·¥ç¨‹åŒ–ä½“ç³»æ­å»ºï¼šä»é›¶æ„å»ºä¼ä¸šçº§å‰ç«¯é¡¹ç›®æ¶æ„</div></div><div class=nav-arrow>â†’</div></a></div></nav></footer></main><aside class=post-sidebar><div class=sidebar-toc id=sidebar-toc><div class=toc-header><div class=toc-title>ç›®å½•</div><button class=toc-toggle id=toc-toggle aria-label="Toggle TOC">
<svg class="toc-toggle-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6 6 18M6 6l12 12"/></svg></button></div><div class=toc-content id=toc-content><ul class=toc-list><li class="toc-item toc-h2"><a href=#h2-0 class=toc-item-link><span class=toc-item-text>å¼•è¨€</span></a></li><li class="toc-item toc-h2"><a href=#h2-1 class=toc-item-link><span class=toc-item-text>ä¸€ã€èº«ä»½è®¤è¯æœºåˆ¶</span></a></li><li class="toc-item toc-h2"><a href=#h2-2 class=toc-item-link><span class=toc-item-text>äºŒã€æ•°æ®å®‰å…¨</span></a></li><li class="toc-item toc-h2"><a href=#h2-3 class=toc-item-link><span class=toc-item-text>ä¸‰ã€é˜²æŠ¤ç­–ç•¥</span></a></li><li class="toc-item toc-h2"><a href=#h2-4 class=toc-item-link><span class=toc-item-text>å››ã€å®‰å…¨æœ€ä½³å®è·µ</span></a></li><li class="toc-item toc-h2"><a href=#h2-5 class=toc-item-link><span class=toc-item-text>æ€»ç»“</span></a></li></ul></div></div><script>document.addEventListener("DOMContentLoaded",function(){const e=document.getElementById("sidebar-toc"),t=document.getElementById("toc-toggle"),o=document.getElementById("toc-content"),i=t?.querySelector(".toc-toggle-icon");if(!e)return;let n=!1;t&&t.addEventListener("click",function(){n=!n,n?(o.style.display="none",e.style.width="auto",i.innerHTML='<path d="M9 18l6-6-6-6"/>'):(o.style.display="block",e.style.width="200px",i.innerHTML='<path d="M18 6L6 18M6 6l12 12"/>')});const s=document.querySelector(".post-content");if(s){const e=s.querySelectorAll("h1");e.forEach((e,t)=>{e.id=`h1-${t}`});const t=s.querySelectorAll("h2");t.forEach((e,t)=>{e.id=`h2-${t}`})}const a=document.querySelectorAll(".toc-item-link");a.forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();const n=this.getAttribute("href").substring(1),t=document.getElementById(n);if(t){const e=document.querySelector(".post-header-main")?.offsetHeight||0,n=t.offsetTop-e-20;window.scrollTo({top:n,behavior:"smooth"})}})})})</script><style>.sidebar-toc{position:sticky;top:2rem;width:200px;background:#fff;border:1px solid #e5e7eb;border-radius:4px;overflow:hidden;box-shadow:0 1px 3px rgba(0,0,0,.1);z-index:100}.sidebar-toc.hidden{display:none}.toc-header{padding:12px 16px;border-bottom:1px solid #e5e7eb;background:#fafbfc;display:flex;align-items:center;justify-content:space-between}.toc-title{margin:0;font-size:13px;font-weight:500;color:#374151 !important;font-family:-apple-system,BlinkMacSystemFont,segoe ui,Roboto,sans-serif;text-transform:uppercase;letter-spacing:1px}.toc-toggle{background:0 0;border:none;cursor:pointer;padding:4px;border-radius:4px;display:flex;align-items:center;justify-content:center;transition:all .2s ease;color:#6b7280}.toc-toggle:hover{background:#e5e7eb;color:#374151}.toc-toggle-icon{transition:transform .2s ease}.toc-content{padding:12px 0}.toc-list{list-style:none;margin:0;padding:0}.toc-item{margin-bottom:4px;display:block !important;visibility:visible !important}.toc-h1,.toc-h2{display:block !important}.toc-h2{margin-left:0}.toc-item-link{display:flex;align-items:center;gap:8px;padding:8px 12px;color:#374151 !important;text-decoration:none;font-size:13px;line-height:1.4;border-radius:3px;transition:all .2s ease;font-weight:400}.toc-item-link:hover{background:#f8fafc;color:#1f2937 !important}.toc-item-link.active{background:#e0f2fe;color:#01579b !important;font-weight:500}.toc-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}.dot-red{background:#ef4444}.dot-blue{background:#2196f3}.toc-item-text{color:#1f2937 !important;font-weight:400;flex:1;display:inline !important;visibility:visible !important;opacity:1 !important;font-size:13px !important;line-height:1.4 !important}.toc-item-link .toc-item-text{color:#1f2937 !important;display:inline !important;visibility:visible !important;opacity:1 !important}.toc-item.active .dot-red{background:#d32f2f}.toc-item.active .dot-blue{background:#1976d2}[data-theme=dark] .sidebar-toc{background:#1f2937;border-color:#374151;box-shadow:0 1px 3px rgba(0,0,0,.3)}[data-theme=dark] .toc-header{background:#111827;border-color:#374151}[data-theme=dark] .toc-title{color:#f3f4f6 !important}[data-theme=dark] .toc-toggle{color:#9ca3af}[data-theme=dark] .toc-toggle:hover{background:#374151;color:#f3f4f6}[data-theme=dark] .toc-item-link{color:#e5e7eb !important}[data-theme=dark] .toc-item-link:hover{background:#374151;color:#f9fafb !important}[data-theme=dark] .toc-item-link.active{background:#0d47a1;color:#fff !important}[data-theme=dark] .toc-item-text{color:#f9fafb !important;display:inline !important;visibility:visible !important;opacity:1 !important}[data-theme=dark] .toc-item-link .toc-item-text{color:#f9fafb !important;display:inline !important;visibility:visible !important;opacity:1 !important}@media(max-width:1024px){.sidebar-toc{display:none}.post-content-wrapper{grid-template-columns:1fr !important;padding:0 1rem !important}}</style><style>.post-content-wrapper{display:grid;grid-template-columns:1fr 200px;gap:2rem;padding:0 2rem;max-width:100%}.post-content-main{min-width:0}.post-sidebar{position:sticky;top:2rem;height:fit-content;min-width:0}.post-header-main{margin-bottom:2rem;padding-bottom:1rem;border-bottom:1px solid var(--border,#333333)}.post-header-main .post-title{color:var(--primary,#ffffff) !important;font-size:2.5rem;font-weight:700;line-height:1.2;margin-bottom:1rem}.post-header-main .post-description{color:var(--secondary,#cccccc) !important;font-size:1.1rem;line-height:1.6;margin-bottom:1rem}.post-header-main .post-meta{margin-bottom:0}@media(max-width:1024px){.post-content-wrapper{grid-template-columns:1fr !important;gap:1rem;padding:0 1rem !important}.post-sidebar{display:none}}@media(max-width:768px){.post-header-main .post-title{font-size:2rem}.post-header-main .post-description{font-size:1rem}}</style></aside></div></article></main><footer class=footer><span>Â© 2024-2025 æœ‰æ¡å·¥å…·æŠ€æœ¯åšå®¢</span> Â·</footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");if(menu){const e=localStorage.getItem("menu-scroll-position");e&&(menu.scrollLeft=parseInt(e,10)),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}}document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{const e=document.querySelector("html");e.dataset.theme==="dark"?(e.dataset.theme="light",localStorage.setItem("pref-theme","light")):(e.dataset.theme="dark",localStorage.setItem("pref-theme","dark"))})</script></body></html>