<!doctype html><html lang=zh-cn dir=auto data-theme=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>åˆ†å¸ƒå¼ç³»ç»Ÿä¸€è‡´æ€§ç®—æ³•æ·±åº¦è§£æï¼šä»Paxosåˆ°Raft | æŠ€æœ¯åšå®¢ - æœ‰æ¡å·¥å…·</title><meta name=keywords content="åˆ†å¸ƒå¼ç³»ç»Ÿ,ä¸€è‡´æ€§ç®—æ³•,Paxos,Raft,å…±è¯†"><meta name=description content="æ·±å…¥æ¢è®¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„æ ¸å¿ƒä¸€è‡´æ€§ç®—æ³•ï¼ŒåŒ…æ‹¬Paxosã€Raftã€EPaxOSç­‰ï¼Œç†è§£å…¶å·¥ä½œåŸç†ã€åº”ç”¨åœºæ™¯å’Œå®ç°ç»†èŠ‚ã€‚"><meta name=author content="æœ‰æ¡å·¥å…·å›¢é˜Ÿ"><link rel=canonical href=/blog/articles/%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F%E4%B8%80%E8%87%B4%E6%80%A7%E7%AE%97%E6%B3%95%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90%E4%BB%8Epaxos%E5%88%B0raft/><link crossorigin=anonymous href=/blog/assets/css/stylesheet.7e8505b7cdf8bb22ab2305e53c2700bb06c7e64faeb72cd3468823a9a3bd3d6e.css integrity="sha256-foUFt834uyKrIwXlPCcAuwbH5k+utyzTRogjqaO9PW4=" rel="preload stylesheet" as=style><link rel=icon href=/favicon.ico><link rel=icon type=image/png sizes=16x16 href=/blog/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=/blog/favicon-32x32.png><link rel=apple-touch-icon href=/blog/apple-touch-icon.png><link rel=mask-icon href=/blog/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate type=application/rss+xml href=/blog/articles/%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F%E4%B8%80%E8%87%B4%E6%80%A7%E7%AE%97%E6%B3%95%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90%E4%BB%8Epaxos%E5%88%B0raft/feed.xml title=rss><link rel=alternate hreflang=zh-cn href=/blog/articles/%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F%E4%B8%80%E8%87%B4%E6%80%A7%E7%AE%97%E6%B3%95%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90%E4%BB%8Epaxos%E5%88%B0raft/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51);color-scheme:dark}.list{background:var(--theme)}.toc{background:var(--entry)}}@media(prefers-color-scheme:light){.list::-webkit-scrollbar-thumb{border-color:var(--code-bg)}}</style></noscript><script>localStorage.getItem("pref-theme")==="dark"?document.querySelector("html").dataset.theme="dark":localStorage.getItem("pref-theme")==="light"?document.querySelector("html").dataset.theme="light":window.matchMedia("(prefers-color-scheme: dark)").matches?document.querySelector("html").dataset.theme="dark":document.querySelector("html").dataset.theme="light"</script><script src=/js/external-link-config.js></script><script src=/js/external-link-interceptor.js></script><link rel=stylesheet href=/blog/css/custom.css media=screen><script type=application/ld+json>{"@context":"https://schema.org","@type":"WebSite","name":"æŠ€æœ¯åšå®¢ - æœ‰æ¡å·¥å…· | å¼€å‘è€…å·¥å…·ä½¿ç”¨æ•™ç¨‹ & ç¼–ç¨‹æŠ€å·§åˆ†äº«","url":"https://www.util.cn/blog/","description":"æœ‰æ¡å·¥å…·æŠ€æœ¯åšå®¢ - åˆ†äº«å¼€å‘è€…å·¥å…·ä½¿ç”¨æ•™ç¨‹ã€ç¼–ç¨‹æŠ€å·§å’Œå®æˆ˜å¼€å‘ç»éªŒã€‚æä¾›JSONæ ¼å¼åŒ–ã€SQLä¼˜åŒ–ã€Markdownç¼–è¾‘å™¨ç­‰åœ¨çº¿å·¥å…·çš„è¯¦ç»†ä½¿ç”¨æŒ‡å—ï¼Œå¸®åŠ©å¼€å‘è€…æå‡å·¥ä½œæ•ˆç‡ã€‚","publisher":{"@type":"Organization","name":"æœ‰æ¡å·¥å…·","url":"https://www.util.cn","logo":{"@type":"ImageObject","url":"https://www.util.cn/blog/logo/logo-256.png","width":256,"height":256}},"potentialAction":[{"@type":"SearchAction","target":"https://www.util.cn/blog/search?q={search_term_string}","query-input":"required name=search_term_string"}]}</script><meta property="og:type" content="website"><meta property="og:title" content="æŠ€æœ¯åšå®¢ - æœ‰æ¡å·¥å…· | å¼€å‘è€…å·¥å…·ä½¿ç”¨æ•™ç¨‹ & ç¼–ç¨‹æŠ€å·§åˆ†äº«"><meta property="og:description" content="æœ‰æ¡å·¥å…·æŠ€æœ¯åšå®¢ - åˆ†äº«å¼€å‘è€…å·¥å…·ä½¿ç”¨æ•™ç¨‹ã€ç¼–ç¨‹æŠ€å·§å’Œå®æˆ˜å¼€å‘ç»éªŒã€‚æä¾›JSONæ ¼å¼åŒ–ã€SQLä¼˜åŒ–ã€Markdownç¼–è¾‘å™¨ç­‰åœ¨çº¿å·¥å…·çš„è¯¦ç»†ä½¿ç”¨æŒ‡å—ï¼Œå¸®åŠ©å¼€å‘è€…æå‡å·¥ä½œæ•ˆç‡ã€‚"><meta property="og:url" content="https://www.util.cn/blog/"><meta property="og:site_name" content="æœ‰æ¡å·¥å…·æŠ€æœ¯åšå®¢"><meta property="og:image" content="https://www.util.cn/blog/logo/logo-256.png"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="630"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="æŠ€æœ¯åšå®¢ - æœ‰æ¡å·¥å…· | å¼€å‘è€…å·¥å…·ä½¿ç”¨æ•™ç¨‹ & ç¼–ç¨‹æŠ€å·§åˆ†äº«"><meta name=twitter:description content="æœ‰æ¡å·¥å…·æŠ€æœ¯åšå®¢ - åˆ†äº«å¼€å‘è€…å·¥å…·ä½¿ç”¨æ•™ç¨‹ã€ç¼–ç¨‹æŠ€å·§å’Œå®æˆ˜å¼€å‘ç»éªŒã€‚"><meta name=twitter:image content="https://www.util.cn/blog/logo/logo-256.png"><meta name=baidu-site-verification content><meta name=category content="æŠ€æœ¯åšå®¢,å¼€å‘è€…å·¥å…·,ç¼–ç¨‹æ•™ç¨‹"><meta name=coverage content="Worldwide"><meta name=distribution content="Global"><meta name=rating content="General"><script id=51la_code async crossorigin=anonymous src="https://sdk.51.la/js-sdk-pro.min.js?id=3OM52V0xJAPv6ozF&hash=pro"></script><script>window.addEventListener("load",function(){setTimeout(function(){typeof la!="undefined"?console.log("51laç»Ÿè®¡å·²åŠ è½½"):(console.warn("51laç»Ÿè®¡åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ"),function(){var e=document.createElement("script");e.src="https://sdk.51.la/js-sdk-pro.min.js?id=3OM52V0xJAPv6ozF&hash=backup",e.async=!0,document.head.appendChild(e)}())},3e3)})</script><meta property="og:url" content="/blog/articles/%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F%E4%B8%80%E8%87%B4%E6%80%A7%E7%AE%97%E6%B3%95%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90%E4%BB%8Epaxos%E5%88%B0raft/"><meta property="og:site_name" content="æŠ€æœ¯åšå®¢ - æœ‰æ¡å·¥å…·"><meta property="og:title" content="åˆ†å¸ƒå¼ç³»ç»Ÿä¸€è‡´æ€§ç®—æ³•æ·±åº¦è§£æï¼šä»Paxosåˆ°Raft"><meta property="og:description" content="æ·±å…¥æ¢è®¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„æ ¸å¿ƒä¸€è‡´æ€§ç®—æ³•ï¼ŒåŒ…æ‹¬Paxosã€Raftã€EPaxOSç­‰ï¼Œç†è§£å…¶å·¥ä½œåŸç†ã€åº”ç”¨åœºæ™¯å’Œå®ç°ç»†èŠ‚ã€‚"><meta property="og:locale" content="zh-cn"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-12-30T10:00:00+08:00"><meta property="article:modified_time" content="2025-12-30T10:00:00+08:00"><meta property="article:tag" content="åˆ†å¸ƒå¼ç³»ç»Ÿ"><meta property="article:tag" content="ä¸€è‡´æ€§ç®—æ³•"><meta property="article:tag" content="Paxos"><meta property="article:tag" content="Raft"><meta property="article:tag" content="å…±è¯†"><meta name=twitter:card content="summary"><meta name=twitter:title content="åˆ†å¸ƒå¼ç³»ç»Ÿä¸€è‡´æ€§ç®—æ³•æ·±åº¦è§£æï¼šä»Paxosåˆ°Raft"><meta name=twitter:description content="æ·±å…¥æ¢è®¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„æ ¸å¿ƒä¸€è‡´æ€§ç®—æ³•ï¼ŒåŒ…æ‹¬Paxosã€Raftã€EPaxOSç­‰ï¼Œç†è§£å…¶å·¥ä½œåŸç†ã€åº”ç”¨åœºæ™¯å’Œå®ç°ç»†èŠ‚ã€‚"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"æ‰€æœ‰æ–‡ç« ","item":"/blog/posts/"},{"@type":"ListItem","position":2,"name":"åˆ†å¸ƒå¼ç³»ç»Ÿä¸€è‡´æ€§ç®—æ³•æ·±åº¦è§£æï¼šä»Paxosåˆ°Raft","item":"/blog/articles/%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F%E4%B8%80%E8%87%B4%E6%80%A7%E7%AE%97%E6%B3%95%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90%E4%BB%8Epaxos%E5%88%B0raft/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"åˆ†å¸ƒå¼ç³»ç»Ÿä¸€è‡´æ€§ç®—æ³•æ·±åº¦è§£æï¼šä»Paxosåˆ°Raft","name":"åˆ†å¸ƒå¼ç³»ç»Ÿä¸€è‡´æ€§ç®—æ³•æ·±åº¦è§£æï¼šä»Paxosåˆ°Raft","description":"æ·±å…¥æ¢è®¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„æ ¸å¿ƒä¸€è‡´æ€§ç®—æ³•ï¼ŒåŒ…æ‹¬Paxosã€Raftã€EPaxOSç­‰ï¼Œç†è§£å…¶å·¥ä½œåŸç†ã€åº”ç”¨åœºæ™¯å’Œå®ç°ç»†èŠ‚ã€‚","keywords":["åˆ†å¸ƒå¼ç³»ç»Ÿ","ä¸€è‡´æ€§ç®—æ³•","Paxos","Raft","å…±è¯†"],"articleBody":"åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œå¦‚ä½•åœ¨èŠ‚ç‚¹ä¹‹é—´è¾¾æˆä¸€è‡´æ˜¯ä¸€ä¸ªæ ¸å¿ƒéš¾é¢˜ã€‚æœ¬æ–‡å°†æ·±å…¥è§£æç»å…¸çš„ä¸€è‡´æ€§ç®—æ³•ï¼Œå¸®åŠ©å¼€å‘è€…ç†è§£å¹¶æ­£ç¡®åº”ç”¨è¿™äº›ç®—æ³•ã€‚\nä¸€è‡´æ€§é—®é¢˜åŸºç¡€ CAPå®šç† 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 from enum import Enum from typing import Dict, List, Optional from dataclasses import dataclass from datetime import datetime, timedelta class CAPProperty(Enum): CONSISTENCY = \"ä¸€è‡´æ€§\" # æ‰€æœ‰èŠ‚ç‚¹åŒæ—¶çœ‹åˆ°ç›¸åŒæ•°æ® AVAILABILITY = \"å¯ç”¨æ€§\" # æ¯ä¸ªè¯·æ±‚éƒ½èƒ½å¾—åˆ°å“åº” PARTITION_TOLERANCE = \"åˆ†åŒºå®¹é”™\" # ç³»ç»Ÿåœ¨ç½‘ç»œåˆ†åŒºæ—¶ä»èƒ½è¿è¡Œ @dataclass class SystemState: \"\"\"ç³»ç»ŸçŠ¶æ€\"\"\" nodes: List[str] leader: Optional[str] term: int log: List[dict] commit_index: int last_applied: int class DistributedSystem: \"\"\"åˆ†å¸ƒå¼ç³»ç»ŸåŸºç±»\"\"\" def __init__(self, nodes: List[str]): self.nodes = nodes self.state = SystemState( nodes=nodes, leader=None, term=0, log=[], commit_index=0, last_applied=0 ) self.rpc_timeout = 1.0 # RPCè¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰ async def send_rpc(self, from_node: str, to_node: str, method: str, **kwargs) -\u003e dict: \"\"\"å‘é€RPCæ¶ˆæ¯\"\"\" # æ¨¡æ‹Ÿç½‘ç»œå»¶è¿Ÿ await self._simulate_network_delay() # æ£€æŸ¥èŠ‚ç‚¹æ˜¯å¦å¯è¾¾ if to_node not in self.nodes: return {\"error\": \"node_not_found\"} # æ¨¡æ‹Ÿå¯èƒ½çš„ç½‘ç»œåˆ†åŒº if self._is_partitioned(from_node, to_node): return {\"error\": \"network_partition\"} return {\"success\": True} async def _simulate_network_delay(self): \"\"\"æ¨¡æ‹Ÿç½‘ç»œå»¶è¿Ÿ\"\"\" import random delay = random.uniform(0.01, 0.1) await asyncio.sleep(delay) def _is_partitioned(self, node1: str, node2: str) -\u003e bool: \"\"\"æ£€æŸ¥ä¸¤ä¸ªèŠ‚ç‚¹ä¹‹é—´æ˜¯å¦å­˜åœ¨ç½‘ç»œåˆ†åŒº\"\"\" # æ¨¡æ‹Ÿåˆ†åŒºåœºæ™¯ return False Raftç®—æ³•è¯¦è§£ æ ¸å¿ƒæ•°æ®ç»“æ„ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 from typing import Optional from dataclasses import dataclass, field from enum import Enum class NodeState(Enum): FOLLOWER = \"follower\" CANDIDATE = \"candidate\" LEADER = \"leader\" @dataclass class LogEntry: \"\"\"æ—¥å¿—æ¡ç›®\"\"\" index: int term: int command: str is_committed: bool = False @dataclass class RaftNode: \"\"\"RaftèŠ‚ç‚¹\"\"\" node_id: str state: NodeState = NodeState.FOLLOWER current_term: int = 0 voted_for: Optional[str] = None log: List[LogEntry] = field(default_factory=list) commit_index: int = 0 last_applied: int = 0 # Leaderç‰¹æœ‰çŠ¶æ€ next_index: Dict[str, int] = field(default_factory=dict) match_index: Dict[str, int] = field(default_factory=dict) # è¶…æ—¶è®¾ç½® election_timeout: float = 5.0 heartbeat_interval: float = 1.0 # è®¡æ—¶å™¨ last_heartbeat: datetime = field(default_factory=datetime.now) last_election_attempt: datetime = field(default_factory=datetime.now) def __post_init__(self): \"\"\"åˆå§‹åŒ–åå¤„ç†\"\"\" self.peers: List[RaftNode] = [] self.vote_count: int = 0 def get_last_log_index(self) -\u003e int: \"\"\"è·å–æœ€åä¸€æ¡æ—¥å¿—çš„ç´¢å¼•\"\"\" return len(self.log) - 1 def get_last_log_term(self) -\u003e int: \"\"\"è·å–æœ€åä¸€æ¡æ—¥å¿—çš„ä»»æœŸ\"\"\" if not self.log: return 0 return self.log[-1].term def get_log_term(self, index: int) -\u003e int: \"\"\"è·å–æŒ‡å®šç´¢å¼•çš„æ—¥å¿—ä»»æœŸ\"\"\" if index \u003c 0 or index \u003e= len(self.log): return 0 return self.log[index].term é¢†å¯¼è€…é€‰ä¸¾ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 import asyncio import random class RaftElection: \"\"\"Rafté€‰ä¸¾æœºåˆ¶\"\"\" def __init__(self, node: RaftNode): self.node = node async def start_election(self) -\u003e bool: \"\"\"å¼€å§‹é€‰ä¸¾\"\"\" # è½¬æ¢ä¸ºå€™é€‰è€…çŠ¶æ€ self.node.state = NodeState.CANDIDATE self.node.current_term += 1 self.node.voted_for = self.node.node_id self.node.vote_count = 1 # è‡ªå·±æŠ•ç»™è‡ªå·± self.node.last_election_attempt = datetime.now() print(f\"[Node {self.node.node_id}] å¼€å§‹é€‰ä¸¾, Term: {self.node.current_term}\") # å‘æ‰€æœ‰å…¶ä»–èŠ‚ç‚¹å‘é€RequestVote RPC votes_needed = len(self.node.peers) // 2 + 1 request_vote = RequestVoteRPC( term=self.node.current_term, candidate_id=self.node.node_id, last_log_index=self.node.get_last_log_index(), last_log_term=self.node.get_last_log_term() ) # å¹¶å‘å‘é€æŠ•ç¥¨è¯·æ±‚ tasks = [ self._request_vote(peer, request_vote) for peer in self.node.peers if peer.node_id != self.node.node_id ] results = await asyncio.gather(*tasks, return_exceptions=True) # ç»Ÿè®¡é€‰ç¥¨ for result in results: if isinstance(result, bool) and result: self.node.vote_count += 1 # æ£€æŸ¥æ˜¯å¦è·å¾—å¤šæ•°ç¥¨ if self.node.vote_count \u003e= votes_needed: self.node.state = NodeState.LEADER print(f\"[Node {self.node.node_id}] å½“é€‰ä¸ºLeader, Term: {self.node.current_term}\") await self._become_leader() return True print(f\"[Node {self.node.node_id}] é€‰ä¸¾å¤±è´¥, å¾—ç¥¨: {self.node.vote_count}/{votes_needed}\") self.node.state = NodeState.FOLLOWER return False async def _request_vote(self, peer: RaftNode, rpc: 'RequestVoteRPC') -\u003e bool: \"\"\"è¯·æ±‚æŠ•ç¥¨\"\"\" try: # æ¨¡æ‹Ÿç½‘ç»œå»¶è¿Ÿ await asyncio.sleep(random.uniform(0.01, 0.05)) # å¯¹æ–¹çš„å†³ç­–é€»è¾‘ if rpc.term \u003c peer.current_term: return False # å¯¹æ–¹çš„ä»»æœŸæ›´å¤§ if rpc.term \u003e peer.current_term: # å‘ç°æ›´å¤§çš„ä»»æœŸï¼Œæ›´æ–°å¹¶æŠ•ç¥¨ peer.current_term = rpc.term peer.voted_for = rpc.candidate_id peer.state = NodeState.FOLLOWER return True # ä»»æœŸç›¸åŒï¼Œæ£€æŸ¥æ˜¯å¦å·²æŠ•ç¥¨ if peer.voted_for is None or peer.voted_for == rpc.candidate_id: # æ£€æŸ¥æ—¥å¿—æ˜¯å¦è‡³å°‘ä¸€æ ·æ–° if (rpc.last_log_term \u003e peer.get_last_log_term() or (rpc.last_log_term == peer.get_last_log_term() and rpc.last_log_index \u003e= peer.get_last_log_index())): peer.voted_for = rpc.candidate_id return True return False except Exception as e: print(f\"[Node {self.node.node_id}] è¯·æ±‚ {peer.node_id} æŠ•ç¥¨å¤±è´¥: {e}\") return False async def _become_leader(self): \"\"\"æˆä¸ºLeaderåçš„åˆå§‹åŒ–\"\"\" # åˆå§‹åŒ–next_indexå’Œmatch_index for peer in self.node.peers: if peer.node_id != self.node.node_id: self.node.next_index[peer.node_id] = self.node.get_last_log_index() + 1 self.node.match_index[peer.node_id] = 0 # ç«‹å³å‘é€å¿ƒè·³ await self._send_heartbeat() async def _send_heartbeat(self): \"\"\"å‘é€å¿ƒè·³ï¼ˆç©ºçš„AppendEntries RPCï¼‰\"\"\" while self.node.state == NodeState.LEADER: for peer in self.node.peers: if peer.node_id != self.node.node_id: await self._send_append_entries(peer, empty=True) await asyncio.sleep(self.node.heartbeat_interval) @dataclass class RequestVoteRPC: \"\"\"RequestVote RPCå‚æ•°\"\"\" term: int candidate_id: str last_log_index: int last_log_term: int æ—¥å¿—å¤åˆ¶ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 class RaftLogReplication: \"\"\"Raftæ—¥å¿—å¤åˆ¶\"\"\" def __init__(self, node: RaftNode): self.node = node async def replicate_log(self, command: str) -\u003e bool: \"\"\"å¤åˆ¶æ—¥å¿—åˆ°æ‰€æœ‰èŠ‚ç‚¹\"\"\" if self.node.state != NodeState.LEADER: return False # æ·»åŠ åˆ°æœ¬åœ°æ—¥å¿— new_entry = LogEntry( index=self.node.get_last_log_index() + 1, term=self.node.current_term, command=command ) self.node.log.append(new_entry) print(f\"[Leader {self.node.node_id}] æ·»åŠ æ—¥å¿—: Index {new_entry.index}, Term {new_entry.term}\") # å¤åˆ¶åˆ°æ‰€æœ‰èŠ‚ç‚¹ success_count = 1 # åŒ…æ‹¬Leaderè‡ªå·± tasks = [] for peer in self.node.peers: if peer.node_id != self.node.node_id: tasks.append(self._replicate_to_peer(peer)) results = await asyncio.gather(*tasks, return_exceptions=True) for result in results: if isinstance(result, bool) and result: success_count += 1 # æ£€æŸ¥æ˜¯å¦è¢«å¤šæ•°èŠ‚ç‚¹æ¥å— if success_count \u003e len(self.node.peers) // 2: # æ›´æ–°commit_index self.node.commit_index = new_entry.index new_entry.is_committed = True print(f\"[Leader {self.node.node_id}] æ—¥å¿— {new_entry.index} å·²æäº¤\") return True return False async def _replicate_to_peer(self, peer: RaftNode) -\u003e bool: \"\"\"å¤åˆ¶æ—¥å¿—åˆ°æŒ‡å®šèŠ‚ç‚¹\"\"\" # å¦‚æœnext_indexè¡¨æ˜å­˜åœ¨ä¸ä¸€è‡´ï¼Œå›é€€ next_idx = self.node.next_index.get(peer.node_id, 0) if next_idx \u003e len(self.node.log): return False # æ„å»ºAppendEntries RPC prev_log_index = next_idx - 1 prev_log_term = self.node.log[prev_log_index].term if prev_log_index \u003e= 0 else 0 entries = self.node.log[next_idx:] rpc = AppendEntriesRPC( term=self.node.current_term, leader_id=self.node.node_id, prev_log_index=prev_log_index, prev_log_term=prev_log_term, entries=entries, leader_commit=self.node.commit_index ) return await self._send_append_entries(peer, empty=False, rpc=rpc) async def _send_append_entries( self, peer: RaftNode, empty: bool = False, rpc: Optional[AppendEntriesRPC] = None ) -\u003e bool: \"\"\"å‘é€AppendEntries RPC\"\"\" if not rpc: rpc = AppendEntriesRPC( term=self.node.current_term, leader_id=self.node.node_id, prev_log_index=self.node.get_last_log_index(), prev_log_term=self.node.get_last_log_term(), entries=[], leader_commit=self.node.commit_index ) try: # æ¨¡æ‹Ÿç½‘ç»œå»¶è¿Ÿ await asyncio.sleep(random.uniform(0.01, 0.05)) # å¦‚æœtermè¿‡æœŸï¼Œè½¬ä¸ºfollower if rpc.term \u003e peer.current_term: peer.current_term = rpc.term peer.state = NodeState.FOLLOWER return False # å¦‚æœtermè¾ƒå°ï¼Œæ‹’ç» if rpc.term \u003c peer.current_term: return False # æ£€æŸ¥æ—¥å¿—ä¸€è‡´æ€§ if rpc.prev_log_index \u003e= 0: if (rpc.prev_log_index \u003e= len(peer.log) or peer.get_log_term(rpc.prev_log_index) != rpc.prev_log_term): # æ—¥å¿—ä¸ä¸€è‡´ï¼Œè¿”å›å¤±è´¥ return False # æ—¥å¿—ä¸€è‡´ï¼Œæ·»åŠ æ–°æ¡ç›® if rpc.entries: # åˆ é™¤å†²çªçš„æ¡ç›® peer.log = peer.log[:rpc.prev_log_index + 1] # æ·»åŠ æ–°æ¡ç›® peer.log.extend(rpc.entries) # æ›´æ–°commit_index if rpc.leader_commit \u003e peer.commit_index: peer.commit_index = min(rpc.leader_commit, len(peer.log) - 1) # æ›´æ–°Leaderçš„next_indexå’Œmatch_index if not empty: last_new_entry = rpc.prev_log_index + len(rpc.entries) self.node.next_index[peer.node_id] = last_new_entry + 1 self.node.match_index[peer.node_id] = last_new_entry return True except Exception as e: print(f\"[Leader {self.node.node_id}] å¤åˆ¶åˆ° {peer.node_id} å¤±è´¥: {e}\") return False @dataclass class AppendEntriesRPC: \"\"\"AppendEntries RPCå‚æ•°\"\"\" term: int leader_id: str prev_log_index: int prev_log_term: int entries: List[LogEntry] leader_commit: int Paxosç®—æ³• Basic Paxos 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 class PaxosProposer: \"\"\"Paxosæè®®è€…\"\"\" def __init__(self, proposer_id: str): self.proposer_id = proposer_id self.proposal_number = 0 self.accepted_value = None self.promises_received = set() self.accepts_received = set() async def propose(self, value: str, quorum_size: int) -\u003e Optional[str]: \"\"\"å‘èµ·æè®®\"\"\" # Phase 1: Prepare self.proposal_number += 1 self.promises_received.clear() print(f\"[Proposer {self.proposer_id}] Phase 1: Prepare (N={self.proposal_number})\") prepare_msg = PrepareMessage( proposal_number=self.proposal_number, proposer_id=self.proposer_id ) # å‘é€Prepareåˆ°æ‰€æœ‰Acceptors tasks = [ self._send_prepare(acceptor, prepare_msg) for acceptor in self.acceptors ] responses = await asyncio.gather(*tasks, return_exceptions=True) # ç»Ÿè®¡Promiseå“åº” for response in responses: if isinstance(response, PromiseMessage): self.promises_received.add(response.acceptor_id) # å¦‚æœæœ‰å·²æ¥å—çš„å€¼ï¼Œä½¿ç”¨å®ƒ if response.accepted_number \u003e 0: self.accepted_value = response.accepted_value # æ£€æŸ¥æ˜¯å¦è·å¾—å¤šæ•°Promise if len(self.promises_received) \u003c quorum_size: print(f\"[Proposer {self.proposer_id}] Phase 1 å¤±è´¥: æœªè·å¾—å¤šæ•°Promise\") return None print(f\"[Proposer {self.proposer_id}] Phase 1 æˆåŠŸ: è·å¾— {len(self.promises_received)} ä¸ªPromise\") # Phase 2: Accept self.accepts_received.clear() # ä½¿ç”¨å·²æ¥å—çš„å€¼æˆ–æè®®çš„æ–°å€¼ value_to_propose = self.accepted_value if self.accepted_value else value accept_msg = AcceptMessage( proposal_number=self.proposal_number, value=value_to_propose, proposer_id=self.proposer_id ) print(f\"[Proposer {self.proposer_id}] Phase 2: Accept (Value={value_to_propose})\") # å‘é€Acceptåˆ°æ‰€æœ‰Acceptors tasks = [ self._send_accept(acceptor, accept_msg) for acceptor in self.acceptors ] responses = await asyncio.gather(*tasks, return_exceptions=True) # ç»Ÿè®¡Acceptedå“åº” for response in responses: if isinstance(response, AcceptedMessage): self.accepts_received.add(response.acceptor_id) # æ£€æŸ¥æ˜¯å¦è·å¾—å¤šæ•°Accepted if len(self.accepts_received) \u003e= quorum_size: print(f\"[Proposer {self.proposer_id}] Phase 2 æˆåŠŸ: å€¼ '{value_to_propose}' å·²è¾¾æˆå…±è¯†\") return value_to_propose print(f\"[Proposer {self.proposer_id}] Phase 2 å¤±è´¥: æœªè·å¾—å¤šæ•°Accepted\") return None async def _send_prepare(self, acceptor: 'PaxosAcceptor', msg: PrepareMessage) -\u003e Optional['PromiseMessage']: \"\"\"å‘é€Prepareæ¶ˆæ¯\"\"\" try: await asyncio.sleep(random.uniform(0.01, 0.05)) return await acceptor.receive_prepare(msg) except Exception as e: print(f\"[Proposer {self.proposer_id}] Prepareå¤±è´¥: {e}\") return None async def _send_accept(self, acceptor: 'PaxosAcceptor', msg: AcceptMessage) -\u003e Optional['AcceptedMessage']: \"\"\"å‘é€Acceptæ¶ˆæ¯\"\"\" try: await asyncio.sleep(random.uniform(0.01, 0.05)) return await acceptor.receive_accept(msg) except Exception as e: print(f\"[Proposer {self.proposer_id}] Acceptå¤±è´¥: {e}\") return None @dataclass class PrepareMessage: proposal_number: int proposer_id: str @dataclass class PromiseMessage: acceptor_id: str proposal_number: int accepted_number: int = 0 accepted_value: Optional[str] = None @dataclass class AcceptMessage: proposal_number: int value: str proposer_id: str @dataclass class AcceptedMessage: acceptor_id: str proposal_number: int EPaxOSï¼ˆEphemeral Paxosï¼‰ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 class EPaxosNode: \"\"\"EPaxOSèŠ‚ç‚¹ - ä¼˜åŒ–Leaderlessåœºæ™¯\"\"\" def __init__(self, node_id: str, cluster: List[str]): self.node_id = node_id self.cluster = cluster self.instance_number = 0 self.dependencies: Dict[int, set] = {} self.log: Dict[int, str] = {} async def fast_write(self, key: str, value: str) -\u003e bool: \"\"\"å¿«é€Ÿå†™å…¥ï¼ˆå•è½®RPCï¼‰\"\"\" self.instance_number += 1 instance = self.instance_number # é€‰æ‹©ä¾èµ–é›†åˆ deps = await self._get_dependencies(key) # å‘é€PreAcceptåˆ°æ‰€æœ‰èŠ‚ç‚¹ preaccept_msg = PreAcceptMessage( instance=instance, key=key, value=value, dependencies=deps, from_node=self.node_id ) print(f\"[EPaxOS {self.node_id}] Fast Write: {key}={value}\") # å¹¶å‘å‘é€ tasks = [ self._send_preaccept(node, preaccept_msg) for node in self.cluster if node != self.node_id ] responses = await asyncio.gather(*tasks, return_exceptions=True) # ç»Ÿè®¡å“åº” success_count = 1 # åŒ…æ‹¬è‡ªå·± all_deps_match = True for response in responses: if isinstance(response, PreAcceptResponse): success_count += 1 # æ£€æŸ¥ä¾èµ–æ˜¯å¦ä¸€è‡´ if response.dependencies != deps: all_deps_match = False # å¦‚æœå¤šæ•°èŠ‚ç‚¹åŒæ„ä¸”ä¾èµ–ä¸€è‡´ï¼Œå¿«é€Ÿæäº¤ quorum = len(self.cluster) // 2 + 1 if success_count \u003e= quorum and all_deps_match: self.log[instance] = f\"{key}={value}\" print(f\"[EPaxOS {self.node_id}] Fast Commit: {key}={value}\") return True # å¦åˆ™å›é€€åˆ°æ ‡å‡†Paxos return await self._slow_write(instance, key, value, deps) async def _get_dependencies(self, key: str) -\u003e set: \"\"\"è·å–ä¾èµ–é›†åˆ\"\"\" # ç®€åŒ–å®ç°ï¼šæŸ¥æ‰¾åŒä¸€keyçš„æœ€æ–°å®ä¾‹ deps = set() for inst, val in self.log.items(): if val.startswith(f\"{key}=\"): deps.add(inst) return deps async def _send_preaccept(self, node: str, msg: PreAcceptMessage) -\u003e Optional[PreAcceptResponse]: \"\"\"å‘é€PreAcceptæ¶ˆæ¯\"\"\" # å®é™…å®ç°ä¸­è¿™é‡Œæ˜¯RPCè°ƒç”¨ await asyncio.sleep(random.uniform(0.01, 0.05)) return PreAcceptResponse( from_node=node, dependencies=msg.dependencies.copy() ) async def _slow_write(self, instance: int, key: str, value: str, deps: set) -\u003e bool: \"\"\"æ…¢é€Ÿå†™å…¥ï¼ˆæ ‡å‡†Paxosï¼‰\"\"\" print(f\"[EPaxOS {self.node_id}] Slow Write: {key}={value}\") # å®ç°æ ‡å‡†Paxos Accepté˜¶æ®µ return True @dataclass class PreAcceptMessage: instance: int key: str value: str dependencies: set from_node: str @dataclass class PreAcceptResponse: from_node: str dependencies: set ä¸€è‡´æ€§ç®—æ³•é€‰å‹ ç®—æ³• é€‚ç”¨åœºæ™¯ ä¼˜ç‚¹ ç¼ºç‚¹ Raft æ—¥å¿—å¤åˆ¶ã€é…ç½®ç®¡ç† æ˜“ç†è§£ã€å®ç°ç®€å• Leaderç“¶é¢ˆ Paxos é€šç”¨å…±è¯† ç†è®ºå®Œå¤‡ å®ç°å¤æ‚ EPaxOS å¤šä¸»å†™å…¥ã€è·¨åœ°åŸŸ æ— Leaderã€ä½å»¶è¿Ÿ å®ç°å¤æ‚ Gossip æœ€ç»ˆä¸€è‡´æ€§ ç®€å•ã€å®¹é”™å¥½ ä¸€è‡´æ€§å¼± æœ€ä½³å®è·µ ç†è§£CAPæƒè¡¡ï¼šæ ¹æ®ä¸šåŠ¡éœ€æ±‚é€‰æ‹©åˆé€‚çš„ä¸€è‡´æ€§çº§åˆ« ç›‘æ§é›†ç¾¤å¥åº·ï¼šæŒç»­è·Ÿè¸ªèŠ‚ç‚¹çŠ¶æ€å’Œé€‰ä¸¾æƒ…å†µ å¤„ç†è„‘è£‚ï¼šé€šè¿‡Quorumæœºåˆ¶é¿å…è„‘è£‚ ä¼˜åŒ–ç½‘ç»œï¼šå‡å°‘RPCå»¶è¿Ÿå¯¹æ€§èƒ½çš„å½±å“ æ—¥å¿—å‹ç¼©ï¼šå®šæœŸæ¸…ç†å·²æäº¤çš„æ—¥å¿— å¿«ç…§æœºåˆ¶ï¼šå‡å°‘æ¢å¤æ—¶é—´ åˆ†å¸ƒå¼ä¸€è‡´æ€§æ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿçš„åŸºçŸ³ã€‚é€‰æ‹©åˆé€‚çš„ç®—æ³•å¹¶æ­£ç¡®å®ç°ï¼Œæ˜¯æ„å»ºå¯é ç³»ç»Ÿçš„å…³é”®ã€‚\n","wordCount":"2027","inLanguage":"zh-cn","datePublished":"2025-12-30T10:00:00+08:00","dateModified":"2025-12-30T10:00:00+08:00","author":{"@type":"Person","name":"æœ‰æ¡å·¥å…·å›¢é˜Ÿ"},"mainEntityOfPage":{"@type":"WebPage","@id":"/blog/articles/%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F%E4%B8%80%E8%87%B4%E6%80%A7%E7%AE%97%E6%B3%95%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90%E4%BB%8Epaxos%E5%88%B0raft/"},"publisher":{"@type":"Organization","name":"æŠ€æœ¯åšå®¢ - æœ‰æ¡å·¥å…·","logo":{"@type":"ImageObject","url":"/favicon.ico"}}}</script></head><body id=top><header class=header><nav class=nav><div class=logo><a href=/blog/ accesskey=h title="æŠ€æœ¯åšå®¢ - æœ‰æ¡å·¥å…· (Alt + H)">æŠ€æœ¯åšå®¢ - æœ‰æ¡å·¥å…·</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=/blog/posts/ title="æ‰€æœ‰æ–‡ç« åˆ—è¡¨ - æœ‰æ¡å·¥å…·æŠ€æœ¯åšå®¢ï¼šæŸ¥çœ‹æ‰€æœ‰æŠ€æœ¯æ–‡ç« å’Œæ•™ç¨‹å†…å®¹"><span>æ–‡ç« </span></a></li><li><a href=https://www.util.cn title="æœ‰æ¡å·¥å…· - å¼€å‘è€…çš„å¸¸ç”¨å·¥å…·é›†åˆï¼šæ— å¹¿å‘Š Â· æœ¬åœ°è®¡ç®— Â· å³å¼€å³ç”¨çš„åœ¨çº¿å·¥å…·å¹³å°ï¼Œæä¾›JSONæ ¼å¼åŒ–ã€SQLæ ¼å¼åŒ–ã€Markdownç¼–è¾‘å™¨ç­‰å®ç”¨å·¥å…·"><span>æœ‰æ¡å·¥å…·</span>&nbsp;
<svg fill="none" shape-rendering="geometricPrecision" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li><li><a href=/blog/categories/ title="æ–‡ç« åˆ†ç±» - æœ‰æ¡å·¥å…·æŠ€æœ¯åšå®¢ï¼šæŒ‰æŠ€æœ¯é¢†åŸŸåˆ†ç±»çš„ä¼˜è´¨æ–‡ç« ï¼ŒåŒ…æ‹¬å‰ç«¯å¼€å‘ã€å·¥å…·ä½¿ç”¨ã€ç¼–ç¨‹æŠ€å·§ç­‰"><span>åˆ†ç±»</span></a></li><li><a href=/blog/tags/ title="æ ‡ç­¾äº‘ - æœ‰æ¡å·¥å…·æŠ€æœ¯åšå®¢ï¼šé€šè¿‡æ ‡ç­¾å¿«é€Ÿæ‰¾åˆ°æ„Ÿå…´è¶£çš„æŠ€æœ¯æ–‡ç« å’Œæ•™ç¨‹å†…å®¹"><span>æ ‡ç­¾</span></a></li><li><a href=/blog/archives/ title="æ–‡ç« å½’æ¡£ - æœ‰æ¡å·¥å…·æŠ€æœ¯åšå®¢ï¼šæŒ‰æ—¶é—´æŸ¥çœ‹å†å²æ–‡ç« "><span>å½’æ¡£</span></a></li><li><a href=/blog/search/ title="æœç´¢æ–‡ç«  - æœ‰æ¡å·¥å…·æŠ€æœ¯åšå®¢ï¼šé€šè¿‡å…³é”®è¯æœç´¢æ‰¾åˆ°æ„Ÿå…´è¶£çš„æŠ€æœ¯æ–‡ç« å’Œæ•™ç¨‹å†…å®¹ï¼Œæ”¯æŒæ ‡é¢˜ã€å†…å®¹ã€åˆ†ç±»å’Œæ ‡ç­¾æœç´¢"><span>æœç´¢</span></a></li></ul></nav></header><main class=main><article class=post-single><div class=post-content-wrapper><main class=post-content-main><header class=post-header-main><h1 class="post-title entry-hint-parent">åˆ†å¸ƒå¼ç³»ç»Ÿä¸€è‡´æ€§ç®—æ³•æ·±åº¦è§£æï¼šä»Paxosåˆ°Raft</h1><div class=post-meta><div class=post-meta-content><div class=post-categories-inline><a href=/blog/categories/%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91/ class=category-link>åç«¯å¼€å‘</a></div><span class=post-date>2025-12-30</span><span class=post-author>æœ‰æ¡å·¥å…·å›¢é˜Ÿ</span></div><style>.post-meta-content{display:flex;align-items:center;flex-wrap:wrap;gap:.75rem;font-family:sf mono,monaco,courier new,monospace;font-size:.875rem;color:#9ca3af !important}.post-categories-inline{display:inline-flex;align-items:center;gap:.5rem}.category-link{display:inline-flex;align-items:center;gap:.25rem;padding:.25rem .75rem;background:rgba(255,255,255,.1);color:#e5e7eb !important;text-decoration:none;font-size:.75rem;font-weight:600;text-transform:uppercase;letter-spacing:.05em;border:1px solid rgba(255,255,255,.2);border-radius:0;transition:all .3s ease;white-space:nowrap}.category-link:hover{background:rgba(255,255,255,.2);color:#fff !important;border-color:rgba(255,255,255,.3);transform:translateY(-1px)}.category-link::before{content:'ğŸ“';font-size:.7rem;opacity:.8}.post-date,.post-reading-time,.post-word-count,.post-author{color:#9ca3af !important}[data-theme=dark] .post-meta-content{color:#9ca3af !important}[data-theme=dark] .category-link{background:rgba(255,255,255,.1);color:#e5e7eb !important;border-color:rgba(255,255,255,.2)}[data-theme=dark] .category-link:hover{background:rgba(255,255,255,.2);color:#fff !important;border-color:rgba(255,255,255,.3)}[data-theme=dark] .post-date,[data-theme=dark] .post-reading-time,[data-theme=dark] .post-word-count,[data-theme=dark] .post-author{color:#9ca3af !important}[data-theme=light] .post-meta-content{color:#6c757d !important}[data-theme=light] .category-link{background:rgba(0,0,0,5%);color:#495057 !important;border-color:rgba(0,0,0,.15)}[data-theme=light] .category-link:hover{background:rgba(0,102,204,.1);color:#212529 !important;border-color:rgba(0,102,204,.3)}[data-theme=light] .post-date,[data-theme=light] .post-reading-time,[data-theme=light] .post-word-count,[data-theme=light] .post-author{color:#6c757d !important}@media(max-width:768px){.post-meta-content{gap:.5rem;font-size:.8rem}.category-link{padding:.2rem .6rem;font-size:.7rem}}</style></div></header><div class=post-content><p>åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œå¦‚ä½•åœ¨èŠ‚ç‚¹ä¹‹é—´è¾¾æˆä¸€è‡´æ˜¯ä¸€ä¸ªæ ¸å¿ƒéš¾é¢˜ã€‚æœ¬æ–‡å°†æ·±å…¥è§£æç»å…¸çš„ä¸€è‡´æ€§ç®—æ³•ï¼Œå¸®åŠ©å¼€å‘è€…ç†è§£å¹¶æ­£ç¡®åº”ç”¨è¿™äº›ç®—æ³•ã€‚</p><h2 id=ä¸€è‡´æ€§é—®é¢˜åŸºç¡€>ä¸€è‡´æ€§é—®é¢˜åŸºç¡€<a hidden class=anchor aria-hidden=true href=#ä¸€è‡´æ€§é—®é¢˜åŸºç¡€>#</a></h2><h3 id=capå®šç†>CAPå®šç†<a hidden class=anchor aria-hidden=true href=#capå®šç†>#</a></h3><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">60
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#ff7b72>from</span> <span style=color:#ff7b72>enum</span> <span style=color:#ff7b72>import</span> Enum
</span></span><span style=display:flex><span><span style=color:#ff7b72>from</span> <span style=color:#ff7b72>typing</span> <span style=color:#ff7b72>import</span> Dict, List, Optional
</span></span><span style=display:flex><span><span style=color:#ff7b72>from</span> <span style=color:#ff7b72>dataclasses</span> <span style=color:#ff7b72>import</span> dataclass
</span></span><span style=display:flex><span><span style=color:#ff7b72>from</span> <span style=color:#ff7b72>datetime</span> <span style=color:#ff7b72>import</span> datetime, timedelta
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>class</span> <span style=color:#f0883e;font-weight:700>CAPProperty</span>(Enum):
</span></span><span style=display:flex><span>    CONSISTENCY <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>&#34;ä¸€è‡´æ€§&#34;</span>    <span style=color:#8b949e;font-style:italic># æ‰€æœ‰èŠ‚ç‚¹åŒæ—¶çœ‹åˆ°ç›¸åŒæ•°æ®</span>
</span></span><span style=display:flex><span>    AVAILABILITY <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>&#34;å¯ç”¨æ€§&#34;</span>    <span style=color:#8b949e;font-style:italic># æ¯ä¸ªè¯·æ±‚éƒ½èƒ½å¾—åˆ°å“åº”</span>
</span></span><span style=display:flex><span>    PARTITION_TOLERANCE <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>&#34;åˆ†åŒºå®¹é”™&#34;</span>  <span style=color:#8b949e;font-style:italic># ç³»ç»Ÿåœ¨ç½‘ç»œåˆ†åŒºæ—¶ä»èƒ½è¿è¡Œ</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#d2a8ff;font-weight:700>@dataclass</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>class</span> <span style=color:#f0883e;font-weight:700>SystemState</span>:
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#34;&#34;&#34;ç³»ç»ŸçŠ¶æ€&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>    nodes: List[str]
</span></span><span style=display:flex><span>    leader: Optional[str]
</span></span><span style=display:flex><span>    term: int
</span></span><span style=display:flex><span>    log: List[dict]
</span></span><span style=display:flex><span>    commit_index: int
</span></span><span style=display:flex><span>    last_applied: int
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>class</span> <span style=color:#f0883e;font-weight:700>DistributedSystem</span>:
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#34;&#34;&#34;åˆ†å¸ƒå¼ç³»ç»ŸåŸºç±»&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>__init__</span>(self, nodes: List[str]):
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>nodes <span style=color:#ff7b72;font-weight:700>=</span> nodes
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>state <span style=color:#ff7b72;font-weight:700>=</span> SystemState(
</span></span><span style=display:flex><span>            nodes<span style=color:#ff7b72;font-weight:700>=</span>nodes,
</span></span><span style=display:flex><span>            leader<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#79c0ff>None</span>,
</span></span><span style=display:flex><span>            term<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>0</span>,
</span></span><span style=display:flex><span>            log<span style=color:#ff7b72;font-weight:700>=</span>[],
</span></span><span style=display:flex><span>            commit_index<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>0</span>,
</span></span><span style=display:flex><span>            last_applied<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>0</span>
</span></span><span style=display:flex><span>        )
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>rpc_timeout <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>1.0</span>  <span style=color:#8b949e;font-style:italic># RPCè¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>async</span> <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>send_rpc</span>(self, from_node: str, to_node: str, method: str, <span style=color:#ff7b72;font-weight:700>**</span>kwargs) <span style=color:#ff7b72;font-weight:700>-&gt;</span> dict:
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;å‘é€RPCæ¶ˆæ¯&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic># æ¨¡æ‹Ÿç½‘ç»œå»¶è¿Ÿ</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>await</span> self<span style=color:#ff7b72;font-weight:700>.</span>_simulate_network_delay()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic># æ£€æŸ¥èŠ‚ç‚¹æ˜¯å¦å¯è¾¾</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>if</span> to_node <span style=color:#ff7b72;font-weight:700>not</span> <span style=color:#ff7b72;font-weight:700>in</span> self<span style=color:#ff7b72;font-weight:700>.</span>nodes:
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>return</span> {<span style=color:#a5d6ff>&#34;error&#34;</span>: <span style=color:#a5d6ff>&#34;node_not_found&#34;</span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic># æ¨¡æ‹Ÿå¯èƒ½çš„ç½‘ç»œåˆ†åŒº</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>if</span> self<span style=color:#ff7b72;font-weight:700>.</span>_is_partitioned(from_node, to_node):
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>return</span> {<span style=color:#a5d6ff>&#34;error&#34;</span>: <span style=color:#a5d6ff>&#34;network_partition&#34;</span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> {<span style=color:#a5d6ff>&#34;success&#34;</span>: <span style=color:#79c0ff>True</span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>async</span> <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>_simulate_network_delay</span>(self):
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;æ¨¡æ‹Ÿç½‘ç»œå»¶è¿Ÿ&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>import</span> <span style=color:#ff7b72>random</span>
</span></span><span style=display:flex><span>        delay <span style=color:#ff7b72;font-weight:700>=</span> random<span style=color:#ff7b72;font-weight:700>.</span>uniform(<span style=color:#a5d6ff>0.01</span>, <span style=color:#a5d6ff>0.1</span>)
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>await</span> asyncio<span style=color:#ff7b72;font-weight:700>.</span>sleep(delay)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>_is_partitioned</span>(self, node1: str, node2: str) <span style=color:#ff7b72;font-weight:700>-&gt;</span> bool:
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;æ£€æŸ¥ä¸¤ä¸ªèŠ‚ç‚¹ä¹‹é—´æ˜¯å¦å­˜åœ¨ç½‘ç»œåˆ†åŒº&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic># æ¨¡æ‹Ÿåˆ†åŒºåœºæ™¯</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> <span style=color:#79c0ff>False</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=raftç®—æ³•è¯¦è§£>Raftç®—æ³•è¯¦è§£<a hidden class=anchor aria-hidden=true href=#raftç®—æ³•è¯¦è§£>#</a></h2><h3 id=æ ¸å¿ƒæ•°æ®ç»“æ„>æ ¸å¿ƒæ•°æ®ç»“æ„<a hidden class=anchor aria-hidden=true href=#æ ¸å¿ƒæ•°æ®ç»“æ„>#</a></h3><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">60
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#ff7b72>from</span> <span style=color:#ff7b72>typing</span> <span style=color:#ff7b72>import</span> Optional
</span></span><span style=display:flex><span><span style=color:#ff7b72>from</span> <span style=color:#ff7b72>dataclasses</span> <span style=color:#ff7b72>import</span> dataclass, field
</span></span><span style=display:flex><span><span style=color:#ff7b72>from</span> <span style=color:#ff7b72>enum</span> <span style=color:#ff7b72>import</span> Enum
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>class</span> <span style=color:#f0883e;font-weight:700>NodeState</span>(Enum):
</span></span><span style=display:flex><span>    FOLLOWER <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>&#34;follower&#34;</span>
</span></span><span style=display:flex><span>    CANDIDATE <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>&#34;candidate&#34;</span>
</span></span><span style=display:flex><span>    LEADER <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>&#34;leader&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#d2a8ff;font-weight:700>@dataclass</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>class</span> <span style=color:#f0883e;font-weight:700>LogEntry</span>:
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#34;&#34;&#34;æ—¥å¿—æ¡ç›®&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>    index: int
</span></span><span style=display:flex><span>    term: int
</span></span><span style=display:flex><span>    command: str
</span></span><span style=display:flex><span>    is_committed: bool <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#79c0ff>False</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#d2a8ff;font-weight:700>@dataclass</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>class</span> <span style=color:#f0883e;font-weight:700>RaftNode</span>:
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#34;&#34;&#34;RaftèŠ‚ç‚¹&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>    node_id: str
</span></span><span style=display:flex><span>    state: NodeState <span style=color:#ff7b72;font-weight:700>=</span> NodeState<span style=color:#ff7b72;font-weight:700>.</span>FOLLOWER
</span></span><span style=display:flex><span>    current_term: int <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>0</span>
</span></span><span style=display:flex><span>    voted_for: Optional[str] <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#79c0ff>None</span>
</span></span><span style=display:flex><span>    log: List[LogEntry] <span style=color:#ff7b72;font-weight:700>=</span> field(default_factory<span style=color:#ff7b72;font-weight:700>=</span>list)
</span></span><span style=display:flex><span>    commit_index: int <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>0</span>
</span></span><span style=display:flex><span>    last_applied: int <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic># Leaderç‰¹æœ‰çŠ¶æ€</span>
</span></span><span style=display:flex><span>    next_index: Dict[str, int] <span style=color:#ff7b72;font-weight:700>=</span> field(default_factory<span style=color:#ff7b72;font-weight:700>=</span>dict)
</span></span><span style=display:flex><span>    match_index: Dict[str, int] <span style=color:#ff7b72;font-weight:700>=</span> field(default_factory<span style=color:#ff7b72;font-weight:700>=</span>dict)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic># è¶…æ—¶è®¾ç½®</span>
</span></span><span style=display:flex><span>    election_timeout: float <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>5.0</span>
</span></span><span style=display:flex><span>    heartbeat_interval: float <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>1.0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic># è®¡æ—¶å™¨</span>
</span></span><span style=display:flex><span>    last_heartbeat: datetime <span style=color:#ff7b72;font-weight:700>=</span> field(default_factory<span style=color:#ff7b72;font-weight:700>=</span>datetime<span style=color:#ff7b72;font-weight:700>.</span>now)
</span></span><span style=display:flex><span>    last_election_attempt: datetime <span style=color:#ff7b72;font-weight:700>=</span> field(default_factory<span style=color:#ff7b72;font-weight:700>=</span>datetime<span style=color:#ff7b72;font-weight:700>.</span>now)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>__post_init__</span>(self):
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;åˆå§‹åŒ–åå¤„ç†&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>peers: List[RaftNode] <span style=color:#ff7b72;font-weight:700>=</span> []
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>vote_count: int <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>get_last_log_index</span>(self) <span style=color:#ff7b72;font-weight:700>-&gt;</span> int:
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;è·å–æœ€åä¸€æ¡æ—¥å¿—çš„ç´¢å¼•&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> len(self<span style=color:#ff7b72;font-weight:700>.</span>log) <span style=color:#ff7b72;font-weight:700>-</span> <span style=color:#a5d6ff>1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>get_last_log_term</span>(self) <span style=color:#ff7b72;font-weight:700>-&gt;</span> int:
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;è·å–æœ€åä¸€æ¡æ—¥å¿—çš„ä»»æœŸ&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>if</span> <span style=color:#ff7b72;font-weight:700>not</span> self<span style=color:#ff7b72;font-weight:700>.</span>log:
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>return</span> <span style=color:#a5d6ff>0</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> self<span style=color:#ff7b72;font-weight:700>.</span>log[<span style=color:#ff7b72;font-weight:700>-</span><span style=color:#a5d6ff>1</span>]<span style=color:#ff7b72;font-weight:700>.</span>term
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>get_log_term</span>(self, index: int) <span style=color:#ff7b72;font-weight:700>-&gt;</span> int:
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;è·å–æŒ‡å®šç´¢å¼•çš„æ—¥å¿—ä»»æœŸ&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>if</span> index <span style=color:#ff7b72;font-weight:700>&lt;</span> <span style=color:#a5d6ff>0</span> <span style=color:#ff7b72;font-weight:700>or</span> index <span style=color:#ff7b72;font-weight:700>&gt;=</span> len(self<span style=color:#ff7b72;font-weight:700>.</span>log):
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>return</span> <span style=color:#a5d6ff>0</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> self<span style=color:#ff7b72;font-weight:700>.</span>log[index]<span style=color:#ff7b72;font-weight:700>.</span>term
</span></span></code></pre></td></tr></table></div></div><h3 id=é¢†å¯¼è€…é€‰ä¸¾>é¢†å¯¼è€…é€‰ä¸¾<a hidden class=anchor aria-hidden=true href=#é¢†å¯¼è€…é€‰ä¸¾>#</a></h3><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 78
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 79
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 80
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 81
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 82
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 83
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 84
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 85
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 86
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 87
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 88
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 89
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 90
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 91
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 92
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 93
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 94
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 95
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 96
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 97
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 98
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 99
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">100
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">101
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">102
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">103
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">104
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">105
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">106
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">107
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">108
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">109
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">110
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">111
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">112
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">113
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#ff7b72>import</span> <span style=color:#ff7b72>asyncio</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>import</span> <span style=color:#ff7b72>random</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>class</span> <span style=color:#f0883e;font-weight:700>RaftElection</span>:
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#34;&#34;&#34;Rafté€‰ä¸¾æœºåˆ¶&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>__init__</span>(self, node: RaftNode):
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>node <span style=color:#ff7b72;font-weight:700>=</span> node
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>async</span> <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>start_election</span>(self) <span style=color:#ff7b72;font-weight:700>-&gt;</span> bool:
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;å¼€å§‹é€‰ä¸¾&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic># è½¬æ¢ä¸ºå€™é€‰è€…çŠ¶æ€</span>
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>node<span style=color:#ff7b72;font-weight:700>.</span>state <span style=color:#ff7b72;font-weight:700>=</span> NodeState<span style=color:#ff7b72;font-weight:700>.</span>CANDIDATE
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>node<span style=color:#ff7b72;font-weight:700>.</span>current_term <span style=color:#ff7b72;font-weight:700>+=</span> <span style=color:#a5d6ff>1</span>
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>node<span style=color:#ff7b72;font-weight:700>.</span>voted_for <span style=color:#ff7b72;font-weight:700>=</span> self<span style=color:#ff7b72;font-weight:700>.</span>node<span style=color:#ff7b72;font-weight:700>.</span>node_id
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>node<span style=color:#ff7b72;font-weight:700>.</span>vote_count <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>1</span>  <span style=color:#8b949e;font-style:italic># è‡ªå·±æŠ•ç»™è‡ªå·±</span>
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>node<span style=color:#ff7b72;font-weight:700>.</span>last_election_attempt <span style=color:#ff7b72;font-weight:700>=</span> datetime<span style=color:#ff7b72;font-weight:700>.</span>now()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        print(<span style=color:#79c0ff>f</span><span style=color:#a5d6ff>&#34;[Node </span><span style=color:#a5d6ff>{</span>self<span style=color:#ff7b72;font-weight:700>.</span>node<span style=color:#ff7b72;font-weight:700>.</span>node_id<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>] å¼€å§‹é€‰ä¸¾, Term: </span><span style=color:#a5d6ff>{</span>self<span style=color:#ff7b72;font-weight:700>.</span>node<span style=color:#ff7b72;font-weight:700>.</span>current_term<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic># å‘æ‰€æœ‰å…¶ä»–èŠ‚ç‚¹å‘é€RequestVote RPC</span>
</span></span><span style=display:flex><span>        votes_needed <span style=color:#ff7b72;font-weight:700>=</span> len(self<span style=color:#ff7b72;font-weight:700>.</span>node<span style=color:#ff7b72;font-weight:700>.</span>peers) <span style=color:#ff7b72;font-weight:700>//</span> <span style=color:#a5d6ff>2</span> <span style=color:#ff7b72;font-weight:700>+</span> <span style=color:#a5d6ff>1</span>
</span></span><span style=display:flex><span>        request_vote <span style=color:#ff7b72;font-weight:700>=</span> RequestVoteRPC(
</span></span><span style=display:flex><span>            term<span style=color:#ff7b72;font-weight:700>=</span>self<span style=color:#ff7b72;font-weight:700>.</span>node<span style=color:#ff7b72;font-weight:700>.</span>current_term,
</span></span><span style=display:flex><span>            candidate_id<span style=color:#ff7b72;font-weight:700>=</span>self<span style=color:#ff7b72;font-weight:700>.</span>node<span style=color:#ff7b72;font-weight:700>.</span>node_id,
</span></span><span style=display:flex><span>            last_log_index<span style=color:#ff7b72;font-weight:700>=</span>self<span style=color:#ff7b72;font-weight:700>.</span>node<span style=color:#ff7b72;font-weight:700>.</span>get_last_log_index(),
</span></span><span style=display:flex><span>            last_log_term<span style=color:#ff7b72;font-weight:700>=</span>self<span style=color:#ff7b72;font-weight:700>.</span>node<span style=color:#ff7b72;font-weight:700>.</span>get_last_log_term()
</span></span><span style=display:flex><span>        )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic># å¹¶å‘å‘é€æŠ•ç¥¨è¯·æ±‚</span>
</span></span><span style=display:flex><span>        tasks <span style=color:#ff7b72;font-weight:700>=</span> [
</span></span><span style=display:flex><span>            self<span style=color:#ff7b72;font-weight:700>.</span>_request_vote(peer, request_vote)
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>for</span> peer <span style=color:#ff7b72;font-weight:700>in</span> self<span style=color:#ff7b72;font-weight:700>.</span>node<span style=color:#ff7b72;font-weight:700>.</span>peers
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>if</span> peer<span style=color:#ff7b72;font-weight:700>.</span>node_id <span style=color:#ff7b72;font-weight:700>!=</span> self<span style=color:#ff7b72;font-weight:700>.</span>node<span style=color:#ff7b72;font-weight:700>.</span>node_id
</span></span><span style=display:flex><span>        ]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        results <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>await</span> asyncio<span style=color:#ff7b72;font-weight:700>.</span>gather(<span style=color:#ff7b72;font-weight:700>*</span>tasks, return_exceptions<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#79c0ff>True</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic># ç»Ÿè®¡é€‰ç¥¨</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>for</span> result <span style=color:#ff7b72;font-weight:700>in</span> results:
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>if</span> isinstance(result, bool) <span style=color:#ff7b72;font-weight:700>and</span> result:
</span></span><span style=display:flex><span>                self<span style=color:#ff7b72;font-weight:700>.</span>node<span style=color:#ff7b72;font-weight:700>.</span>vote_count <span style=color:#ff7b72;font-weight:700>+=</span> <span style=color:#a5d6ff>1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic># æ£€æŸ¥æ˜¯å¦è·å¾—å¤šæ•°ç¥¨</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>if</span> self<span style=color:#ff7b72;font-weight:700>.</span>node<span style=color:#ff7b72;font-weight:700>.</span>vote_count <span style=color:#ff7b72;font-weight:700>&gt;=</span> votes_needed:
</span></span><span style=display:flex><span>            self<span style=color:#ff7b72;font-weight:700>.</span>node<span style=color:#ff7b72;font-weight:700>.</span>state <span style=color:#ff7b72;font-weight:700>=</span> NodeState<span style=color:#ff7b72;font-weight:700>.</span>LEADER
</span></span><span style=display:flex><span>            print(<span style=color:#79c0ff>f</span><span style=color:#a5d6ff>&#34;[Node </span><span style=color:#a5d6ff>{</span>self<span style=color:#ff7b72;font-weight:700>.</span>node<span style=color:#ff7b72;font-weight:700>.</span>node_id<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>] å½“é€‰ä¸ºLeader, Term: </span><span style=color:#a5d6ff>{</span>self<span style=color:#ff7b72;font-weight:700>.</span>node<span style=color:#ff7b72;font-weight:700>.</span>current_term<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>&#34;</span>)
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>await</span> self<span style=color:#ff7b72;font-weight:700>.</span>_become_leader()
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>return</span> <span style=color:#79c0ff>True</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        print(<span style=color:#79c0ff>f</span><span style=color:#a5d6ff>&#34;[Node </span><span style=color:#a5d6ff>{</span>self<span style=color:#ff7b72;font-weight:700>.</span>node<span style=color:#ff7b72;font-weight:700>.</span>node_id<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>] é€‰ä¸¾å¤±è´¥, å¾—ç¥¨: </span><span style=color:#a5d6ff>{</span>self<span style=color:#ff7b72;font-weight:700>.</span>node<span style=color:#ff7b72;font-weight:700>.</span>vote_count<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>/</span><span style=color:#a5d6ff>{</span>votes_needed<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>&#34;</span>)
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>node<span style=color:#ff7b72;font-weight:700>.</span>state <span style=color:#ff7b72;font-weight:700>=</span> NodeState<span style=color:#ff7b72;font-weight:700>.</span>FOLLOWER
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> <span style=color:#79c0ff>False</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>async</span> <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>_request_vote</span>(self, peer: RaftNode, rpc: <span style=color:#a5d6ff>&#39;RequestVoteRPC&#39;</span>) <span style=color:#ff7b72;font-weight:700>-&gt;</span> bool:
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;è¯·æ±‚æŠ•ç¥¨&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>try</span>:
</span></span><span style=display:flex><span>            <span style=color:#8b949e;font-style:italic># æ¨¡æ‹Ÿç½‘ç»œå»¶è¿Ÿ</span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>await</span> asyncio<span style=color:#ff7b72;font-weight:700>.</span>sleep(random<span style=color:#ff7b72;font-weight:700>.</span>uniform(<span style=color:#a5d6ff>0.01</span>, <span style=color:#a5d6ff>0.05</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#8b949e;font-style:italic># å¯¹æ–¹çš„å†³ç­–é€»è¾‘</span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>if</span> rpc<span style=color:#ff7b72;font-weight:700>.</span>term <span style=color:#ff7b72;font-weight:700>&lt;</span> peer<span style=color:#ff7b72;font-weight:700>.</span>current_term:
</span></span><span style=display:flex><span>                <span style=color:#ff7b72>return</span> <span style=color:#79c0ff>False</span>  <span style=color:#8b949e;font-style:italic># å¯¹æ–¹çš„ä»»æœŸæ›´å¤§</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>if</span> rpc<span style=color:#ff7b72;font-weight:700>.</span>term <span style=color:#ff7b72;font-weight:700>&gt;</span> peer<span style=color:#ff7b72;font-weight:700>.</span>current_term:
</span></span><span style=display:flex><span>                <span style=color:#8b949e;font-style:italic># å‘ç°æ›´å¤§çš„ä»»æœŸï¼Œæ›´æ–°å¹¶æŠ•ç¥¨</span>
</span></span><span style=display:flex><span>                peer<span style=color:#ff7b72;font-weight:700>.</span>current_term <span style=color:#ff7b72;font-weight:700>=</span> rpc<span style=color:#ff7b72;font-weight:700>.</span>term
</span></span><span style=display:flex><span>                peer<span style=color:#ff7b72;font-weight:700>.</span>voted_for <span style=color:#ff7b72;font-weight:700>=</span> rpc<span style=color:#ff7b72;font-weight:700>.</span>candidate_id
</span></span><span style=display:flex><span>                peer<span style=color:#ff7b72;font-weight:700>.</span>state <span style=color:#ff7b72;font-weight:700>=</span> NodeState<span style=color:#ff7b72;font-weight:700>.</span>FOLLOWER
</span></span><span style=display:flex><span>                <span style=color:#ff7b72>return</span> <span style=color:#79c0ff>True</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#8b949e;font-style:italic># ä»»æœŸç›¸åŒï¼Œæ£€æŸ¥æ˜¯å¦å·²æŠ•ç¥¨</span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>if</span> peer<span style=color:#ff7b72;font-weight:700>.</span>voted_for <span style=color:#ff7b72;font-weight:700>is</span> <span style=color:#79c0ff>None</span> <span style=color:#ff7b72;font-weight:700>or</span> peer<span style=color:#ff7b72;font-weight:700>.</span>voted_for <span style=color:#ff7b72;font-weight:700>==</span> rpc<span style=color:#ff7b72;font-weight:700>.</span>candidate_id:
</span></span><span style=display:flex><span>                <span style=color:#8b949e;font-style:italic># æ£€æŸ¥æ—¥å¿—æ˜¯å¦è‡³å°‘ä¸€æ ·æ–°</span>
</span></span><span style=display:flex><span>                <span style=color:#ff7b72>if</span> (rpc<span style=color:#ff7b72;font-weight:700>.</span>last_log_term <span style=color:#ff7b72;font-weight:700>&gt;</span> peer<span style=color:#ff7b72;font-weight:700>.</span>get_last_log_term() <span style=color:#ff7b72;font-weight:700>or</span>
</span></span><span style=display:flex><span>                    (rpc<span style=color:#ff7b72;font-weight:700>.</span>last_log_term <span style=color:#ff7b72;font-weight:700>==</span> peer<span style=color:#ff7b72;font-weight:700>.</span>get_last_log_term() <span style=color:#ff7b72;font-weight:700>and</span>
</span></span><span style=display:flex><span>                     rpc<span style=color:#ff7b72;font-weight:700>.</span>last_log_index <span style=color:#ff7b72;font-weight:700>&gt;=</span> peer<span style=color:#ff7b72;font-weight:700>.</span>get_last_log_index())):
</span></span><span style=display:flex><span>                    peer<span style=color:#ff7b72;font-weight:700>.</span>voted_for <span style=color:#ff7b72;font-weight:700>=</span> rpc<span style=color:#ff7b72;font-weight:700>.</span>candidate_id
</span></span><span style=display:flex><span>                    <span style=color:#ff7b72>return</span> <span style=color:#79c0ff>True</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>return</span> <span style=color:#79c0ff>False</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>except</span> <span style=color:#f0883e;font-weight:700>Exception</span> <span style=color:#ff7b72>as</span> e:
</span></span><span style=display:flex><span>            print(<span style=color:#79c0ff>f</span><span style=color:#a5d6ff>&#34;[Node </span><span style=color:#a5d6ff>{</span>self<span style=color:#ff7b72;font-weight:700>.</span>node<span style=color:#ff7b72;font-weight:700>.</span>node_id<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>] è¯·æ±‚ </span><span style=color:#a5d6ff>{</span>peer<span style=color:#ff7b72;font-weight:700>.</span>node_id<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff> æŠ•ç¥¨å¤±è´¥: </span><span style=color:#a5d6ff>{</span>e<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>&#34;</span>)
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>return</span> <span style=color:#79c0ff>False</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>async</span> <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>_become_leader</span>(self):
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;æˆä¸ºLeaderåçš„åˆå§‹åŒ–&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic># åˆå§‹åŒ–next_indexå’Œmatch_index</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>for</span> peer <span style=color:#ff7b72;font-weight:700>in</span> self<span style=color:#ff7b72;font-weight:700>.</span>node<span style=color:#ff7b72;font-weight:700>.</span>peers:
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>if</span> peer<span style=color:#ff7b72;font-weight:700>.</span>node_id <span style=color:#ff7b72;font-weight:700>!=</span> self<span style=color:#ff7b72;font-weight:700>.</span>node<span style=color:#ff7b72;font-weight:700>.</span>node_id:
</span></span><span style=display:flex><span>                self<span style=color:#ff7b72;font-weight:700>.</span>node<span style=color:#ff7b72;font-weight:700>.</span>next_index[peer<span style=color:#ff7b72;font-weight:700>.</span>node_id] <span style=color:#ff7b72;font-weight:700>=</span> self<span style=color:#ff7b72;font-weight:700>.</span>node<span style=color:#ff7b72;font-weight:700>.</span>get_last_log_index() <span style=color:#ff7b72;font-weight:700>+</span> <span style=color:#a5d6ff>1</span>
</span></span><span style=display:flex><span>                self<span style=color:#ff7b72;font-weight:700>.</span>node<span style=color:#ff7b72;font-weight:700>.</span>match_index[peer<span style=color:#ff7b72;font-weight:700>.</span>node_id] <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic># ç«‹å³å‘é€å¿ƒè·³</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>await</span> self<span style=color:#ff7b72;font-weight:700>.</span>_send_heartbeat()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>async</span> <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>_send_heartbeat</span>(self):
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;å‘é€å¿ƒè·³ï¼ˆç©ºçš„AppendEntries RPCï¼‰&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>while</span> self<span style=color:#ff7b72;font-weight:700>.</span>node<span style=color:#ff7b72;font-weight:700>.</span>state <span style=color:#ff7b72;font-weight:700>==</span> NodeState<span style=color:#ff7b72;font-weight:700>.</span>LEADER:
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>for</span> peer <span style=color:#ff7b72;font-weight:700>in</span> self<span style=color:#ff7b72;font-weight:700>.</span>node<span style=color:#ff7b72;font-weight:700>.</span>peers:
</span></span><span style=display:flex><span>                <span style=color:#ff7b72>if</span> peer<span style=color:#ff7b72;font-weight:700>.</span>node_id <span style=color:#ff7b72;font-weight:700>!=</span> self<span style=color:#ff7b72;font-weight:700>.</span>node<span style=color:#ff7b72;font-weight:700>.</span>node_id:
</span></span><span style=display:flex><span>                    <span style=color:#ff7b72>await</span> self<span style=color:#ff7b72;font-weight:700>.</span>_send_append_entries(peer, empty<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#79c0ff>True</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>await</span> asyncio<span style=color:#ff7b72;font-weight:700>.</span>sleep(self<span style=color:#ff7b72;font-weight:700>.</span>node<span style=color:#ff7b72;font-weight:700>.</span>heartbeat_interval)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#d2a8ff;font-weight:700>@dataclass</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>class</span> <span style=color:#f0883e;font-weight:700>RequestVoteRPC</span>:
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#34;&#34;&#34;RequestVote RPCå‚æ•°&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>    term: int
</span></span><span style=display:flex><span>    candidate_id: str
</span></span><span style=display:flex><span>    last_log_index: int
</span></span><span style=display:flex><span>    last_log_term: int
</span></span></code></pre></td></tr></table></div></div><h3 id=æ—¥å¿—å¤åˆ¶>æ—¥å¿—å¤åˆ¶<a hidden class=anchor aria-hidden=true href=#æ—¥å¿—å¤åˆ¶>#</a></h3><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 78
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 79
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 80
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 81
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 82
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 83
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 84
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 85
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 86
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 87
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 88
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 89
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 90
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 91
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 92
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 93
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 94
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 95
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 96
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 97
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 98
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 99
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">100
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">101
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">102
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">103
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">104
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">105
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">106
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">107
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">108
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">109
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">110
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">111
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">112
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">113
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">114
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">115
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">116
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">117
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">118
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">119
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">120
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">121
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">122
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">123
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">124
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">125
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">126
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">127
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">128
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">129
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">130
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">131
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">132
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">133
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">134
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">135
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">136
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">137
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">138
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">139
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">140
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">141
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">142
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#ff7b72>class</span> <span style=color:#f0883e;font-weight:700>RaftLogReplication</span>:
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#34;&#34;&#34;Raftæ—¥å¿—å¤åˆ¶&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>__init__</span>(self, node: RaftNode):
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>node <span style=color:#ff7b72;font-weight:700>=</span> node
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>async</span> <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>replicate_log</span>(self, command: str) <span style=color:#ff7b72;font-weight:700>-&gt;</span> bool:
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;å¤åˆ¶æ—¥å¿—åˆ°æ‰€æœ‰èŠ‚ç‚¹&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>if</span> self<span style=color:#ff7b72;font-weight:700>.</span>node<span style=color:#ff7b72;font-weight:700>.</span>state <span style=color:#ff7b72;font-weight:700>!=</span> NodeState<span style=color:#ff7b72;font-weight:700>.</span>LEADER:
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>return</span> <span style=color:#79c0ff>False</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic># æ·»åŠ åˆ°æœ¬åœ°æ—¥å¿—</span>
</span></span><span style=display:flex><span>        new_entry <span style=color:#ff7b72;font-weight:700>=</span> LogEntry(
</span></span><span style=display:flex><span>            index<span style=color:#ff7b72;font-weight:700>=</span>self<span style=color:#ff7b72;font-weight:700>.</span>node<span style=color:#ff7b72;font-weight:700>.</span>get_last_log_index() <span style=color:#ff7b72;font-weight:700>+</span> <span style=color:#a5d6ff>1</span>,
</span></span><span style=display:flex><span>            term<span style=color:#ff7b72;font-weight:700>=</span>self<span style=color:#ff7b72;font-weight:700>.</span>node<span style=color:#ff7b72;font-weight:700>.</span>current_term,
</span></span><span style=display:flex><span>            command<span style=color:#ff7b72;font-weight:700>=</span>command
</span></span><span style=display:flex><span>        )
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>node<span style=color:#ff7b72;font-weight:700>.</span>log<span style=color:#ff7b72;font-weight:700>.</span>append(new_entry)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        print(<span style=color:#79c0ff>f</span><span style=color:#a5d6ff>&#34;[Leader </span><span style=color:#a5d6ff>{</span>self<span style=color:#ff7b72;font-weight:700>.</span>node<span style=color:#ff7b72;font-weight:700>.</span>node_id<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>] æ·»åŠ æ—¥å¿—: Index </span><span style=color:#a5d6ff>{</span>new_entry<span style=color:#ff7b72;font-weight:700>.</span>index<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>, Term </span><span style=color:#a5d6ff>{</span>new_entry<span style=color:#ff7b72;font-weight:700>.</span>term<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic># å¤åˆ¶åˆ°æ‰€æœ‰èŠ‚ç‚¹</span>
</span></span><span style=display:flex><span>        success_count <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>1</span>  <span style=color:#8b949e;font-style:italic># åŒ…æ‹¬Leaderè‡ªå·±</span>
</span></span><span style=display:flex><span>        tasks <span style=color:#ff7b72;font-weight:700>=</span> []
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>for</span> peer <span style=color:#ff7b72;font-weight:700>in</span> self<span style=color:#ff7b72;font-weight:700>.</span>node<span style=color:#ff7b72;font-weight:700>.</span>peers:
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>if</span> peer<span style=color:#ff7b72;font-weight:700>.</span>node_id <span style=color:#ff7b72;font-weight:700>!=</span> self<span style=color:#ff7b72;font-weight:700>.</span>node<span style=color:#ff7b72;font-weight:700>.</span>node_id:
</span></span><span style=display:flex><span>                tasks<span style=color:#ff7b72;font-weight:700>.</span>append(self<span style=color:#ff7b72;font-weight:700>.</span>_replicate_to_peer(peer))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        results <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>await</span> asyncio<span style=color:#ff7b72;font-weight:700>.</span>gather(<span style=color:#ff7b72;font-weight:700>*</span>tasks, return_exceptions<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#79c0ff>True</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>for</span> result <span style=color:#ff7b72;font-weight:700>in</span> results:
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>if</span> isinstance(result, bool) <span style=color:#ff7b72;font-weight:700>and</span> result:
</span></span><span style=display:flex><span>                success_count <span style=color:#ff7b72;font-weight:700>+=</span> <span style=color:#a5d6ff>1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic># æ£€æŸ¥æ˜¯å¦è¢«å¤šæ•°èŠ‚ç‚¹æ¥å—</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>if</span> success_count <span style=color:#ff7b72;font-weight:700>&gt;</span> len(self<span style=color:#ff7b72;font-weight:700>.</span>node<span style=color:#ff7b72;font-weight:700>.</span>peers) <span style=color:#ff7b72;font-weight:700>//</span> <span style=color:#a5d6ff>2</span>:
</span></span><span style=display:flex><span>            <span style=color:#8b949e;font-style:italic># æ›´æ–°commit_index</span>
</span></span><span style=display:flex><span>            self<span style=color:#ff7b72;font-weight:700>.</span>node<span style=color:#ff7b72;font-weight:700>.</span>commit_index <span style=color:#ff7b72;font-weight:700>=</span> new_entry<span style=color:#ff7b72;font-weight:700>.</span>index
</span></span><span style=display:flex><span>            new_entry<span style=color:#ff7b72;font-weight:700>.</span>is_committed <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#79c0ff>True</span>
</span></span><span style=display:flex><span>            print(<span style=color:#79c0ff>f</span><span style=color:#a5d6ff>&#34;[Leader </span><span style=color:#a5d6ff>{</span>self<span style=color:#ff7b72;font-weight:700>.</span>node<span style=color:#ff7b72;font-weight:700>.</span>node_id<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>] æ—¥å¿— </span><span style=color:#a5d6ff>{</span>new_entry<span style=color:#ff7b72;font-weight:700>.</span>index<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff> å·²æäº¤&#34;</span>)
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>return</span> <span style=color:#79c0ff>True</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> <span style=color:#79c0ff>False</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>async</span> <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>_replicate_to_peer</span>(self, peer: RaftNode) <span style=color:#ff7b72;font-weight:700>-&gt;</span> bool:
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;å¤åˆ¶æ—¥å¿—åˆ°æŒ‡å®šèŠ‚ç‚¹&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic># å¦‚æœnext_indexè¡¨æ˜å­˜åœ¨ä¸ä¸€è‡´ï¼Œå›é€€</span>
</span></span><span style=display:flex><span>        next_idx <span style=color:#ff7b72;font-weight:700>=</span> self<span style=color:#ff7b72;font-weight:700>.</span>node<span style=color:#ff7b72;font-weight:700>.</span>next_index<span style=color:#ff7b72;font-weight:700>.</span>get(peer<span style=color:#ff7b72;font-weight:700>.</span>node_id, <span style=color:#a5d6ff>0</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>if</span> next_idx <span style=color:#ff7b72;font-weight:700>&gt;</span> len(self<span style=color:#ff7b72;font-weight:700>.</span>node<span style=color:#ff7b72;font-weight:700>.</span>log):
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>return</span> <span style=color:#79c0ff>False</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic># æ„å»ºAppendEntries RPC</span>
</span></span><span style=display:flex><span>        prev_log_index <span style=color:#ff7b72;font-weight:700>=</span> next_idx <span style=color:#ff7b72;font-weight:700>-</span> <span style=color:#a5d6ff>1</span>
</span></span><span style=display:flex><span>        prev_log_term <span style=color:#ff7b72;font-weight:700>=</span> self<span style=color:#ff7b72;font-weight:700>.</span>node<span style=color:#ff7b72;font-weight:700>.</span>log[prev_log_index]<span style=color:#ff7b72;font-weight:700>.</span>term <span style=color:#ff7b72>if</span> prev_log_index <span style=color:#ff7b72;font-weight:700>&gt;=</span> <span style=color:#a5d6ff>0</span> <span style=color:#ff7b72>else</span> <span style=color:#a5d6ff>0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        entries <span style=color:#ff7b72;font-weight:700>=</span> self<span style=color:#ff7b72;font-weight:700>.</span>node<span style=color:#ff7b72;font-weight:700>.</span>log[next_idx:]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        rpc <span style=color:#ff7b72;font-weight:700>=</span> AppendEntriesRPC(
</span></span><span style=display:flex><span>            term<span style=color:#ff7b72;font-weight:700>=</span>self<span style=color:#ff7b72;font-weight:700>.</span>node<span style=color:#ff7b72;font-weight:700>.</span>current_term,
</span></span><span style=display:flex><span>            leader_id<span style=color:#ff7b72;font-weight:700>=</span>self<span style=color:#ff7b72;font-weight:700>.</span>node<span style=color:#ff7b72;font-weight:700>.</span>node_id,
</span></span><span style=display:flex><span>            prev_log_index<span style=color:#ff7b72;font-weight:700>=</span>prev_log_index,
</span></span><span style=display:flex><span>            prev_log_term<span style=color:#ff7b72;font-weight:700>=</span>prev_log_term,
</span></span><span style=display:flex><span>            entries<span style=color:#ff7b72;font-weight:700>=</span>entries,
</span></span><span style=display:flex><span>            leader_commit<span style=color:#ff7b72;font-weight:700>=</span>self<span style=color:#ff7b72;font-weight:700>.</span>node<span style=color:#ff7b72;font-weight:700>.</span>commit_index
</span></span><span style=display:flex><span>        )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> <span style=color:#ff7b72>await</span> self<span style=color:#ff7b72;font-weight:700>.</span>_send_append_entries(peer, empty<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#79c0ff>False</span>, rpc<span style=color:#ff7b72;font-weight:700>=</span>rpc)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>async</span> <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>_send_append_entries</span>(
</span></span><span style=display:flex><span>        self,
</span></span><span style=display:flex><span>        peer: RaftNode,
</span></span><span style=display:flex><span>        empty: bool <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#79c0ff>False</span>,
</span></span><span style=display:flex><span>        rpc: Optional[AppendEntriesRPC] <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#79c0ff>None</span>
</span></span><span style=display:flex><span>    ) <span style=color:#ff7b72;font-weight:700>-&gt;</span> bool:
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;å‘é€AppendEntries RPC&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>if</span> <span style=color:#ff7b72;font-weight:700>not</span> rpc:
</span></span><span style=display:flex><span>            rpc <span style=color:#ff7b72;font-weight:700>=</span> AppendEntriesRPC(
</span></span><span style=display:flex><span>                term<span style=color:#ff7b72;font-weight:700>=</span>self<span style=color:#ff7b72;font-weight:700>.</span>node<span style=color:#ff7b72;font-weight:700>.</span>current_term,
</span></span><span style=display:flex><span>                leader_id<span style=color:#ff7b72;font-weight:700>=</span>self<span style=color:#ff7b72;font-weight:700>.</span>node<span style=color:#ff7b72;font-weight:700>.</span>node_id,
</span></span><span style=display:flex><span>                prev_log_index<span style=color:#ff7b72;font-weight:700>=</span>self<span style=color:#ff7b72;font-weight:700>.</span>node<span style=color:#ff7b72;font-weight:700>.</span>get_last_log_index(),
</span></span><span style=display:flex><span>                prev_log_term<span style=color:#ff7b72;font-weight:700>=</span>self<span style=color:#ff7b72;font-weight:700>.</span>node<span style=color:#ff7b72;font-weight:700>.</span>get_last_log_term(),
</span></span><span style=display:flex><span>                entries<span style=color:#ff7b72;font-weight:700>=</span>[],
</span></span><span style=display:flex><span>                leader_commit<span style=color:#ff7b72;font-weight:700>=</span>self<span style=color:#ff7b72;font-weight:700>.</span>node<span style=color:#ff7b72;font-weight:700>.</span>commit_index
</span></span><span style=display:flex><span>            )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>try</span>:
</span></span><span style=display:flex><span>            <span style=color:#8b949e;font-style:italic># æ¨¡æ‹Ÿç½‘ç»œå»¶è¿Ÿ</span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>await</span> asyncio<span style=color:#ff7b72;font-weight:700>.</span>sleep(random<span style=color:#ff7b72;font-weight:700>.</span>uniform(<span style=color:#a5d6ff>0.01</span>, <span style=color:#a5d6ff>0.05</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#8b949e;font-style:italic># å¦‚æœtermè¿‡æœŸï¼Œè½¬ä¸ºfollower</span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>if</span> rpc<span style=color:#ff7b72;font-weight:700>.</span>term <span style=color:#ff7b72;font-weight:700>&gt;</span> peer<span style=color:#ff7b72;font-weight:700>.</span>current_term:
</span></span><span style=display:flex><span>                peer<span style=color:#ff7b72;font-weight:700>.</span>current_term <span style=color:#ff7b72;font-weight:700>=</span> rpc<span style=color:#ff7b72;font-weight:700>.</span>term
</span></span><span style=display:flex><span>                peer<span style=color:#ff7b72;font-weight:700>.</span>state <span style=color:#ff7b72;font-weight:700>=</span> NodeState<span style=color:#ff7b72;font-weight:700>.</span>FOLLOWER
</span></span><span style=display:flex><span>                <span style=color:#ff7b72>return</span> <span style=color:#79c0ff>False</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#8b949e;font-style:italic># å¦‚æœtermè¾ƒå°ï¼Œæ‹’ç»</span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>if</span> rpc<span style=color:#ff7b72;font-weight:700>.</span>term <span style=color:#ff7b72;font-weight:700>&lt;</span> peer<span style=color:#ff7b72;font-weight:700>.</span>current_term:
</span></span><span style=display:flex><span>                <span style=color:#ff7b72>return</span> <span style=color:#79c0ff>False</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#8b949e;font-style:italic># æ£€æŸ¥æ—¥å¿—ä¸€è‡´æ€§</span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>if</span> rpc<span style=color:#ff7b72;font-weight:700>.</span>prev_log_index <span style=color:#ff7b72;font-weight:700>&gt;=</span> <span style=color:#a5d6ff>0</span>:
</span></span><span style=display:flex><span>                <span style=color:#ff7b72>if</span> (rpc<span style=color:#ff7b72;font-weight:700>.</span>prev_log_index <span style=color:#ff7b72;font-weight:700>&gt;=</span> len(peer<span style=color:#ff7b72;font-weight:700>.</span>log) <span style=color:#ff7b72;font-weight:700>or</span>
</span></span><span style=display:flex><span>                    peer<span style=color:#ff7b72;font-weight:700>.</span>get_log_term(rpc<span style=color:#ff7b72;font-weight:700>.</span>prev_log_index) <span style=color:#ff7b72;font-weight:700>!=</span> rpc<span style=color:#ff7b72;font-weight:700>.</span>prev_log_term):
</span></span><span style=display:flex><span>                    <span style=color:#8b949e;font-style:italic># æ—¥å¿—ä¸ä¸€è‡´ï¼Œè¿”å›å¤±è´¥</span>
</span></span><span style=display:flex><span>                    <span style=color:#ff7b72>return</span> <span style=color:#79c0ff>False</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#8b949e;font-style:italic># æ—¥å¿—ä¸€è‡´ï¼Œæ·»åŠ æ–°æ¡ç›®</span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>if</span> rpc<span style=color:#ff7b72;font-weight:700>.</span>entries:
</span></span><span style=display:flex><span>                <span style=color:#8b949e;font-style:italic># åˆ é™¤å†²çªçš„æ¡ç›®</span>
</span></span><span style=display:flex><span>                peer<span style=color:#ff7b72;font-weight:700>.</span>log <span style=color:#ff7b72;font-weight:700>=</span> peer<span style=color:#ff7b72;font-weight:700>.</span>log[:rpc<span style=color:#ff7b72;font-weight:700>.</span>prev_log_index <span style=color:#ff7b72;font-weight:700>+</span> <span style=color:#a5d6ff>1</span>]
</span></span><span style=display:flex><span>                <span style=color:#8b949e;font-style:italic># æ·»åŠ æ–°æ¡ç›®</span>
</span></span><span style=display:flex><span>                peer<span style=color:#ff7b72;font-weight:700>.</span>log<span style=color:#ff7b72;font-weight:700>.</span>extend(rpc<span style=color:#ff7b72;font-weight:700>.</span>entries)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#8b949e;font-style:italic># æ›´æ–°commit_index</span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>if</span> rpc<span style=color:#ff7b72;font-weight:700>.</span>leader_commit <span style=color:#ff7b72;font-weight:700>&gt;</span> peer<span style=color:#ff7b72;font-weight:700>.</span>commit_index:
</span></span><span style=display:flex><span>                peer<span style=color:#ff7b72;font-weight:700>.</span>commit_index <span style=color:#ff7b72;font-weight:700>=</span> min(rpc<span style=color:#ff7b72;font-weight:700>.</span>leader_commit, len(peer<span style=color:#ff7b72;font-weight:700>.</span>log) <span style=color:#ff7b72;font-weight:700>-</span> <span style=color:#a5d6ff>1</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#8b949e;font-style:italic># æ›´æ–°Leaderçš„next_indexå’Œmatch_index</span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>if</span> <span style=color:#ff7b72;font-weight:700>not</span> empty:
</span></span><span style=display:flex><span>                last_new_entry <span style=color:#ff7b72;font-weight:700>=</span> rpc<span style=color:#ff7b72;font-weight:700>.</span>prev_log_index <span style=color:#ff7b72;font-weight:700>+</span> len(rpc<span style=color:#ff7b72;font-weight:700>.</span>entries)
</span></span><span style=display:flex><span>                self<span style=color:#ff7b72;font-weight:700>.</span>node<span style=color:#ff7b72;font-weight:700>.</span>next_index[peer<span style=color:#ff7b72;font-weight:700>.</span>node_id] <span style=color:#ff7b72;font-weight:700>=</span> last_new_entry <span style=color:#ff7b72;font-weight:700>+</span> <span style=color:#a5d6ff>1</span>
</span></span><span style=display:flex><span>                self<span style=color:#ff7b72;font-weight:700>.</span>node<span style=color:#ff7b72;font-weight:700>.</span>match_index[peer<span style=color:#ff7b72;font-weight:700>.</span>node_id] <span style=color:#ff7b72;font-weight:700>=</span> last_new_entry
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>return</span> <span style=color:#79c0ff>True</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>except</span> <span style=color:#f0883e;font-weight:700>Exception</span> <span style=color:#ff7b72>as</span> e:
</span></span><span style=display:flex><span>            print(<span style=color:#79c0ff>f</span><span style=color:#a5d6ff>&#34;[Leader </span><span style=color:#a5d6ff>{</span>self<span style=color:#ff7b72;font-weight:700>.</span>node<span style=color:#ff7b72;font-weight:700>.</span>node_id<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>] å¤åˆ¶åˆ° </span><span style=color:#a5d6ff>{</span>peer<span style=color:#ff7b72;font-weight:700>.</span>node_id<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff> å¤±è´¥: </span><span style=color:#a5d6ff>{</span>e<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>&#34;</span>)
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>return</span> <span style=color:#79c0ff>False</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#d2a8ff;font-weight:700>@dataclass</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>class</span> <span style=color:#f0883e;font-weight:700>AppendEntriesRPC</span>:
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#34;&#34;&#34;AppendEntries RPCå‚æ•°&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>    term: int
</span></span><span style=display:flex><span>    leader_id: str
</span></span><span style=display:flex><span>    prev_log_index: int
</span></span><span style=display:flex><span>    prev_log_term: int
</span></span><span style=display:flex><span>    entries: List[LogEntry]
</span></span><span style=display:flex><span>    leader_commit: int
</span></span></code></pre></td></tr></table></div></div><h2 id=paxosç®—æ³•>Paxosç®—æ³•<a hidden class=anchor aria-hidden=true href=#paxosç®—æ³•>#</a></h2><h3 id=basic-paxos>Basic Paxos<a hidden class=anchor aria-hidden=true href=#basic-paxos>#</a></h3><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 78
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 79
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 80
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 81
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 82
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 83
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 84
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 85
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 86
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 87
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 88
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 89
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 90
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 91
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 92
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 93
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 94
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 95
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 96
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 97
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 98
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 99
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">100
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">101
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">102
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">103
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">104
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">105
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">106
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">107
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">108
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">109
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">110
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">111
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">112
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">113
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">114
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">115
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">116
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">117
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">118
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">119
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">120
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">121
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">122
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#ff7b72>class</span> <span style=color:#f0883e;font-weight:700>PaxosProposer</span>:
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#34;&#34;&#34;Paxosæè®®è€…&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>__init__</span>(self, proposer_id: str):
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>proposer_id <span style=color:#ff7b72;font-weight:700>=</span> proposer_id
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>proposal_number <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>0</span>
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>accepted_value <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#79c0ff>None</span>
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>promises_received <span style=color:#ff7b72;font-weight:700>=</span> set()
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>accepts_received <span style=color:#ff7b72;font-weight:700>=</span> set()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>async</span> <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>propose</span>(self, value: str, quorum_size: int) <span style=color:#ff7b72;font-weight:700>-&gt;</span> Optional[str]:
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;å‘èµ·æè®®&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic># Phase 1: Prepare</span>
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>proposal_number <span style=color:#ff7b72;font-weight:700>+=</span> <span style=color:#a5d6ff>1</span>
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>promises_received<span style=color:#ff7b72;font-weight:700>.</span>clear()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        print(<span style=color:#79c0ff>f</span><span style=color:#a5d6ff>&#34;[Proposer </span><span style=color:#a5d6ff>{</span>self<span style=color:#ff7b72;font-weight:700>.</span>proposer_id<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>] Phase 1: Prepare (N=</span><span style=color:#a5d6ff>{</span>self<span style=color:#ff7b72;font-weight:700>.</span>proposal_number<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>)&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        prepare_msg <span style=color:#ff7b72;font-weight:700>=</span> PrepareMessage(
</span></span><span style=display:flex><span>            proposal_number<span style=color:#ff7b72;font-weight:700>=</span>self<span style=color:#ff7b72;font-weight:700>.</span>proposal_number,
</span></span><span style=display:flex><span>            proposer_id<span style=color:#ff7b72;font-weight:700>=</span>self<span style=color:#ff7b72;font-weight:700>.</span>proposer_id
</span></span><span style=display:flex><span>        )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic># å‘é€Prepareåˆ°æ‰€æœ‰Acceptors</span>
</span></span><span style=display:flex><span>        tasks <span style=color:#ff7b72;font-weight:700>=</span> [
</span></span><span style=display:flex><span>            self<span style=color:#ff7b72;font-weight:700>.</span>_send_prepare(acceptor, prepare_msg)
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>for</span> acceptor <span style=color:#ff7b72;font-weight:700>in</span> self<span style=color:#ff7b72;font-weight:700>.</span>acceptors
</span></span><span style=display:flex><span>        ]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        responses <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>await</span> asyncio<span style=color:#ff7b72;font-weight:700>.</span>gather(<span style=color:#ff7b72;font-weight:700>*</span>tasks, return_exceptions<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#79c0ff>True</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic># ç»Ÿè®¡Promiseå“åº”</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>for</span> response <span style=color:#ff7b72;font-weight:700>in</span> responses:
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>if</span> isinstance(response, PromiseMessage):
</span></span><span style=display:flex><span>                self<span style=color:#ff7b72;font-weight:700>.</span>promises_received<span style=color:#ff7b72;font-weight:700>.</span>add(response<span style=color:#ff7b72;font-weight:700>.</span>acceptor_id)
</span></span><span style=display:flex><span>                <span style=color:#8b949e;font-style:italic># å¦‚æœæœ‰å·²æ¥å—çš„å€¼ï¼Œä½¿ç”¨å®ƒ</span>
</span></span><span style=display:flex><span>                <span style=color:#ff7b72>if</span> response<span style=color:#ff7b72;font-weight:700>.</span>accepted_number <span style=color:#ff7b72;font-weight:700>&gt;</span> <span style=color:#a5d6ff>0</span>:
</span></span><span style=display:flex><span>                    self<span style=color:#ff7b72;font-weight:700>.</span>accepted_value <span style=color:#ff7b72;font-weight:700>=</span> response<span style=color:#ff7b72;font-weight:700>.</span>accepted_value
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic># æ£€æŸ¥æ˜¯å¦è·å¾—å¤šæ•°Promise</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>if</span> len(self<span style=color:#ff7b72;font-weight:700>.</span>promises_received) <span style=color:#ff7b72;font-weight:700>&lt;</span> quorum_size:
</span></span><span style=display:flex><span>            print(<span style=color:#79c0ff>f</span><span style=color:#a5d6ff>&#34;[Proposer </span><span style=color:#a5d6ff>{</span>self<span style=color:#ff7b72;font-weight:700>.</span>proposer_id<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>] Phase 1 å¤±è´¥: æœªè·å¾—å¤šæ•°Promise&#34;</span>)
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>return</span> <span style=color:#79c0ff>None</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        print(<span style=color:#79c0ff>f</span><span style=color:#a5d6ff>&#34;[Proposer </span><span style=color:#a5d6ff>{</span>self<span style=color:#ff7b72;font-weight:700>.</span>proposer_id<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>] Phase 1 æˆåŠŸ: è·å¾— </span><span style=color:#a5d6ff>{</span>len(self<span style=color:#ff7b72;font-weight:700>.</span>promises_received)<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff> ä¸ªPromise&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic># Phase 2: Accept</span>
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>accepts_received<span style=color:#ff7b72;font-weight:700>.</span>clear()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic># ä½¿ç”¨å·²æ¥å—çš„å€¼æˆ–æè®®çš„æ–°å€¼</span>
</span></span><span style=display:flex><span>        value_to_propose <span style=color:#ff7b72;font-weight:700>=</span> self<span style=color:#ff7b72;font-weight:700>.</span>accepted_value <span style=color:#ff7b72>if</span> self<span style=color:#ff7b72;font-weight:700>.</span>accepted_value <span style=color:#ff7b72>else</span> value
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        accept_msg <span style=color:#ff7b72;font-weight:700>=</span> AcceptMessage(
</span></span><span style=display:flex><span>            proposal_number<span style=color:#ff7b72;font-weight:700>=</span>self<span style=color:#ff7b72;font-weight:700>.</span>proposal_number,
</span></span><span style=display:flex><span>            value<span style=color:#ff7b72;font-weight:700>=</span>value_to_propose,
</span></span><span style=display:flex><span>            proposer_id<span style=color:#ff7b72;font-weight:700>=</span>self<span style=color:#ff7b72;font-weight:700>.</span>proposer_id
</span></span><span style=display:flex><span>        )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        print(<span style=color:#79c0ff>f</span><span style=color:#a5d6ff>&#34;[Proposer </span><span style=color:#a5d6ff>{</span>self<span style=color:#ff7b72;font-weight:700>.</span>proposer_id<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>] Phase 2: Accept (Value=</span><span style=color:#a5d6ff>{</span>value_to_propose<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>)&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic># å‘é€Acceptåˆ°æ‰€æœ‰Acceptors</span>
</span></span><span style=display:flex><span>        tasks <span style=color:#ff7b72;font-weight:700>=</span> [
</span></span><span style=display:flex><span>            self<span style=color:#ff7b72;font-weight:700>.</span>_send_accept(acceptor, accept_msg)
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>for</span> acceptor <span style=color:#ff7b72;font-weight:700>in</span> self<span style=color:#ff7b72;font-weight:700>.</span>acceptors
</span></span><span style=display:flex><span>        ]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        responses <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>await</span> asyncio<span style=color:#ff7b72;font-weight:700>.</span>gather(<span style=color:#ff7b72;font-weight:700>*</span>tasks, return_exceptions<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#79c0ff>True</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic># ç»Ÿè®¡Acceptedå“åº”</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>for</span> response <span style=color:#ff7b72;font-weight:700>in</span> responses:
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>if</span> isinstance(response, AcceptedMessage):
</span></span><span style=display:flex><span>                self<span style=color:#ff7b72;font-weight:700>.</span>accepts_received<span style=color:#ff7b72;font-weight:700>.</span>add(response<span style=color:#ff7b72;font-weight:700>.</span>acceptor_id)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic># æ£€æŸ¥æ˜¯å¦è·å¾—å¤šæ•°Accepted</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>if</span> len(self<span style=color:#ff7b72;font-weight:700>.</span>accepts_received) <span style=color:#ff7b72;font-weight:700>&gt;=</span> quorum_size:
</span></span><span style=display:flex><span>            print(<span style=color:#79c0ff>f</span><span style=color:#a5d6ff>&#34;[Proposer </span><span style=color:#a5d6ff>{</span>self<span style=color:#ff7b72;font-weight:700>.</span>proposer_id<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>] Phase 2 æˆåŠŸ: å€¼ &#39;</span><span style=color:#a5d6ff>{</span>value_to_propose<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>&#39; å·²è¾¾æˆå…±è¯†&#34;</span>)
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>return</span> value_to_propose
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        print(<span style=color:#79c0ff>f</span><span style=color:#a5d6ff>&#34;[Proposer </span><span style=color:#a5d6ff>{</span>self<span style=color:#ff7b72;font-weight:700>.</span>proposer_id<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>] Phase 2 å¤±è´¥: æœªè·å¾—å¤šæ•°Accepted&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> <span style=color:#79c0ff>None</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>async</span> <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>_send_prepare</span>(self, acceptor: <span style=color:#a5d6ff>&#39;PaxosAcceptor&#39;</span>, msg: PrepareMessage) <span style=color:#ff7b72;font-weight:700>-&gt;</span> Optional[<span style=color:#a5d6ff>&#39;PromiseMessage&#39;</span>]:
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;å‘é€Prepareæ¶ˆæ¯&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>try</span>:
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>await</span> asyncio<span style=color:#ff7b72;font-weight:700>.</span>sleep(random<span style=color:#ff7b72;font-weight:700>.</span>uniform(<span style=color:#a5d6ff>0.01</span>, <span style=color:#a5d6ff>0.05</span>))
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>return</span> <span style=color:#ff7b72>await</span> acceptor<span style=color:#ff7b72;font-weight:700>.</span>receive_prepare(msg)
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>except</span> <span style=color:#f0883e;font-weight:700>Exception</span> <span style=color:#ff7b72>as</span> e:
</span></span><span style=display:flex><span>            print(<span style=color:#79c0ff>f</span><span style=color:#a5d6ff>&#34;[Proposer </span><span style=color:#a5d6ff>{</span>self<span style=color:#ff7b72;font-weight:700>.</span>proposer_id<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>] Prepareå¤±è´¥: </span><span style=color:#a5d6ff>{</span>e<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>&#34;</span>)
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>return</span> <span style=color:#79c0ff>None</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>async</span> <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>_send_accept</span>(self, acceptor: <span style=color:#a5d6ff>&#39;PaxosAcceptor&#39;</span>, msg: AcceptMessage) <span style=color:#ff7b72;font-weight:700>-&gt;</span> Optional[<span style=color:#a5d6ff>&#39;AcceptedMessage&#39;</span>]:
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;å‘é€Acceptæ¶ˆæ¯&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>try</span>:
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>await</span> asyncio<span style=color:#ff7b72;font-weight:700>.</span>sleep(random<span style=color:#ff7b72;font-weight:700>.</span>uniform(<span style=color:#a5d6ff>0.01</span>, <span style=color:#a5d6ff>0.05</span>))
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>return</span> <span style=color:#ff7b72>await</span> acceptor<span style=color:#ff7b72;font-weight:700>.</span>receive_accept(msg)
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>except</span> <span style=color:#f0883e;font-weight:700>Exception</span> <span style=color:#ff7b72>as</span> e:
</span></span><span style=display:flex><span>            print(<span style=color:#79c0ff>f</span><span style=color:#a5d6ff>&#34;[Proposer </span><span style=color:#a5d6ff>{</span>self<span style=color:#ff7b72;font-weight:700>.</span>proposer_id<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>] Acceptå¤±è´¥: </span><span style=color:#a5d6ff>{</span>e<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>&#34;</span>)
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>return</span> <span style=color:#79c0ff>None</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#d2a8ff;font-weight:700>@dataclass</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>class</span> <span style=color:#f0883e;font-weight:700>PrepareMessage</span>:
</span></span><span style=display:flex><span>    proposal_number: int
</span></span><span style=display:flex><span>    proposer_id: str
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#d2a8ff;font-weight:700>@dataclass</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>class</span> <span style=color:#f0883e;font-weight:700>PromiseMessage</span>:
</span></span><span style=display:flex><span>    acceptor_id: str
</span></span><span style=display:flex><span>    proposal_number: int
</span></span><span style=display:flex><span>    accepted_number: int <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>0</span>
</span></span><span style=display:flex><span>    accepted_value: Optional[str] <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#79c0ff>None</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#d2a8ff;font-weight:700>@dataclass</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>class</span> <span style=color:#f0883e;font-weight:700>AcceptMessage</span>:
</span></span><span style=display:flex><span>    proposal_number: int
</span></span><span style=display:flex><span>    value: str
</span></span><span style=display:flex><span>    proposer_id: str
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#d2a8ff;font-weight:700>@dataclass</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>class</span> <span style=color:#f0883e;font-weight:700>AcceptedMessage</span>:
</span></span><span style=display:flex><span>    acceptor_id: str
</span></span><span style=display:flex><span>    proposal_number: int
</span></span></code></pre></td></tr></table></div></div><h2 id=epaxosephemeral-paxos>EPaxOSï¼ˆEphemeral Paxosï¼‰<a hidden class=anchor aria-hidden=true href=#epaxosephemeral-paxos>#</a></h2><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">78
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">79
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">80
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">81
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">82
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">83
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">84
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">85
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">86
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">87
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">88
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">89
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">90
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">91
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">92
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">93
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">94
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">95
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">96
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#ff7b72>class</span> <span style=color:#f0883e;font-weight:700>EPaxosNode</span>:
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#34;&#34;&#34;EPaxOSèŠ‚ç‚¹ - ä¼˜åŒ–Leaderlessåœºæ™¯&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>__init__</span>(self, node_id: str, cluster: List[str]):
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>node_id <span style=color:#ff7b72;font-weight:700>=</span> node_id
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>cluster <span style=color:#ff7b72;font-weight:700>=</span> cluster
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>instance_number <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>0</span>
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>dependencies: Dict[int, set] <span style=color:#ff7b72;font-weight:700>=</span> {}
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>log: Dict[int, str] <span style=color:#ff7b72;font-weight:700>=</span> {}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>async</span> <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>fast_write</span>(self, key: str, value: str) <span style=color:#ff7b72;font-weight:700>-&gt;</span> bool:
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;å¿«é€Ÿå†™å…¥ï¼ˆå•è½®RPCï¼‰&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>instance_number <span style=color:#ff7b72;font-weight:700>+=</span> <span style=color:#a5d6ff>1</span>
</span></span><span style=display:flex><span>        instance <span style=color:#ff7b72;font-weight:700>=</span> self<span style=color:#ff7b72;font-weight:700>.</span>instance_number
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic># é€‰æ‹©ä¾èµ–é›†åˆ</span>
</span></span><span style=display:flex><span>        deps <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>await</span> self<span style=color:#ff7b72;font-weight:700>.</span>_get_dependencies(key)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic># å‘é€PreAcceptåˆ°æ‰€æœ‰èŠ‚ç‚¹</span>
</span></span><span style=display:flex><span>        preaccept_msg <span style=color:#ff7b72;font-weight:700>=</span> PreAcceptMessage(
</span></span><span style=display:flex><span>            instance<span style=color:#ff7b72;font-weight:700>=</span>instance,
</span></span><span style=display:flex><span>            key<span style=color:#ff7b72;font-weight:700>=</span>key,
</span></span><span style=display:flex><span>            value<span style=color:#ff7b72;font-weight:700>=</span>value,
</span></span><span style=display:flex><span>            dependencies<span style=color:#ff7b72;font-weight:700>=</span>deps,
</span></span><span style=display:flex><span>            from_node<span style=color:#ff7b72;font-weight:700>=</span>self<span style=color:#ff7b72;font-weight:700>.</span>node_id
</span></span><span style=display:flex><span>        )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        print(<span style=color:#79c0ff>f</span><span style=color:#a5d6ff>&#34;[EPaxOS </span><span style=color:#a5d6ff>{</span>self<span style=color:#ff7b72;font-weight:700>.</span>node_id<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>] Fast Write: </span><span style=color:#a5d6ff>{</span>key<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>=</span><span style=color:#a5d6ff>{</span>value<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic># å¹¶å‘å‘é€</span>
</span></span><span style=display:flex><span>        tasks <span style=color:#ff7b72;font-weight:700>=</span> [
</span></span><span style=display:flex><span>            self<span style=color:#ff7b72;font-weight:700>.</span>_send_preaccept(node, preaccept_msg)
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>for</span> node <span style=color:#ff7b72;font-weight:700>in</span> self<span style=color:#ff7b72;font-weight:700>.</span>cluster
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>if</span> node <span style=color:#ff7b72;font-weight:700>!=</span> self<span style=color:#ff7b72;font-weight:700>.</span>node_id
</span></span><span style=display:flex><span>        ]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        responses <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>await</span> asyncio<span style=color:#ff7b72;font-weight:700>.</span>gather(<span style=color:#ff7b72;font-weight:700>*</span>tasks, return_exceptions<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#79c0ff>True</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic># ç»Ÿè®¡å“åº”</span>
</span></span><span style=display:flex><span>        success_count <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>1</span>  <span style=color:#8b949e;font-style:italic># åŒ…æ‹¬è‡ªå·±</span>
</span></span><span style=display:flex><span>        all_deps_match <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#79c0ff>True</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>for</span> response <span style=color:#ff7b72;font-weight:700>in</span> responses:
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>if</span> isinstance(response, PreAcceptResponse):
</span></span><span style=display:flex><span>                success_count <span style=color:#ff7b72;font-weight:700>+=</span> <span style=color:#a5d6ff>1</span>
</span></span><span style=display:flex><span>                <span style=color:#8b949e;font-style:italic># æ£€æŸ¥ä¾èµ–æ˜¯å¦ä¸€è‡´</span>
</span></span><span style=display:flex><span>                <span style=color:#ff7b72>if</span> response<span style=color:#ff7b72;font-weight:700>.</span>dependencies <span style=color:#ff7b72;font-weight:700>!=</span> deps:
</span></span><span style=display:flex><span>                    all_deps_match <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#79c0ff>False</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic># å¦‚æœå¤šæ•°èŠ‚ç‚¹åŒæ„ä¸”ä¾èµ–ä¸€è‡´ï¼Œå¿«é€Ÿæäº¤</span>
</span></span><span style=display:flex><span>        quorum <span style=color:#ff7b72;font-weight:700>=</span> len(self<span style=color:#ff7b72;font-weight:700>.</span>cluster) <span style=color:#ff7b72;font-weight:700>//</span> <span style=color:#a5d6ff>2</span> <span style=color:#ff7b72;font-weight:700>+</span> <span style=color:#a5d6ff>1</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>if</span> success_count <span style=color:#ff7b72;font-weight:700>&gt;=</span> quorum <span style=color:#ff7b72;font-weight:700>and</span> all_deps_match:
</span></span><span style=display:flex><span>            self<span style=color:#ff7b72;font-weight:700>.</span>log[instance] <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#79c0ff>f</span><span style=color:#a5d6ff>&#34;</span><span style=color:#a5d6ff>{</span>key<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>=</span><span style=color:#a5d6ff>{</span>value<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>&#34;</span>
</span></span><span style=display:flex><span>            print(<span style=color:#79c0ff>f</span><span style=color:#a5d6ff>&#34;[EPaxOS </span><span style=color:#a5d6ff>{</span>self<span style=color:#ff7b72;font-weight:700>.</span>node_id<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>] Fast Commit: </span><span style=color:#a5d6ff>{</span>key<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>=</span><span style=color:#a5d6ff>{</span>value<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>&#34;</span>)
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>return</span> <span style=color:#79c0ff>True</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic># å¦åˆ™å›é€€åˆ°æ ‡å‡†Paxos</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> <span style=color:#ff7b72>await</span> self<span style=color:#ff7b72;font-weight:700>.</span>_slow_write(instance, key, value, deps)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>async</span> <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>_get_dependencies</span>(self, key: str) <span style=color:#ff7b72;font-weight:700>-&gt;</span> set:
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;è·å–ä¾èµ–é›†åˆ&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic># ç®€åŒ–å®ç°ï¼šæŸ¥æ‰¾åŒä¸€keyçš„æœ€æ–°å®ä¾‹</span>
</span></span><span style=display:flex><span>        deps <span style=color:#ff7b72;font-weight:700>=</span> set()
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>for</span> inst, val <span style=color:#ff7b72;font-weight:700>in</span> self<span style=color:#ff7b72;font-weight:700>.</span>log<span style=color:#ff7b72;font-weight:700>.</span>items():
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>if</span> val<span style=color:#ff7b72;font-weight:700>.</span>startswith(<span style=color:#79c0ff>f</span><span style=color:#a5d6ff>&#34;</span><span style=color:#a5d6ff>{</span>key<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>=&#34;</span>):
</span></span><span style=display:flex><span>                deps<span style=color:#ff7b72;font-weight:700>.</span>add(inst)
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> deps
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>async</span> <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>_send_preaccept</span>(self, node: str, msg: PreAcceptMessage) <span style=color:#ff7b72;font-weight:700>-&gt;</span> Optional[PreAcceptResponse]:
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;å‘é€PreAcceptæ¶ˆæ¯&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic># å®é™…å®ç°ä¸­è¿™é‡Œæ˜¯RPCè°ƒç”¨</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>await</span> asyncio<span style=color:#ff7b72;font-weight:700>.</span>sleep(random<span style=color:#ff7b72;font-weight:700>.</span>uniform(<span style=color:#a5d6ff>0.01</span>, <span style=color:#a5d6ff>0.05</span>))
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> PreAcceptResponse(
</span></span><span style=display:flex><span>            from_node<span style=color:#ff7b72;font-weight:700>=</span>node,
</span></span><span style=display:flex><span>            dependencies<span style=color:#ff7b72;font-weight:700>=</span>msg<span style=color:#ff7b72;font-weight:700>.</span>dependencies<span style=color:#ff7b72;font-weight:700>.</span>copy()
</span></span><span style=display:flex><span>        )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>async</span> <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>_slow_write</span>(self, instance: int, key: str, value: str, deps: set) <span style=color:#ff7b72;font-weight:700>-&gt;</span> bool:
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;æ…¢é€Ÿå†™å…¥ï¼ˆæ ‡å‡†Paxosï¼‰&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        print(<span style=color:#79c0ff>f</span><span style=color:#a5d6ff>&#34;[EPaxOS </span><span style=color:#a5d6ff>{</span>self<span style=color:#ff7b72;font-weight:700>.</span>node_id<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>] Slow Write: </span><span style=color:#a5d6ff>{</span>key<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>=</span><span style=color:#a5d6ff>{</span>value<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic># å®ç°æ ‡å‡†Paxos Accepté˜¶æ®µ</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> <span style=color:#79c0ff>True</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#d2a8ff;font-weight:700>@dataclass</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>class</span> <span style=color:#f0883e;font-weight:700>PreAcceptMessage</span>:
</span></span><span style=display:flex><span>    instance: int
</span></span><span style=display:flex><span>    key: str
</span></span><span style=display:flex><span>    value: str
</span></span><span style=display:flex><span>    dependencies: set
</span></span><span style=display:flex><span>    from_node: str
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#d2a8ff;font-weight:700>@dataclass</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>class</span> <span style=color:#f0883e;font-weight:700>PreAcceptResponse</span>:
</span></span><span style=display:flex><span>    from_node: str
</span></span><span style=display:flex><span>    dependencies: set
</span></span></code></pre></td></tr></table></div></div><h2 id=ä¸€è‡´æ€§ç®—æ³•é€‰å‹>ä¸€è‡´æ€§ç®—æ³•é€‰å‹<a hidden class=anchor aria-hidden=true href=#ä¸€è‡´æ€§ç®—æ³•é€‰å‹>#</a></h2><table><thead><tr><th>ç®—æ³•</th><th>é€‚ç”¨åœºæ™¯</th><th>ä¼˜ç‚¹</th><th>ç¼ºç‚¹</th></tr></thead><tbody><tr><td>Raft</td><td>æ—¥å¿—å¤åˆ¶ã€é…ç½®ç®¡ç†</td><td>æ˜“ç†è§£ã€å®ç°ç®€å•</td><td>Leaderç“¶é¢ˆ</td></tr><tr><td>Paxos</td><td>é€šç”¨å…±è¯†</td><td>ç†è®ºå®Œå¤‡</td><td>å®ç°å¤æ‚</td></tr><tr><td>EPaxOS</td><td>å¤šä¸»å†™å…¥ã€è·¨åœ°åŸŸ</td><td>æ— Leaderã€ä½å»¶è¿Ÿ</td><td>å®ç°å¤æ‚</td></tr><tr><td>Gossip</td><td>æœ€ç»ˆä¸€è‡´æ€§</td><td>ç®€å•ã€å®¹é”™å¥½</td><td>ä¸€è‡´æ€§å¼±</td></tr></tbody></table><h2 id=æœ€ä½³å®è·µ>æœ€ä½³å®è·µ<a hidden class=anchor aria-hidden=true href=#æœ€ä½³å®è·µ>#</a></h2><ol><li><strong>ç†è§£CAPæƒè¡¡</strong>ï¼šæ ¹æ®ä¸šåŠ¡éœ€æ±‚é€‰æ‹©åˆé€‚çš„ä¸€è‡´æ€§çº§åˆ«</li><li><strong>ç›‘æ§é›†ç¾¤å¥åº·</strong>ï¼šæŒç»­è·Ÿè¸ªèŠ‚ç‚¹çŠ¶æ€å’Œé€‰ä¸¾æƒ…å†µ</li><li><strong>å¤„ç†è„‘è£‚</strong>ï¼šé€šè¿‡Quorumæœºåˆ¶é¿å…è„‘è£‚</li><li><strong>ä¼˜åŒ–ç½‘ç»œ</strong>ï¼šå‡å°‘RPCå»¶è¿Ÿå¯¹æ€§èƒ½çš„å½±å“</li><li><strong>æ—¥å¿—å‹ç¼©</strong>ï¼šå®šæœŸæ¸…ç†å·²æäº¤çš„æ—¥å¿—</li><li><strong>å¿«ç…§æœºåˆ¶</strong>ï¼šå‡å°‘æ¢å¤æ—¶é—´</li></ol><p>åˆ†å¸ƒå¼ä¸€è‡´æ€§æ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿçš„åŸºçŸ³ã€‚é€‰æ‹©åˆé€‚çš„ç®—æ³•å¹¶æ­£ç¡®å®ç°ï¼Œæ˜¯æ„å»ºå¯é ç³»ç»Ÿçš„å…³é”®ã€‚</p></div><footer class=post-footer-modern><div class=post-tags-modern><span class=tags-label>ğŸ·ï¸ æ ‡ç­¾</span><div class=tags-list><a href=/blog/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F/ class=tag-pill>åˆ†å¸ƒå¼ç³»ç»Ÿ
</a><a href=/blog/tags/%E4%B8%80%E8%87%B4%E6%80%A7%E7%AE%97%E6%B3%95/ class=tag-pill>ä¸€è‡´æ€§ç®—æ³•
</a><a href=/blog/tags/paxos/ class=tag-pill>Paxos
</a><a href=/blog/tags/raft/ class=tag-pill>Raft
</a><a href=/blog/tags/%E5%85%B1%E8%AF%86/ class=tag-pill>å…±è¯†</a></div></div><style>.post-footer-modern{margin-top:3rem;padding-top:2rem;border-top:1px solid var(--border,#333333)}.post-tags-modern{display:flex;align-items:center;gap:1rem;margin-bottom:2rem;flex-wrap:wrap}.tags-label{font-size:.875rem;font-weight:600;color:var(--secondary,#999999) !important;white-space:nowrap}.tags-list{display:flex;flex-wrap:wrap;gap:.5rem;flex:1}.tag-pill{display:inline-block;padding:.25rem .75rem;background:rgba(255,255,255,5%);border:1px solid var(--border,#333333);border-radius:0;color:var(--secondary,#cccccc) !important;text-decoration:none;font-size:.8rem;font-weight:500;transition:all .2s ease}.tag-pill:hover{background:var(--primary,#ffffff);color:var(--background,#000000) !important;border-color:var(--primary,#ffffff);transform:translateY(-1px)}.post-nav-modern{margin-top:2rem}.nav-grid{display:grid;grid-template-columns:1fr 1fr;gap:1rem}.nav-card{display:flex;align-items:center;gap:1rem;padding:1.25rem;background:rgba(255,255,255,2%);border:1px solid var(--border,#333333);border-radius:12px;text-decoration:none;transition:all .2s ease;min-height:80px}.nav-card:hover{background:rgba(255,255,255,5%);border-color:var(--primary,#ffffff);transform:translateY(-2px)}.nav-card.nav-prev{justify-content:flex-start}.nav-card.nav-next{justify-content:flex-end;text-align:right}.nav-card.nav-next .nav-content{text-align:right}.nav-empty{display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,1%);border:1px dashed var(--border,#333333);color:var(--secondary,#666666)}.nav-arrow{font-size:1.5rem;color:var(--primary,#ffffff);font-weight:300}.nav-content{flex:1}.nav-title{font-size:.95rem;font-weight:600;color:var(--primary,#ffffff) !important;line-height:1.4;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}[data-theme=light] .post-footer-modern{border-color:var(--border-light,#dee2e6)}[data-theme=light] .tags-label{color:var(--secondary-light,#6c757d) !important}[data-theme=light] .tag-pill{background:rgba(0,0,0,5%);border-color:var(--border-light,#dee2e6);color:var(--secondary-light,#495057) !important}[data-theme=light] .tag-pill:hover{background:var(--primary-light,#0066cc);color:var(--background-light,#ffffff) !important;border-color:var(--primary-light,#0066cc)}[data-theme=light] .nav-card{background:rgba(0,0,0,2%);border-color:var(--border-light,#dee2e6)}[data-theme=light] .nav-card:hover{background:rgba(0,102,204,5%);border-color:var(--primary-light,#0066cc)}[data-theme=light] .nav-empty{background:rgba(0,0,0,1%);border-color:var(--border-light,#dee2e6);color:var(--secondary-light,#6c757d)}[data-theme=light] .nav-arrow{color:var(--primary-light,#0066cc)}[data-theme=light] .nav-title{color:var(--primary-light,#212529) !important}@media(max-width:768px){.nav-grid{grid-template-columns:1fr;gap:.75rem}.nav-card{padding:1rem;min-height:70px}.nav-card.nav-next{text-align:left}.nav-card.nav-next .nav-content{text-align:left}.nav-title{font-size:.875rem}.post-tags-modern{flex-direction:column;gap:.75rem}}@media(max-width:480px){.nav-arrow{font-size:1.25rem}.nav-card{padding:.875rem}.nav-title{font-size:.8rem;-webkit-line-clamp:1}}</style><nav class=post-nav-modern><div class=nav-grid><a href=/blog/articles/%E7%8E%B0%E4%BB%A3%E5%89%8D%E7%AB%AF%E6%9E%B6%E6%9E%84%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90%E6%9E%84%E5%BB%BA%E5%8F%AF%E6%89%A9%E5%B1%95%E7%9A%84%E5%A4%A7%E5%9E%8B%E5%BA%94%E7%94%A8/ class="nav-card nav-prev"><div class=nav-arrow>â†</div><div class=nav-content><div class=nav-title>ç°ä»£å‰ç«¯æ¶æ„æ·±åº¦è§£æï¼šæ„å»ºå¯æ‰©å±•çš„å¤§å‹åº”ç”¨</div></div></a><a href=/blog/articles/%E5%90%8E%E7%AB%AF%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1%E4%BB%8E%E5%8D%95%E4%BD%93%E5%88%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%E7%9A%84%E6%BC%94%E8%BF%9B%E4%B9%8B%E8%B7%AF/ class="nav-card nav-next"><div class=nav-content><div class=nav-title>åç«¯ç³»ç»Ÿæ¶æ„è®¾è®¡ï¼šä»å•ä½“åˆ°å¾®æœåŠ¡çš„æ¼”è¿›ä¹‹è·¯</div></div><div class=nav-arrow>â†’</div></a></div></nav></footer></main><aside class=post-sidebar><div class=sidebar-toc id=sidebar-toc><div class=toc-header><div class=toc-title>ç›®å½•</div><button class=toc-toggle id=toc-toggle aria-label="Toggle TOC">
<svg class="toc-toggle-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6 6 18M6 6l12 12"/></svg></button></div><div class=toc-content id=toc-content><ul class=toc-list><li class="toc-item toc-h2"><a href=#h2-0 class=toc-item-link><span class=toc-item-text>ä¸€è‡´æ€§é—®é¢˜åŸºç¡€</span></a></li><li class="toc-item toc-h2"><a href=#h2-1 class=toc-item-link><span class=toc-item-text>Raftç®—æ³•è¯¦è§£</span></a></li><li class="toc-item toc-h2"><a href=#h2-2 class=toc-item-link><span class=toc-item-text>Paxosç®—æ³•</span></a></li><li class="toc-item toc-h2"><a href=#h2-3 class=toc-item-link><span class=toc-item-text>EPaxOSï¼ˆEphemeral Paxosï¼‰</span></a></li><li class="toc-item toc-h2"><a href=#h2-4 class=toc-item-link><span class=toc-item-text>ä¸€è‡´æ€§ç®—æ³•é€‰å‹</span></a></li><li class="toc-item toc-h2"><a href=#h2-5 class=toc-item-link><span class=toc-item-text>æœ€ä½³å®è·µ</span></a></li></ul></div></div><script>document.addEventListener("DOMContentLoaded",function(){const e=document.getElementById("sidebar-toc"),t=document.getElementById("toc-toggle"),o=document.getElementById("toc-content"),i=t?.querySelector(".toc-toggle-icon");if(!e)return;let n=!1;t&&t.addEventListener("click",function(){n=!n,n?(o.style.display="none",e.style.width="auto",i.innerHTML='<path d="M9 18l6-6-6-6"/>'):(o.style.display="block",e.style.width="200px",i.innerHTML='<path d="M18 6L6 18M6 6l12 12"/>')});const s=document.querySelector(".post-content");if(s){const e=s.querySelectorAll("h1");e.forEach((e,t)=>{e.id=`h1-${t}`});const t=s.querySelectorAll("h2");t.forEach((e,t)=>{e.id=`h2-${t}`})}const a=document.querySelectorAll(".toc-item-link");a.forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();const n=this.getAttribute("href").substring(1),t=document.getElementById(n);if(t){const e=document.querySelector(".post-header-main")?.offsetHeight||0,n=t.offsetTop-e-20;window.scrollTo({top:n,behavior:"smooth"})}})})})</script><style>.sidebar-toc{position:sticky;top:2rem;width:200px;background:#fff;border:1px solid #e5e7eb;border-radius:4px;overflow:hidden;box-shadow:0 1px 3px rgba(0,0,0,.1);z-index:100}.sidebar-toc.hidden{display:none}.toc-header{padding:12px 16px;border-bottom:1px solid #e5e7eb;background:#fafbfc;display:flex;align-items:center;justify-content:space-between}.toc-title{margin:0;font-size:13px;font-weight:500;color:#374151 !important;font-family:-apple-system,BlinkMacSystemFont,segoe ui,Roboto,sans-serif;text-transform:uppercase;letter-spacing:1px}.toc-toggle{background:0 0;border:none;cursor:pointer;padding:4px;border-radius:4px;display:flex;align-items:center;justify-content:center;transition:all .2s ease;color:#6b7280}.toc-toggle:hover{background:#e5e7eb;color:#374151}.toc-toggle-icon{transition:transform .2s ease}.toc-content{padding:12px 0}.toc-list{list-style:none;margin:0;padding:0}.toc-item{margin-bottom:4px;display:block !important;visibility:visible !important}.toc-h1,.toc-h2{display:block !important}.toc-h2{margin-left:0}.toc-item-link{display:flex;align-items:center;gap:8px;padding:8px 12px;color:#374151 !important;text-decoration:none;font-size:13px;line-height:1.4;border-radius:3px;transition:all .2s ease;font-weight:400}.toc-item-link:hover{background:#f8fafc;color:#1f2937 !important}.toc-item-link.active{background:#e0f2fe;color:#01579b !important;font-weight:500}.toc-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}.dot-red{background:#ef4444}.dot-blue{background:#2196f3}.toc-item-text{color:#1f2937 !important;font-weight:400;flex:1;display:inline !important;visibility:visible !important;opacity:1 !important;font-size:13px !important;line-height:1.4 !important}.toc-item-link .toc-item-text{color:#1f2937 !important;display:inline !important;visibility:visible !important;opacity:1 !important}.toc-item.active .dot-red{background:#d32f2f}.toc-item.active .dot-blue{background:#1976d2}[data-theme=dark] .sidebar-toc{background:#1f2937;border-color:#374151;box-shadow:0 1px 3px rgba(0,0,0,.3)}[data-theme=dark] .toc-header{background:#111827;border-color:#374151}[data-theme=dark] .toc-title{color:#f3f4f6 !important}[data-theme=dark] .toc-toggle{color:#9ca3af}[data-theme=dark] .toc-toggle:hover{background:#374151;color:#f3f4f6}[data-theme=dark] .toc-item-link{color:#e5e7eb !important}[data-theme=dark] .toc-item-link:hover{background:#374151;color:#f9fafb !important}[data-theme=dark] .toc-item-link.active{background:#0d47a1;color:#fff !important}[data-theme=dark] .toc-item-text{color:#f9fafb !important;display:inline !important;visibility:visible !important;opacity:1 !important}[data-theme=dark] .toc-item-link .toc-item-text{color:#f9fafb !important;display:inline !important;visibility:visible !important;opacity:1 !important}@media(max-width:1024px){.sidebar-toc{display:none}.post-content-wrapper{grid-template-columns:1fr !important;padding:0 1rem !important}}</style><style>.post-content-wrapper{display:grid;grid-template-columns:1fr 200px;gap:2rem;padding:0 2rem;max-width:100%}.post-content-main{min-width:0}.post-sidebar{position:sticky;top:2rem;height:fit-content;min-width:0}.post-header-main{margin-bottom:2rem;padding-bottom:1rem;border-bottom:1px solid var(--border,#333333)}.post-header-main .post-title{color:var(--primary,#ffffff) !important;font-size:2.5rem;font-weight:700;line-height:1.2;margin-bottom:1rem}.post-header-main .post-description{color:var(--secondary,#cccccc) !important;font-size:1.1rem;line-height:1.6;margin-bottom:1rem}.post-header-main .post-meta{margin-bottom:0}@media(max-width:1024px){.post-content-wrapper{grid-template-columns:1fr !important;gap:1rem;padding:0 1rem !important}.post-sidebar{display:none}}@media(max-width:768px){.post-header-main .post-title{font-size:2rem}.post-header-main .post-description{font-size:1rem}}</style></aside></div></article></main><footer class=footer><span>Â© 2024-2025 æœ‰æ¡å·¥å…·æŠ€æœ¯åšå®¢</span> Â·</footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");if(menu){const e=localStorage.getItem("menu-scroll-position");e&&(menu.scrollLeft=parseInt(e,10)),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}}document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{const e=document.querySelector("html");e.dataset.theme==="dark"?(e.dataset.theme="light",localStorage.setItem("pref-theme","light")):(e.dataset.theme="dark",localStorage.setItem("pref-theme","dark"))})</script></body></html>